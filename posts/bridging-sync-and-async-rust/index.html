<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#282c34">
	<meta name="msapplication-TileColor" content="#282c34">
<meta itemprop="name" content="如何在同步的 Rust 方法中调用异步代码？">
<meta itemprop="description" content="背景和问题 最近在做我们的 GreptimeDB 项目的时候遇到一个关于在同步 Rust 方法中调用异步代码的问题，排查清楚之后大大加深了对异步 Rust 的理解，因此在这篇文章中记录"><meta itemprop="datePublished" content="2022-10-30T21:42:33+08:00" />
<meta itemprop="dateModified" content="2022-10-30T21:42:33+08:00" />
<meta itemprop="wordCount" content="2804">
<meta itemprop="keywords" content="Rust," /><meta property="og:title" content="如何在同步的 Rust 方法中调用异步代码？" />
<meta property="og:description" content="背景和问题 最近在做我们的 GreptimeDB 项目的时候遇到一个关于在同步 Rust 方法中调用异步代码的问题，排查清楚之后大大加深了对异步 Rust 的理解，因此在这篇文章中记录" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huanglei.rocks/posts/bridging-sync-and-async-rust/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-30T21:42:33+08:00" />
<meta property="article:modified_time" content="2022-10-30T21:42:33+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何在同步的 Rust 方法中调用异步代码？"/>
<meta name="twitter:description" content="背景和问题 最近在做我们的 GreptimeDB 项目的时候遇到一个关于在同步 Rust 方法中调用异步代码的问题，排查清楚之后大大加深了对异步 Rust 的理解，因此在这篇文章中记录"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>如何在同步的 Rust 方法中调用异步代码？</title>
	<link rel="stylesheet" href="https://huanglei.rocks/css/style.min.9769612e13f1728d406e3a8c5fd8c525de278fb5793a661c18d8474d7acbfcc7.css" integrity="sha256-l2lhLhPxco1AbjqMX9jFJd4nj7V5OmYcGNhHTXrL/Mc=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://huanglei.rocks">Ratuthomm</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://huanglei.rocks/posts/">Posts</a>
				<a href="https://huanglei.rocks/gallery/">Gallery</a>
				<a href="https://huanglei.rocks/scribbles/">Scribbles</a>
				<a href="https://huanglei.rocks/tags/">Tags</a>
				<a href="https://huanglei.rocks/about-me/">About Me</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://twitter.com/ratuthomm" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.instagram.com/ratuthomm" target="_blank" rel="noopener me" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a><a href="https://github.com/v0y4g3r" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
    <script defer data-domain="huanglei.rocks" src="https://plausible.io/js/plausible.js"></script>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://huanglei.rocks/posts/">Posts</a></li>
			<li><a href="https://huanglei.rocks/gallery/">Gallery</a></li>
			<li><a href="https://huanglei.rocks/scribbles/">Scribbles</a></li>
			<li><a href="https://huanglei.rocks/tags/">Tags</a></li>
			<li><a href="https://huanglei.rocks/about-me/">About Me</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Oct 30, 2022</span></div>
				<h1>如何在同步的 Rust 方法中调用异步代码？</h1>
			</header>

			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://huanglei.rocks/tags/rust">Rust</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2804 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2022-10-30 21:42 &#43;0800</p>
			</footer>
		</br>

			<div class="content">
				<h2 id="背景和问题">背景和问题<a href="#背景和问题" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>最近在做我们的 <a href="https://greptime.com/">GreptimeDB</a> 项目的时候遇到一个关于在同步 Rust 方法中调用异步代码的问题，排查清楚之后大大加深了对异步 Rust 的理解，因此在这篇文章中记录一下。</p>
<p>我们的整个项目是基于 <a href="https://tokio.rs/">Tokio</a> 这个异步 Rust runtime 的，它将协作式的任务运行和调度方便地封装在 <code>.await</code> 调用中，非常简洁优雅。但是这样也让不熟悉 Tokio 底层原理的用户一不小心就掉入到坑里。</p>
<p>我们遇到的问题是，需要在一个第三方库的 trait 实现中执行一些异步代码，而这个 trait 是同步的😅
，我们无法修改这个 trait 的定义。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们用一个<code>PlainSequencer</code>来实现这个 trait ，而在实现 <code>generate</code>方法的时候依赖一些异步的调用（比如这里的 <code>PlainSequencer::generate_async</code>）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span>-&gt;<span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这样就会出现问题，因为 <code>generate</code>是一个同步方法，里面是不能直接 await 的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">error[E0728]: `await` is only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">  --&gt; src/common/tt.rs:32:30
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">   |
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">31 | /     fn generate(<span class="nb">&amp;</span>self) -&gt; Vec&lt;i32&gt; <span class="nb">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">32 | |         self.generate<span class="nb">_</span>async().await
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl">   | |                              <span class="nb">^^^^^^</span> only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">33 | |     <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl">   | |<span class="nb">_____</span>- this is not `async`
</span></span></code></pre></div><p>我们首先想到的是，tokio 的 runtime 有一个 <code>Runtime::block_on</code><a href="https://docs.rs/tokio/latest/tokio/runtime/struct.Runtime.html#method.block_on">[1]</a> 方法，可以同步地等待一个 future 完成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="no">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">tests</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">    </span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: </span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>编译通过，但是运行时直接报错：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">thread &#39;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#39; panicked at &#39;Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.&#39;, /Users/lei/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.17.0/src/runtime/enter.rs:39:9
</span></span></code></pre></div><p>提示不能从一个执行中一个 runtime 直接启动另一个异步 runtime。</p>
<p>看来 Tokio 为了避免这种情况特地在入口做了检查。
既然不行那我们就再看看其他的异步库是否有类似的异步转同步的方法。果然找到一个 <code>futures::executor::block_on</code><a href="https://docs.rs/futures/0.2.0/futures/executor/fn.block_on.html">[2]</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>编译同样没问题，但是运行时代码直接直接 hang 住不返回了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">cargo test --color=always --package tokio-demo --bin tt tests::test<span class="nb">_</span>sync<span class="nb">_</span>method --no-fail-fast -- --format=json --exact -Z unstable-options --show-output      
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">   Compiling tokio-demo v0.1.0 (/Users/lei/Workspace/Rust/learning/tokio-demo)
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">    Finished test [unoptimized + debuginfo] target(s) in 0.39s
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">     Running unittests src/common/tt.rs (target/debug/deps/tt-adb10abca6625c07)
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;suite&#34;, &#34;event&#34;: &#34;started&#34;, &#34;test<span class="nb">_</span>count&#34;: 1 <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;test&#34;, &#34;event&#34;: &#34;started&#34;, &#34;name&#34;: &#34;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#34; <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"># The test just hangs here...
</span></span></code></pre></div><p>明明 <code>generate_async</code>方法里面只有一个简单的 sleep 调用，但是为什么 future 一直没完成呢？
并且吊诡的是，同样的代码，在 <code>tokio::test</code> 里面会 hang 住，但是在 <code>tokio::main</code> 中则可以正常执行完毕：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: </span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>执行结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">cargo run --color=always --package tokio-demo --bin tt
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">    Finished dev [unoptimized + debuginfo] target(s) in 0.05s
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">     Running `target/debug/tt`
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">vec: [0, 1, 2]
</span></span></code></pre></div><blockquote>
<p>其实当初真正遇到这个问题的时候定位到具体在哪里 hang 住并没有那么容易。真实代码中 async 执行的是一个远程的 gRPC 调用，当初怀疑过是否是 gRPC server 的问题，动用了网络抓包等等手段最终发现是 client 侧 的问题。这也提醒了我们在出现 bug 的时候，抽象出问题代码的执行模式并且做出一个最小可复现的样例（Minimal Reproducible Example）是非常重要的。</p>
</blockquote>
<h2 id="catchup">Catchup<a href="#catchup" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>在 Rust 中，异步代码块最终会被 <a href="https://github.com/rust-lang/rust/blob/7e966bcd03f6d0fae41f58cf80bcb10566ab971a/compiler/rustc_ast_lowering/src/expr.rs#L585"><code>make_async_expr</code></a> 编译成一个实现了 <code>std::future::Future</code> 的 generator:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_future</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="c1">// the above async block won&#39;t get executed until we await it.
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">future</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9">9</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>而 <code>.await</code> 本质上是一个语法糖，最终会被  <a href="https://github.com/rust-lang/rust/blob/7e966bcd03f6d0fae41f58cf80bcb10566ab971a/compiler/rustc_ast_lowering/src/expr.rs#L717"><code>lower_expr_await</code></a> 解开成为类似下面的语法结构:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="c1">// pseudo-rust code
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="c1"></span><span class="k">match</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">future</span>::<span class="n">IntoFuture</span>::<span class="n">into_future</span><span class="p">(</span><span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="k">mut</span><span class="w"> </span><span class="n">__awaitee</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span>::<span class="n">poll</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="o">&lt;</span>::<span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="o">&gt;</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">__awaitee</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span>::<span class="n">std</span>::<span class="n">future</span>::<span class="n">get_context</span><span class="p">(</span><span class="n">task_context</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">            </span>::<span class="n">std</span>::<span class="n">task</span>::<span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">            </span>::<span class="n">std</span>::<span class="n">task</span>::<span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">        </span><span class="n">task_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">yield</span><span class="w"> </span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在上面的伪代码中，可以看到有一个循环持续检查 generator 的状态是否 ready。既然如此是谁在检查呢？这就需要引入类似 Tokio 这样的异步 runtime 了，在这个 case 中，poll 的代码最终是交由 Tokio 的 executor 执行的。</p>
<p>问题分析</p>
<p>回顾完背景知识，我们再看一眼方法的实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>调用 <code>generate</code>方法的肯定是 Tokio 的 executor，那么 block_on 里面的 <code>self.generate_async().await</code>这个 future 又是谁在 poll 呢？一开始我以为，<code>futures::executor::block_on</code>会有一个内部的 runtime 去负责 <code>generate_async</code>的 poll。于是点进去<a href="https://docs.rs/futures-executor/0.3.6/src/futures_executor/local_pool.rs.html#77-104">代码</a>（主要是<code>futures_executor::local_pool::run_executor</code>这个方法）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">run_executor</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;</span><span class="nb">&#39;_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_enter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enter</span><span class="p">().</span><span class="n">expect</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="s">&#34;cannot execute `LocalPool` executor from within </span><span class="se">\</span><span class="s">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="s">         another executor&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="no">CURRENT_THREAD_NOTIFY</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">|</span><span class="n">thread_notify</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">waker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waker_ref</span><span class="p">(</span><span class="n">thread_notify</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">from_waker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">unparked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Acquire</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">unparked</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">                </span><span class="n">thread</span>::<span class="n">park</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">                </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Release</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>立刻嗅到了一丝不对的味道，虽然这个方法名为 <code>run_executor</code>，但是整个方法里面貌似没有任何 spawn 的操作，只是在当前线程不停的循环判断用户提交的 future 的状态是否为 ready 啊！！！！</p>
<p>这意味着，当 Tokio 的 runtime 线程执行到这里的时候，会立刻进入一个循环，在循环中不停地判断用户的的 future 是否 ready，如果还是 pending 状态，则将当前线程 park 住。假设，用户 future 的异步任务也是交给了当前线程去执行，<code>futures::executor::block_on</code>等待用户的 future ready，而用户 future 等待 <code>futures::executor::block_on</code>释放当前的线程资源，那么不就死锁了？
很有道理啊，立刻验证一下。既然不能在当前 runtime 线程 block，那就重新开一个线程 block：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">                </span><span class="c1">// 这里使用一个全局的 runtime 来 block
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span><span class="w">                </span><span class="no">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">                        </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">                        </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">                    </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">                </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="p">}).</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>果然可以了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">color</span><span class="o">=</span><span class="n">always</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">demo</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">tt</span><span class="w"> </span><span class="n">tests</span>::<span class="n">test_sync_method</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">fail</span><span class="o">-</span><span class="n">fast</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">format</span><span class="o">=</span><span class="n">json</span><span class="w"> </span><span class="o">--</span><span class="n">exact</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="n">unstable</span><span class="o">-</span><span class="n">options</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">tt</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">tt</span><span class="o">-</span><span class="n">adb10abca6625c07</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="n">vec</span>: <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>值得注意的是，在 <code>futures::executor::block_on</code>里面，额外使用了一个 <code>RUNTIME</code>来 spawn 我们的异步代码。其原因还是刚刚所说，这个异步任务需要一个 runtime 来驱动状态的变化，如果去掉 runtime，从一个新线程中执行我们的异步任务的话，<code>futures::executor::block_on</code>第一次 poll 我们异步任务的 future，会进入到 <code>tokio::time::sleep</code>方法调用，这个方法会判断当前执行的异步 runtime （上下文信息），而这个上下文信息是保留在 thread local 中的，在新线程中并不存在这个 thread local，从而会 panic。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="n">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="n">thread</span><span class="w"> </span><span class="na">&#39;</span><span class="o">&lt;</span><span class="n">unnamed</span><span class="o">&gt;</span><span class="na">&#39;</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="na">&#39;there</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">reactor</span><span class="w"> </span><span class="n">running</span><span class="p">,</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Tokio</span><span class="w"> </span><span class="mf">1.</span><span class="n">x</span><span class="w"> </span><span class="n">runtime</span><span class="na">&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span></code></pre></div><h2 id="tokiomain和-tokiotest"><code>tokio::main</code>和 <code>tokio::test</code><a href="#tokiomain和-tokiotest" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>在分析完上面的原因之后，“为什么 <code>tokio::main</code>中不会 hang 住而 <code>tokio::test</code>会 hang 住”这个问题也很清楚了，他们两者所使用的的 runtime 并不一样。<code>tokio::main</code>使用的是多线程的 runtime，而 <code>tokio::test</code> 使用的是单线程的 runtime，而在单线程的 runtime 下，当前线程被 <code>futures::executor::block_on</code>卡死，那么用户提交的异步代码是一定没机会执行的，从而必然形成上面所说的死锁。</p>
<h2 id="best-practice">Best practice<a href="#best-practice" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>经过上面的分析，结合 Rust 基于 generator 的协作式异步特性，我们可以总结出 Rust 下桥接异步代码和同步代码的一些注意事项：</p>
<ul>
<li>将异步代码与同步代码结合使用可能会导致阻塞，因此不是一个明智的选择。</li>
<li>在同步的上下文中调用异步代码时，请使用 <code>futures::executor::block_on</code> 并将异步代码 spawn 到另一个专用的 runtime 中执行 ，因为前者会阻塞当前线程。</li>
<li>如果必须从异步的上下文中调用有可能阻塞的同步代码（比如文件 IO 等），则建议使用 <code>tokio::task::spawn_blocking</code> 在专门处理阻塞操作的 executor 上执行相应的代码。</li>
</ul>
<h2 id="参考">参考<a href="#参考" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ul>
<li><a href="https://ryhl.io/blog/async-what-is-blocking/">Async: What is blocking?</a></li>
<li><a href="https://cfsamson.github.io/books-futures-explained/4_generators_async_await.html">Generators and async/await</a></li>
<li><a href="https://news.ycombinator.com/item?id=17536441">Async and Await in Rust: a full proposal</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2603">calling futures::executor::block_on in block_in_place may hang</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2376">tokio@0.2.14 + futures::executor::block_on causes hang</a></li>
</ul>

			</div>

<div class="related-posts thin">
	<h2>See Also</h2>
	<ul>
	
	<li><a href="/posts/rust-pinning/">理解 Rust 的 Pin 机制</a></li>
	
	<li><a href="/posts/object-safety/">Rust 对象安全详解</a></li>
	
	</ul>
</div>

		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#背景和问题">背景和问题</a></li>
    <li><a href="#catchup">Catchup</a></li>
    <li><a href="#tokiomain和-tokiotest"><code>tokio::main</code>和 <code>tokio::test</code></a></li>
    <li><a href="#best-practice">Best practice</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://huanglei.rocks/posts/send-sync/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>三个字母引发的惨案</span>
			</a>
			<a class="prev-post" href="https://huanglei.rocks/posts/notes-on-influxdb-storage/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Notes on InfluxDB Storage Engine</span>
			</a>
		</div>
		<div id="comments" class="thin"><script src="https://giscus.app/client.js"
        data-repo="v0y4g3r/blog"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyNTQ5MDMwOTk="
        data-category="Announcements"
        data-category-id="DIC_kwDODzGDO84CBGIK"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>&copy; 2023 <a href="https://huanglei.rocks/about-me/">Lei, HUANG</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a>
		&#183; <a href="https://huanglei.rocks/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
	</p>
</footer>


	

	


	<script src="https://huanglei.rocks/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js" integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin="anonymous"></script>
	

</body>

</html>
