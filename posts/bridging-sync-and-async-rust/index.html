<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#282c34">
	<meta name="msapplication-TileColor" content="#282c34">
<meta itemprop="name" content="å¦‚ä½•åœ¨åŒæ­¥çš„ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç ï¼Ÿ">
<meta itemprop="description" content="èƒŒæ™¯å’Œé—®é¢˜ æœ€è¿‘åœ¨åšæˆ‘ä»¬çš„ GreptimeDB é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå…³äºåœ¨åŒæ­¥ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç çš„é—®é¢˜ï¼Œæ’æŸ¥æ¸…æ¥šä¹‹åå¤§å¤§åŠ æ·±äº†å¯¹å¼‚æ­¥ Rust çš„ç†è§£ï¼Œå› æ­¤åœ¨è¿™ç¯‡æ–‡ç« ä¸­è®°å½•"><meta itemprop="datePublished" content="2022-10-30T21:42:33+08:00" />
<meta itemprop="dateModified" content="2022-10-30T21:42:33+08:00" />
<meta itemprop="wordCount" content="2804">
<meta itemprop="keywords" content="Rust," /><meta property="og:title" content="å¦‚ä½•åœ¨åŒæ­¥çš„ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç ï¼Ÿ" />
<meta property="og:description" content="èƒŒæ™¯å’Œé—®é¢˜ æœ€è¿‘åœ¨åšæˆ‘ä»¬çš„ GreptimeDB é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå…³äºåœ¨åŒæ­¥ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç çš„é—®é¢˜ï¼Œæ’æŸ¥æ¸…æ¥šä¹‹åå¤§å¤§åŠ æ·±äº†å¯¹å¼‚æ­¥ Rust çš„ç†è§£ï¼Œå› æ­¤åœ¨è¿™ç¯‡æ–‡ç« ä¸­è®°å½•" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huanglei.rocks/posts/bridging-sync-and-async-rust/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-30T21:42:33+08:00" />
<meta property="article:modified_time" content="2022-10-30T21:42:33+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å¦‚ä½•åœ¨åŒæ­¥çš„ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç ï¼Ÿ"/>
<meta name="twitter:description" content="èƒŒæ™¯å’Œé—®é¢˜ æœ€è¿‘åœ¨åšæˆ‘ä»¬çš„ GreptimeDB é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå…³äºåœ¨åŒæ­¥ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç çš„é—®é¢˜ï¼Œæ’æŸ¥æ¸…æ¥šä¹‹åå¤§å¤§åŠ æ·±äº†å¯¹å¼‚æ­¥ Rust çš„ç†è§£ï¼Œå› æ­¤åœ¨è¿™ç¯‡æ–‡ç« ä¸­è®°å½•"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>å¦‚ä½•åœ¨åŒæ­¥çš„ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç ï¼Ÿ</title>
	<link rel="stylesheet" href="https://huanglei.rocks/css/style.min.9769612e13f1728d406e3a8c5fd8c525de278fb5793a661c18d8474d7acbfcc7.css" integrity="sha256-l2lhLhPxco1AbjqMX9jFJd4nj7V5OmYcGNhHTXrL/Mc=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://huanglei.rocks">Ratuthomm</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://huanglei.rocks/posts/">Posts</a>
				<a href="https://huanglei.rocks/gallery/">Gallery</a>
				<a href="https://huanglei.rocks/scribbles/">Scribbles</a>
				<a href="https://huanglei.rocks/tags/">Tags</a>
				<a href="https://huanglei.rocks/about-me/">About Me</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://twitter.com/ratuthomm" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.instagram.com/ratuthomm" target="_blank" rel="noopener me" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a><a href="https://github.com/v0y4g3r" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
    <script defer data-domain="huanglei.rocks" src="https://plausible.io/js/plausible.js"></script>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://huanglei.rocks/posts/">Posts</a></li>
			<li><a href="https://huanglei.rocks/gallery/">Gallery</a></li>
			<li><a href="https://huanglei.rocks/scribbles/">Scribbles</a></li>
			<li><a href="https://huanglei.rocks/tags/">Tags</a></li>
			<li><a href="https://huanglei.rocks/about-me/">About Me</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Oct 30, 2022</span></div>
				<h1>å¦‚ä½•åœ¨åŒæ­¥çš„ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç ï¼Ÿ</h1>
			</header>

			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://huanglei.rocks/tags/rust">Rust</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2804 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2022-10-30 21:42 &#43;0800</p>
			</footer>
		</br>

			<div class="content">
				<h2 id="èƒŒæ™¯å’Œé—®é¢˜">èƒŒæ™¯å’Œé—®é¢˜<a href="#èƒŒæ™¯å’Œé—®é¢˜" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>æœ€è¿‘åœ¨åšæˆ‘ä»¬çš„ <a href="https://greptime.com/">GreptimeDB</a> é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå…³äºåœ¨åŒæ­¥ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç çš„é—®é¢˜ï¼Œæ’æŸ¥æ¸…æ¥šä¹‹åå¤§å¤§åŠ æ·±äº†å¯¹å¼‚æ­¥ Rust çš„ç†è§£ï¼Œå› æ­¤åœ¨è¿™ç¯‡æ–‡ç« ä¸­è®°å½•ä¸€ä¸‹ã€‚</p>
<p>æˆ‘ä»¬çš„æ•´ä¸ªé¡¹ç›®æ˜¯åŸºäº <a href="https://tokio.rs/">Tokio</a> è¿™ä¸ªå¼‚æ­¥ Rust runtime çš„ï¼Œå®ƒå°†åä½œå¼çš„ä»»åŠ¡è¿è¡Œå’Œè°ƒåº¦æ–¹ä¾¿åœ°å°è£…åœ¨ <code>.await</code> è°ƒç”¨ä¸­ï¼Œéå¸¸ç®€æ´ä¼˜é›…ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿè®©ä¸ç†Ÿæ‚‰ Tokio åº•å±‚åŸç†çš„ç”¨æˆ·ä¸€ä¸å°å¿ƒå°±æ‰å…¥åˆ°å‘é‡Œã€‚</p>
<p>æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜æ˜¯ï¼Œéœ€è¦åœ¨ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“çš„ trait å®ç°ä¸­æ‰§è¡Œä¸€äº›å¼‚æ­¥ä»£ç ï¼Œè€Œè¿™ä¸ª trait æ˜¯åŒæ­¥çš„ğŸ˜…
ï¼Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹è¿™ä¸ª trait çš„å®šä¹‰ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘ä»¬ç”¨ä¸€ä¸ª<code>PlainSequencer</code>æ¥å®ç°è¿™ä¸ª trait ï¼Œè€Œåœ¨å®ç° <code>generate</code>æ–¹æ³•çš„æ—¶å€™ä¾èµ–ä¸€äº›å¼‚æ­¥çš„è°ƒç”¨ï¼ˆæ¯”å¦‚è¿™é‡Œçš„ <code>PlainSequencer::generate_async</code>ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span>-&gt;<span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™æ ·å°±ä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸º <code>generate</code>æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œé‡Œé¢æ˜¯ä¸èƒ½ç›´æ¥ await çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">error[E0728]: `await` is only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">  --&gt; src/common/tt.rs:32:30
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">   |
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">31 | /     fn generate(<span class="nb">&amp;</span>self) -&gt; Vec&lt;i32&gt; <span class="nb">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">32 | |         self.generate<span class="nb">_</span>async().await
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl">   | |                              <span class="nb">^^^^^^</span> only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">33 | |     <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl">   | |<span class="nb">_____</span>- this is not `async`
</span></span></code></pre></div><p>æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯ï¼Œtokio çš„ runtime æœ‰ä¸€ä¸ª <code>Runtime::block_on</code><a href="https://docs.rs/tokio/latest/tokio/runtime/struct.Runtime.html#method.block_on">[1]</a> æ–¹æ³•ï¼Œå¯ä»¥åŒæ­¥åœ°ç­‰å¾…ä¸€ä¸ª future å®Œæˆã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="no">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">tests</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">    </span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: </span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯è¿è¡Œæ—¶ç›´æ¥æŠ¥é”™ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">thread &#39;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#39; panicked at &#39;Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.&#39;, /Users/lei/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.17.0/src/runtime/enter.rs:39:9
</span></span></code></pre></div><p>æç¤ºä¸èƒ½ä»ä¸€ä¸ªæ‰§è¡Œä¸­ä¸€ä¸ª runtime ç›´æ¥å¯åŠ¨å¦ä¸€ä¸ªå¼‚æ­¥ runtimeã€‚</p>
<p>çœ‹æ¥ Tokio ä¸ºäº†é¿å…è¿™ç§æƒ…å†µç‰¹åœ°åœ¨å…¥å£åšäº†æ£€æŸ¥ã€‚
æ—¢ç„¶ä¸è¡Œé‚£æˆ‘ä»¬å°±å†çœ‹çœ‹å…¶ä»–çš„å¼‚æ­¥åº“æ˜¯å¦æœ‰ç±»ä¼¼çš„å¼‚æ­¥è½¬åŒæ­¥çš„æ–¹æ³•ã€‚æœç„¶æ‰¾åˆ°ä¸€ä¸ª <code>futures::executor::block_on</code><a href="https://docs.rs/futures/0.2.0/futures/executor/fn.block_on.html">[2]</a>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç¼–è¯‘åŒæ ·æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¿è¡Œæ—¶ä»£ç ç›´æ¥ç›´æ¥ hang ä½ä¸è¿”å›äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">cargo test --color=always --package tokio-demo --bin tt tests::test<span class="nb">_</span>sync<span class="nb">_</span>method --no-fail-fast -- --format=json --exact -Z unstable-options --show-output      
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">   Compiling tokio-demo v0.1.0 (/Users/lei/Workspace/Rust/learning/tokio-demo)
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">    Finished test [unoptimized + debuginfo] target(s) in 0.39s
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">     Running unittests src/common/tt.rs (target/debug/deps/tt-adb10abca6625c07)
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;suite&#34;, &#34;event&#34;: &#34;started&#34;, &#34;test<span class="nb">_</span>count&#34;: 1 <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;test&#34;, &#34;event&#34;: &#34;started&#34;, &#34;name&#34;: &#34;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#34; <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"># The test just hangs here...
</span></span></code></pre></div><p>æ˜æ˜ <code>generate_async</code>æ–¹æ³•é‡Œé¢åªæœ‰ä¸€ä¸ªç®€å•çš„ sleep è°ƒç”¨ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆ future ä¸€ç›´æ²¡å®Œæˆå‘¢ï¼Ÿ
å¹¶ä¸”åŠè¯¡çš„æ˜¯ï¼ŒåŒæ ·çš„ä»£ç ï¼Œåœ¨ <code>tokio::test</code> é‡Œé¢ä¼š hang ä½ï¼Œä½†æ˜¯åœ¨ <code>tokio::main</code> ä¸­åˆ™å¯ä»¥æ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: </span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ‰§è¡Œç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">cargo run --color=always --package tokio-demo --bin tt
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">    Finished dev [unoptimized + debuginfo] target(s) in 0.05s
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">     Running `target/debug/tt`
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">vec: [0, 1, 2]
</span></span></code></pre></div><blockquote>
<p>å…¶å®å½“åˆçœŸæ­£é‡åˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™å®šä½åˆ°å…·ä½“åœ¨å“ªé‡Œ hang ä½å¹¶æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ã€‚çœŸå®ä»£ç ä¸­ async æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªè¿œç¨‹çš„ gRPC è°ƒç”¨ï¼Œå½“åˆæ€€ç–‘è¿‡æ˜¯å¦æ˜¯ gRPC server çš„é—®é¢˜ï¼ŒåŠ¨ç”¨äº†ç½‘ç»œæŠ“åŒ…ç­‰ç­‰æ‰‹æ®µæœ€ç»ˆå‘ç°æ˜¯ client ä¾§ çš„é—®é¢˜ã€‚è¿™ä¹Ÿæé†’äº†æˆ‘ä»¬åœ¨å‡ºç° bug çš„æ—¶å€™ï¼ŒæŠ½è±¡å‡ºé—®é¢˜ä»£ç çš„æ‰§è¡Œæ¨¡å¼å¹¶ä¸”åšå‡ºä¸€ä¸ªæœ€å°å¯å¤ç°çš„æ ·ä¾‹ï¼ˆMinimal Reproducible Exampleï¼‰æ˜¯éå¸¸é‡è¦çš„ã€‚</p>
</blockquote>
<h2 id="catchup">Catchup<a href="#catchup" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>åœ¨ Rust ä¸­ï¼Œå¼‚æ­¥ä»£ç å—æœ€ç»ˆä¼šè¢« <a href="https://github.com/rust-lang/rust/blob/7e966bcd03f6d0fae41f58cf80bcb10566ab971a/compiler/rustc_ast_lowering/src/expr.rs#L585"><code>make_async_expr</code></a> ç¼–è¯‘æˆä¸€ä¸ªå®ç°äº† <code>std::future::Future</code> çš„ generator:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_future</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="c1">// the above async block won&#39;t get executed until we await it.
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">future</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9">9</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è€Œ <code>.await</code> æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œæœ€ç»ˆä¼šè¢«  <a href="https://github.com/rust-lang/rust/blob/7e966bcd03f6d0fae41f58cf80bcb10566ab971a/compiler/rustc_ast_lowering/src/expr.rs#L717"><code>lower_expr_await</code></a> è§£å¼€æˆä¸ºç±»ä¼¼ä¸‹é¢çš„è¯­æ³•ç»“æ„:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="c1">// pseudo-rust code
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="c1"></span><span class="k">match</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">future</span>::<span class="n">IntoFuture</span>::<span class="n">into_future</span><span class="p">(</span><span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="k">mut</span><span class="w"> </span><span class="n">__awaitee</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span>::<span class="n">poll</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="o">&lt;</span>::<span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="o">&gt;</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">__awaitee</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span>::<span class="n">std</span>::<span class="n">future</span>::<span class="n">get_context</span><span class="p">(</span><span class="n">task_context</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">            </span>::<span class="n">std</span>::<span class="n">task</span>::<span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">            </span>::<span class="n">std</span>::<span class="n">task</span>::<span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">        </span><span class="n">task_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">yield</span><span class="w"> </span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>åœ¨ä¸Šé¢çš„ä¼ªä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªå¾ªç¯æŒç»­æ£€æŸ¥ generator çš„çŠ¶æ€æ˜¯å¦ readyã€‚æ—¢ç„¶å¦‚æ­¤æ˜¯è°åœ¨æ£€æŸ¥å‘¢ï¼Ÿè¿™å°±éœ€è¦å¼•å…¥ç±»ä¼¼ Tokio è¿™æ ·çš„å¼‚æ­¥ runtime äº†ï¼Œåœ¨è¿™ä¸ª case ä¸­ï¼Œpoll çš„ä»£ç æœ€ç»ˆæ˜¯äº¤ç”± Tokio çš„ executor æ‰§è¡Œçš„ã€‚</p>
<p>é—®é¢˜åˆ†æ</p>
<p>å›é¡¾å®ŒèƒŒæ™¯çŸ¥è¯†ï¼Œæˆ‘ä»¬å†çœ‹ä¸€çœ¼æ–¹æ³•çš„å®ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è°ƒç”¨ <code>generate</code>æ–¹æ³•çš„è‚¯å®šæ˜¯ Tokio çš„ executorï¼Œé‚£ä¹ˆ block_on é‡Œé¢çš„ <code>self.generate_async().await</code>è¿™ä¸ª future åˆæ˜¯è°åœ¨ poll å‘¢ï¼Ÿä¸€å¼€å§‹æˆ‘ä»¥ä¸ºï¼Œ<code>futures::executor::block_on</code>ä¼šæœ‰ä¸€ä¸ªå†…éƒ¨çš„ runtime å»è´Ÿè´£ <code>generate_async</code>çš„ pollã€‚äºæ˜¯ç‚¹è¿›å»<a href="https://docs.rs/futures-executor/0.3.6/src/futures_executor/local_pool.rs.html#77-104">ä»£ç </a>ï¼ˆä¸»è¦æ˜¯<code>futures_executor::local_pool::run_executor</code>è¿™ä¸ªæ–¹æ³•ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">run_executor</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;</span><span class="nb">&#39;_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_enter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enter</span><span class="p">().</span><span class="n">expect</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="s">&#34;cannot execute `LocalPool` executor from within </span><span class="se">\</span><span class="s">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="s">         another executor&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="no">CURRENT_THREAD_NOTIFY</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">|</span><span class="n">thread_notify</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">waker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waker_ref</span><span class="p">(</span><span class="n">thread_notify</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">from_waker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">unparked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Acquire</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">unparked</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">                </span><span class="n">thread</span>::<span class="n">park</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">                </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Release</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç«‹åˆ»å—…åˆ°äº†ä¸€ä¸ä¸å¯¹çš„å‘³é“ï¼Œè™½ç„¶è¿™ä¸ªæ–¹æ³•åä¸º <code>run_executor</code>ï¼Œä½†æ˜¯æ•´ä¸ªæ–¹æ³•é‡Œé¢è²Œä¼¼æ²¡æœ‰ä»»ä½• spawn çš„æ“ä½œï¼Œåªæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸åœçš„å¾ªç¯åˆ¤æ–­ç”¨æˆ·æäº¤çš„ future çš„çŠ¶æ€æ˜¯å¦ä¸º ready å•Šï¼ï¼ï¼ï¼</p>
<p>è¿™æ„å‘³ç€ï¼Œå½“ Tokio çš„ runtime çº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œä¼šç«‹åˆ»è¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨å¾ªç¯ä¸­ä¸åœåœ°åˆ¤æ–­ç”¨æˆ·çš„çš„ future æ˜¯å¦ readyï¼Œå¦‚æœè¿˜æ˜¯ pending çŠ¶æ€ï¼Œåˆ™å°†å½“å‰çº¿ç¨‹ park ä½ã€‚å‡è®¾ï¼Œç”¨æˆ· future çš„å¼‚æ­¥ä»»åŠ¡ä¹Ÿæ˜¯äº¤ç»™äº†å½“å‰çº¿ç¨‹å»æ‰§è¡Œï¼Œ<code>futures::executor::block_on</code>ç­‰å¾…ç”¨æˆ·çš„ future readyï¼Œè€Œç”¨æˆ· future ç­‰å¾… <code>futures::executor::block_on</code>é‡Šæ”¾å½“å‰çš„çº¿ç¨‹èµ„æºï¼Œé‚£ä¹ˆä¸å°±æ­»é”äº†ï¼Ÿ
å¾ˆæœ‰é“ç†å•Šï¼Œç«‹åˆ»éªŒè¯ä¸€ä¸‹ã€‚æ—¢ç„¶ä¸èƒ½åœ¨å½“å‰ runtime çº¿ç¨‹ blockï¼Œé‚£å°±é‡æ–°å¼€ä¸€ä¸ªçº¿ç¨‹ blockï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">                </span><span class="c1">// è¿™é‡Œä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„ runtime æ¥ block
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span><span class="w">                </span><span class="no">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">                        </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">                        </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">                    </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">                </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="p">}).</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æœç„¶å¯ä»¥äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">color</span><span class="o">=</span><span class="n">always</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">demo</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">tt</span><span class="w"> </span><span class="n">tests</span>::<span class="n">test_sync_method</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">fail</span><span class="o">-</span><span class="n">fast</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">format</span><span class="o">=</span><span class="n">json</span><span class="w"> </span><span class="o">--</span><span class="n">exact</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="n">unstable</span><span class="o">-</span><span class="n">options</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">tt</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">tt</span><span class="o">-</span><span class="n">adb10abca6625c07</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="n">vec</span>: <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>futures::executor::block_on</code>é‡Œé¢ï¼Œé¢å¤–ä½¿ç”¨äº†ä¸€ä¸ª <code>RUNTIME</code>æ¥ spawn æˆ‘ä»¬çš„å¼‚æ­¥ä»£ç ã€‚å…¶åŸå› è¿˜æ˜¯åˆšåˆšæ‰€è¯´ï¼Œè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡éœ€è¦ä¸€ä¸ª runtime æ¥é©±åŠ¨çŠ¶æ€çš„å˜åŒ–ï¼Œå¦‚æœå»æ‰ runtimeï¼Œä»ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­æ‰§è¡Œæˆ‘ä»¬çš„å¼‚æ­¥ä»»åŠ¡çš„è¯ï¼Œ<code>futures::executor::block_on</code>ç¬¬ä¸€æ¬¡ poll æˆ‘ä»¬å¼‚æ­¥ä»»åŠ¡çš„ futureï¼Œä¼šè¿›å…¥åˆ° <code>tokio::time::sleep</code>æ–¹æ³•è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåˆ¤æ–­å½“å‰æ‰§è¡Œçš„å¼‚æ­¥ runtime ï¼ˆä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰ï¼Œè€Œè¿™ä¸ªä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯ä¿ç•™åœ¨ thread local ä¸­çš„ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­å¹¶ä¸å­˜åœ¨è¿™ä¸ª thread localï¼Œä»è€Œä¼š panicã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="n">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="n">thread</span><span class="w"> </span><span class="na">&#39;</span><span class="o">&lt;</span><span class="n">unnamed</span><span class="o">&gt;</span><span class="na">&#39;</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="na">&#39;there</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">reactor</span><span class="w"> </span><span class="n">running</span><span class="p">,</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Tokio</span><span class="w"> </span><span class="mf">1.</span><span class="n">x</span><span class="w"> </span><span class="n">runtime</span><span class="na">&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span></code></pre></div><h2 id="tokiomainå’Œ-tokiotest"><code>tokio::main</code>å’Œ <code>tokio::test</code><a href="#tokiomainå’Œ-tokiotest" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>åœ¨åˆ†æå®Œä¸Šé¢çš„åŸå› ä¹‹åï¼Œâ€œä¸ºä»€ä¹ˆ <code>tokio::main</code>ä¸­ä¸ä¼š hang ä½è€Œ <code>tokio::test</code>ä¼š hang ä½â€è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œä»–ä»¬ä¸¤è€…æ‰€ä½¿ç”¨çš„çš„ runtime å¹¶ä¸ä¸€æ ·ã€‚<code>tokio::main</code>ä½¿ç”¨çš„æ˜¯å¤šçº¿ç¨‹çš„ runtimeï¼Œè€Œ <code>tokio::test</code> ä½¿ç”¨çš„æ˜¯å•çº¿ç¨‹çš„ runtimeï¼Œè€Œåœ¨å•çº¿ç¨‹çš„ runtime ä¸‹ï¼Œå½“å‰çº¿ç¨‹è¢« <code>futures::executor::block_on</code>å¡æ­»ï¼Œé‚£ä¹ˆç”¨æˆ·æäº¤çš„å¼‚æ­¥ä»£ç æ˜¯ä¸€å®šæ²¡æœºä¼šæ‰§è¡Œçš„ï¼Œä»è€Œå¿…ç„¶å½¢æˆä¸Šé¢æ‰€è¯´çš„æ­»é”ã€‚</p>
<h2 id="best-practice">Best practice<a href="#best-practice" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œç»“åˆ Rust åŸºäº generator çš„åä½œå¼å¼‚æ­¥ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º Rust ä¸‹æ¡¥æ¥å¼‚æ­¥ä»£ç å’ŒåŒæ­¥ä»£ç çš„ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>å°†å¼‚æ­¥ä»£ç ä¸åŒæ­¥ä»£ç ç»“åˆä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´é˜»å¡ï¼Œå› æ­¤ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ã€‚</li>
<li>åœ¨åŒæ­¥çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç æ—¶ï¼Œè¯·ä½¿ç”¨ <code>futures::executor::block_on</code> å¹¶å°†å¼‚æ­¥ä»£ç  spawn åˆ°å¦ä¸€ä¸ªä¸“ç”¨çš„ runtime ä¸­æ‰§è¡Œ ï¼Œå› ä¸ºå‰è€…ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚</li>
<li>å¦‚æœå¿…é¡»ä»å¼‚æ­¥çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨æœ‰å¯èƒ½é˜»å¡çš„åŒæ­¥ä»£ç ï¼ˆæ¯”å¦‚æ–‡ä»¶ IO ç­‰ï¼‰ï¼Œåˆ™å»ºè®®ä½¿ç”¨ <code>tokio::task::spawn_blocking</code> åœ¨ä¸“é—¨å¤„ç†é˜»å¡æ“ä½œçš„ executor ä¸Šæ‰§è¡Œç›¸åº”çš„ä»£ç ã€‚</li>
</ul>
<h2 id="å‚è€ƒ">å‚è€ƒ<a href="#å‚è€ƒ" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ul>
<li><a href="https://ryhl.io/blog/async-what-is-blocking/">Async: What is blocking?</a></li>
<li><a href="https://cfsamson.github.io/books-futures-explained/4_generators_async_await.html">Generators and async/await</a></li>
<li><a href="https://news.ycombinator.com/item?id=17536441">Async and Await in Rust: a full proposal</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2603">calling futures::executor::block_on in block_in_place may hang</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2376">tokio@0.2.14 + futures::executor::block_on causes hang</a></li>
</ul>

			</div>

<div class="related-posts thin">
	<h2>See Also</h2>
	<ul>
	
	<li><a href="/posts/rust-pinning/">ç†è§£ Rust çš„ Pin æœºåˆ¶</a></li>
	
	<li><a href="/posts/object-safety/">Rust å¯¹è±¡å®‰å…¨è¯¦è§£</a></li>
	
	</ul>
</div>

		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#èƒŒæ™¯å’Œé—®é¢˜">èƒŒæ™¯å’Œé—®é¢˜</a></li>
    <li><a href="#catchup">Catchup</a></li>
    <li><a href="#tokiomainå’Œ-tokiotest"><code>tokio::main</code>å’Œ <code>tokio::test</code></a></li>
    <li><a href="#best-practice">Best practice</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://huanglei.rocks/posts/send-sync/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>ä¸‰ä¸ªå­—æ¯å¼•å‘çš„æƒ¨æ¡ˆ</span>
			</a>
			<a class="prev-post" href="https://huanglei.rocks/posts/notes-on-influxdb-storage/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Notes on InfluxDB Storage Engine</span>
			</a>
		</div>
		<div id="comments" class="thin"><script src="https://giscus.app/client.js"
        data-repo="v0y4g3r/blog"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyNTQ5MDMwOTk="
        data-category="Announcements"
        data-category-id="DIC_kwDODzGDO84CBGIK"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>&copy; 2023 <a href="https://huanglei.rocks/about-me/">Lei, HUANG</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a>
		&#183; <a href="https://huanglei.rocks/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
	</p>
</footer>


	

	


	<script src="https://huanglei.rocks/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js" integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin="anonymous"></script>
	

</body>

</html>
