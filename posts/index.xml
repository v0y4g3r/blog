<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on Ratuthomm</title>
		<link>https://huanglei.rocks/posts/</link>
		<description>Recent content in Posts on Ratuthomm</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>en-us</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Sun, 19 Feb 2023 18:28:33 +0800</lastBuildDate>
		<atom:link href="https://huanglei.rocks/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>三个字母引发的惨案</title>
			<link>https://huanglei.rocks/posts/send-sync/</link>
			<pubDate>Sun, 19 Feb 2023 18:28:33 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/send-sync/</guid>
			<description>问题 在 feat: compaction integration - GreptimeTeam/greptimedb #997 中，我们尝试把 table compaction 作为 flush 的后置任务触发，因此需要为 FlushJob增加一个 callback，因为涉及到异步操作，所以这个 callback</description>
			<content type="html"><![CDATA[<h2 id="问题">问题</h2>
<p>在 <a href="https://github.com/GreptimeTeam/greptimedb/pull/997">feat: compaction integration - GreptimeTeam/greptimedb #997</a> 中，我们尝试把 table compaction 作为 flush 的后置任务触发，因此需要为 <code>FlushJob</code>增加一个 callback，因为涉及到异步操作，所以这个 callback 的定义是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">FlushCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">FlushJob</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">LogStore</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">on_success</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">FlushCallback</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>然后在完成 flush 后调用 callback：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="cp">#[async_trait]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">LogStore</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">FlushJob</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">Context</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">write_manifest_and_apply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_metas</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">on_success</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">            </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可惜编译器无情地给出了 error：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="n">error</span>: <span class="nc">future</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="n">safely</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">58</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="mi">250</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">Context</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="n">__________________________________________________________</span><span class="o">^</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w"></span><span class="mi">251</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="mi">252</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_manifest_and_apply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_metas</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w"></span><span class="mi">253</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="o">..</span><span class="p">.</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="mi">257</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="mi">258</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">_____</span><span class="o">^</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="err">`</span><span class="nb">Send</span><span class="err">`</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">help</span>: <span class="nc">the</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="err">`</span><span class="nb">Sync</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">implemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">futures_util</span>::<span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">)</span><span class="err">`</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w"></span><span class="n">note</span>: <span class="nc">future</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="err">`</span><span class="nb">Send</span><span class="err">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">251</span>:<span class="mi">60</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="mi">251</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">----</span><span class="w">                              </span><span class="o">^^^^^^</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">later</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">here</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">|</span><span class="w">                                 </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">|</span><span class="w">                                 </span><span class="k">await</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="n">here</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span><span class="err">`</span><span class="w"> </span><span class="n">maybe</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">later</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="n">has</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="o">&amp;</span><span class="n">FlushJob</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="err">`</span><span class="nb">Send</span><span class="err">`</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w"></span><span class="n">help</span>: <span class="nc">consider</span><span class="w"> </span><span class="n">moving</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="kd">let</span><span class="err">`</span><span class="w"> </span><span class="n">binding</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">shorter</span><span class="w"> </span><span class="n">lived</span><span class="w"> </span><span class="n">borrow</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">251</span>:<span class="mi">26</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w"></span><span class="mi">251</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">required</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cast</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">`</span><span class="p">[</span><span class="k">async</span><span class="w"> </span><span class="n">block</span><span class="o">@</span><span class="n">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">58</span>: <span class="mi">258</span>:<span class="mi">6</span><span class="p">]</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="k">dyn</span><span class="w"> </span><span class="n">futures_util</span>::<span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">result</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Send</span><span class="err">`</span><span class="w">
</span></span></span></code></pre></div><p>大概意思是说，新加入<code>FlushJob</code> 的<code>cb</code>字段不是<code>Sync</code>的，导致<code>FlushJob::run</code>方法所产生的 future 不满足<code>Send</code>约束。</p>
<blockquote>
<p>这一点倒是容易理解，因为我们对 FlushCallback 的定义<code>Pin&lt;Box&lt;dyn Future&lt;Output=xxx&gt; + Send&gt;&gt;</code>并未带上 <code>Sync</code>trait，通常我们也不应该要求一个 future 是<code>Sync</code>的，因为 future 的定义中唯一一个方法的 receiver 是 <code>self: Pin&lt;&amp;mut Self&gt;</code>，不存在对 self 的 shared reference，所以不应该要求 future 满足<code>Sync</code>。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">            </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>因此，除了为 <code>FlushCallback</code>强行加上<code>Sync</code>约束外，我们更应该想一想为什么编译器会要求<code>FlushCallback: Sync</code>。</p>
<h2 id="mre">MRE</h2>
<p>为了方便排查问题，我们把不相关的代码逻辑去掉，用一段最简单的代码来复现这个问题。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="cp">#[async_trait::async_trait]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Job</span>: <span class="nb">Send</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="k">type</span> <span class="nc">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="n">cb</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Callback</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="cp">#[async_trait::async_trait]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">do_something</span><span class="p">().</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cb</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">            </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="w"></span><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">job_impl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cb</span>: <span class="nb">None</span> <span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl"><span class="w">    </span><span class="n">job_impl</span><span class="p">.</span><span class="n">run</span><span class="p">().</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在 <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=90f5a253a0a6e5cef0e659e42fa1a193">Rust Playground</a> 中编译运行这段代码可以看到类似的报错。</p>
<p>现在代码里面的魔法只剩下了<code>async_trait</code>这个 proc macro。为了进一步简化代码，我们可以手动把这个宏展开：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">mre</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="n">Checking</span><span class="w"> </span><span class="n">lance</span><span class="o">-</span><span class="n">demo</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">lei</span><span class="o">/</span><span class="n">Workspace</span><span class="o">/</span><span class="n">Rust</span><span class="o">/</span><span class="n">mre</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.23</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">mre</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Job</span>: <span class="nb">Send</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; 
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl">            <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">    </span><span class="k">type</span> <span class="nc">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">        </span><span class="n">cb</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Callback</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">        </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">__self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">            </span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w">                </span><span class="n">JobImpl</span>::<span class="n">do_something</span><span class="p">(</span><span class="n">__self</span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__self</span><span class="p">.</span><span class="n">cb</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="w">                    </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl"><span class="w">                </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a class="lnlinks" href="#code-sec-35">35</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-36"><a class="lnlinks" href="#code-sec-36">36</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到 <code>JobImpl::run</code>方法返回的 future 里面只包含了对 self 的引用 <code>__self</code>。因此 future 不满足<code>Send</code>约束，也就是<code>__self</code>不满足<code>Send</code>约束，而 <code>__self</code>的类型是什么呢？根据<code>JobImpl::run</code>的 receiver 很显然是 <code>&amp;mut self</code>。</p>
<p>Hmmm&hellip; <code>Send</code>/<code>Sync</code>/<code>&amp;mut T</code>/<code>&amp;T</code>似乎让人想起来刚刚开始学 Rust 的时候一些古早记忆，查到这里不妨再复习一下。</p>
<h2 id="一点点小知识">一点点小知识🤏🏻</h2>
<p><code>Send</code> 和 <code>Sync</code> 都是用于描述 thread-safety 的 marker trait.</p>
<ul>
<li><code>Send</code>指的是某个数据类型可以被安全地转移到另一个线程 (move)</li>
<li><code>Sync</code>指的是某个数据类型可以安全地被多个线程共享不可变引用 (borrow)</li>
</ul>
<blockquote>
<p>“安全地传递”指的是在保证线程安全的情况下转移所有权。那么什么情况下转移所有权是不安全的呢？举个例子，<code>Rc</code>并没有实现 <code>Send</code>，只能用作单线程内部的引用计数。<code>Rc</code> 的内部是用的 <code>Cell</code>实现内部可变性，在 drop 的时候，如果引用计数为 0，则将内部包含的数据析构掉。因为<a href="https://doc.rust-lang.org/src/alloc/rc.rs.html#2633-2635">修改引用计数</a>的行为本身不是原子的，因此 move 到另一个线程之后如果进行 clone，那么可能就会导致并发问题，因此 <code>Rc</code> 不能安全地被转移所有权。</p>
</blockquote>
<ul>
<li>Send 和 Sync 的绑定关系
<ul>
<li><code>&amp;T: Send</code> ⇔ <code>T: Sync</code>：要想一个数据类型的不可变引用是<code>Send</code>的，那么这个数据类型自身必须是<code>Sync</code>的，这样才能保证跨线程的只读访问是安全的；</li>
<li><code>&amp;mut T: Send</code> ⇔ <code>T: Send</code>：要想一个数据类型的可变引用是 <code>Send</code>的，那么这个数据类型自身也必须是<code>Send</code>的，因为跨线程共享可变引用即意味着 move 。</li>
<li>显然，相比要求 <code>T: Sync</code>，<code>T: Send</code>是更加宽松的。</li>
</ul>
</li>
</ul>
<h2 id="去掉一点糖">去掉一点糖</h2>
<p>我们再来看看 <code>!Send</code>的 future：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">__self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="n">JobImpl</span>::<span class="n">do_something</span><span class="p">(</span><span class="n">__self</span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__self</span><span class="p">.</span><span class="n">cb</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>既然 future 捕获的是 <code>JobImpl</code>的可变引用，那么只要 <code>JobImpl</code>是<code>Send</code>的那么 future 就一定是<code>Send</code>才对啊？哪里出了问题呢？我们再来看看 <code>JobImpl::do_something</code>的签名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到 <code>do_something</code>的 receiver 是 <code>JobImpl</code>的共享引用，那么<code>__self</code>自然就会被 coerce 成 <code>&amp;JobImpl</code>。根据 <code>Send</code> 和 <code>Sync</code> 的绑定关系，如果 T 的共享引用是 <code>Send</code>，那么 T 自身必须是 <code>Sync</code>，这样就能解释为啥要求 <code>JobImpl: Sync</code>了。</p>
<p>仅仅是因为 coercion 吗？我们可以试试把 <code>JobImpl::do_something</code>改成同步的签名 <code>fn do_something(&amp;self) {}</code>，结果居然是可以编译的。显然问题不仅出在 receiver，也和 async 有关。我们都知道，Rust 的 async 本质上只是一个 generator 的语法糖，对 <code>JobImpl::do_something</code>的调用会被展开成一个实现了 Generator trait 的 struct，这个 struct 捕获了<code>JobImpl</code>的共享引用，而 <code>JobImpl</code>不满足<code>Sync</code>约束，从而 genrator 不满足 <code>Send</code>约束。</p>
<p>因此我们只需要增加三个字母，把 <code>JobImpl::do_something</code>的 receiver 改成可变引用就行啦。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="c1">//                         ^~~~ the magic lies here
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=0f06bf5a9a02c8bfc93a9781462e3b4e">You can try it here</a></p>
<h2 id="结论">结论</h2>
<p>所以这个问题的本质是，在一个要求 T 的可变引用的异步上下文中，调用了一个接收 T 的共享引用的异步方法，从而导致对 T 的要求从 <code>Send</code> 升级成了 <code>Sync</code>。
其实这在做了一个复现的 demo 之后还是很容易发现的（毕竟才二三十行代码），但是在项目的一个几百行的 PR 里面就不太容易发现到底是哪里不 <code>Sync</code>了。Rust 的 async/await 语法糖用起来很方便，但是还是要理解它背后是怎么实现的，不然很容易踩坑里。</p>
]]></content>
		</item>
		
		<item>
			<title>如何在同步的 Rust 方法中调用异步代码？</title>
			<link>https://huanglei.rocks/posts/bridging-sync-and-async-rust/</link>
			<pubDate>Sun, 30 Oct 2022 21:42:33 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/bridging-sync-and-async-rust/</guid>
			<description>背景和问题 最近在做我们的 GreptimeDB 项目的时候遇到一个关于在同步 Rust 方法中调用异步代码的问题，排查清楚之后大大加深了对异步 Rust 的理解，因此在这篇文章中记录</description>
			<content type="html"><![CDATA[<h2 id="背景和问题">背景和问题</h2>
<p>最近在做我们的 <a href="https://greptime.com/">GreptimeDB</a> 项目的时候遇到一个关于在同步 Rust 方法中调用异步代码的问题，排查清楚之后大大加深了对异步 Rust 的理解，因此在这篇文章中记录一下。</p>
<p>我们的整个项目是基于 <a href="https://tokio.rs/">Tokio</a> 这个异步 Rust runtime 的，它将协作式的任务运行和调度方便地封装在 <code>.await</code> 调用中，非常简洁优雅。但是这样也让不熟悉 Tokio 底层原理的用户一不小心就掉入到坑里。</p>
<p>我们遇到的问题是，需要在一个第三方库的 trait 实现中执行一些异步代码，而这个 trait 是同步的😅
，我们无法修改这个 trait 的定义。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们用一个<code>PlainSequencer</code>来实现这个 trait ，而在实现 <code>generate</code>方法的时候依赖一些异步的调用（比如这里的 <code>PlainSequencer::generate_async</code>）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span>-&gt;<span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这样就会出现问题，因为 <code>generate</code>是一个同步方法，里面是不能直接 await 的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">error[E0728]: `await` is only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">  --&gt; src/common/tt.rs:32:30
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">   |
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">31 | /     fn generate(<span class="nb">&amp;</span>self) -&gt; Vec&lt;i32&gt; <span class="nb">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">32 | |         self.generate<span class="nb">_</span>async().await
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl">   | |                              <span class="nb">^^^^^^</span> only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">33 | |     <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl">   | |<span class="nb">_____</span>- this is not `async`
</span></span></code></pre></div><p>我们首先想到的是，tokio 的 runtime 有一个 <code>Runtime::block_on</code><a href="https://docs.rs/tokio/latest/tokio/runtime/struct.Runtime.html#method.block_on">[1]</a> 方法，可以同步地等待一个 future 完成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">tests</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">    </span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>编译通过，但是运行时直接报错：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">thread &#39;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#39; panicked at &#39;Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.&#39;, /Users/lei/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.17.0/src/runtime/enter.rs:39:9
</span></span></code></pre></div><p>提示不能从一个执行中一个 runtime 直接启动另一个异步 runtime。</p>
<p>看来 Tokio 为了避免这种情况特地在入口做了检查。
既然不行那我们就再看看其他的异步库是否有类似的异步转同步的方法。果然找到一个 <code>futures::executor::block_on</code><a href="https://docs.rs/futures/0.2.0/futures/executor/fn.block_on.html">[2]</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>编译同样没问题，但是运行时代码直接直接 hang 住不返回了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">cargo test --color=always --package tokio-demo --bin tt tests::test<span class="nb">_</span>sync<span class="nb">_</span>method --no-fail-fast -- --format=json --exact -Z unstable-options --show-output      
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">   Compiling tokio-demo v0.1.0 (/Users/lei/Workspace/Rust/learning/tokio-demo)
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">    Finished test [unoptimized + debuginfo] target(s) in 0.39s
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">     Running unittests src/common/tt.rs (target/debug/deps/tt-adb10abca6625c07)
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;suite&#34;, &#34;event&#34;: &#34;started&#34;, &#34;test<span class="nb">_</span>count&#34;: 1 <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;test&#34;, &#34;event&#34;: &#34;started&#34;, &#34;name&#34;: &#34;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#34; <span class="nb">}</span>
</span></span></code></pre></div><p>明明 <code>generate_async</code>方法里面只有一个简单的 sleep 调用，但是为什么 future 一直没完成呢？
并且吊诡的是，同样的代码，在 <code>tokio::test</code>里面会 hang 住，但是在 <code>tokio::main</code>中则可以正常执行完毕：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>执行结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">cargo run --color=always --package tokio-demo --bin tt
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">    Finished dev [unoptimized + debuginfo] target(s) in 0.05s
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">     Running `target/debug/tt`
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">vec: [0, 1, 2]
</span></span></code></pre></div><blockquote>
<p>其实当初真正遇到这个问题的时候定位到具体在哪里 hang 住并没有那么容易。真实代码中 async 执行的是一个远程的 gRPC 调用，当初怀疑过是否是 gRPC server 的问题，动用了网络抓包等等手段最终发现是 client 侧 的问题。这也提醒了我们在出现 bug 的时候，抽象出问题代码的执行模式并且做出一个最小可复现的样例（Minimal Reproducible Example）是非常重要的。</p>
</blockquote>
<h2 id="catchup">Catchup</h2>
<p>凭着对 Rust 异步 runtime 的基本了解，我大概知道类似 Tokio 这样的异步 runtime 是一个 executor+scheduler+reactor 的模型。其中：</p>
<ul>
<li>executor：在计算资源（在 std 环境下就是操作系统的 thread，嵌入式环境下则没有 thread 抽象）上执行真正的异步任务；</li>
<li>scheduler：负责维护一个异步任务的 FIFO 并且负责任务在不同 executor 之间调度；</li>
<li>reactor：抽象底层阻塞 IO，提供非阻塞事件监听和唤醒的功能（类似 epoll 那样）。</li>
</ul>
<p>Rust 中的一个异步代码块本质上是一个 future，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>其是不会直接执行的，只有将其 spawn 到异步的 runtime 里面才会真正封装成一个任务交给 executor 执行。Runtime 有一套机制去唤醒异步任务，检查 future 的状态是否为 ready 等等。</p>
<h2 id="问题分析">问题分析</h2>
<p>回顾完背景知识，我们再看一眼方法的实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>调用 <code>generate</code>方法的肯定是 Tokio 的 executor，那么 block_on 里面的 <code>self.generate_async().await</code>这个 future 又是谁在 poll 呢？一开始我以为，<code>futures::executor::block_on</code>会有一个内部的 runtime 去负责 <code>generate_async</code>的 poll。于是点进去<a href="https://docs.rs/futures-executor/0.3.6/src/futures_executor/local_pool.rs.html#77-104">代码</a>（主要是<code>futures_executor::local_pool::run_executor</code>这个方法）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">run_executor</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_enter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enter</span><span class="p">().</span><span class="n">expect</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="err">&#34;</span><span class="n">cannot</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="err">`</span><span class="n">LocalPool</span><span class="err">`</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="err">\</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">         </span><span class="n">another</span><span class="w"> </span><span class="n">executor</span><span class="err">&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="n">CURRENT_THREAD_NOTIFY</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">|</span><span class="n">thread_notify</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">waker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waker_ref</span><span class="p">(</span><span class="n">thread_notify</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">from_waker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">unparked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Acquire</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">unparked</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">                </span><span class="n">thread</span>::<span class="n">park</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">                </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Release</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>立刻嗅到了一丝不对的味道，虽然这个方法名为 <code>run_executor</code>，但是整个方法里面貌似没有任何 spawn 的操作，只是在当前线程不停的循环判断用户提交的 future 的状态是否为 ready 啊！！！！</p>
<p>这意味着，当 Tokio 的 runtime 线程执行到这里的时候，会立刻进入一个循环，在循环中不停地判断用户的的 future 是否 ready，如果还是 pending 状态，则将当前线程 park 住。假设，用户 future 的异步任务也是交给了当前线程去执行，<code>futures::executor::block_on</code>等待用户的 future ready，而用户 future 等待 <code>futures::executor::block_on</code>释放当前的线程资源，那么不就死锁了？
很有道理啊，立刻验证一下。既然不能在当前 runtime 线程 block，那就重新开一个线程 block：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">                </span><span class="c1">// 这里使用一个全局的 runtime 来 block
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span><span class="w">                </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">                        </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">                        </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">                    </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">                </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="p">}).</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>果然可以了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">color</span><span class="o">=</span><span class="n">always</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">demo</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">tt</span><span class="w"> </span><span class="n">tests</span>::<span class="n">test_sync_method</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">fail</span><span class="o">-</span><span class="n">fast</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">format</span><span class="o">=</span><span class="n">json</span><span class="w"> </span><span class="o">--</span><span class="n">exact</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="n">unstable</span><span class="o">-</span><span class="n">options</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">tt</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">tt</span><span class="o">-</span><span class="n">adb10abca6625c07</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="n">vec</span>: <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>值得注意的是，在 <code>futures::executor::block_on</code>里面，额外使用了一个 <code>RUNTIME</code>来 spawn 我们的异步代码。其原因还是刚刚所说，这个异步任务需要一个 runtime 来驱动状态的变化，如果去掉 runtime，从一个新线程中执行我们的异步任务的话，<code>futures::executor::block_on</code>第一次 poll 我们异步任务的 future，会进入到 <code>tokio::time::sleep</code>方法调用，这个方法会判断当前执行的异步 runtime （上下文信息），而这个上下文信息是保留在 thread local 中的，在新线程中并不存在这个 thread local，从而会 panic。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="n">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="n">thread</span><span class="w"> </span><span class="o">&#39;&lt;</span><span class="n">unnamed</span><span class="o">&gt;&#39;</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">&#39;</span><span class="na">there</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">reactor</span><span class="w"> </span><span class="n">running</span><span class="p">,</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Tokio</span><span class="w"> </span><span class="mf">1.</span><span class="n">x</span><span class="w"> </span><span class="n">runtime</span><span class="o">&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span></code></pre></div><h3 id="tokiomain和-tokiotest"><code>tokio::main</code>和 <code>tokio::test</code></h3>
<p>在分析完上面的原因之后，“为什么 <code>tokio::main</code>中不会 hang 住而 <code>tokio::test</code>会 hang 住”这个问题也很清楚了，他们两者所使用的的 runtime 并不一样。<code>tokio::main</code>使用的是多线程的 runtime，而 <code>tokio::test</code> 使用的是单线程的 runtime，而在单线程的 runtime 下，当前线程被 <code>futures::executor::block_on</code>卡死，那么用户提交的异步代码是一定没机会执行的，从而必然形成上面所说的死锁。</p>
<h2 id="best-practice">Best practice</h2>
<p>经过上面的分析，结合 Rust 基于 generator 的协作式异步特性，我们可以总结出 Rust 下桥接异步代码和同步代码的一些注意事项：</p>
<ul>
<li>在异步代码调用（可能阻塞的）同步代码时，请使用 <code>tokio::task::spawn_blocking</code> <a href="https://docs.rs/tokio/0.2.22/tokio/task/fn.spawn_blocking.html">[3]</a></li>
<li>尽量避免在异步代码中进行大规模的 CPU 密集型计算，避免对任务调度的公平性造成影响（CPU 密集型任务可以使用 <a href="https://docs.rs/rayon/latest/rayon/">rayon</a> 代替）</li>
<li>在同步代码调用异步代码的时候，使用 <code>futures::executor::block_on</code>请务必注意和 <code>tokio::task::spawn_blocking</code>（或者<code>std::thread::spawn</code>）配合使用，因为前者会阻塞当前线程。理想情况是，通过一个 blocking-dedicated executor 去调用 <code>futures::executor::block_on</code>，然后再通过 <code>tokio::runtime::spawn</code>把任务丢回给原来的 runtime 去执行。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="c1">// 如果你可以控制 generate 方法如何被调用
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="c1"></span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">    </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">            </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="c1">// 那么你可以在调用 generate 之前使用 spawn_blocking 避免死锁
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="c1"></span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">task</span>::<span class="n">spawn_blocking</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">        </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="c1">// 如果 generate 方法的调用方并不是你能控制的，那么请使用 std::thread::spawn
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="c1"></span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">    </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                    </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">                    </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="p">}).</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">	</span><span class="c1">// 这里只是一个普通的同步方法调用
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://ryhl.io/blog/async-what-is-blocking/">Async: What is blocking?</a></li>
<li><a href="https://cfsamson.github.io/books-futures-explained/4_generators_async_await.html">Generators and async/await</a></li>
<li><a href="https://news.ycombinator.com/item?id=17536441">Async and Await in Rust: a full proposal</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2603">calling futures::executor::block_on in block_in_place may hang</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2376">tokio@0.2.14 + futures::executor::block_on causes hang</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Notes on InfluxDB Storage Engine</title>
			<link>https://huanglei.rocks/posts/notes-on-influxdb-storage/</link>
			<pubDate>Sat, 12 Mar 2022 17:42:25 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/notes-on-influxdb-storage/</guid>
			<description>InfluxDB 的存储引擎经过多次修改，本文描述的系统结构基于 InfluxDB 截止 2022-02-24 的 adf29dfedfc785620db0e104652544ce9f67cb6e 版本。当前版本已经支持 TSI 索引结构。 InfluxDB 的存储系统 InfluxDB 的存储层有三个子系统： TSM：数</description>
			<content type="html"><![CDATA[<blockquote>
<p>InfluxDB 的存储引擎经过多次修改，本文描述的系统结构基于 InfluxDB 截止 2022-02-24 的 <code>adf29dfedfc785620db0e104652544ce9f67cb6e</code> 版本。当前版本已经支持 TSI 索引结构。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-overview.svg" alt="image.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
  InfluxDB 的存储系统 
</i>
</div>
<p>InfluxDB 的存储层有三个子系统：</p>
<ul>
<li>TSM：数据点的存储，可以高效地提供 SeriesKey 到时序数据值的插入和检索；</li>
<li>TSI：时序数据的倒排索引，提供查询某个 measurement 下某个 tag 包含特定值的 SeriesID 的接口；
<ul>
<li>TSI 是 InfluxDB 查询引擎的核心，所谓的基数膨胀带来的问题也是出现在这一层。</li>
<li>为了降低 TSI 的内存占用，InfluxDB 引入了一个额外的 SeriesID。</li>
</ul>
</li>
<li>Series 索引：提供根据 SeriesID 查找 SeriesKey 的接口等
<ul>
<li><code>SeriesFile.CreateSeriesListIfNotExists</code>：创建 <code>SeriesKey</code>-&gt;<code>SeriesID</code> 的映射</li>
<li><code>SeriesFile.SeriesKey</code>：根据 SeriesID 查找 SeriesKey</li>
</ul>
</li>
</ul>
<p>应该说 TSI 加上 SeriesIndex 才是 InfluxDB 完整的索引部分，但是这两者各自是一个类 LSMT 的数据结构，也有自己的 WAL、compaction/recover 策略等等，因此 InfluxDB 做了区分。</p>
<p>在 InfluxDB 查询数据时，首先根据用户的查询条件从 TSI 查找到符合条件的 SeriesID，然后从 SeriesIndex 查询对应的 SeriesKey，最后从 TSM 根据 SeriesKey 读取并合并所有的数据点。</p>
<blockquote>
<p>值得额外说明的是，InfluxDB 采用了 Roaring Bitmap 作为压缩的 map 用来存储 SeriesID 等数据；此外用 Robin Hood Hash 用作磁盘上的持久化的 hashtable 的 hash 算法，读取时的 locality 比较好。本文所述的 磁盘文件上的 hash index 都是采用的 RHH。</p>
</blockquote>
<h2 id="tsm">TSM</h2>
<p>TSM 是 InfluxDB 存储时间线数据点的引擎。可以理解为一个 <code> map&lt;SeriesKey, list&lt;DataPoint&gt;&gt;</code> 的数据库。为了提高时间点的写入吞吐，TSM 采用了类似于 LSMT 的数据结构。</p>
<p>InfluxDB 将每个时间段划分为一个 shard，每个 shard 对应底层的一个数据库文件，包括其自己的 WAL 和 TSM 文件。InfluxDB 文档中很多地方把这个 DB 的概念称为 RP（Retention Policy），本质上是因为 RP 决定了 DB 下面的 shard 如何过期清理，一个 DB 只会有一个 RP，因此 RP 实例就是 DB 实例。</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/tsm-overview.svg#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;height=588&amp;id=p6Hzv&amp;originHeight=2175&amp;originWidth=1997&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=&amp;width=540" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSM 文件总览 
</i>
</div>
<h2 id="tsi">TSI</h2>
<p>TSI 提供的能力是 tag 到 series key 的索引，如开头所说，为了降低 TSI 的内存占用，InfluxDB 额外引入了 SeriesID 的概念，这样一来就将 TSI 分为 tag-&gt;id 和 id-&gt;key 两部分，本文分别称为 Index 和 Series。只有两部分加起来才是完整的 InfluxDB 的时序索引。</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-overview.svg" alt="influxdb-tsi-overview"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSI 索引存储全景 
</i>
</div>
<h3 id="index-部分">Index 部分</h3>
<p>TSI 主要维护的是一个持久化的 <code>map&lt;TagName, map&lt;TagValue, list&lt;SeriesID&gt;&gt;&gt;</code> 数据结构，类似于一个 LSMT 的 KV 系统。</p>
<p>TSI 提供的接口主要是：</p>
<ul>
<li><code>Index.TagValueSeriesIDIterator</code>：根据 measurement、tag key、tag value 找到需要读取的 SeriesID</li>
<li><code>Index.CreateSeriesIfNotExists</code>：根据输入的 measurement、key 和 tag value 创建一个新的</li>
</ul>
<p>和其他的 LSMT 一样，TSI 也有一个 WAL、Memtable、SST。</p>
<ul>
<li>WAL：<code>LogFile</code> 的磁盘部分（.tsl 文件）</li>
<li>MemTable：<code>LogFile</code>的内存部分</li>
<li>SST：<code>IndexFile</code></li>
</ul>
<p>TSI 本身也是 Shard 维度的，这样当旧的 shard 过期之后里面的 索引也会自动删除。</p>
<h4 id="tsl-文件的格式">TSL 文件的格式</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsl-layout.svg" alt="image.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSL 文件的布局 
</i>
</div>
<p>TSL 文件是  LogFile 的磁盘表示，由一系列的 LogEntry 组成。当新的 SeriesKey 写入的时候，会在这个 TSL 文件的末尾 append 一个 log entry。每个 log entry 包括：</p>
<ul>
<li>flag：代表这个 entry 所执行的操作，可以是新增/删除 series、删除 measurement、删除 tag key、删除 tag value 之一</li>
<li>series id：series key 的 ID</li>
<li>name：series key 的 name</li>
<li>key：series key 的 tag key</li>
<li>value：series key 的 tag value</li>
<li>checksum：校验和</li>
<li>size：大小</li>
</ul>
<p>当 InfluxDB 实例重启的时候，会通过重放这个 TSL 文件获得一份最新的 series key 数据。</p>
<h4 id="tsi-文件的格式">TSI 文件的格式</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-layout.svg" alt="influxdb-tsi-layout"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSI 文件布局 
</i>
</div>
<p>TSI 文件分为三部分，分别是文件尾部的 tailer、measurement block 和 tag block 组成。</p>
<ul>
<li>通过读取 trailer 的数据，可以找到 measurement 对应 的 measurement block 的 offset</li>
<li>通过 measurement block 中的 tag offset 可以找到 tag 对应的 tag block 。除此之外，measurement block 还记录了 measurement  的 cardinality 、SeriesID Set（bitmap）等信息。</li>
<li>tag block 本质上是一个持久化的 hashmap</li>
</ul>
<h5 id="indexfiletailer">IndexFileTailer</h5>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-index-trailer.svg" alt="influxdb-tsi-index-trailer.svg"></p>
<h5 id="measurementblocks">MeasurementBlocks</h5>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-measurement-block.svg" alt="influxdb-tsi-measurement-block.svg"></p>
<p>MeasurementBlocks 有一系列的 MeasurementBlock、一个 HashIndex 和一个 MeasurementBlockTrailer 组成：</p>
<ul>
<li>MeasurementBlock 保存的是 measurement 的数据</li>
<li>HashIndex 保存的是每一个 MeasurementBlock 在文件的偏移量</li>
<li>MeasurementBlockTrailer 记录了在 MeasurementBlock 数据区的起始 offset 和 size、HashIndex 的起始 offset 和 size 以及 sketch、tsketch 的起始 offset 和 size 信息。</li>
</ul>
<h5 id="tagblocks">TagBlocks</h5>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-tag-block.svg" alt="influxdb-tsi-tag-block"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
Tag block 存储格式
</i>
</div>
<p>TagBlocks 保存的是某个 tag key 下面的所有 tag value 以及这个 tag value 对应的 series id 列表。TagBlock 通过一个多级的 map 去维护了这样的双重映射关系。</p>
<ul>
<li>首先在 TagBlockTrailer 这个尾部的数据结构维护了 tag value section、tag key section、tag key array map 的地址；</li>
<li>通过 trailer 的 hash index offset 可以找到 tag key block 的 hash index （下图中的 1）；</li>
<li>遍历 hash index 可以找到所需要某个 tag key 的 tag key block entry （下图中的 2）；</li>
<li>通过 tag key block entry 的 tag hash index offset 可以找到 这个 key 对应的 tag value 的 hash index 部分的地址 （下图中的 3）；</li>
<li>遍历这个 tag value block 的 tag value hash index 可以找到符合条件的 tag value entry 的地址，从而读取到这个 tag value 的数据，包括 series id 等（下图中的 4）。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-search.svg" alt="influxdb-tsi-tag-lookup.png"></p>
<h4 id="根据-tag-key-和-tag-value-查找">根据 Tag key 和 Tag value 查找</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">Index.TagValueSeriesIDIterator 						@tsdb/index/tsi1/index.go:999
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="k">\-</span>-- Partition.TagValueSeriesIDIterator 	@tsdb/index/tsi1/index.go:1010
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">    <span class="k">\-</span>-- IndexFile.TagValueSeriesIDSet 		@tsdb/index/tsi1/partition.go:805
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">        <span class="k">\-</span>-- TagBlock.DecodeTagValueElem	@tsdb/index/tsi1/index<span class="nb">_</span>file.go:335
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">              <span class="nb">^</span>~ 这里的 tagblocks 在启动的时候就会从磁盘上的 IndexFile 读取到IndexFile.tblks 中来，
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl">                  而 IndexFile 之外的变更保留在 LogFile 的内存索引中
</span></span></code></pre></div><h4 id="index-compaction">Index Compaction</h4>
<p>TSI 索引的 compaction 有两类：</p>
<ul>
<li>LogFile -&gt; IndexFile: <code>LogFile.Compact</code>，即 level 0 到 level 1 的 compaction，把 TSL 文件压缩成 TSI 文件</li>
<li>IndexFile leveled compaction: <code>IndexFiles.Compact</code>，即 level n 到 level n+1 的 compaction</li>
</ul>
<h3 id="series-索引">Series 索引</h3>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-index-overview.svg" alt="influxdb-series-index-overview.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Series 索引全景图 
</i>
</div>
<p>Series 索引主要负责 SeriesKey 到 SeriesID 和 SeriesID 到 SeriesOffset 的映射，可以理解为一个持久化的 <code>map&lt;SeriesID, SeriesKey&gt;</code>。Series 索引也是 database 维度的。Series 索引分为三个部分：</p>
<ul>
<li>&ldquo;WAL&rdquo;：SeriesSegment</li>
<li>&ldquo;MemTable&rdquo;：SeriesIndex 的内存部分</li>
<li>&ldquo;SST&rdquo;：SeriesIndex 持久化到磁盘的部分（在启动的时候会通过 mmap 载入）</li>
</ul>
<p>理解 Series 索引的核心在于理解 SeriesIndex 和 SeriesSegment 的交互。</p>
<p>SeriesIndex 相当于是 Memtable，SeriesSegment 相当于是 WAL。SeriesSegment 里面保存的都是具体针对 series 的操作（operation），只要在 recover 的时候把 SeriesSegment 里面的数据重放一遍就可以了（见<code>SeriesIndex.Recover</code>）。<strong>为了减小 SeriesIndex 的内存占用，InfluxDB 做了 KV 分离</strong>，真实的 value（即Series Key） 都是保存在 “WAL”（SeriesSegment） 中的，“memtable”（即 SeriesIndex） 中的 value 只是指向  SeriesSegment 当中一个地址的 offset。</p>
<p>和其他 LSMT 类似，SeriesIndex 也需要做 compact，compact 的逻辑就是 遍历 SeriesPartition 下面的所有的 segment 里面的所有 entry，把存活的 series 写到 series index 文件中。具体的 compact 逻辑是在<code>SeriesPartitionCompactor.compactIndexTo</code>中，为了实现 series 的删除，也在 compact 的时候判断是 series 是否已经被标记为 deleted。</p>
<blockquote>
<p>为什么需要 SeriesID？如果直接在内存里面维护 SeriesKey 到 Series 的映射，则内存里面会多很多的 tag key 和 tag value 拼接而成的数据，而且这个数据会有大量的冗余。SeriesID 相当于合并了这部分冗余的数据。</p>
</blockquote>
<h4 id="seriesindex">SeriesIndex</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-index-file-layout.svg" alt="influxdb-series-index-file-layout.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
SeriesIndex 的数据组成
</i>
</div>
<p>SeriesIndex 分为两部分，一部分是保存在内存上的：<code>SeriesIndex.keyIDMap</code>/<code>SeriesIndex.idOffsetMap</code>/<code>SeriesIndex.tombstones</code>，另一部分是保存在磁盘上的：<code>SeriesIndex.keyIDData</code> /<code>SeriesIndex.idOffsetData</code>。</p>
<p>SeriesIndex 磁盘文件里面的 series 数据可以理解为基线数据。在启动的时候，InfluxDB 会把磁盘上面的 Series Index 文件里面的内容加在到 <code>SeriesIndex.keyIdData</code>和 <code>SeriesIndex.idOffsetData</code>中（通过 mmap 的方式），这块文件里面的内容实际上就是一个持久化的 HashMap。InfluxDB 会定期地把 内存的数据（<code>SeriesIndex.keyIDMap</code>和 <code>SeriesIndex.idOffsetMap</code>等）和磁盘的基线数据合并形成一个新的基线数据。</p>
<h4 id="seriessegment">SeriesSegment</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-segment-file-layout.svg" alt="influxdb-series-segment-file-layout.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 SeriesSegment 的二进制格式 
</i>
</div>
<p>SeriesSegment 就是一组磁盘上的文件，由一个 header 和椅子列的 SeriesEntry 组成，每个 Entry 可能是一个 insert entry（代表 SeriesKey 的插入）或者 tombstone entry （代表 series key 的删除）。在启动的时候会通过 mmap 的方式把 segments 加载进来，每次创建新的 Series Key 的时候也会向这个 mmap 的文件的末尾去 append 一个新的 series entry。</p>
<p>如上介绍，SeriesIndex 内部维护的并不是 SeriesID 到 SeriesKey 的映射，真正的 SeriesKey 是保存在 WAL 即 SeriesSegment 上面的，因此 SeriesIndex 额外引入了一个 offset 去表明 SeriesKey 在 SeriesSegment 上的 地址。</p>
<h4 id="seriesoffset">SeriesOffset</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-offset.svg" alt="influxdb-series-offset.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 SeriesOffset 格式
</i>
</div>
<p>SeriesOffset 指向的是一个 series entry 在 series segments 中的地址，是一个 64 位值，由两部分组成，高 32 位（实际上只会有 16 位使用，足够寻址 2^16 个 segment)是 segment id ，低 32 位是 series entry 在此 id 的 series segment 中的偏移量。因此通过 SeriesOffset 可以唯一地找到 segment 以及其中 entry 的位置。</p>
<blockquote>
<p>Series Offset 的拼接和拆分见<code>JoinSeriesOffset</code>和 <code>SplitSeriesOffset</code>两个函数</p>
</blockquote>
<h4 id="查找路径">查找路径</h4>
<ul>
<li>根据 SeriesKey 查找 SeriesID：首先在内存的<code>SeriesIndex.keyIDMap</code>查找，如果没有则<strong>遍历</strong> SeriesSegment 下面的所有 SeriesEntry，找到 Key 匹配的 ID 返回</li>
<li>根据 SeriesID 查找 SeriesKey：<code>SeriesPartition.SeriesKey</code>。首先根据 series id 找到 series offset，然后根据 series offset 找到 series key。
<ul>
<li>根据 id 找到 offset 首先也是从 内存的 <code>SeriesIndex.idOffsetMap</code>读取，如果没有就去 SeriesIndex 的磁盘部分读取（遍历 <code>SeriesIndex.idOffsetData</code>查找）</li>
<li>根据 offset 找到 key：把 offset 分割为 SegmentID 和 pos 两部分，从 Segment ID 可以找到 磁盘上的 SeriesSegment 文件，接着这个 SeriesSegment 的 pos 位置的数据（Uvarint+string）就是对应的 series key。</li>
</ul>
</li>
</ul>
<h3 id="high-cardinality-问题是如何出现的">High Cardinality 问题是如何出现的</h3>
<p>InfluxDB 最为人诟病的问题就是所谓的 high cardinality 问题，即当 InfluxDB 实例写入大量的不同 tag value 的时候，时间线数量会大幅膨胀。</p>
<p>考虑某个 measurement 有三个 tag: HostName, AZ, Region，分别代表一个服务器的机器名、可用区和 region。其中 HostName 可能出现 100 个值，AZ 可能 出现 20 个值，Region 可能出现 10 个值，那么这个 measurement 可能出现的总时间线数量（即所谓的 cardinality）为 $100 \times 20 \times 10=20000$，即所有 tag 值空间大小的笛卡尔积。</p>
<p>当时序数据的 cardinality 增长的时候，InfluxDB 内部的倒排索引会大幅膨胀。InfluxDB 历史上为了解决倒排索引膨胀的问题采取了多种策略，比如通过 SeriesID 降低倒排索引的大小，将<a href="https://github.com/influxdata/influxdb/issues/7151">纯内存存储的倒排索引优化为内存+磁盘的索引</a>（即本文的 TSI 引擎）等等。但是这些手段都是延缓倒排出现性能瓶颈的时间。除此之外，Series Index 部分（即 SeriesID 到 SeriesKey 的正排索引）在大量时间线的情况下也会出现性能瓶颈。比如 Series 索引在做 compaction 的时候（<code>SeriesPartitionCompactor.Compact</code>）一方面会遍历 SeriesSegment 文件中的所有 entry 去 apply 到内存的 hashmap，再把内存中的数据写入到磁盘上的 SeriesIndex 文件中。假设 Series 数量很大，那么这个 compact 过程很有可能出现 OOM。</p>
<p>目前可以想到的一个简单的缓解办法是现在 RP 维度的 Series 索引变成 RP 下面的 Shard 维度的，当 Shard 过期之后会自动把相应的 Series 索引过期。</p>
]]></content>
		</item>
		
		<item>
			<title>Apache Parquet 格式简介</title>
			<link>https://huanglei.rocks/posts/parquet/</link>
			<pubDate>Sat, 05 Mar 2022 15:44:33 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/parquet/</guid>
			<description>简介 Parquet 是一种面向列的数据存储格式，在 Hadoop 生态中使用广泛。Parquet 文件是不可变的，如果需要修改，只能通过 rewrite 的方式实现。 数据 layout 一个 Parquet 文件的数</description>
			<content type="html"><![CDATA[<h2 id="简介">简介</h2>
<p>Parquet 是一种面向列的数据存储格式，在 Hadoop 生态中使用广泛。Parquet 文件是不可变的，如果需要修改，只能通过 rewrite 的方式实现。</p>
<h2 id="数据-layout">数据 layout</h2>
<p>一个 Parquet 文件的数据布局如下图所示。需要注意的是，官网上的这个图并没有包含 index pages。</p>
<p><img src="https://raw.githubusercontent.com/apache/parquet-format/master/doc/images/FileLayout.gif#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=gFbsV&amp;originHeight=478&amp;originWidth=601&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 官方的格式图  
</i>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-original.svg" alt="parquet-original.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 原始行格式的数据  
</i>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-travel.svg" alt="parquet-travel.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Parquet 数据的遍历顺序 
</i>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-layout.svg" alt="parquet-layout.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 使用 Parquet 转换之后的格式 
</i>
</div>
<p>在 Parquet 中，数据每隔若干行被分作一个 row group；在同一个 row group 中，不同 row 的相同列被连续存储在一起。连续的列再间隔若干行会被分割为一个页（page）。</p>
<h2 id="元数据">元数据</h2>
<p><img src="https://cdn.jsdelivr.net/gh/apache/parquet-format/doc/images/FileLayout.gif" alt="image.png"></p>
<p>从如上的 Parquet 格式可以看出来，一个 Parquet 文件是包含了一些元数据的，比如 footer、page header 等等，这些元数据可以在读取 parquet 文件的时候提供相关信息来加速遍历。</p>
<h3 id="footer">Footer</h3>
<p>Footer 是整个 Parquet 文件的元数据，从 footer 可以得到文件的版本、数据 schema、row group 的元数据、row group 中的每一列的元数据等等。</p>
<p>Footer 位于 Parquet 的末尾，因此可以从文件结尾 seek 到倒数第 8 到倒数第 4 字节，作为 footer 的长度，从而得到 footer 区的起始 offset。</p>
<p>Footer 区数据遵循特定的编码格式（ThriftCompactProtocol），因此可以方便地反序列化。</p>
<p>Footer 区还包含了 row group 和 row group 中的列的信息。</p>
<h3 id="列的元数据">列的元数据</h3>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/20220305160426.png" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
  列的元数据位置  
</i>
</div>
<p>在 footer 中，每一列的信息也被记录，包括：</p>
<ul>
<li>列的类型、编码；</li>
<li>列值的数量；</li>
<li>第一个数据页的 offset；</li>
<li>第一个索引页的 offset；</li>
<li>压测/解压缩的大小；</li>
<li>以及一些额外的键值对。</li>
</ul>
<p>根据 footer 中的这些列的信息就可以快速找到 Parquet 文件中的数据地址和索引地址、以及如何解析这些数据。</p>
<h3 id="文件内索列">文件内索列</h3>
<p><a href="https://issues.apache.org/jira/browse/PARQUET-1201">Parquet 2.5 版本</a>支持了列值索引功能，具体的功能介绍可以参考 <a href="https://github.com/apache/parquet-format/blob/master/PageIndex.md">ColumnIndex Layout to Support Page Skipping</a>.</p>
<p>在之前的版本中，统计数据（min、max）只在 column 的 metadata 和 page header 当中，当读取 page 的时候，可以根据 page header 中的统计数据决定是否需要跳过这一页，但这样还是需要遍历文件中的每一页。</p>
<p>目标：通过 minmax 可以直接定位到 page 的方式提高范围查询和点查的 IO 效率。具体来说针对 row group 排序列的单行查询，每一列只需要读取一页数据。排序列的范围查询只读取范围所涉及的数据页；如果其他的查询具有高选择性，即使查询条件不是排序列，也要能够按需读取数据页。</p>
<p>为了实现这样的目标，Parquet 在 row group 的元数据上增加了如下两个针对列的数据结构（即在一个 row group 中的每一个列都有下面的两个索引来描述它们）：</p>
<ul>
<li>ColumnIndex：针对 scan predicate，支持通过列值找到列的数据所在的页；</li>
<li>OffsetIndex：通过 ColumnIndex 找到 match 的 row 之后，OffsetIndex 支持按 row index 去获取相应的值。一个 row group 的所有 column 的 OffsetIndex 都是存储在一起的。</li>
</ul>
<p>索引的地址在 footer 区之前的地方，footer 里面有一个字段指明了其 offset。</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-file-format.svg" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Index page 的位置 
</i>
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="sd">/// Description for ColumnIndex.
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="sd">/// Each &lt;array-field&gt;[i] refers to the page at OffsetIndex.page_locations[i]
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="sd"></span><span class="cp">#[derive(Clone, Debug, Eq, Hash, Ord, PartialEq, PartialOrd)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ColumnIndex</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">  </span><span class="sd">/// A list of Boolean values to determine the validity of the corresponding
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// min and max values. If true, a page contains only null values, and writers
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// have to set the corresponding entries in min_values and max_values to
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// byte[0], so that all lists have the same length. If false, the
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// corresponding entries in min_values and max_values must be valid.
</span></span></span><span class="line hl"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">null_pages</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">  </span><span class="sd">/// Two lists containing lower and upper bounds for the values of each page.
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// These may be the actual minimum and maximum values found on a page, but
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// can also be (more compact) values that do not exist on a page. For
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// example, instead of storing &#34;&#34;Blart Versenwald III&#34;, a writer may set
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// min_values[i]=&#34;B&#34;, max_values[i]=&#34;C&#34;. Such more compact values must still
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// be valid values within the column&#39;s logical type. Readers must make sure
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// that list entries are populated before using them by inspecting null_pages.
</span></span></span><span class="line hl"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">min_values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line hl"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">max_values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">  </span><span class="sd">/// Stores whether both min_values and max_values are orderd and if so, in
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// which direction. This allows readers to perform binary searches in both
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// lists. Readers cannot assume that max_values[i] &lt;= min_values[i+1], even
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// if the lists are ordered.
</span></span></span><span class="line hl"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">boundary_order</span>: <span class="nc">BoundaryOrder</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">  </span><span class="sd">/// A list containing the number of null values for each page *
</span></span></span><span class="line hl"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">null_counts</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Clone, Debug, Eq, Hash, Ord, PartialEq, PartialOrd)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">OffsetIndex</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl"><span class="w">  </span><span class="sd">/// PageLocations, ordered by increasing PageLocation.offset. It is required
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// that page_locations[i].first_row_index &lt; page_locations[i+1].first_row_index.
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">page_locations</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PageLocation</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a class="lnlinks" href="#code-sec-35">35</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="parquet-的优势">Parquet 的优势</h2>
<ul>
<li>按需读取列的值，比如在 OLAP 场景下，大宽表往往最终只有少量的列会被读取到；</li>
<li>自描述，自带 schema，支持数据结构嵌套；</li>
<li>由于列保存在一起，因此可以提高压缩和编码的效率（比如 RLE、字典压、Bit Packing 等等）;</li>
<li>文件自带索引，支持快速检索 data page。</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Apache BookKeeper 笔记</title>
			<link>https://huanglei.rocks/posts/bookkeeper-note/</link>
			<pubDate>Thu, 24 Feb 2022 01:18:35 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/bookkeeper-note/</guid>
			<description>BookKeeper 的使用场景 WAL：比如 HDFS Namenode 的 EditLog（要求高可靠） 分布式存储：比如 Pulsar 的消息存储、DistributedLog 等 核心理念 通过条带化写（</description>
			<content type="html"><![CDATA[<h1 id="bookkeeper-的使用场景">BookKeeper 的使用场景</h1>
<ul>
<li>WAL：比如 HDFS Namenode 的 EditLog（要求高可靠）</li>
<li>分布式存储：比如 Pulsar 的消息存储、DistributedLog 等</li>
</ul>
<h1 id="核心理念">核心理念</h1>
<ul>
<li>通过条带化写（Data Striping）实现数据的多副本，所有存储节点角色对等；</li>
<li>通过其他的存储组件（ZooKeeper）实现元数据高可靠，故障恢复（recover）流程强依赖 ZK 的元数据；
<ul>
<li>也可以选用其他的存储服务，要求 1. CP 系统；2. 提供 CAS 原语</li>
</ul>
</li>
<li>基于 RocksDB 提供 <code>(ledger, sequence) -&gt; (file, physicalOffset)</code>  的索引（<code>SingleDirectoryDbLedgerStorage#ledgerIndex</code>）；</li>
<li>同一时刻只有一个 writer 和多个 reader，通过 fencing 机制避免出现多 writer，避免 sequence 乱序；</li>
<li>读写分离，冷热分离（tailing read/catch-up read）提高吞吐；</li>
</ul>
<h1 id="bookkeeper-的术语">BookKeeper 的术语</h1>
<ul>
<li>ledger：一写多读的 append-only 文件，ledger 的最小数据单元是 fragment；</li>
<li>bookie：存储 ledger 的节点；</li>
<li>ledger has many records， called：entry，每个entry都有一个 sequence number，可以根据 ledger + seq 来读取一部分 entry。</li>
<li>quorum：几个 bookie 组成一个 quorum，通过复制提高可用性。</li>
<li>data striping：数据块交织写入到各个设备，提高写入的性能。类似 RAID1 的机制。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/bookkeeper-quorum-writes.svg" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 BookKeeper 的 quorum write 机制 
</i>
</div>
<p>Striping 很容易就会导致读取者所看到的 log 不一致，因此 BK 引入了 ZK 去保存元数据，并且通过 triming 机制（BK 称为 reader-initiated ledger recovery）来确保末尾未完整写完整个 quorum 的数据能够被安全删除并且对 reader 不可见。</p>
<h1 id="实现细节">实现细节</h1>
<h2 id="bookie-的结构">Bookie 的结构</h2>
<p>Bookie 是存储节点，具体包含两个模块：</p>
<ul>
<li>journal：WAL，同步写，负责保存 writer 的写入操作；</li>
<li>ledger：包含内存的状态（memtable）、ledger 的索引等，异步写。</li>
</ul>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/20220224231150.png" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 BookKeeper 的读写路径 
</i>
</div>
<p>理想状况下，journal 和 ledger 应该位于不同的磁盘上，减少他们同时不可用的概率。</p>
<h2 id="bookkeeper-提供的-api">BookKeeper 提供的 API</h2>
<ul>
<li>创建 ledger</li>
<li>向 ledger 新增 entry</li>
<li>打开一个 ledger</li>
<li>从ledger 读取 entry</li>
<li>关闭 ledger 避免后续数据写入</li>
<li>删除一个ledger</li>
</ul>
<h2 id="ledger-操作">Ledger 操作</h2>
<h3 id="ledger-创建">Ledger 创建</h3>
<p>一个 ledger 需要由一个 ensemble 来负责，因此创建 ledger 的时候必须指定 ledger 的 quorum 和 ensemble。具备 f+1 个节点的 quorum 可以容忍 f 个节点宕机。</p>
<ul>
<li>quorum：写入节点集合。更大的quorum 提供更强的可用性。</li>
<li>ensemble：striping 所需要的节点总数。更大的 ensemble 提供更大的吞吐。</li>
</ul>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/paper-creating-using-ledger.png?versionId=CAEQIBiBgMDlsZax.RciIGJmZGJjYjRjODNiZjQ4ZDE4OWZkMjVlZWRhNmEzMGJh" alt="paper-creating-using-ledger.png"></p>
<ul>
<li>quorum 是以 round-robin 的形式分散在整个 ensemble 中。</li>
<li>quorum 和 ensemble 这些元数据保存在 zookeeper 中。</li>
</ul>
<blockquote>
<p>这里有个问题，当bk客户端尝试读取 entry 的时候，需要确定从哪些bookie组成的quorum 读取，那这个quorum是怎么确定的？</p>
</blockquote>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/paper-to-read-a-given-entry-e.png?versionId=CAEQIBiBgICTgJmx.RciIGNmMjU4OWFmYTE0YjQ4NzFiNjY0MTM4NzRjZjNjZTJi" alt="image.png"></p>
<h3 id="ledger-关闭">Ledger 关闭</h3>
<p>Ledger 关闭是一个原子的操作，会在 ZK 中记录 ledger 最后一个 entry 的 seq。这里ZK 提供的一致性协议非常重要，否则 Bookkeper 的客户端可能会观察到 ledger 的 不一致。
<img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/1635067390415-cdc4ede3-9bd7-4bd3-82e7-f3c3091be3d1.png" alt="paper-closing-a-ledger">
当 BK 的客户端没有 close 一个ledger 就 crash 怎么办？因此需要一个额外的机制来保证所有 open 的ledger 都能够最终被 close。</p>
<h3 id="ledger-的恢复">Ledger 的恢复</h3>
<p>Ledger 的写入者可能在没关闭 ledger 的时候就 crash 了，这种情况下 entry 的元数据尚未更新到 zk中， ledger 的读取者无法安全地确认 ledger中的最后的 entry 是什么，因此 ledger 需要 恢复操作（recovery）。</p>
<p>当 reader 打开一个 ledger 读取的时候，从 ZK 中获取元数据，同时如果发现这个 ledger 尚未被 close，就触发一个 recovery 流程。</p>
<p>Recovery：确定按所要求的 quorum 写入成功的最后一个 entry，写入到 ZK 中。</p>
<blockquote>
<p>如何确认最后一个 entry？可以简单地从 ledger 一次读取所有的entry，重新写入一遍。
为了加速，reader 向 ensemble 中所有的 bookie 询问 此ledger 写入的最新的 entry 的LAC字段（Last Add Confirmed）。然后恢复流程就可以从最高的 LAC 位置开始，而无需读取整个 ledger。</p>
</blockquote>
<h3 id="lac">LAC</h3>
<p>LAC：Last add confirmed，获取一个 quorum 中最后一个被确认写入的 entry 的 id
对于 单个 bookie 而言，所谓的LAC就是当前 ledger 最后一个写入的 entry 的 entry id。而对于客户端而言，获取quorum 的LAC就是获取整个 quorum 中最大的LAC。</p>
<p><strong>这里比较容易混淆：LAC 应该是维护在 writer 本地的，只是每次写入到 bookie 的时候把它放在 entry 的某个字段中。Quorum 中所有 bookie 的最后一个 entry 的 LAC 最大值，所反映的一定是这个 writer 的 LAC 的最大值，这样一来 LAC 的作用就好理解了，相当于是把 writer 的写入确认水位状态随着 entry 写入到了每一个 bookie中。</strong></p>
<blockquote>
<p><strong>这块的介绍可以看 <strong><a href="https://bookkeeper.apache.org/distributedlog/docs/latest/user_guide/design/main.html"><strong>DistributedLog</strong></a></strong>。</strong></p>
</blockquote>
<h1 id="fencing">Fencing</h1>
<p>LAC 只能保证 reader 之间读取的一致性，但是不能避免出现多个 writer。</p>
<p>bookie 检测到某个 ledger 出于 recovery 流程中时，拒绝掉所有这个ledger 写入的请求。</p>
<h3 id="从一个-open-状态的-ledger-读取数据">从一个 open 状态的 ledger 读取数据</h3>
<p>前述都是基于 reader 只能读取 closed 的 ledger 的前提。但是 reader完全有可能需要读取 open 的ledger（废话。。。），因此 BK 提供了绕过了 recovery 流程的读取API。在这个API 中，为了防止 reader 读取到 transient entry（只在 quorum 中复制了一部分，关闭 ledger 后可能会被 trim 掉的 entry），reader会向bookie 查询 ledger 的 LAC，读取 LAC 以前的 entry 是安全的，因为他们都已经被完整地复制了。</p>
<p>Ledger device：第一版不同的 ledger 有不同的文件，后来改为一个（类似RocketMQ的CommitLog），成为entry log。原因是多个文件的随机写入带来的磁盘寻道、Page cache 的竞争大大降低了写入吞吐。不同 ledger 的 entry 都存储在一个 entry log 中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/bookkeeper-journal-to-ledger-index.svg" alt="bookkeeper-journal-to-ledger-index.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Journal to Ledger Log 
</i>
</div>
<p>对于每个ledger，bookie 在 ledger device 上还维护了一个索引，并且把这个索引 映射 到内存，降低索引构建导致的 IO 开销。</p>
<p>Ledger 的设计主要针对写为主的流量。读的场景下，如果命中了内存中的ledger index，那么只需要一次磁盘 IO，否则需要先从 Ledger index文件找到 entry 所在 entry log 中的位置，然后再去 entry log 中读取entry内容。</p>
<h2 id="源码分析">源码分析</h2>
<h3 id="entry-的写入">Entry 的写入</h3>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/entry-write-diagram.png" alt="entry-write-diagram.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Entry 写入的流程 
</i>
</div>
<h3 id="entry-的读取">Entry 的读取</h3>
<p>还是根据 write set 找到负责 entry 的 bookie 列表，然后向这些 bookie 发送读取请求。</p>
<p>Entry 读取的时候可能存在一种特殊情况：读取的 entry 范围一jnkmlxc部分落在一个 ensemble，一部分落在另一个 ensemble，比如下面图中的情况。</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/bookkeeper-read-ensemble-change.svg" alt="bookkeeper-read-ensemble-change"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 尝试读取散落在不同 ensemble 的 entry 
</i>
</div>
<p>为了处理读取散落在不同 ensemble 的 entry 的情况，BookKeeper 每次读取 entry 前都会判断所读取的 entry id 是否出现 ensemble change。</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/Bookkeeper.drawio.svg?" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Entry 读取的主流程代码 
</i>
</div>
<p>为了避免部分慢节点导致延迟升高，提升读取的性能，BookKeeper 客户端还采用了 speculative read（推测读取）的方式，如果当前读取的 bookie 没有在特定时间内返回数据，那么客户端会立刻尝试向另一个 bookie 发送读取请求，并同时等待两个 bookie 的响应。具体可见 <a href="https://bookkeeper.apache.org/docs/4.5.0/api/javadoc/org/apache/bookkeeper/client/DefaultSpeculativeRequestExecutionPolicy.html">DefaultSpeculativeRequestExecutionPolicy</a>.</p>
]]></content>
		</item>
		
		<item>
			<title>LSM Tree 笔记</title>
			<link>https://huanglei.rocks/posts/note-on-lsmt/</link>
			<pubDate>Thu, 10 Feb 2022 22:34:39 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/note-on-lsmt/</guid>
			<description>写入（Write path） 先从磁盘（HDD）写入的特性引入 append-only 的 WAL。 对于 KV 结构，如果写入是 append only的，那么就需要合并，不然读取性能太差。</description>
			<content type="html"><![CDATA[<h2 id="写入write-path">写入（Write path）</h2>
<ul>
<li>
<p>先从磁盘（HDD）写入的特性引入 append-only 的 WAL。</p>
</li>
<li>
<p>对于 KV 结构，如果写入是 append only的，那么就需要合并，不然读取性能太差。</p>
</li>
<li>
<p>单文件合并性能差，因此需要按阈值切分为多个小文件，通过归并排序的思路优化合并的效率。</p>
</li>
<li>
<p>多路归并要求每个文件有序，为了保证每个文件有序，就需要，数据写入的时候，不直接把 operation 直接写入到磁盘，而是先在内存缓存一段时间，并且在内存排好序，然后再一次把整个文件 flush 到磁盘。</p>
<ul>
<li>内存有序的数据结构：跳表、红黑树、B+ 树</li>
<li>buffer 在内存的数据丢了怎么办？先写 redo log</li>
</ul>
</li>
</ul>
<h2 id="有序数据结构">有序数据结构</h2>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/V8oKiYS5z/1639280343.png" alt=""></p>
<blockquote>
<p><a href="https://github.com/facebook/rocksdb/wiki/MemTable">RocksDB 的数据结构比较</a>：选择跳表的原因是跳表支持并发插入。</p>
</blockquote>
<p>LSMT 的数据分类</p>
<ul>
<li>内存数据：MemTable</li>
<li>磁盘数据：SSTable（Sorted Sequence Table）</li>
<li>日志：redo log</li>
</ul>
<h2 id="内存数据组织">内存数据组织</h2>
<p>内存的数据需要保证有序，同时支持高性能的插入和查找。</p>
<ul>
<li>ART：自适应基树（比如 Bitcask 采用）；</li>
<li>SkipList：LevelDB、RocksDB 等。</li>
</ul>
<h2 id="sstable-文件格式">SSTable 文件格式</h2>
<p>按 Block 进行存储，可以参考 LevelDB 和 RocksDB 的 SST 文件的格式。</p>
<h2 id="compaction">Compaction</h2>
<ul>
<li>Leveling compaction
<ul>
<li>当某个 level 出现一个新的 sorted run 的时候触发；</li>
<li>每一级的文件只会组成一个 sorted run，也就是说不同文件的 key range 不会重叠；</li>
<li>写放大较大，但查询性能好，适合写少读多的 workload。</li>
</ul>
</li>
<li>Tiering compaction
<ul>
<li>当某个 level 的 size 达到阈值时触发；</li>
<li>每一级可能存在多个 sorted run；</li>
<li>读放大和空间放大小，但 compaction 开销大，适合读多写少的 workload。</li>
</ul>
</li>
</ul>
<blockquote>
<p>对于 tiering 和 leveling 的比较，我们可以考虑一种极限情况：只有一个 level。此时 tiering 变成一个 append only 的 log，每次产生一个新的 SST 只会 append 到 SST file queue 末尾，这种情况下写性能较高因为 flush 不涉及到已有的 SST，而读取性能则较差，因为有可能需要遍历所有的 SST。而 leveling 要求一层内只有一个 sorted run，因此会变成一个 sorted array，每次 flush 都会导致现有的 SST 被完整重写以排序，因此写放大较大而读性能好。</p>
</blockquote>
<ul>
<li>事实上工业级的 LSMT 往往会采用混合策略，比如 <a href="https://github.com/facebook/rocksdb/blob/9502856edd77260bf8a12a66f2a232078ddb2d60/db/compaction/compaction_picker_level.cc#L483-L484">RocksDB 在 Level 0 使用 tiering compaction</a> 以提高写性能而在其他 level 使用 leveling compaction 以提高查询性能。</li>
</ul>
<h2 id="读取read-path">读取（Read path）</h2>
<p>核心原则：先热后冷读取最新的数据，一旦读取到就停止。</p>
<ul>
<li>优先读取 MemTable，然后读取 SSTable</li>
</ul>
<h3 id="读取的优化">读取的优化</h3>
<ul>
<li>通过 BloomFilter 优化不存在的数据的判断</li>
<li>SSTable 分区</li>
<li>压缩</li>
</ul>
<h2 id="lsmt-的问题">LSMT 的问题</h2>
<h3 id="读放大">读放大</h3>
<p>一次 key 的读取需要由新到旧依次读取，涉及到不止一次IO，在范围查询的时候尤其明显。</p>
<h3 id="写放大">写放大</h3>
<p>后台合并（compaction）导致一个文件可能需要被写入多次。</p>
<h3 id="空间放大">空间放大</h3>
<p>Append-only 导致过期数据一致存在，直到被清理</p>
<h2 id="总结">总结</h2>
<ul>
<li>写放大：尽管 LSM Tree 通过顺序 IO 提供了更大的写入吞吐，但是写入放大的问题会争抢正常写入的磁盘带宽，从而降低性能和磁盘的使用寿命。</li>
<li>合并：后台的合并操作导致 write stall</li>
<li>新硬件：Remote compaction，Compaction offloading，AEP</li>
</ul>
<p>索引存储</p>
<ul>
<li>索引不存储
<ul>
<li>buntdb：每次重启重建</li>
</ul>
</li>
<li>索引存储
<ul>
<li>分离存储
<ul>
<li>Bitcask</li>
<li>MySQL MyISAM</li>
</ul>
</li>
<li>一起存储
<ul>
<li>BoltDB</li>
<li>MySQL Innodb</li>
<li>LevelDB (SStable)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="https://dl.acm.org/doi/abs/10.1145/3183713.3196927">Dostoevsky: Better Space-Time Trade-Offs for LSM-Tree Based Key-Value Stores via Adaptive Removal of Superfluous Merging</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/141186118">深入探讨LSM Compaction机制</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>使用 GitHub Issue 作为 Hugo 的评论系统</title>
			<link>https://huanglei.rocks/posts/hugo-comment-with-github-issues/</link>
			<pubDate>Thu, 10 Feb 2022 15:07:10 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/hugo-comment-with-github-issues/</guid>
			<description>安装 Octomments 按照 Octomments 的介绍，将 Octomments 安装到您的 GitHub 账户，确保它拥有访问您的目标 repo 的 issue 的权限。 配置 GitHub issue 在配置文件中增加配置项： comment.owner：I</description>
			<content type="html"><![CDATA[<h1 id="安装-octomments">安装 Octomments</h1>
<p>按照 <a href="https://ocs.vercel.app/">Octomments</a> 的介绍，将 Octomments 安装到您的 GitHub 账户，确保它拥有访问您的目标 repo 的 issue 的权限。</p>
<h1 id="配置-github-issue">配置 GitHub issue</h1>
<p>在配置文件中增加配置项：</p>
<ul>
<li><code>comment.owner</code>：Issue repo 的拥有者</li>
<li><code>comment.repo</code>：Issue repo 的名字</li>
</ul>
<h1 id="配置-comment-组件">配置 Comment 组件</h1>
<p>在您的博客站点根目录下的<code>layouts/partials/comments.html</code> 模板中增加：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl">{{ if .Params.issueNumber -}}
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://unpkg.com/octomments/build/ocs-ui.min.css&#34;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;comments&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://unpkg.com/octomments/build/ocs.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl">  <span class="nx">Octomments</span><span class="p">({</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl">    <span class="nx">github</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl">      <span class="nx">owner</span><span class="o">:</span> <span class="s1">&#39;{{ $.Site.Params.comment.owner }}&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl">      <span class="nx">repo</span><span class="o">:</span> <span class="s1">&#39;{{ $.Site.Params.comment.repo }}&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl">    <span class="nx">issueNumber</span><span class="o">:</span> <span class="p">{{</span> <span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">issueNumber</span> <span class="p">}},</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl">    <span class="nx">renderer</span><span class="o">:</span> <span class="p">[</span><span class="nx">OctommentsRenderer</span><span class="p">,</span> <span class="s1">&#39;#comments&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl">  <span class="p">}).</span><span class="nx">init</span><span class="p">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl">{{ end }}
</span></span></code></pre></div><h1 id="配置需要评论的文章">配置需要评论的文章</h1>
<p>在文章的 metadata 章节加入创建的 issue 的 issue number，如本文的 metadata：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w"></span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;使用 GitHub Issue 作为 Hugo 的评论系统&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w"></span><span class="nt">date</span><span class="p">:</span><span class="w"> </span><span class="ld">2022-02-10T15:07:10</span><span class="m">+08</span><span class="p">:</span><span class="m">00</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="nt">draft</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w"></span><span class="nt">toc</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w"></span><span class="nt">issueNumber</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="nt">images</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w"></span><span class="nt">tags</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">  </span>- <span class="l">Hugo</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">  </span>- <span class="l">Github</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span></code></pre></div><p>这样本文的末尾就会出现一个评论栏啦，所有对本文的评论都会同步到 GitHub 的 issue 中。</p>
]]></content>
		</item>
		
		<item>
			<title>理解 Rust 的 Pin 机制</title>
			<link>https://huanglei.rocks/posts/rust-pinning/</link>
			<pubDate>Sat, 29 Jan 2022 22:41:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/rust-pinning/</guid>
			<description>Pin 之所以难以理解，是因为其是同时涉及到移动语义、所有权、异步的一个概念。可以说，Pin 是为了解决自引用数据结构的移动问题，而这个问题在 Rust 的基</description>
			<content type="html"><![CDATA[<p>Pin 之所以难以理解，是因为其是同时涉及到移动语义、所有权、异步的一个概念。可以说，Pin 是为了解决自引用数据结构的移动问题，而这个问题在 Rust 的基于 Future 的异步编程中较为常见。</p>
<p>首先在文章的最开始用几句话总结下这几个概念：</p>
<ul>
<li>Pin：控制数据的所有权（how?），让其无法移动，从而避免 self-referential 的数据结构在移动的过程中被破坏。</li>
<li>Unpin：说明数据不关心被移动，即使它被移动了也不会产生悬挂指针。如果一个被 pin 住的数据的类型实现了 unpin trait，那么就可以通过这个 pin 获取被 pin 住的数据的一个可变引用，从而移动这个值（how?）。</li>
<li>!Unpin：一个 Marker，告诉编译器这个数据结构不能被随意移动，从而当这个数据结构被 pin 住的时候，无法得到其可变引用。</li>
<li>Pin-Projection：被 pin 的数据结构可能存在部分字段是需要同时被 pin、部分字段不需要被 pin 的。</li>
<li>为什么 Rust 的 Future 的方法签名是 <code>Pin&lt;&amp;mut self&gt;</code>? 因为 Rust 的 Future 本质上就是一个通过状态机实现的 generator，genrator 是 stackless 的，也就是说 Rust 在 runtime 并不会为每个 generator 维护上下文的状态，这些状态都是通过编译器的黑魔法变成 future 里面的数据。而 future 有可能会被传递、移动。Rust 所生成的 future 里面的数据存在 self-referential 的情况，那么在 future 被移动的时候，这些 self-referential 的指针就会变成野指针，从而导致异常。</li>
</ul>
<h2 id="catch-up-如何在-rust-中移动数据">Catch up: 如何在 Rust 中移动数据</h2>
<ul>
<li>赋值、传参、返回：这个是最常见的。</li>
<li>receiver 为<code>self</code>的方法调用：为什么数据结构上方法调用也有可能需要移动呢？一个典型的例子就是 <code>Vec#push</code>，调用之后可能会导致内部数组扩容从而被移动到新的内存位置。</li>
<li><code>std::mem::replace</code>：通过一个可变引用来移动。</li>
</ul>
<h2 id="self-reference">Self-reference</h2>
<p>我们来构建一个存在自我引用的数据结构：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="n">parsed</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Parsed</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Parsed</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="w">    </span><span class="n">result</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9">9</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到 <code>ParsedContext</code>拥有一个字符数组 <code>buf</code>和 解析的结果：<code>Parsed</code>。而 <code>Parsed</code>内部包含一个对字符数组 <code>buf</code>的引用（先不考虑这样的数据结构是否必要合理）。</p>
<div style="width:100%;display:flex; justify-content: center; align-items: center;">
<div style="width: 70%;">
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/rust-self-referential-data.svg" alt="image.png"></p>
</div>
</div>    
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
<p>数据引用结构</p>
</i>
</div>
<p>这样的 <code>ParserContext</code>显然是存在一些问题的。假设由于各种原因，<code>ParserContext</code>的内存被移动了，那么就会造成悬垂引用，可以看下图：</p>
<div style="width:100%;display:flex; justify-content: center; align-items: center;">
<div style="width: 70%;">
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/rust-move-a-self-referential.svg" alt="image.png"></p>
</div>
</div>    
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
<p>移动后的数据结构</p>
</i>
</div>
<p>在 ParserContext 被移动之后，<code>ParserContext#buf</code>被移动了 <code>0xDCBA</code>，但是 <code>ParserContext#parsed#buf</code>引用指向的还是 <code>0xABCD</code>这个无效的地址。</p>
<p>我们把这种字段中存在一个指针指向自身或者自身一部分的数据结构称作自引用（self-referential）数据结构。自引用数据结构之所以需要单独提及，是因为自引用数据结构的值移动操作需要特殊处理。</p>
<p>Rust 处理自引用数据结构的方法，是引入 <code>Pin</code>语义来防止其被随意移动。</p>
<h2 id="how-pin-works">How Pin works</h2>
<p>当你把一个值放进 Pin 中，你就无法再获取这个值的可变引用。这样就无法通过赋值、传参、返回、方法调用、<code>std::mem::replace</code> 这些方法来移动值了。当然也有例外，当你明确地知道被 Pin 包裹的值不会再被移动，那可以通过 unsafe 的方法来获取它的可变引用。</p>
<h2 id="how-async-code-compiles">How async code compiles</h2>
<p>举个例子</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">AsyncRead</span><span class="o">+</span><span class="n">AsyncWrite</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">	</span><span class="n">tokio</span>::<span class="n">io</span>::<span class="n">read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="o">..</span><span class="p">]).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w"></span><span class="c1">// 上面的代码会被编译器生成下面的样子 
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">AsyncRead</span><span class="o">+</span><span class="n">AsyncWrite</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">FooFuture</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">	</span><span class="c1">//...
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="c1">// 当 foo 返回的 future 第一次被 poll 的时候,会生成一个新的 ReadFuture 设置到 FooFuture 的
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="c1">// readFuture 字段中
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">ReadFuture</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">	</span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="n">s</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">AsyncRead</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="c1">// foo 函数返回的 future，是一个存在 self-reference 的结构—— buf的所有权在 FooFuture，
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="c1">// FooFuture 包含一个 readFuture，readFuture 包含一个 buf 的指针
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">FooFuture</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="p">[</span><span class="kt">u8</span>: <span class="mi">1024</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">	</span><span class="n">readFuture</span>: <span class="nc">ReadFuture</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到最终 foo 返回的 future 是一个 self-reference 的结构。
由于 Rust 的 future 是通过不断地被 poll 从而驱动状态机的状态流转的，foo 函数返回的这个 self-referential future 如果会被移动（比如在赋值、传参、数组扩缩容等情况下），那么这个 self-referential 的数据结构就会被破坏，从而导致异常。</p>
<p>Rust 的 future 的特性：</p>
<ul>
<li>Future 刚刚创建出来的时候，移动它是安全的：因为没有被 poll 过，self-referential 的结构还没有形成；</li>
<li>Future 第一次被 poll 之后，移动这个 future 就不再是是安全的：因为跨越不同的 yield point 之间，一定会导致生成嵌套的 self-refenrential future。</li>
</ul>
<p>我们来看 Future 的签名:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到，poll 方法的 self 的类型是：<code>Pin&lt;&amp;mut Self&gt;</code>，这就意味着，调用一次 poll 之后，self 的所有权就 somehow 被这个 <code>Pin</code>获取了，持有 future 对象的代码无法再通过任何办法获取到 future 的所有权，也就无法移动这个 future。</p>
<p>这里也有一点需要注意下，持有这个 future 的对象如何去 poll ？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">f</span>: <span class="nc">FooFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="n">f</span><span class="p">.</span><span class="n">poll</span><span class="p">();</span><span class="w"> </span><span class="c1">// x: 这里不能直接调用,因为这里的 f 的类型是 FooFuture，也就是 Self
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w"> </span><span class="c1">// p 的类型是：Pin&lt;&amp;mut FooFuture&gt; 
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="c1"></span><span class="n">p</span><span class="p">.</span><span class="n">poll</span><span class="p">();</span><span class="w"> </span><span class="c1">// 这才是符合poll 方法签名的
</span></span></span></code></pre></div><p>那么，假设我们通过一些 workaround 去拿到 pin 里面的值呢？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">f</span>: <span class="nc">FooFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="n">p</span><span class="p">.</span><span class="n">poll</span><span class="p">();</span><span class="w"> </span><span class="c1">// p 里面的 future 已经被 poll 过了,按道理这个时候 future 不能再被移动
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w"></span><span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">());</span><span class="c1">// 视试图通过 mem::replace 移动 p  里面的future
</span></span></span></code></pre></div><p>其实这个时候的 mem::replace 会报错的:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">Deref</span><span class="o">&lt;</span><span class="n">Target</span>: <span class="nb">Unpin</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="c1">//             ^~~~~ Deref 的目标类型必须是 Unpin   
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到, Pin 所实现的 Deref trait 是有类型限制的：它要求 pin 里面的指针的目标类型必须实现 Unpin Trait. 如果指针的目标类型存在 self-referential 的情况，那么它是不能被 deref 的，也就无法从 Pin 中取出原始的值从而任意移动。</p>
<blockquote>
<p>Rust’s solution to this problem rests on the insight that futures are always safe to move when they are first created, and only become unsafe to move when they are polled. A future that has just been created by calling an asynchronous function simply holds a resumption point and the argument values. These are only in scope for the asynchronous function’s body, which has not yet begun execution. Only polling a future can borrow its contents.</p>
</blockquote>
<p><code>Pin&lt;&amp;mut Self&gt;</code> 就是为了确保 Future 对象自己不会被移动。</p>
<p><code>Unpin</code>：代表对象不存在 self-reference 等情况，可以被随意移动。大部分 Rust 标准库里面的数据结构都是 Unpin 的。
<code>!Unpin</code>：作为一个 marker,告诉 rust 编译器这个数据结构是无法被随意移动的,一旦这个数据结构进入到 Pin 中，就不能从 Pin 中重新获取数据的所有权。</p>
<h1 id="一个-self-referential-的例子">一个 self-referential 的例子</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="c1">// buf 不能移动
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">buf</span>: <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">    </span><span class="c1">// parsed 这个字段可以随意移动
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">parsed</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Parsed</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="n">result</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_parse</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">        </span><span class="c1">// do_parse 只修改 parsed，而 parsed 的移动
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">        </span><span class="n">this</span><span class="p">.</span><span class="n">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w">            </span><span class="n">buf</span>: <span class="nc">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">            </span><span class="n">result</span>: <span class="nb">String</span>::<span class="n">from_utf8_lossy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()]).</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;h&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a class="lnlinks" href="#code-sec-35">35</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;e&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-36"><a class="lnlinks" href="#code-sec-36">36</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-37"><a class="lnlinks" href="#code-sec-37">37</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-38"><a class="lnlinks" href="#code-sec-38">38</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;o&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-39"><a class="lnlinks" href="#code-sec-39">39</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-40"><a class="lnlinks" href="#code-sec-40">40</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-41"><a class="lnlinks" href="#code-sec-41">41</a></span><span class="cl"><span class="w">        </span><span class="n">buf</span>: <span class="nc">pin</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-42"><a class="lnlinks" href="#code-sec-42">42</a></span><span class="cl"><span class="w">        </span><span class="n">parsed</span>: <span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-43"><a class="lnlinks" href="#code-sec-43">43</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-44"><a class="lnlinks" href="#code-sec-44">44</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-45"><a class="lnlinks" href="#code-sec-45">45</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pinned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-46"><a class="lnlinks" href="#code-sec-46">46</a></span><span class="cl"><span class="w">    </span><span class="n">pinned</span><span class="p">.</span><span class="n">do_parse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-47"><a class="lnlinks" href="#code-sec-47">47</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-48"><a class="lnlinks" href="#code-sec-48">48</a></span><span class="cl"><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-49"><a class="lnlinks" href="#code-sec-49">49</a></span><span class="cl"><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-50"><a class="lnlinks" href="#code-sec-50">50</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Not expect to reach here.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-51"><a class="lnlinks" href="#code-sec-51">51</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-52"><a class="lnlinks" href="#code-sec-52">52</a></span><span class="cl"><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-53"><a class="lnlinks" href="#code-sec-53">53</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Parse success&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-54"><a class="lnlinks" href="#code-sec-54">54</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-55"><a class="lnlinks" href="#code-sec-55">55</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-56"><a class="lnlinks" href="#code-sec-56">56</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-57"><a class="lnlinks" href="#code-sec-57">57</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如果用 pin_project 来改写</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w"></span><span class="cp">#[pin_project::pin_project]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="c1">// buf 不能移动，因此使用 pin 来标识
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="cp">#[pin]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="c1">// parsed 这个字段可以随意移动
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">parsed</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Parsed</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w"></span><span class="cp">#[pin_project::pin_project]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="cp">#[pin]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="n">result</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_parse</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">project</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">parsed</span><span class="p">,</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">            </span><span class="n">buf</span>: <span class="nc">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w">            </span><span class="n">result</span>: <span class="nb">String</span>::<span class="n">from_utf8_lossy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()]).</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">        </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;h&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;e&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a class="lnlinks" href="#code-sec-35">35</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-36"><a class="lnlinks" href="#code-sec-36">36</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-37"><a class="lnlinks" href="#code-sec-37">37</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;o&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-38"><a class="lnlinks" href="#code-sec-38">38</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-39"><a class="lnlinks" href="#code-sec-39">39</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-40"><a class="lnlinks" href="#code-sec-40">40</a></span><span class="cl"><span class="w">        </span><span class="n">buf</span>: <span class="nc">vec</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-41"><a class="lnlinks" href="#code-sec-41">41</a></span><span class="cl"><span class="w">        </span><span class="n">parsed</span>: <span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-42"><a class="lnlinks" href="#code-sec-42">42</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-43"><a class="lnlinks" href="#code-sec-43">43</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-44"><a class="lnlinks" href="#code-sec-44">44</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pinned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-45"><a class="lnlinks" href="#code-sec-45">45</a></span><span class="cl"><span class="w">    </span><span class="n">pinned</span><span class="p">.</span><span class="n">do_parse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-46"><a class="lnlinks" href="#code-sec-46">46</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-47"><a class="lnlinks" href="#code-sec-47">47</a></span><span class="cl"><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-48"><a class="lnlinks" href="#code-sec-48">48</a></span><span class="cl"><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-49"><a class="lnlinks" href="#code-sec-49">49</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Not expect to reach here.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-50"><a class="lnlinks" href="#code-sec-50">50</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-51"><a class="lnlinks" href="#code-sec-51">51</a></span><span class="cl"><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-52"><a class="lnlinks" href="#code-sec-52">52</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Parse success&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-53"><a class="lnlinks" href="#code-sec-53">53</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-54"><a class="lnlinks" href="#code-sec-54">54</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-55"><a class="lnlinks" href="#code-sec-55">55</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-56"><a class="lnlinks" href="#code-sec-56">56</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>Rust 对象安全详解</title>
			<link>https://huanglei.rocks/posts/object-safety/</link>
			<pubDate>Thu, 09 Dec 2021 21:57:33 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/object-safety/</guid>
			<description>Rust 的 RFC 上只给出了 object-safety 的定义，但是没有解释为何在满足这些条件的时候 trait 是 object safe 的，以及为啥需要 object safety，这反而是初学者最为困惑的点。 为什么需要</description>
			<content type="html"><![CDATA[<p>Rust 的 <a href="https://rust-lang.github.io/rfcs/0255-object-safety.html">RFC</a> 上只给出了 object-safety 的定义，但是没有解释为何在满足这些条件的时候 trait 是 object safe 的，以及为啥需要 object safety，这反而是初学者最为困惑的点。</p>
<h1 id="为什么需要-object-safety">为什么需要 object safety？</h1>
<p>Rust 通过 trait object 提供了类型擦除、动态分派的能力，但是这个能力是有限制的，不是所有的 trait 都能自动生成实现。
<strong>Trait object 本质上是对某个 trait 的自动默认实现，包括一个数据区和一个方法表。<u>Object-safety 就是为了保证 Rust 编译器能够为某个 trait 生成合法自动实现。</u></strong></p>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/QAgzwRCoT/1644416416.png" alt="trait-object.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Trait object 的内存布局 
</i>
</div>
<blockquote>
<p><a href="https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/">Where Self Meets Sized: Revisiting Object Safety</a></p>
</blockquote>
<p>首先是关于 trait 的 object safety，一个 trait 是对象安全的，当且仅当它<strong>满足以下<u>所有</u>条件</strong>：</p>
<ul>
<li>trait 的类型不能限定为 <code>Self: Sized</code><sup>1️⃣</sup>；</li>
<li>trait 中所定义的所有方法都是 object-safe 的<sup>2️⃣</sup>；</li>
</ul>
<p>接下来是关于方法的 object safety：一个方法是对象安全的，当且仅当这个方法<strong>满足下面<u>任意一个</u>特性</strong>：</p>
<ul>
<li>方法 receiver 的类型限定是 <code>Self: Sized</code><sup>3️⃣ </sup>；或者</li>
<li>满足以下所有条件：
<ul>
<li>方法不能有泛型参数<sup>4️⃣</sup>；且</li>
<li>receiver 类型必须是 Self 或者可以解引用为 Self 的引用类型<sup>5️⃣ </sup>。目前只包括<code>self</code>/ <code>&amp;self</code> / <code>&amp;mut self</code>/ <code>self: Box&lt;Self&gt;</code>。以后可能也会扩展到 <code>Rc&lt;Self&gt;</code>等等。</li>
<li><code>Self</code>类型只能用作 receiver <sup>6️⃣ </sup></li>
</ul>
</li>
</ul>
<p>1️⃣   也就是说，如下的 trait 是不能用作 trait object 的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Test</span>: <span class="nb">Sized</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">	</span><span class="k">fn</span> <span class="nf">some_method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>为什么trait 的方法的 receiver 不能限定为 <code>Self: Sized</code>？因为 trait object 本身是动态分派的，编译期无法确定 trait object 的大小。如果这个时候 trait object 的方法又要求 Self 大小可确定，那就互相矛盾了。
需要注意的是，trait object 自身的大小是可确定的，因为其只包括指向数据的指针和指向 vtable 的指针而已。</p>
<p>2️⃣   要求 trait 所有的方法都是对象安全的也是为了确保动态分派的时候能够正确从 vtable 中找到方法进行调用。</p>
<p>3️⃣   由于 trait object 自身是 Unsized，如果方法限定了<code>Self: Sized</code>，那么一定无法通过 trait object 去调用。也就不会导致动态分派的 object safety 问题，因此一个限定了 <code>Self: Sized</code>的 trait 方法也被认为是 object-safe 的。</p>
<blockquote>
<ul>
<li><a href="https://stackoverflow.com/questions/42620022/why-does-a-generic-method-inside-a-trait-require-trait-object-to-be-sized">Why does a generic method inside a trait require trait object to be sized? - Stack Overflow</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/22031">A method marked where Self: Sized on a trait should not be considered during object safety checks #22031</a></li>
</ul>
</blockquote>
<p>4️⃣   如果方法不限定 <code>Self: Sized</code> ，就意味着那么这个方法首先不能有泛型参数。如果有泛型参数，那么 vtable 中的方法列表大小是难以确定的。当然如果非要做，在编译期，rust 编译器可以拿到 trait 的所有具体实现，然后为每一个具体实现在 vtable 生成一个特化的方法项。但是首先这会大大降低编译速度，其次也会引入极大的复杂性。因此 Rust 的 trait object 直接禁止了这种使用场景。</p>
<blockquote>
<p><a href="https://stackoverflow.com/questions/67767207/why-are-trait-methods-with-generic-type-parameters-object-unsafe">Why are trait methods with generic type parameters object-unsafe?</a></p>
</blockquote>
<p>5️⃣   如果方法没有 receiver，那么使用 trait object 毫无意义，因为这个方法的调用根本不需要 trait object 里面的 data 指针。</p>
<p>6️⃣   假设 trait 定义了这么一个方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">	</span><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>那么这个 trait 的 duplicate 方法要求返回的类型和方法 receiver 的类型是一样的。如果 Trait 是静态分派，那么在编译器就可以确定所有可能的方法签名。比如结构体 A、B 实现了 Test trait，那么 duplicate 方法所有可能的签名是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">A</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">A</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">B</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>而在动态分派下，从一个 trait object 发起方法的调用，也就无法在编译期约束不同位置的 Self 类型都是一致的，完全有可能出现下面的情况：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">A</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>显然这不是对 <code>Test</code> 这个 trait 的一个合法实现。</p>
<ul>
<li><a href="https://rust-lang.github.io/rfcs/0255-object-safety.html">https://rust-lang.github.io/rfcs/0255-object-safety.html</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Paxos Made Simple 笔记 (WIP)</title>
			<link>https://huanglei.rocks/posts/notes-on-paxos-made-simple/</link>
			<pubDate>Mon, 14 Jun 2021 11:24:18 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/notes-on-paxos-made-simple/</guid>
			<description>关于 P2c P2c 是 P2b 的充分不必要条件，why？ P2b: If a proposal with value v is chosen, then every higher-numbered proposal issued by any proposer has value v. P2c: For any v and n, if a proposal with value v and number n is issued, then there is a set S consisting of a majority of acceptors such that</description>
			<content type="html"><![CDATA[<h1 id="关于-p2c">关于 P2c</h1>
<p>P2c 是 P2b 的充分不必要条件，why？</p>
<blockquote>
<ul>
<li>P2b: If a proposal with value v is chosen, then every higher-numbered proposal issued by any proposer has value <code>v</code>.</li>
<li>P2c: For any <code>v</code> and <code>n</code>, if a proposal with value <code>v</code> and number <code>n</code> is issued, then there is a set S consisting of a majority of acceptors such that either
<ul>
<li>(a) no acceptor in S has accepted any proposal numbered less than <code>n</code>, or</li>
<li>(b) <code>v</code> is the value of the highest-numbered proposal among all proposals numbered less than <code>n</code> accepted by the acceptors in S.</li>
</ul>
</li>
</ul>
</blockquote>
<p>已知 proposal:<code>(m,v)</code>被选中，要满足任意 proposer 提出序号 n （n &gt; m）的 proposal 的值都是 <code>v</code>，那么只要满足条件：<u> $ \forall i\in [m,\ n-1]$ ，有 proposal <code>i</code> 的值是 <code>v</code> 1</u>，那么根据数学归纳法，proposal <code>n</code>的值也必然是 <code>v</code>。</p>
<p>1: 是附加假设，我们需要根据这个附加假设去约束 proposer 的行为，从而使得 P2b 能够被满足。下面就需要解释这个附加假设对 proposer 的行为做出了什么样的约束。</p>
<p>由于 <code>(m,v)</code>已经被选中了，那就意味着存在一个 acceptor 的集合 C 满足任意 C 中的 acceptor 都 accept 了<code>(m,v)</code>，再加上我们需要让附加假设（满足 $i\in [m,\ n-1]$ ，有 proposal <code>i</code> 的值是 <code>v</code>）成立，
这就意味着所谓的 C-condition 2 ，对于 accept 了 <code>(m,v)</code> 的 acceptor 集合 C，满足：</p>
<ul>
<li>(1)  C 中的所有 acceptor 都 accept 了 $[m,\ n-1]$ 中的一个 proposal（因为至少有<code>m</code>已经被 C 中的所有 acceptor 给 accept 了）</li>
<li>(2) $[m,\ n-1]$ 中所有的被任意 acceptor 所 accept 的 proposal 的值都是 <code>v</code>（注意，这里约束的对象从 proposer 变成了 acceptor，实际上 narrow down 了，因为是非拜占庭问题，所有被 acceptor 所 accept 的值都需要 proposer 提出）。</li>
</ul>
<p>那么只要 proposer 满足 P2c，就能满足所谓的 C-condition，从而实现 P2c -&gt; C-condidtion -&gt; 附加假设 1-&gt; P2b 的证明路径。</p>
<blockquote>
<p>为什么 P2c 可以保证 C-condidition？
P2c 约束了 proposer 每次提案之前先要知道 majority 的情况，由于<code>(m,v)</code>已经 chosen，因此符合 P2c 的 proposer 在提出 m+1 的时候，提案的值必然是 m（highest accepted proposal）的值 v，m+2、m+3 直到 n-1 都是这样，从而可以保证 C-condition 的 (2)，</p>
</blockquote>
<p>因此 P2b 到 P2c 实际上是让约束逐步可实现化的 narrow down，因为让 proposer 去感知 acceptor 的状态是更容易实现的。</p>
<blockquote>
<p>Learning about proposals already accepted is easy enough; predicting future acceptances is hard. Instead of trying to predict the future, the proposer controls it by extracting a promise that there won’t be any such acceptances.</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>现代 Java 捉虫指南</title>
			<link>https://huanglei.rocks/posts/java-debug-manual/</link>
			<pubDate>Fri, 12 Feb 2021 22:01:27 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/java-debug-manual/</guid>
			<description>gnu.hl@antgroup.com 2020-12-01 本文是作者 2021 年在蚂蚁内部分享时的 slides 经过脱敏之后的版本。 当我们排查问题的时候，我们关注什么？ 横向来看: context/critical path/caller/callee (tracing) statistics/metrics (profiling) 纵向来看: application runtime kernel Arthas Arthas 是基于</description>
			<content type="html"><![CDATA[<p><img src="https://gw.alipayobjects.com/zos/antfincdn/Se%26jyp0zs1/fe9fd884-3cb2-4cf7-b060-cd8d704cb03e.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=HK8X9&amp;originHeight=1634&amp;originWidth=2419&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 <a href="mailto:gnu.hl@antgroup.com">gnu.hl@antgroup.com</a>  
</i>
</div>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
<p><strong>2020-12-01</strong></p>
</i>
</div>
<hr>
<blockquote>
<p>本文是作者 2021 年在蚂蚁内部分享时的 slides 经过脱敏之后的版本。</p>
</blockquote>
<h2 id="当我们排查问题的时候我们关注什么">当我们排查问题的时候，我们关注什么？</h2>
<p>横向来看:</p>
<ul>
<li>context/critical path/caller/callee (tracing)</li>
<li>statistics/metrics (profiling)</li>
</ul>
<p>纵向来看:</p>
<ul>
<li>application</li>
<li>runtime</li>
<li>kernel</li>
</ul>
<hr>
<h2 id="arthas">Arthas</h2>
<blockquote>
<p>Arthas 是基于字节码增强的调试工具.</p>
</blockquote>
<p>功能:</p>
<ul>
<li>观察方法的入参/返回值/异常等数据</li>
<li>观察内存对象的值</li>
<li>跟踪方法的耗时和调用栈</li>
<li>查看类加载来源/热更新类定义</li>
</ul>
<h3 id="安装">安装</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">curl -L http://start.alibaba-inc.com/install.sh <span class="p">|</span> sh
</span></span></code></pre></div><hr>
<h3 id="arthas-使用方法">Arthas 使用方法</h3>
<ul>
<li>观察方法入参、返回值、异常</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp}&#34; [condition] [-f] [-b] [-xN]
</code></pre><ul>
<li>拦截指定线程执行的方法</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp}&#34; \
  &#34;@java.lang.Thread@currentThread().getName()==&#39;&lt;thread_name&gt;&#39;&#34; [-f] [-b] [-xN]
</code></pre><ul>
<li>在观察入参同时打印方法栈</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp, \
@java.lang.Thread@currentThread().getStackTrace()}&#34; [condition] [-f] [-b] [-xN]
</code></pre><hr>
<h3 id="arthas-使用方法cont">Arthas 使用方法(cont.)</h3>
<ul>
<li>耗时较长的方法</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp, @java.lang.Thread@currentThread().getStackTrace()}&#34; \
&#39;#cost&gt;100 [&amp;&amp; other_cond]&#39; [-f] [-b] [-xN]
</code></pre><ul>
<li>classloading 问题</li>
</ul>
<pre tabindex="0"><code>sc -d &#39;&lt;class_name&gt;&#39;
</code></pre><ul>
<li>构造对象</li>
</ul>
<pre tabindex="0"><code>watch com.alipay.antq.broker.processor.SendMessageProcessor sendMessage \
&#34;{new java.lang.String(params[1].body)}&#34; -x2 -n10
</code></pre><hr>
<h3 id="arthas-使用方法cont-1">Arthas 使用方法(cont.)</h3>
<ul>
<li>Projection &amp; filtering</li>
</ul>
<pre tabindex="0"><code>watch com.alipay.antqnamesrv.core.service.broker.BrokerFileService getBrokerFiles \
    &#34;{returnObj[&#39;FILE_CLUSTER&#39;][&#39;antq-eu95-3.gz00b.stable.alipay.net&#39;]\
    .topicQueues.values().{ #this.{? #this.queueId==32 } }.{? #this.size()!=0 }}&#34; -x3
</code></pre><ul>
<li>观察方法执行路径</li>
</ul>
<pre tabindex="0"><code>trace [--skipJDKMethod true|false] &lt;class_fqcn&gt; &lt;method_name&gt;
</code></pre><blockquote>
<p>N/A</p>
</blockquote>
<hr>
<h3 id="arthas-使用方法cont-2">Arthas 使用方法(cont.)</h3>
<ul>
<li>制作火焰图</li>
</ul>
<pre tabindex="0"><code># list all events
profiler list
# profile object allocation
profiler start --event alloc -d 10
# profile lock acquire
profiler start --event lock -d 10
</code></pre><ul>
<li>热更新代码</li>
</ul>
<pre tabindex="0"><code>mc/redefine
</code></pre><p>N/A</p>
<hr>
<h3 id="arthas-的缺陷">Arthas 的缺陷</h3>
<ul>
<li>启动期观测 -&gt; <code>jdb</code> / <a href="https://github.com/btraceio/btrace">btrace</a></li>
<li>测量引入 overhead</li>
<li>注意内存问题</li>
</ul>
<hr>
<h2 id="eclipse-mat--zprofiler">Eclipse MAT / zprofiler</h2>
<ul>
<li><a href="https://lark-assets-prod-aliyun.oss-accelerate.aliyuncs.com/lark/0/2020/png/122844/1595069971931-7bb33b65-cb9e-41a0-b1b4-8547b2c1708b.png?OSSAccessKeyId=LTAI4GGhPJmQ4HWCmhDAn4F5&amp;Expires=1607186074&amp;Signature=LF4bn%2FxILpoIgYCGtFBWyEjDIXE%3D&amp;response-content-disposition=inline">OQL</a>
<code>select * from io.netty.channel.AbstractChannelhandlerContext$11</code></li>
</ul>
<h3 id="native-memory-issues">Native memory issues</h3>
<p>RSS = xmx +  MaxDirectMemory + N * xss [ + gc + code cache + metaspace ]</p>
<ul>
<li>case1) DirectByteBuffer 未释放-&gt;通过观察堆内的DirectMemory</li>
<li>case2) <code>[G]ZIPInput[/Output]Stream</code>/<code>De[/In]flater</code> <a href="https://www.evanjones.ca/java-native-leak-bug.html">native memory leak</a></li>
<li>case3) Netty&lt;= 4.0.24 <a href="https://github.com/netty/netty/pull/3844">epoll native memory leak</a></li>
<li>case4) <a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8164293">JDK-8164293:HotSpot leaking memory</a> (fixed <a href="/8u152">@8u152) </a> )</li>
</ul>
<hr>
<h2 id="sa-jdi--clhsdb">sa-jdi / clhsdb</h2>
<blockquote>
<p>Off-process vs. in-process instrumentation</p>
</blockquote>
<ul>
<li>sa: serviceability agent</li>
<li>clhsdb: command-line hotspot debugger</li>
<li>sa-jdi 提供了获取 JVM 内部数据结构的编程接口</li>
<li>sa-jdi 不仅可以 attach 活着的进程, 也可以分析 coredump</li>
<li><code>jstack</code>/<code>jstat</code>等工具均提供了基于 attach api(tools.jar) 和 sa-jdi(sa-jdi.jar)的实现</li>
<li><a href="https://www.iteye.com/blog/rednaxelafx-1847971">借HSDB来探索HotSpot VM的运行时数据</a></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">ls <span class="nv">$JAVA_HOME</span>/lib
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">java -cp <span class="nv">$JAVA_HOME</span>/lib/sa-jdi.jar sun.jvm.hotspot.CLHSDB
</span></span></code></pre></div><hr>
<h2 id="sa-jdi--clhsdbcont">sa-jdi / clhsdb(cont.)</h2>
<h5 id="使用-sa-jdi-分析反射生成的类">使用 sa-jdi 分析反射生成的类</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="kn">import</span> <span class="nn">sun.jvm.hotspot.oops.InstanceKlass</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="kn">import</span> <span class="nn">sun.jvm.hotspot.tools.jcore.ClassFilter</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodAccessorFilter</span> <span class="kd">implements</span> <span class="n">ClassFilter</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">canInclude</span><span class="o">(</span><span class="n">InstanceKlass</span> <span class="n">instanceKlass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">        <span class="k">return</span> <span class="n">instanceKlass</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">asString</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;sun/reflect/Generated&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9">9</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">java -classpath <span class="s2">&#34;.:</span><span class="nv">$JAVA_HOME</span><span class="s2">/lib/sa-jdi.jar&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="se"></span>-Dsun.jvm.hotspot.tools.jcore.filter<span class="o">=</span>MethodAccessorFilter sun.jvm.hotspot.tools.jcore.ClassDump &lt;pid&gt;
</span></span></code></pre></div><blockquote>
<p>SA-JDI is deprecated since Java9 &ndash; <a href="https://bugs.openjdk.java.net/browse/JDK-8158050">JDK-8158050</a></p>
</blockquote>
<hr>
<h2 id="jfr">JFR</h2>
<ul>
<li>域内要求 JVM 版本 <code>^ajdk-8_5_10_fp2-b9</code></li>
<li><code>-XX:+EnableJFR -XX:+FlightRecorder -XX:FlightRecorderOptions=&lt;opt&gt;=&lt;val&gt; -XX:StartFlightRecording=&lt;opt&gt;=&lt;val&gt;</code></li>
<li>可分析的事件类型:
<ul>
<li>Lock contention</li>
<li>Memory allocation</li>
<li>IO performance (Network/File)</li>
<li>Code execution performance</li>
<li>Garbage Collector</li>
<li>JIT performance</li>
</ul>
</li>
</ul>
<hr>
<h2 id="jfr-cont">JFR (cont.)</h2>
<p>使用步骤</p>
<ul>
<li>启动进程时增加开启 JFR 的参数</li>
<li>开始 JFR 记录 <code>jcmd &lt;pid&gt; JFR.start settings=profile name=&lt;record_name&gt;</code></li>
<li>dumpJFR 记录 <code>jcmd &lt;pid&gt; JFR.dump filename=jfr.output name=&lt;record_name&gt;</code></li>
<li>使用 <a href="https://www.oracle.com/java/technologies/jdk-mission-control.html">JDK Mission Control</a> 分析 JFR dump</li>
</ul>
<hr>
<h2 id="jfr-cont-1">JFR (cont.)</h2>
<p>参考资料</p>
<ul>
<li><a href="http://hirt.se/blog/">Continuous Production Profiling and Diagnostics</a></li>
<li><a href="https://www.javacodegeeks.com/2015/03/oracle-java-mission-control-the-ultimate-guide.html">Oracle Java Mission Control: The Ultimate Guide</a></li>
</ul>
<hr>
<h2 id="interesting-cases">Interesting Cases</h2>
<ul>
<li>N/A</li>
<li>N/A</li>
<li>N/A</li>
</ul>
<hr>
<h2 id="one-more-thing">One more thing</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Tool</th>
</tr>
</thead>
<tbody>
<tr>
<td>Application on runtime(Java/Node/Ruby/PHP)</td>
<td>Runtime debugger,eBPF</td>
</tr>
<tr>
<td>Application (native code)</td>
<td>System debugger,eBPF</td>
</tr>
<tr>
<td>System libraries: /lib/*</td>
<td>ltrace(1),eBPF</td>
</tr>
<tr>
<td>System call interface</td>
<td>strace(1), perf(1),eBPF</td>
</tr>
<tr>
<td>Network Traffic</td>
<td>tcpdump(8),eBPF</td>
</tr>
<tr>
<td>Kernel: Scheduler, file systems, TCP, IP, etc</td>
<td>ftrace(1), perf(1),eBPF</td>
</tr>
<tr>
<td>Hardware: CPU internals, devicec</td>
<td>perf, sar, eBPF</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="perf">Perf</h2>
<ul>
<li>Why is the kernel on-CPU so much? What code-paths?</li>
<li>Which code-paths are causing CPU level 2 cache misses?</li>
<li>Are the CPUs stalled on memory I/O?</li>
<li>Which code-paths are allocating memory, and how much?</li>
<li>What is triggering TCP retransmits?</li>
<li>Is a certain kernel function being called, and how often?</li>
<li>What reasons are threads leaving the CPU?</li>
</ul>
<p>&ndash; Brendan Greg</p>
<hr>
<h2 id="perf-cont">Perf (cont.)</h2>
<p><code>perf_event</code>:</p>
<ul>
<li>Software events</li>
<li>Hardware events</li>
<li>Kernel static tracepoint events</li>
<li>USDT</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/122844/1606655883925-873a4d92-9d1b-4d7d-8e24-31cd567ebd1f.png?x-oss-process=image%2Fresize%2Cw_1412#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=oFLoJ&amp;originHeight=988&amp;originWidth=1412&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<p><code>sudo perf list</code> to list all available events.</p>
<hr>
<pre tabindex="0"><code># sudo perf record -e block:block_rq_issue -e block:block_rq_complete -a sleep 10
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.428 MB perf.data (~18687 samples) ]
# sudo perf script
        run 30339 [000] 2083345.722767: block:block_rq_complete: 202,1 W () 12984648 + 8 [0]
        run 30339 [000] 2083345.722857: block:block_rq_complete: 202,1 W () 12986336 + 8 [0]
        run 30339 [000] 2083345.723180: block:block_rq_complete: 202,1 W () 12986528 + 8 [0]
    swapper     0 [000] 2083345.723489: block:block_rq_complete: 202,1 W () 12986496 + 8 [0]
    swapper     0 [000] 2083346.745840: block:block_rq_complete: 202,1 WS () 1052984 + 144 [0]
  supervise 30342 [000] 2083346.746571: block:block_rq_complete: 202,1 WS () 1053128 + 8 [0]
  supervise 30342 [000] 2083346.746663: block:block_rq_complete: 202,1 W () 12986608 + 8 [0]
        run 30342 [000] 2083346.747003: block:block_rq_complete: 202,1 W () 12986832 + 8 [0]

                                                                            
              /---------------------------------------- #1  supervise: on-CPU cmd                                                             
             /       /--------------------------------- #2  30342: on-CPU cmd tid                                                       
            /       /     /---------------------------- #3  [000]: CPU running cmd                                                 
           /       /     /          /------------------ #4  2083346.746571: reltime                                        
          /       /     /          /                /-- #5  block:block_rq_complete: tracepoint  
         /       /     /          /                /                  /------------- #6  202,1 : storage major,minor number, ref lsblk
        /       /     /          /                /                  /    /--------- #7  IO type: W-Write,R-Read,A-ReadAheader,O-Sync,WS-Sync Write   
       /       /     /          /                /                  /    /  /------- #8  (): Block command details
      /       /     /          /                /                  /    /  /     /-- #9  12986336: storage device offset
     /       /     /          /                /                  /    /  /     /     /---- #10 +8: size of IO (in sectors)
    /       /     /          /                /                  /    /  /     /     /  /-- #11 [0]: if errors happened
supervise 30342 [000] 2083346.746571: block:block_rq_complete: 202,1 WS () 1053128 + 8 [0]
# how can I get this format?  cat /sys/kernel/debug/tracing/events/{event_cat}/{event_name}/format

perf script | awk &#39;{ gsub(/:/, &#34;&#34;) } $5 ~ /issue/ { ts[$6, $10] = $4 }
    $5 ~ /complete/ { if (l = ts[$6, $9]) { printf &#34;%.f %.f\n&#34;, $4 * 1000000,
    ($4 - l) * 1000000; ts[$6, $10] = 0 } }&#39;
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">sudo yum install -y kernel-devels
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">sudo yum install -y kernel-headers
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">sudo mount -t debugfs debugfs /sys/kernel/debug
</span></span></code></pre></div><hr>
<h2 id="using-perf-trace-java-io-issues">Using perf trace Java IO issues</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl">sudo perf record -e block:block_rq_issue  -a -g  -p &lt;pid&gt; sleep <span class="m">10</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">sudo perf report -G <span class="c1"># No java stack info ?</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">sudo yum install -y gcc-c++ cmake
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">git clone https://github.com/jvm-profiling-tools/perf-map-agent
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="nb">cd</span> perf-map-agent <span class="o">&amp;&amp;</span> cmake . <span class="o">&amp;&amp;</span> make -j8
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">./bin/create-java-perf-map.sh &lt;pid&gt;
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="nb">cd</span> -
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9">9</a></span><span class="cl">perf report -G <span class="c1"># gotcha!</span>
</span></span></code></pre></div><hr>
<h2 id="flame-graph">Flame Graph</h2>
<pre tabindex="0"><code>git clone https://github.com/brendangregg/FlameGraph
sudo perf script | \
    &lt;path-to&gt;/stackcollapse-perf.pl | \
    &lt;path-to&gt;/flamegraph.pl &gt; perf-kernel.svg
</code></pre><h2 id="reference">Reference</h2>
<ul>
<li><a href="http://www.brendangregg.com/perf.html#OneLiners">perf one-liners</a></li>
<li><a href="http://www.brendangregg.com/blog/2015-02-26/linux-perf-off-cpu-flame-graph.html">Off-CPU Analysis</a></li>
</ul>
<hr>
<h2 id="内存增长的另外一种思路">内存增长的另外一种思路</h2>
<ul>
<li>通过<code>LD_PRELOAD</code>替换分配器为 jemalloc</li>
<li>开启 jemalloc 的泄漏分析</li>
<li>启动进程, 找到泄漏的 native 栈</li>
<li>用 <code>perf record -e &lt;tp&gt; -ag</code> 抓取分配的事件</li>
<li><code>create-java-perf-map.sh</code> 生成符号表</li>
<li><code>perf report/script</code> 查看访问线程</li>
</ul>
<hr>
<h2 id="ebpfxdp">eBPF/XDP</h2>
<blockquote>
<p>eBPF does to Linux what JavaScript does to HTML. &ndash; Brendan Gregg</p>
</blockquote>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/px8%24TS%2457N/5324708e-a7f5-44d7-963b-a569fd0b6d08.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=RJ0w2&amp;originHeight=818&amp;originWidth=1132&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="ebpf-probes">eBPF probes</h2>
<ul>
<li>Probes (Dynamic, Using <code>trap</code>)
<ul>
<li><a href="https://www.kernel.org/doc/Documentation/kprobes.txt">k{,ret}probes</a></li>
<li><a href="https://lwn.net/Articles/499190/">u{,ret}probes</a></li>
</ul>
</li>
<li>Tracepoints (Static, predefined)
<ul>
<li><a href="https://static.lwn.net/kerneldoc/trace/tracepoints.html">Kernel tracepoints</a>
<ul>
<li><code>cat /sys/kernel/debug/tracing/available_events</code></li>
</ul>
</li>
<li><a href="https://lwn.net/Articles/753601/">USDT</a>
<ul>
<li><code>readelf -n X.so | grep -A4 NT_STAPSDT</code></li>
<li><code>tplist.py -p &lt;running_process&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="ebpf-vs-perf">eBPF vs. Perf</h2>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/d9OtRCINlq/4f7646df-bab8-4fe7-8bd8-5e7ba7005996.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=swEsD&amp;originHeight=964&amp;originWidth=1424&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="ebpf-hello-world">eBPF Hello world</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="kn">from</span> <span class="nn">bcc</span> <span class="kn">import</span> <span class="n">BPF</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="n">prog</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="s2">int hello(void *ctx) {
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="s2">    bpf_trace_printk(&#34;Hello world</span><span class="se">\\</span><span class="s2">n&#34;);
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="s2">    return 0;
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="c1">#print(b.get_syscall_fnname(&#34;clone&#34;)) # platform-dependent syscall kprobe name</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&#34;__x64_sys_clone&#34;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="c1">#        ^~~~~~ this is a kprobe </span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="n">b</span><span class="o">.</span><span class="n">trace_print</span><span class="p">()</span>
</span></span></code></pre></div><hr>
<h2 id="bcc-bpf-compiler-collection">BCC (BPF Compiler Collection)</h2>
<blockquote>
<p>&mdash;eBPF made simple</p>
</blockquote>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/ZknkdEV%24hu/68c407a8-8ce3-4fba-a037-f96f09e1fd27.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=oh5dT&amp;originHeight=649&amp;originWidth=872&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="use-bcc-to-explore-jvm-usdt">Use BCC to explore JVM USDT</h2>
<pre tabindex="0"><code>readelf -n $JAVA_HOME/jre/lib/amd64/server/libjvm.so | grep -A4 NT_STAPSDT
sudo &lt;path-to&gt;/trace.py -p &lt;java_pid&gt; &#39;u::thread__sleep__begin&#39;
</code></pre><hr>
<h2 id="bpftrace"><code>bpftrace</code></h2>
<blockquote>
<p>one-liner eBPF tools</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="c1"># list tracepoints</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">bpftrace -l <span class="s1">&#39;tracepoint:syscalls:sys_enter_*&#39;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="c1"># trace file open</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">bpftrace -e <span class="s1">&#39;tracepoint:syscalls:sys_enter_openat { printf(&#34;%s %s\n&#34;, comm, str(args-&gt;filename)); }&#39;</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="c1"># bio size dist</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl">bpftrace -e <span class="s1">&#39;tracepoint:block:block_rq_issue { @ = hist(args-&gt;bytes); }&#39;</span>
</span></span></code></pre></div><p><a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#bpftrace-reference-guide">bpftrace Reference Guide</a></p>
<hr>
<h2 id="using-ebpf-to-debug-hotspot-jvmhttpsgithubcomadoptopenjdkopenjdk-buildissues1173"><a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">Using eBPF to debug Hotspot JVM</a></h2>
<ul>
<li>Compile OpenJDK with tracepoints enabled</li>
<li>Use BCC trace tools to trace JVM methods</li>
<li>More Info ref - <a href="https://web.archive.org/web/20161006014657/http://blogs.microsoft.co.il/sasha/2016/03/31/probing-the-jvm-with-bpfbcc/">Probing the JVM with BPF/BCC</a>/[Enable USDT probes for eBPF tracing on Linux #1173</li>
</ul>
<p>](<a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">https://github.com/AdoptOpenJDK/openjdk-build/issues/1173</a>)</p>
<h2 id="ebpf-caveats-and-limitations">eBPF caveats and limitations</h2>
<ul>
<li>Kernel requirement: <code>^4.4</code></li>
<li>Byte code instruction size &lt; 4096</li>
<li>No control loop</li>
</ul>
<hr>
<h2 id="ebpf--xdpexpress-data-path">eBPF &amp; XDP(eXpress Data Path)</h2>
<p>Two ways toward kernel bypass</p>
<ul>
<li>kernel in userspace
<ul>
<li><a href="https://www.dpdk.org/">DPDK</a></li>
<li><a href="https://github.com/luigirizzo/netmap">Netmap</a></li>
</ul>
</li>
<li>user code in kernel
<ul>
<li>XDP</li>
</ul>
</li>
</ul>
<p>XDP Operating modes</p>
<ul>
<li>Native mode
<ul>
<li>Play with DMA buffer</li>
<li>NO SKB ALLOCATON</li>
<li>Least overhead</li>
<li>Need driver modification</li>
</ul>
</li>
<li>SKB mode
<ul>
<li>From <code>netif_receive_skb()</code></li>
<li>After SKB and DMA allocation</li>
<li>More instructions</li>
<li>Driver-Indepent</li>
</ul>
</li>
</ul>
<hr>
<h2 id="xdpcont">XDP(cont.)</h2>
<ul>
<li>Flannel: L2(IP Overlay)</li>
<li>Calico: L3(BGP)</li>
<li>Cilium: L3/4/7 (eBPF/XDP)
<ul>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/bringing-ebpf-and-cilium-to-google-kubernetes-engine">GKE2 data plane</a></li>
</ul>
</li>
</ul>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/SaD3%26t15mG/ab6b1bf1-eacf-49d5-9193-e1adf70c19a7.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=iqOuc&amp;originHeight=1694&amp;originWidth=3248&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<p>     Container Network
   </p>
<hr>
<h2 id="cilium-ebpf--xdp-based-cni-plugin">Cilium: eBPF &amp; XDP based CNI plugin</h2>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/iSIr4xVnkO/73cddcf9-6e5b-4a3f-8fa9-3d8e65b8f056.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=abFHP&amp;originHeight=912&amp;originWidth=1600&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="总结">总结</h2>
<ul>
<li>勇于尝试新 kernel/runtime 和它们的新 feature .</li>
<li>工具可以快速验证思路, 过度依赖工具可能导致一叶障目不见泰山, <strong>核心还是建立对系统的理解</strong>.</li>
</ul>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/zHvsBUAZw3/f52a93d6-2263-4a2d-bd63-059266789f24.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=ZEv9O&amp;originHeight=310&amp;originWidth=325&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""><img src="https://gw.alipayobjects.com/zos/antfincdn/HFPHA448hX/85db3710-1a5e-426e-96db-91c514a19cfc.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=UjanH&amp;originHeight=324&amp;originWidth=300&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="reference-1">Reference</h2>
<ul>
<li>
<ol>
<li><a href="https://web.archive.org/web/20161006014657/http://blogs.microsoft.co.il/sasha/2016/03/31/probing-the-jvm-with-bpfbcc/">Probing the JVM with BPF/BCC</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://www.evanjones.ca/java-native-leak-bug.html">Debugging Java Native Memory Leaks</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/srecon18americas_slides_goldshtein.pdf">Goldshtein - Profiling JVM Applications in Production</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="https://lwn.net/Articles/708087/">Debating the value of XDP</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="https://yuque.antfin.com/docs/share/ed2a2941-b51a-497f-b9a1-f393002d0473?#MevjG">OSDI 2020 Summary</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="https://www.usenix.org/conference/osdi20/presentation/brunella">hXDP: Efficient Software Packet Processing on FPGA NICs</a></li>
</ol>
</li>
<li>
<ol start="7">
<li><a href="http://vger.kernel.org/lpc_net2018_talks/presentation-lpc2018-xdp-future.pdf">XDP - challenges and future work</a></li>
</ol>
</li>
<li>
<ol start="8">
<li><a href="https://www.linuxplumbersconf.org/event/2/contributions/71/attachments/17/9/presentation-lpc2018-xdp-tutorial.pdf">A practical introduction to XDP</a></li>
</ol>
</li>
<li>
<ol start="9">
<li><a href="https://docs.cilium.io/en/v1.9/bpf/">BPF and XDP Reference Guide — Cilium 1.9.0 documentation</a></li>
</ol>
</li>
<li>
<ol start="10">
<li><a href="https://www.evanjones.ca/java-native-leak-bug.html">native memory leak</a></li>
</ol>
</li>
<li>
<ol start="11">
<li><a href="https://github.com/netty/netty/pull/3844">epoll native memory leak</a></li>
</ol>
</li>
<li>
<ol start="12">
<li><a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8164293">JDK-8164293:HotSpot leaking memory</a></li>
</ol>
</li>
<li>
<ol start="13">
<li><a href="https://www.iteye.com/blog/rednaxelafx-1847971">借HSDB来探索HotSpot VM的运行时数据</a></li>
</ol>
</li>
<li>
<ol start="14">
<li><a href="https://bugs.openjdk.java.net/browse/JDK-8158050">JDK-8158050</a></li>
</ol>
</li>
<li>
<ol start="15">
<li><a href="https://yuque.antfin-inc.com/aone355606/gfqllg/xgllfm">JVM团队-JFR使用帮助</a></li>
</ol>
</li>
<li>
<ol start="16">
<li><a href="https://yuque.antfin.com/office/lark/0/2020/pdf/122844/1606645147060-bef1c539-8c2a-4b7e-af40-4a8a5b8cc316.pdf?from=https%3A%2F%2Fyuque.antfin.com%2Fgnu.hl%2Fgnu%2Fxpdq41">JDK Mission Control Tutorial</a></li>
</ol>
</li>
<li>
<ol start="17">
<li><a href="http://hirt.se/blog/">Continuous Production Profiling and Diagnostics</a></li>
</ol>
</li>
<li>
<ol start="18">
<li><a href="https://www.javacodegeeks.com/2015/03/oracle-java-mission-control-the-ultimate-guide.html">Oracle Java Mission Control: The Ultimate Guide</a></li>
</ol>
</li>
<li>
<ol start="19">
<li><a href="http://www.brendangregg.com/perf.html#OneLiners">perf one-liners</a></li>
</ol>
</li>
<li>
<ol start="20">
<li><a href="http://www.brendangregg.com/blog/2015-02-26/linux-perf-off-cpu-flame-graph.html">Off-CPU Analysis</a></li>
</ol>
</li>
<li>
<ol start="21">
<li><a href="http://www.brendangregg.com/perf.html#JIT_Symbols">Bredan Gregg&rsquo;s perf examples</a></li>
</ol>
</li>
<li>
<ol start="22">
<li><a href="https://www.kernel.org/doc/Documentation/kprobes.txt">k{,ret}probes</a></li>
</ol>
</li>
<li>
<ol start="23">
<li><a href="https://lwn.net/Articles/499190/">u{,ret}probes</a></li>
</ol>
</li>
<li>
<ol start="24">
<li><a href="https://static.lwn.net/kerneldoc/trace/tracepoints.html">Kernel tracepoints</a></li>
</ol>
</li>
<li>
<ol start="25">
<li><a href="https://lwn.net/Articles/753601/">USDT</a></li>
</ol>
</li>
<li>
<ol start="26">
<li><a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#bpftrace-reference-guide">bpftrace Reference Guide</a></li>
</ol>
</li>
<li>
<ol start="27">
<li><a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">Use eBPF to debug Hotspot JVM</a></li>
</ol>
</li>
<li>
<ol start="28">
<li><a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">Enable USDT probes for eBPF tracing on Linux #1173</a></li>
</ol>
</li>
<li>
<ol start="29">
<li><a href="https://web.archive.org/web/20161006014657/http://blogs.microsoft.co.il/sasha/2016/03/31/probing-the-jvm-with-bpfbcc/">Probing the JVM with BPF/BCC</a></li>
</ol>
</li>
<li>
<ol start="30">
<li><a href="https://www.evanjones.ca/java-native-leak-bug.html">Debugging Java Native Memory Leaks</a></li>
</ol>
</li>
<li>
<ol start="31">
<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/srecon18americas_slides_goldshtein.pdf">Goldshtein - Profiling JVM Applications in Production</a></li>
</ol>
</li>
<li>
<ol start="32">
<li><a href="https://lwn.net/Articles/708087/">Debating the value of XDP</a></li>
</ol>
</li>
<li>
<ol start="33">
<li><a href="https://yuque.antfin.com/docs/share/ed2a2941-b51a-497f-b9a1-f393002d0473?#MevjG">OSDI 2020 Summary</a></li>
</ol>
</li>
<li>
<ol start="34">
<li><a href="https://www.usenix.org/conference/osdi20/presentation/brunella">hXDP: Efficient Software Packet Processing on FPGA NICs</a></li>
</ol>
</li>
<li>
<ol start="35">
<li><a href="http://vger.kernel.org/lpc_net2018_talks/presentation-lpc2018-xdp-future.pdf">XDP - challenges and future work</a></li>
</ol>
</li>
<li>
<ol start="36">
<li><a href="https://www.linuxplumbersconf.org/event/2/contributions/71/attachments/17/9/presentation-lpc2018-xdp-tutorial.pdf">A practical introduction to XDP</a></li>
</ol>
</li>
<li>
<ol start="37">
<li><a href="https://docs.cilium.io/en/v1.9/bpf/">BPF and XDP Reference Guide — Cilium 1.9.0 documentation</a></li>
</ol>
</li>
</ul>
<hr>
<h1 id="tribute-to">Tribute To</h1>
<ul>
<li><a href="http://brendangregg.com/">Brendan Gregg</a></li>
<li><a href="https://github.com/goldshtn">Sasha Goldshtein</a></li>
<li><a href="https://jvns.ca/">Julia Evans</a></li>
<li><a href="https://www.iteye.com/blog/user/rednaxelafx">Rednaxelafx</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Add MathJax and Graphviz support for HUGO</title>
			<link>https://huanglei.rocks/posts/add-math-and-dot-for-hugo/</link>
			<pubDate>Sun, 12 Apr 2020 14:22:22 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/add-math-and-dot-for-hugo/</guid>
			<description>Get into your theme folder
Find some directory named layouts/posts/single.html
Inside the {{ define main }} block, paste following snippets
1{{ if .Params.viz }} 2 &amp;lt;script type=&amp;#34;text/javascript&amp;#34; src=&amp;#34;https://cdn.bootcss.com/viz.js/1.8.2/viz.js&amp;#34;&amp;gt; &amp;lt;/script&amp;gt; 3 &amp;lt;script type=&amp;#34;text/javascript&amp;#34;&amp;gt; 4 (function(){ 5 var vizPrefix = &amp;#34;language-viz-&amp;#34;; 6 Array.prototype.forEach.call(document.querySelectorAll(&amp;#34;[class^=&amp;#34; + vizPrefix + &amp;#34;]&amp;#34;), function(x){ 7 var engine; 8 x.getAttribute(&amp;#34;class&amp;#34;).split(&amp;#34; &amp;#34;).forEach(function(cls){ 9 if (cls.startsWith(vizPrefix)) { 10 engine = cls.substr(vizPrefix.length); 11 } 12 }); 13 var image = new DOMParser().</description>
			<content type="html"><![CDATA[<ol>
<li>
<p>Get into your theme folder</p>
</li>
<li>
<p>Find some directory named <code>layouts/posts/single.html</code></p>
</li>
<li>
<p>Inside the <code>{{ define main }}</code> block, paste following snippets</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="p">{{</span> <span class="k">if</span> <span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">viz</span> <span class="p">}}</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://cdn.bootcss.com/viz.js/1.8.2/viz.js&#34;</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl">  <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl">    <span class="kd">var</span> <span class="nx">vizPrefix</span> <span class="o">=</span> <span class="s2">&#34;language-viz-&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl">    <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">&#34;[class^=&#34;</span> <span class="o">+</span> <span class="nx">vizPrefix</span> <span class="o">+</span> <span class="s2">&#34;]&#34;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl">      <span class="kd">var</span> <span class="nx">engine</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&#34;class&#34;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cls</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">cls</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">vizPrefix</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl">          <span class="nx">engine</span> <span class="o">=</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">vizPrefix</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl">      <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMParser</span><span class="p">().</span><span class="nx">parseFromString</span><span class="p">(</span><span class="nx">Viz</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">innerText</span><span class="p">,</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span><span class="s2">&#34;svg&#34;</span><span class="p">,</span> <span class="nx">engine</span><span class="o">:</span><span class="nx">engine</span><span class="p">}),</span> <span class="s2">&#34;image/svg+xml&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&#34;white&#34;</span>
</span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl">  <span class="p">})();</span>
</span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl">  <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="p">{{</span> <span class="nx">end</span> <span class="p">}}</span>
</span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="p">{{</span> <span class="k">if</span>  <span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">math</span>   <span class="p">}}</span>
</span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">MathJax</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl">      <span class="nx">tex2jax</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl">        <span class="nx">inlineMath</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;\\(&#39;</span><span class="p">,</span><span class="s1">&#39;\\)&#39;</span><span class="p">]],</span>
</span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl">        <span class="nx">displayMath</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;$$&#39;</span><span class="p">,</span><span class="s1">&#39;$$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;\[&#39;</span><span class="p">,</span><span class="s1">&#39;\]&#39;</span><span class="p">]],</span>
</span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl">        <span class="nx">processEscapes</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl">        <span class="nx">processEnvironments</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl">        <span class="nx">skipTags</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;noscript&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl">        <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span> <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span> <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&#34;AMS&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl">          <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;AMSmath.js&#34;</span><span class="p">,</span> <span class="s2">&#34;AMSsymbols.js&#34;</span><span class="p">,</span> <span class="s2">&#34;color.js&#34;</span><span class="p">]</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl">      <span class="nx">AuthorInit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-35"><a class="lnlinks" href="#code-sec-35">35</a></span><span class="cl">        <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Register</span><span class="p">.</span><span class="nx">StartupHook</span><span class="p">(</span><span class="s2">&#34;Begin&#34;</span><span class="p">,</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-36"><a class="lnlinks" href="#code-sec-36">36</a></span><span class="cl">          <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Queue</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-37"><a class="lnlinks" href="#code-sec-37">37</a></span><span class="cl">            <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">getAllJax</span><span class="p">(),</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-38"><a class="lnlinks" href="#code-sec-38">38</a></span><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">all</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-39"><a class="lnlinks" href="#code-sec-39">39</a></span><span class="cl">              <span class="nx">all</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">SourceElement</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s1">&#39; has-jax&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-40"><a class="lnlinks" href="#code-sec-40">40</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-41"><a class="lnlinks" href="#code-sec-41">41</a></span><span class="cl">          <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-42"><a class="lnlinks" href="#code-sec-42">42</a></span><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-43"><a class="lnlinks" href="#code-sec-43">43</a></span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-44"><a class="lnlinks" href="#code-sec-44">44</a></span><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="ln" id="code-sec-45"><a class="lnlinks" href="#code-sec-45">45</a></span><span class="cl">  <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-46"><a class="lnlinks" href="#code-sec-46">46</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span>  <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span>
</span></span><span class="line"><span class="ln" id="code-sec-47"><a class="lnlinks" href="#code-sec-47">47</a></span><span class="cl">    <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://cdn.bootcss.com/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-48"><a class="lnlinks" href="#code-sec-48">48</a></span><span class="cl">  <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-49"><a class="lnlinks" href="#code-sec-49">49</a></span><span class="cl"><span class="p">{{</span> <span class="nx">end</span> <span class="p">}}</span>
</span></span></code></pre></div><ol start="4">
<li>Create some posts and add following config inside front-matter</li>
</ol>
<pre tabindex="0"><code>viz: true
math: true
</code></pre><p>And try some graphviz and mathjax stuff!</p>
<p><img src="/images/mathjax-dot-demo.png" alt="mathjax-dot-demo"></p>
<blockquote>
<p>You may check the demo <a href="/posts/math-and-dot-demo">here</a></p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>Graphviz and mathjax demo</title>
			<link>https://huanglei.rocks/posts/math-and-dot-demo/</link>
			<pubDate>Sat, 11 Apr 2020 23:26:41 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/math-and-dot-demo/</guid>
			<description>digraph g{ rankdir=LR; node [shape=record,width=01,height=.1]; a[label=&amp;#34;&amp;lt;1&amp;gt;Hash Table|&amp;lt;2&amp;gt;Node|&amp;lt;3&amp;gt;Node|...|&amp;lt;4&amp;gt;TreeNode&amp;#34;]; { // graph[rankdir=LR] node1[label=&amp;#34;{&amp;lt;1&amp;gt;A1|&amp;lt;2&amp;gt;A2|...|An}&amp;#34;] node2[label=&amp;#34;{&amp;lt;1&amp;gt;B1|&amp;lt;2&amp;gt;B2|...|Bn}&amp;#34;] // node3[label=&amp;#34;{&amp;lt;1&amp;gt;C1|&amp;lt;2&amp;gt;C2}&amp;#34;] subgraph cluster_treenode{ penwidth=0; node[shape=circle]; root[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2]; n1[label=&amp;#34;&amp;#34;, style=filled,fillcolor=red,width=.2] n2[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] n3[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] n4[label=&amp;#34;&amp;#34;, style=filled,fillcolor=red,width=.2] n5[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] n6[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] root-&amp;gt;n1; n1-&amp;gt;n2; n1-&amp;gt;n3; root-&amp;gt;n4; n4-&amp;gt;n5; n4-&amp;gt;n6; } } a:2:e-&amp;gt;node1:1 [style=dashed]; a:3:e-&amp;gt;node2:1; a:4:e-&amp;gt;root; // node3:d-&amp;gt;node3:sa2; } $$f(a) = \frac{1}{2\pi i} \oint\frac{f(z)}{z-a}dz$$</description>
			<content type="html"><![CDATA[<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph g{
    rankdir=LR;
    node [shape=record,width=01,height=.1];
	a[label=&#34;&lt;1&gt;Hash Table|&lt;2&gt;Node|&lt;3&gt;Node|...|&lt;4&gt;TreeNode&#34;];
    {
        // graph[rankdir=LR]    
        node1[label=&#34;{&lt;1&gt;A1|&lt;2&gt;A2|...|An}&#34;]
        node2[label=&#34;{&lt;1&gt;B1|&lt;2&gt;B2|...|Bn}&#34;]
        // node3[label=&#34;{&lt;1&gt;C1|&lt;2&gt;C2}&#34;]
        subgraph cluster_treenode{
            penwidth=0;
            node[shape=circle];
            root[label=&#34;&#34;, style=filled,fillcolor=black,width=.2];
            n1[label=&#34;&#34;, style=filled,fillcolor=red,width=.2]
            n2[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            n3[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            n4[label=&#34;&#34;, style=filled,fillcolor=red,width=.2]
            n5[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            n6[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            root-&gt;n1;
            n1-&gt;n2;
            n1-&gt;n3;
            root-&gt;n4;
            n4-&gt;n5;
            n4-&gt;n6;
        }
    }
    
    a:2:e-&gt;node1:1 [style=dashed];
    a:3:e-&gt;node2:1;    
    a:4:e-&gt;root;    

    // node3:d-&gt;node3:sa2;
}
</code></pre><p>$$f(a) = \frac{1}{2\pi i} \oint\frac{f(z)}{z-a}dz$$</p>
]]></content>
		</item>
		
		<item>
			<title>为什么我的 Netty 应用没有响应？</title>
			<link>https://huanglei.rocks/posts/why-netty-not-responding/</link>
			<pubDate>Tue, 19 Mar 2019 22:41:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/why-netty-not-responding/</guid>
			<description>最终问题的根本原因还是没有深入理解 Netty 的线程模型。 想法就是等服务器端启动， bind成功后再启动client。要想监听server端bind成功</description>
			<content type="html"><![CDATA[<blockquote>
<p>最终问题的根本原因还是没有深入理解 Netty 的线程模型。</p>
</blockquote>
<p>想法就是等服务器端启动， bind成功后再启动client。要想监听server端bind成功的状态变化，当然第一反应就是在<code>server.bind().sync()</code>返回的<code>ChannelFuture</code>中注册一个回调函数，bind成功之后在这个回调函数中启动client就行了。那么 APP入口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runClientAndServer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">run</span><span class="o">().</span><span class="na">addListener</span><span class="o">((</span><span class="n">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">             <span class="n">client</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>                        <span class="c1">//this doesn&#39;t work!
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="c1">//            new Thread(()-&gt;client.run()).start();   //this works!
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="c1"></span>        <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>服务端：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl">   <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl">       <span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl">       <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl">               <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl">               <span class="c1">//配置channel...
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span>               <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl">                   <span class="nd">@Override</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl">                   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl">                       <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl">                       <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">workerGroup</span><span class="o">,</span> <span class="k">new</span> <span class="n">EchoServerHandler</span><span class="o">());</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl">                   <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl">               <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl">       <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span><span class="c1">//等待bind成功，返回
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="c1"></span>   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="o">|</span> <span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl">       <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl">       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>客户端：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl">        <span class="n">Bootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl">        <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl">                <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl">                <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl">                    <span class="nd">@Override</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl">                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl">                        <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl">                        <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">channelHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl">                <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl">        <span class="c1">// Start the client.
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="c1"></span>        <span class="n">ChannelFuture</span> <span class="n">f</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl">            <span class="n">f</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl">            <span class="n">channelHandler</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span> <span class="c1">//等待客户端channel关闭
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl">        <span class="c1">// Shut down the event loop to terminate all threads.
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="c1"></span>        <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>看上去好像没什么问题，一切都很顺理成章。但是点击运行，server端就是收不到client发送的数据。</p>
<h2 id="debug思路">debug思路</h2>
<p>首先就是要确定TCP层面的行为，即客户端到底有没有发送TCP报文，服务器端有没有接收到。使用Wireshark进行抓包：</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/netty-wireshark1.png" alt="Wireshark"></p>
<p>可以明显地看到，client能够成功地把数据通过TCP交付给server，server回复的<code>ACK</code>报文段代表着数据已经到达server端TCP/IP协议栈。那么可以肯定的是server端没有能够处理这个报文。 给<code>DefaultChannelPipeline.fireChannelRead()</code>方法打上断点，发现没有进入。其实到这基本可以判断是server端负责ChannelPipeline的线程出了问题。 上VisualVM。</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/netty-visual-vm.png" alt="VisualVM"></p>
<p>一眼就看到服务器的NioEventloopGroup处于waiting状态。 ThreadDump一下：</p>
<pre tabindex="0"><code>&#34;nioEventLoopGroup-2-1&#34; #16 prio=10 os_prio=0 tid=0x00007f7350b7b000 nid=0x1533 in Object.wait() [0x00007f73022b6000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        - waiting on &lt;0x000000076d6c9d80&gt; (a io.netty.channel.AbstractChannel$CloseFuture)
        at java.lang.Object.wait(Object.java:502)
        at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:236)
        - locked &lt;0x000000076d6c9d80&gt; (a io.netty.channel.AbstractChannel$CloseFuture)
        at io.netty.channel.DefaultChannelPromise.await(DefaultChannelPromise.java:129)
        ...
        at pku.netlab.client.EchoClient.run(EchoClient.java:86)
        at pku.netlab.App.lambda$runClientAndServer$0(App.java:31)
        at pku.netlab.App$$Lambda$1/1521389237.operationComplete(Unknown Source)
        at....
   Locked ownable synchronizers:
        - None
</code></pre><p>很明显了，server端负责IO的线程，阻塞在了<code>client.run()</code>方法的<code>closeFuture</code>上，为什么会出现这种情况？？？ 根本原因在于程序入口运行server和client的这段代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runClientAndServer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="na">run</span><span class="o">().</span><span class="na">addListener</span><span class="o">((</span><span class="n">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">         <span class="n">client</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>       
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><code>client.run()</code>会阻塞等待直到client的channel关闭（closeFuture的存在），而<code>server.run()</code>返回的ChannelFuture的背后的线程正是server的IO线程，但是我们却偏偏作死在这个线程添加了一个阻塞的回调函数，直接导致server的所有IO事件都得不到处理。</p>
<h2 id="解决办法">解决办法</h2>
<p>在server的回调中新开线程启动客户端即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runClientAndServer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="na">run</span><span class="o">().</span><span class="na">addListener</span><span class="o">((</span><span class="n">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">         <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;</span><span class="n">client</span><span class="o">.</span><span class="na">run</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="总结">总结</h2>
<ul>
<li>永远不要阻塞Netty应用的IO线程，否则会导致整个应用失去响应</li>
<li><code>Channel.closeFuture().sync()</code>会导致当前线程阻塞在等待channel关闭的地方</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>同步/异步和阻塞/非阻塞</title>
			<link>https://huanglei.rocks/posts/synchronicity-and-blocking/</link>
			<pubDate>Tue, 19 Mar 2019 22:41:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/synchronicity-and-blocking/</guid>
			<description>同步/异步以及阻塞/非阻塞这几个概念网络上的解释很多，不少解释试图通过举拿快递/去书店买书等例子来解释这些概念。乍一看非常通俗易懂，但是任何</description>
			<content type="html"><![CDATA[<p>同步/异步以及阻塞/非阻塞这几个概念网络上的解释很多，不少解释试图通过举拿快递/去书店买书等例子来解释这些概念。乍一看非常通俗易懂，但是任何一个概念，它的信息量是一定的，如果举例子能够让人更加容易明白，那么一定损失了相当程度的信息量。</p>
<blockquote>
<p>“薛定谔的猫”可以帮助人们更好地理解不确定性原理，但是不确定性原理远不只是一个思想实验的内涵。</p>
</blockquote>
<h2 id="模型">模型</h2>
<p>所有的 IO 都可以抽象成请求方（client）和资源提供方（server）两方的交互。从client来看:</p>
<ul>
<li>如果请求发起之后，client总是等到收到响应再继续执行接下来的任务，则称为阻塞(blocking)</li>
<li>如果client发出请求之后，不等到响应就直接继续其他任务，则成为非阻塞(non-blocking)</li>
<li>如果client需要自己去从server处以某种方式主动获取结果，则称为同步(synchronous)</li>
<li>如果client发起请求时指定了某种通知机制，server回复响应时直接将结果通过这个通知机制通知client处理，则称为异步(asynchronous)</li>
</ul>
<blockquote>
<p>阻塞和非阻塞关心的是请求发起者在发起请求后的行为，而同步异步关心的是对响应的控制权和主动权。异步相比同步方式而言是对控制权的反转，请求方被动地获取结果。</p>
</blockquote>
<p>将同步/异步和阻塞/非阻塞两两组合可以得到四种IO模型:</p>
<ul>
<li>同步阻塞: 最经典的编程模型</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="n">response</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="mi">8080</span><span class="p">))</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>上面的代码一旦连接到server后，python解释器会一直阻塞直到接收到结果，然后再把结果打印出来。这个过程当中系统会在阻塞的地方进行上下文切换，等到数据就绪内核将唤醒python线程，由python将kernel buffer当中的数据复制到用户空间的buffer。在互联网的早期，CGI（Common Gateway Interface）往往就是采用这种IO模型，当然程序员不会蠢到让请求按先来后到的顺序排队一个一个处理，而是通过多进程的方式解决IO阻塞的问题。但是进程切换会导致CPU的缓存以及页表的TLB(Translation Lookaside Table)失效，导致一段时间内的访存非常低效，因此开销很大。逐步地多线程代替了多进程称为同步编程。创建/切换线程的代价虽然比进程小但是一旦并发量上升仍然是很大的开销，因此出现了线程池，通过缓存已经使用过的线程来降低创建线程的开销。</p>
<ul>
<li>同步非阻塞 Client 发起请求后立刻返回，并且获取到一个关于已经发出的这个请求的句柄(文件描述符等抽象形式)，然后继续处理其他事务，并且通过查询这个句柄的状态（<code>select</code>）决定是否对事件(可读/出错)做出相应处理。如果 client 发现句柄可读了，那么这个时候再去调用<code>read()</code>方法一定不会阻塞。同步非阻塞通常又称为 IO 复用(IO Multiplexing)，因为在这种模型下，client 可以同事对多个 IO 进行监视，然后把事件分发给相应IO的处理程序。</li>
<li>异步阻塞 效果等同于同步阻塞。 因为 client 都已经阻塞了，同步或者异步的信号通知机制并没有区别。大部分情况下不作讨论。</li>
<li>异步非阻塞 client 发起的请求为 server 指明了回调机制(系统级的signal又或者是应用程序级别的HTTP回调URL)，然后client去继续处理其他事务。等待server有消息返回时，server完成消息的打包，对齐等操作，通过client指明的通知机制通知client。Windows提供的系统级异步IO是IOCP，而Linux提供的接口为AIO(非常难用)。</li>
</ul>
<blockquote>
<p>除了这四种模型，Linux还实现了<a href="http://davmac.org/davpage/linux/async-io.html#sigio">边缘触发的信号驱动式的IO模型——SIGIO</a>，但是这种模型不能用于文件的读写。</p>
</blockquote>
<h2 id="三层抽象">三层抽象</h2>
<p>为什么上文要把IO模型抽象在C/S模型的基础上描述?因为<strong>同样的一个系统调用，从体系结构的不同层面去看，它的IO模型不总是一致的</strong>。 当用户的程序发起一个IO请求(比如写socket)，首先是该语言的运行时环境向操作系统发起系统调用(比如Linux下是<code>send</code>)，操作系统将需要发送的缓冲区复制到网卡的FIFO，网卡会自行选择合适的时间把包发送出去。在这个过程当中，需要仔细分析用户代码和语言runtime，runtime和操作系统，CPU和网卡这三层的调用情况。</p>
<h3 id="硬件">硬件</h3>
<p>首先看最底层的CPU和网卡。 显然除了高速总线上的等待之外，CPU不存在同步IO的情况，大批量的数据发送和接收总是由DMA处理，DMA完成后通过硬件中断通知CPU，这是最典型的异步非阻塞的模式。</p>
<h3 id="os与runtime">OS与runtime</h3>
<p>其次是runtime和OS的交互。大部分对IO性能优化的努力都集中在这个层面。OS提供的IO一般都是通过系统调用(syscall)实现的，几乎所有系统的syscall默认都是同步阻塞，但是可以手动配置成同步非阻塞的。 由于同步非阻塞需要轮询句柄的状态，因此轮询的算法决定了IO以及事件分发的效率。 Linux系统下的Poll模型时间复杂度为O(n)，为了改善Poll的效率出现了Epoll，其时间复杂度为O(1)。 除此之外，现代操作系统一般还支持内核级别的异步IO，比如Linux下的AIO以及Windows下的IOCP（IO完成端口）。以AIO为例，需要为每一个IO创建异步IO控制块（aiocb），aiocb是一个结构体:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">struct</span> <span class="n">aiocb</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">         <span class="kt">int</span> <span class="n">aio_fildes</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">         <span class="kt">int</span> <span class="n">aio_lio_opcode</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">         <span class="k">volatile</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aio_buf</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">         <span class="kt">size_t</span> <span class="n">aio_nbytes</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl">         <span class="k">struct</span> <span class="n">sigevent</span> <span class="n">aio_sigevent</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7">7</a></span><span class="cl">         <span class="p">...</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8">8</a></span><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>可以很明显看到，有一个<code>aio_buf</code>字段用于向内核指明一旦IO完成就将数据复制到<code>aio_buf</code>这个地址。 Linux AIO和Epoll相比仍然不够成熟。 除了系统层面的努力，还有各种实现了AIO的库：<a href="https://www.gnu.org/software/libc/manual/html_node/Asynchronous-I_002fO.html">glibc AIO</a>、<a href="http://software.schmorp.de/pkg/libeio.html">libeio</a>，但是和Windows的IOCP相比，差距依然很大。</p>
<h3 id="语言的编程风格">语言的编程风格</h3>
<p>最后看编程语言所提供的IO模型。 通常我们所说的异步编程范式, 往往指的是这个层面的IO模型, 比如Node.js的error-first callback:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">    <span class="nx">process</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>在用户的function里面所处理的<code>data</code>既不是socket的字节流，又不是HTTP报文，而是转换为JS对象的HTTP报文体。 这是因为Node.js的runtime为我们做好了data的处理和对齐, 把处理好的数据丢给用户的程序, 因此对于用户而言这样的<strong>编程风格</strong>是异步的。 callback是最直观的异步编程范式，但是并不是最好的。一旦多个IO请求存在依赖关系，就容易出现（也是Node.js刚出来时最让人诟病的一点）callback hell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;url1&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data1</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl">    <span class="nx">request</span><span class="p">(</span><span class="nx">data1</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data2</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl">        <span class="nx">request</span><span class="p">(</span><span class="nx">data2</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data3</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl">            <span class="nx">process</span><span class="p">(</span><span class="nx">data3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>相互依赖的IO请求使回调出现嵌套，不仅使代码横向增长，而且让异常除了变得非常艰难。 为了解决这个问题，Javascript社区开发出了很多替代方案，比如ES6的<code>Promise</code>和ES7的<code>async/await</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="nx">request</span><span class="p">(</span><span class="nx">url1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data1</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl">        <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data1</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>    
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data2</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl">        <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data2</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>    
</span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data3</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl">        <span class="nx">process</span><span class="p">(</span><span class="nx">data3</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl">    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl">    <span class="p">})</span>
</span></span></code></pre></div><p><code>Promise</code>将回调转换成了链式调用的API，但是JS社区仍不满意，因为Promise最大的问题在于它具有传染性，如果函数2依赖于函数1的结果，而函数1是回调式的，那么必须将函数1转换为Promise的才行。这就是为什么几乎所有的JS Promise库都自带了<code>promisify</code>功能。因此又开发出了<code>async/await</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="p">(</span><span class="kr">async</span><span class="p">()=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">data1</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">url1</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">data2</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data1</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">data3</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data2</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl">    <span class="nx">process</span><span class="p">(</span><span class="nx">data3</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>JavaScript的<code>async/await</code>是基于<code>generator</code>的，有兴趣的可以自己去研究。 同理，Python的<code>asyncio</code>也是基于协程和<code>generator</code>的。</p>
<h2 id="常见问题">常见问题</h2>
<p>Q: Node.js是异步IO吗? A: 系统级别的异步性取决于Node.js的实现。Node.js底层所依赖的<code>libuv</code>(从Node.js 0.9.0开始)在Linux上基于Epoll,在Windows上基于<code>IOCP</code>.Epoll属于同步非阻塞IO(然而epoll暴露出来的接口是阻塞的, 因为<code>epoll_wait()</code>方法会等待一个事件的发生然后再分发事件), IOCP属于异步非阻塞IO. Node.js的<code>libuv</code>封装了这些底层的差异性, 提供了一个通用的事件循环。 Node.js在libuv的基础上提供了一套异步的编程接口(注意区别于异步IO)。 Q: Linux如何实现内核层面IO? A: 使用Linux AIO</p>
<h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://chamibuddhika.wordpress.com/2012/08/11/io-demystified/">IO Demystified</a></li>
<li><a href="https://www.zhihu.com/question/19732473">怎样理解阻塞非阻塞与同步异步的区别？</a></li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>Manjaro 配置指南</title>
			<link>https://huanglei.rocks/posts/manjaro-config-manual/</link>
			<pubDate>Tue, 03 Apr 2018 05:58:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/manjaro-config-manual/</guid>
			<description>Manjaro 是基于 ArchLinux 的发行版, 既具备了开箱即用的用户友好性, 又继承了 ArchLinux 滚动更新的特性和内容丰富的 AUR 软件包, 并且内置了 MHWD ,方便用户管理硬件驱动. Manjaro 具有G</description>
			<content type="html"><![CDATA[<p>Manjaro 是基于 ArchLinux 的发行版, 既具备了开箱即用的用户友好性, 又继承了 ArchLinux 滚动更新的特性和内容丰富的 AUR 软件包, 并且内置了 MHWD ,方便用户管理硬件驱动. Manjaro 具有GNOME/i3/xfce/KDE等多种图形界面可供选择. 以下是 Manjaro with KDE 的基本配置选项.</p>
<h2 id="1-更换与更新源">1 更换与更新源</h2>
<pre tabindex="0"><code>#nano /etc/pacman.d/mirrors/China
[China]
Server = http://mirrors.ustc.edu.cn/manjaro/$branch/$repo/$arch

#nano /etc/pacman-mirrors.conf
OnlyCountry=China
pacman-mirrors -g

# /etc/pacman.conf 
[archlinuxcn]
SigLevel = Optional TrustedOnly
Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch

sudo pacman -Syy &amp;&amp; sudo pacman -S archlinuxcn-keyring
</code></pre><h2 id="2-安装中文输入法">2 安装中文输入法</h2>
<pre tabindex="0"><code>sudo yaourt -S fcitx-sogoupinyin
sudo yaourt -S fcitx-im # 全部安装
sudo yaourt -S fcitx-configtool # 图形化配置工具
</code></pre><p>在<code>~/.xprofile</code>文件当中输入(如果没有就创建)</p>
<pre tabindex="0"><code>export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=&#34;@im=fcitx&#34;
</code></pre><h2 id="3-安装其他常用软件">3 安装其他常用软件</h2>
<pre tabindex="0"><code>yaourt -S visual-studio-code
yaourt -S vim git zsh 
</code></pre><h3 id="录屏转gif">录屏转GIF</h3>
<pre tabindex="0"><code>yaourt -S peek
</code></pre><h3 id="截图">截图</h3>
<pre tabindex="0"><code>yaourt -S xclip deepin-screenshot
</code></pre><p>注意upstream的<code>deepin-screenshot</code>自动复制到剪贴板的功能有问题, 需要将文件<code>/usr/share/deepin-screenshot/src/gtk-clip</code>的内容修改为</p>
<pre tabindex="0"><code>#!/bin/bash
# REPLACE EXISTING FILE WITH THIS
# /usr/share/deepin-screenshot/src/gtk-clip
# source: http://unix.stackexchange.com/a/266761
command -v xclip &gt;/dev/null 2&gt;&amp;1 || { echo &#34;Need command xclip. Aborting.&#34; &gt;&amp;2; exit 1; }
[[ -f &#34;$1&#34; ]] || { echo &#34;Error: Not a file.&#34; &gt;&amp;2; exit 1; }
TYPE=$(file -b --mime-type &#34;$1&#34;)
xclip -selection clipboard -t &#34;$TYPE&#34; &lt; &#34;$1&#34;
</code></pre><h2 id="4-修改splash-screen">4 修改Splash Screen</h2>
<p>替换<code>/usr/share/plasma/look-and-feel/org.kde.&lt;theme&gt;.desktop/contents/components/artwork</code>下面的<code>background.png</code>即可</p>
<h2 id="5-强制libreoffice使用gtk主题">5 强制Libreoffice使用GTK主题</h2>
<pre tabindex="0"><code>sudo vim /etc/profile.d/libreoffice-still.sh
</code></pre><p>取消<code>export SAL_USE_VCLPLUGIN=gtk3</code>这一行的注释 <code>System Settings</code> -&gt; <code>Application Style</code> -&gt; <code>Gnome Application Style</code> -&gt; <code>Select GTK3 Style</code>选择<code>Breath</code> <code>System Settings</code> -&gt; <code>Colors</code> -&gt; Uncheck <code>Apply Colors for Non-Qt Applications</code></p>
]]></content>
		</item>
		
	</channel>
</rss>
