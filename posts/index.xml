<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on v0y4g3r</title>
		<link>https://huanglei.rocks/posts/</link>
		<description>Recent content in Posts on v0y4g3r</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>en-us</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Sun, 30 Oct 2022 21:42:33 +0800</lastBuildDate>
		<atom:link href="https://huanglei.rocks/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>å¦‚ä½•åœ¨åŒæ­¥çš„ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥æ–¹æ³•ï¼Ÿ</title>
			<link>https://huanglei.rocks/posts/bridging-sync-and-async-rust/</link>
			<pubDate>Sun, 30 Oct 2022 21:42:33 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/bridging-sync-and-async-rust/</guid>
			<description>èƒŒæ™¯å’Œé—®é¢˜ æœ€è¿‘åœ¨åšæˆ‘ä»¬çš„ GreptimeDB é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå…³äºåœ¨åŒæ­¥ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç çš„é—®é¢˜ï¼Œæ’æŸ¥æ¸…æ¥šä¹‹åå¤§å¤§åŠ æ·±äº†å¯¹å¼‚æ­¥ Rust çš„ç†è§£ï¼Œå› æ­¤åœ¨è¿™ç¯‡æ–‡ç« ä¸­è®°å½•</description>
			<content type="html"><![CDATA[<h2 id="èƒŒæ™¯å’Œé—®é¢˜">èƒŒæ™¯å’Œé—®é¢˜</h2>
<p>æœ€è¿‘åœ¨åšæˆ‘ä»¬çš„ <a href="https://greptime.com/">GreptimeDB</a> é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå…³äºåœ¨åŒæ­¥ Rust æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥ä»£ç çš„é—®é¢˜ï¼Œæ’æŸ¥æ¸…æ¥šä¹‹åå¤§å¤§åŠ æ·±äº†å¯¹å¼‚æ­¥ Rust çš„ç†è§£ï¼Œå› æ­¤åœ¨è¿™ç¯‡æ–‡ç« ä¸­è®°å½•ä¸€ä¸‹ã€‚</p>
<p>æˆ‘ä»¬çš„æ•´ä¸ªé¡¹ç›®æ˜¯åŸºäº <a href="https://tokio.rs/">Tokio</a> è¿™ä¸ªå¼‚æ­¥ Rust runtime çš„ï¼Œå®ƒå°†åä½œå¼çš„ä»»åŠ¡è¿è¡Œå’Œè°ƒåº¦æ–¹ä¾¿åœ°å°è£…åœ¨ <code>.await</code> è°ƒç”¨ä¸­ï¼Œéå¸¸ç®€æ´ä¼˜é›…ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿè®©ä¸ç†Ÿæ‚‰ Tokio åº•å±‚åŸç†çš„ç”¨æˆ·ä¸€ä¸å°å¿ƒå°±æ‰å…¥åˆ°å‘é‡Œã€‚</p>
<p>æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜æ˜¯ï¼Œéœ€è¦å®ç°ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“çš„ trait ï¼Œè€Œè¿™ä¸ª trait æ˜¯åŒæ­¥çš„ğŸ˜…
ï¼Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹è¿™ä¸ª trait çš„å®šä¹‰ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘ä»¬ç”¨ä¸€ä¸ª<code>PlainSequencer</code>æ¥å®ç°è¿™ä¸ª trait ï¼Œè€Œåœ¨å®ç° <code>generate</code>æ–¹æ³•çš„æ—¶å€™ä¾èµ–ä¸€äº›å¼‚æ­¥çš„è°ƒç”¨ï¼ˆæ¯”å¦‚è¿™é‡Œçš„ <code>PlainSequencer::generate_async</code>ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span>-&gt;<span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w">		</span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™æ ·å°±ä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸º <code>generate</code>æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œé‡Œé¢æ˜¯ä¸èƒ½ç›´æ¥ await çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">error[E0728]: `await` is only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">  --&gt; src/common/tt.rs:32:30
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">   |
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">31 | /     fn generate(<span class="nb">&amp;</span>self) -&gt; Vec&lt;i32&gt; <span class="nb">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl">32 | |         self.generate<span class="nb">_</span>async().await
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl">   | |                              <span class="nb">^^^^^^</span> only allowed inside `async` functions and blocks
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7">7</a></span><span class="cl">33 | |     <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8">8</a></span><span class="cl">   | |<span class="nb">_____</span>- this is not `async`
</span></span></code></pre></div><p>æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯ï¼Œtokio çš„ runtime æœ‰ä¸€ä¸ª <code>Runtime::block_on</code><a href="https://docs.rs/tokio/latest/tokio/runtime/struct.Runtime.html#method.block_on">[1]</a> æ–¹æ³•ï¼Œå¯ä»¥åŒæ­¥åœ°ç­‰å¾…ä¸€ä¸ª future å®Œæˆã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">tests</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">	</span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯è¿è¡Œæ—¶ç›´æ¥æŠ¥é”™ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">thread &#39;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#39; panicked at &#39;Cannot start a runtime from within a runtime. This happens because a function (like `block<span class="nb">_</span>on`) attempted to block the current thread while the thread is being used to drive asynchronous tasks.&#39;, /Users/lei/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.17.0/src/runtime/enter.rs:39:9
</span></span></code></pre></div><p>æç¤ºä¸èƒ½ä»ä¸€ä¸ªæ‰§è¡Œä¸­ä¸€ä¸ª runtime ç›´æ¥å¯åŠ¨å¦ä¸€ä¸ªå¼‚æ­¥ runtimeã€‚</p>
<p>çœ‹æ¥ Tokio ä¸ºäº†é¿å…è¿™ç§æƒ…å†µç‰¹åœ°åœ¨å…¥å£åšäº†æ£€æŸ¥ã€‚
æ—¢ç„¶ä¸è¡Œé‚£æˆ‘ä»¬å°±å†çœ‹çœ‹å…¶ä»–çš„å¼‚æ­¥åº“æ˜¯å¦æœ‰ç±»ä¼¼çš„å¼‚æ­¥è½¬åŒæ­¥çš„æ–¹æ³•ã€‚æœç„¶æ‰¾åˆ°ä¸€ä¸ª <code>futures::executor::block_on</code><a href="https://docs.rs/futures/0.2.0/futures/executor/fn.block_on.html">[2]</a>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7">7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç¼–è¯‘åŒæ ·æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¿è¡Œæ—¶ä»£ç ç›´æ¥ç›´æ¥ hang ä½ä¸è¿”å›äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">cargo test --color=always --package tokio-demo --bin tt tests::test<span class="nb">_</span>sync<span class="nb">_</span>method --no-fail-fast -- --format=json --exact -Z unstable-options --show-output      
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">   Compiling tokio-demo v0.1.0 (/Users/lei/Workspace/Rust/learning/tokio-demo)
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">    Finished test [unoptimized + debuginfo] target(s) in 0.39s
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">     Running unittests src/common/tt.rs (target/debug/deps/tt-adb10abca6625c07)
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;suite&#34;, &#34;event&#34;: &#34;started&#34;, &#34;test<span class="nb">_</span>count&#34;: 1 <span class="nb">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="nb">{</span> &#34;type&#34;: &#34;test&#34;, &#34;event&#34;: &#34;started&#34;, &#34;name&#34;: &#34;tests::test<span class="nb">_</span>sync<span class="nb">_</span>method&#34; <span class="nb">}</span>
</span></span></code></pre></div><p>æ˜æ˜ <code>generate_async</code>æ–¹æ³•é‡Œé¢åªæœ‰ä¸€ä¸ªç®€å•çš„ sleep è°ƒç”¨ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆ future ä¸€ç›´æ²¡å®Œæˆå‘¢ï¼Ÿ
å¹¶ä¸”åŠè¯¡çš„æ˜¯ï¼ŒåŒæ ·çš„ä»£ç ï¼Œåœ¨ <code>tokio::test</code>é‡Œé¢ä¼š hang ä½ï¼Œä½†æ˜¯åœ¨ <code>tokio::main</code>ä¸­åˆ™å¯ä»¥æ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8">8</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ‰§è¡Œç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">cargo run --color=always --package tokio-demo --bin tt
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">    Finished dev [unoptimized + debuginfo] target(s) in 0.05s
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">     Running `target/debug/tt`
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">vec: [0, 1, 2]
</span></span></code></pre></div><blockquote>
<p>å…¶å®å½“åˆçœŸæ­£é‡åˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™å®šä½åˆ°å…·ä½“åœ¨å“ªé‡Œ hang ä½å¹¶æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ã€‚çœŸå®ä»£ç ä¸­ async æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªè¿œç¨‹çš„ gRPC è°ƒç”¨ï¼Œå½“åˆæ€€ç–‘è¿‡æ˜¯å¦æ˜¯ gRPC server çš„é—®é¢˜ï¼ŒåŠ¨ç”¨äº†ç½‘ç»œæŠ“åŒ…ç­‰ç­‰æ‰‹æ®µæœ€ç»ˆå‘ç°æ˜¯ client ä¾§ çš„é—®é¢˜ã€‚è¿™ä¹Ÿæé†’äº†æˆ‘ä»¬åœ¨å‡ºç° bug çš„æ—¶å€™ï¼ŒæŠ½è±¡å‡ºé—®é¢˜ä»£ç çš„æ‰§è¡Œæ¨¡å¼å¹¶ä¸”åšå‡ºä¸€ä¸ªæœ€å°å¯å¤ç°çš„æ ·ä¾‹ï¼ˆMinimal Reproducible Exampleï¼‰æ˜¯éå¸¸é‡è¦çš„ã€‚</p>
</blockquote>
<h2 id="catchup">Catchup</h2>
<p>å‡­ç€å¯¹ Rust å¼‚æ­¥ runtime çš„åŸºæœ¬äº†è§£ï¼Œæˆ‘å¤§æ¦‚çŸ¥é“ç±»ä¼¼ Tokio è¿™æ ·çš„å¼‚æ­¥ runtime æ˜¯ä¸€ä¸ª executor+scheduler+reactor çš„æ¨¡å‹ã€‚å…¶ä¸­ï¼š</p>
<ul>
<li>executorï¼šåœ¨è®¡ç®—èµ„æºï¼ˆåœ¨ std ç¯å¢ƒä¸‹å°±æ˜¯æ“ä½œç³»ç»Ÿçš„ threadï¼ŒåµŒå…¥å¼ç¯å¢ƒä¸‹åˆ™æ²¡æœ‰ thread æŠ½è±¡ï¼‰ä¸Šæ‰§è¡ŒçœŸæ­£çš„å¼‚æ­¥ä»»åŠ¡ï¼›</li>
<li>schedulerï¼šè´Ÿè´£ç»´æŠ¤ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„ FIFO å¹¶ä¸”è´Ÿè´£ä»»åŠ¡åœ¨ä¸åŒ executor ä¹‹é—´è°ƒåº¦ï¼›</li>
<li>reactorï¼šæŠ½è±¡åº•å±‚é˜»å¡ IOï¼Œæä¾›éé˜»å¡äº‹ä»¶ç›‘å¬å’Œå”¤é†’çš„åŠŸèƒ½ï¼ˆç±»ä¼¼ epoll é‚£æ ·ï¼‰ã€‚</li>
</ul>
<p>Rust ä¸­çš„ä¸€ä¸ªå¼‚æ­¥ä»£ç å—æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª futureï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å…¶æ˜¯ä¸ä¼šç›´æ¥æ‰§è¡Œçš„ï¼Œåªæœ‰å°†å…¶ spawn åˆ°å¼‚æ­¥çš„ runtime é‡Œé¢æ‰ä¼šçœŸæ­£å°è£…æˆä¸€ä¸ªä»»åŠ¡äº¤ç»™ executor æ‰§è¡Œã€‚Runtime æœ‰ä¸€å¥—æœºåˆ¶å»å”¤é†’å¼‚æ­¥ä»»åŠ¡ï¼Œæ£€æŸ¥ future çš„çŠ¶æ€æ˜¯å¦ä¸º ready ç­‰ç­‰ã€‚</p>
<h2 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ</h2>
<p>å›é¡¾å®ŒèƒŒæ™¯çŸ¥è¯†ï¼Œæˆ‘ä»¬å†çœ‹ä¸€çœ¼æ–¹æ³•çš„å®ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_async</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è°ƒç”¨ <code>generate</code>æ–¹æ³•çš„è‚¯å®šæ˜¯ Tokio çš„ executorï¼Œé‚£ä¹ˆ block_on é‡Œé¢çš„ <code>self.generate_async().await</code>è¿™ä¸ª future åˆæ˜¯è°åœ¨ poll å‘¢ï¼Ÿä¸€å¼€å§‹æˆ‘ä»¥ä¸ºï¼Œ<code>futures::executor::block_on</code>ä¼šæœ‰ä¸€ä¸ªå†…éƒ¨çš„ runtme å»è´Ÿè´£ <code>generate_async</code>çš„ pollã€‚äºæ˜¯ç‚¹è¿›å»<a href="https://docs.rs/futures-executor/0.3.6/src/futures_executor/local_pool.rs.html#77-104">ä»£ç </a>ï¼ˆä¸»è¦æ˜¯<code>futures_executor::local_pool::run_executor</code>è¿™ä¸ªæ–¹æ³•ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">run_executor</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_enter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enter</span><span class="p">().</span><span class="n">expect</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="err">&#34;</span><span class="n">cannot</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="err">`</span><span class="n">LocalPool</span><span class="err">`</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="err">\</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">         </span><span class="n">another</span><span class="w"> </span><span class="n">executor</span><span class="err">&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="n">CURRENT_THREAD_NOTIFY</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">|</span><span class="n">thread_notify</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">waker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waker_ref</span><span class="p">(</span><span class="n">thread_notify</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">from_waker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">unparked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Acquire</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">unparked</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w">                </span><span class="n">thread</span>::<span class="n">park</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="w">                </span><span class="n">thread_notify</span><span class="p">.</span><span class="n">unparked</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Release</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç«‹åˆ»å—…åˆ°äº†ä¸€ä¸ä¸å¯¹çš„å‘³é“ï¼Œè™½ç„¶è¿™ä¸ªæ–¹æ³•åä¸º <code>run_executor</code>ï¼Œä½†æ˜¯æ•´ä¸ªæ–¹æ³•é‡Œé¢è²Œä¼¼æ²¡æœ‰ä»»ä½• spawn çš„æ“ä½œï¼Œåªæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸åœçš„å¾ªç¯åˆ¤æ–­ç”¨æˆ·æäº¤çš„ future çš„çŠ¶æ€æ˜¯å¦ä¸º ready å•Šï¼ï¼ï¼ï¼</p>
<p>è¿™æ„å‘³ç€ï¼Œå½“ Tokio çš„ runtime çº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œä¼šç«‹åˆ»è¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨å¾ªç¯ä¸­ä¸åœåœ°åˆ¤æ–­ç”¨æˆ·çš„çš„ future æ˜¯å¦ readyï¼Œå¦‚æœè¿˜æ˜¯ pending çŠ¶æ€ï¼Œåˆ™å°†å½“å‰çº¿ç¨‹ park ä½ã€‚å‡è®¾ï¼Œç”¨æˆ· future çš„å¼‚æ­¥ä»»åŠ¡ä¹Ÿæ˜¯äº¤ç»™äº†å½“å‰çº¿ç¨‹å»æ‰§è¡Œï¼Œ<code>futures::executor::block_on</code>ç­‰å¾…ç”¨æˆ·çš„ future readyï¼Œè€Œç”¨æˆ· future ç­‰å¾… <code>futures::executor::block_on</code>é‡Šæ”¾å½“å‰çš„çº¿ç¨‹èµ„æºï¼Œé‚£ä¹ˆä¸å°±æ­»é”äº†ï¼Ÿ
å¾ˆæœ‰é“ç†å•Šï¼Œç«‹åˆ»éªŒè¯ä¸€ä¸‹ã€‚æ—¢ç„¶ä¸èƒ½åœ¨å½“å‰ runtime çº¿ç¨‹ blockï¼Œé‚£å°±é‡æ–°å¼€ä¸€ä¸ªçº¿ç¨‹ blockï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Sequencer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">            </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">                </span><span class="c1">// è¿™é‡Œä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„ runtime æ¥ block
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span><span class="w">                </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w">                        </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">                        </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w">                    </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w">                </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w">        </span><span class="p">}).</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æœç„¶å¯ä»¥äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">color</span><span class="o">=</span><span class="n">always</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">demo</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">tt</span><span class="w"> </span><span class="n">tests</span>::<span class="n">test_sync_method</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">fail</span><span class="o">-</span><span class="n">fast</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">format</span><span class="o">=</span><span class="n">json</span><span class="w"> </span><span class="o">--</span><span class="n">exact</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="n">unstable</span><span class="o">-</span><span class="n">options</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">tt</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">tt</span><span class="o">-</span><span class="n">adb10abca6625c07</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="n">vec</span>: <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>futures::executor::block_on</code>é‡Œé¢ï¼Œé¢å¤–ä½¿ç”¨äº†ä¸€ä¸ª <code>RUNTIME</code>æ¥ spawn æˆ‘ä»¬çš„å¼‚æ­¥ä»£ç ã€‚å…¶åŸå› è¿˜æ˜¯åˆšåˆšæ‰€è¯´ï¼Œè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡éœ€è¦ä¸€ä¸ª runtime æ¥é©±åŠ¨çŠ¶æ€çš„å˜åŒ–ï¼Œå¦‚æœå»æ‰ runtimeï¼Œä»ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­æ‰§è¡Œæˆ‘ä»¬çš„å¼‚æ­¥ä»»åŠ¡çš„è¯ï¼Œ<code>futures::executor::block_on</code>ç¬¬ä¸€æ¬¡ poll æˆ‘ä»¬å¼‚æ­¥ä»»åŠ¡çš„ futureï¼Œä¼šè¿›å…¥åˆ° <code>tokio::time::sleep</code>æ–¹æ³•è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåˆ¤æ–­å½“å‰æ‰§è¡Œçš„å¼‚æ­¥ runtime ï¼ˆä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰ï¼Œè€Œè¿™ä¸ªä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯ä¿ç•™åœ¨ thread local ä¸­çš„ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­å¹¶ä¸å­˜åœ¨è¿™ä¸ª thread localï¼Œä»è€Œä¼š panicã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="n">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="n">thread</span><span class="w"> </span><span class="o">&#39;&lt;</span><span class="n">unnamed</span><span class="o">&gt;&#39;</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">&#39;</span><span class="na">there</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">reactor</span><span class="w"> </span><span class="n">running</span><span class="p">,</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Tokio</span><span class="w"> </span><span class="mf">1.</span><span class="n">x</span><span class="w"> </span><span class="n">runtime</span><span class="o">&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span></code></pre></div><h3 id="tokiomainå’Œ-tokiotest"><code>tokio::main</code>å’Œ <code>tokio::test</code></h3>
<p>åœ¨åˆ†æå®Œä¸Šé¢çš„åŸå› ä¹‹åï¼Œâ€œä¸ºä»€ä¹ˆ <code>tokio::main</code>ä¸­ä¸ä¼š hang ä½è€Œ <code>tokio::test</code>ä¼š hang ä½â€è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œä»–ä»¬ä¸¤è€…æ‰€ä½¿ç”¨çš„çš„ runtime å¹¶ä¸ä¸€æ ·ã€‚<code>tokio::main</code>ä½¿ç”¨çš„æ˜¯å¤šçº¿ç¨‹çš„ runtimeï¼Œè€Œ <code>tokio::test</code> ä½¿ç”¨çš„æ˜¯å•çº¿ç¨‹çš„ runtimeï¼Œè€Œåœ¨å•çº¿ç¨‹çš„ runtime ä¸‹ï¼Œå½“å‰çº¿ç¨‹è¢« <code>futures::executor::block_on</code>å¡æ­»ï¼Œé‚£ä¹ˆç”¨æˆ·æäº¤çš„å¼‚æ­¥ä»£ç æ˜¯ä¸€å®šæ²¡æœºä¼šæ‰§è¡Œçš„ï¼Œä»è€Œå¿…ç„¶å½¢æˆä¸Šé¢æ‰€è¯´çš„æ­»é”ã€‚</p>
<h2 id="best-practice">Best practice</h2>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œç»“åˆ Rust åŸºäº generator çš„åä½œå¼å¼‚æ­¥ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º Rust ä¸‹æ¡¥æ¥å¼‚æ­¥ä»£ç å’ŒåŒæ­¥ä»£ç çš„ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>åœ¨å¼‚æ­¥ä»£ç è°ƒç”¨ï¼ˆå¯èƒ½é˜»å¡çš„ï¼‰åŒæ­¥ä»£ç æ—¶ï¼Œè¯·ä½¿ç”¨ <code>tokio::task::spawn_blocking</code> <a href="https://docs.rs/tokio/0.2.22/tokio/task/fn.spawn_blocking.html">[3]</a></li>
<li>å°½é‡é¿å…åœ¨å¼‚æ­¥ä»£ç ä¸­è¿›è¡Œå¤§è§„æ¨¡çš„ CPU å¯†é›†å‹è®¡ç®—ï¼Œé¿å…å¯¹ä»»åŠ¡è°ƒåº¦çš„å…¬å¹³æ€§é€ æˆå½±å“ï¼ˆCPU å¯†é›†å‹ä»»åŠ¡å¯ä»¥ä½¿ç”¨ <a href="https://docs.rs/rayon/latest/rayon/">rayon</a> ä»£æ›¿ï¼‰</li>
<li>åœ¨åŒæ­¥ä»£ç è°ƒç”¨å¼‚æ­¥ä»£ç çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>futures::executor::block_on</code>è¯·åŠ¡å¿…æ³¨æ„å’Œ <code>tokio::task::spawn_blocking</code>ï¼ˆæˆ–è€…<code>std::thread::spawn</code>ï¼‰é…åˆä½¿ç”¨ï¼Œå› ä¸ºå‰è€…ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚ç†æƒ³æƒ…å†µæ˜¯ï¼Œé€šè¿‡ä¸€ä¸ª blocking-dedicated executor å»è°ƒç”¨ <code>futures::executor::block_on</code>ï¼Œç„¶åå†é€šè¿‡ <code>tokio::runtime::spawn</code>æŠŠä»»åŠ¡ä¸¢å›ç»™åŸæ¥çš„ runtime å»æ‰§è¡Œã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="c1">// å¦‚æœä½ å¯ä»¥æ§åˆ¶ generate æ–¹æ³•å¦‚ä½•è¢«è°ƒç”¨
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="c1"></span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">    </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">            </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="c1">// é‚£ä¹ˆä½ å¯ä»¥åœ¨è°ƒç”¨ generate ä¹‹å‰ä½¿ç”¨ spawn_blocking é¿å…æ­»é”
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="c1"></span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">task</span>::<span class="n">spawn_blocking</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl"><span class="w">        </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-25">25</a></span><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-26">26</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-27">27</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="c1">// å¦‚æœ generate æ–¹æ³•çš„è°ƒç”¨æ–¹å¹¶ä¸æ˜¯ä½ èƒ½æ§åˆ¶çš„ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ std::thread::spawn
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="c1"></span><span class="k">fn</span> <span class="nf">generate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bound</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">    </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">RUNTIME</span><span class="p">.</span><span class="n">block_on</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">bound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">                    </span><span class="n">res</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w">                    </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w">                </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="p">}).</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_sync_method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sequencer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlainSequencer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl"><span class="w">        </span><span class="n">bound</span>: <span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl"><span class="w">	</span><span class="c1">// è¿™é‡Œåªæ˜¯ä¸€ä¸ªæ™®é€šçš„åŒæ­¥æ–¹æ³•è°ƒç”¨
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequencer</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-25">25</a></span><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;vec: {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-26">26</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://ryhl.io/blog/async-what-is-blocking/">Async: What is blocking?</a></li>
<li><a href="https://cfsamson.github.io/books-futures-explained/4_generators_async_await.html">Generators and async/await</a></li>
<li><a href="https://news.ycombinator.com/item?id=17536441">Async and Await in Rust: a full proposal</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2603">calling futures::executor::block_on in block_in_place may hang</a></li>
<li><a href="https://github.com/tokio-rs/tokio/issues/2376">tokio@0.2.14 + futures::executor::block_on causes hang</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Notes on InfluxDB Storage Engine</title>
			<link>https://huanglei.rocks/posts/notes-on-influxdb-storage/</link>
			<pubDate>Sat, 12 Mar 2022 17:42:25 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/notes-on-influxdb-storage/</guid>
			<description>InfluxDB çš„å­˜å‚¨å¼•æ“ç»è¿‡å¤šæ¬¡ä¿®æ”¹ï¼Œæœ¬æ–‡æè¿°çš„ç³»ç»Ÿç»“æ„åŸºäº InfluxDB æˆªæ­¢ 2022-02-24 çš„ adf29dfedfc785620db0e104652544ce9f67cb6e ç‰ˆæœ¬ã€‚å½“å‰ç‰ˆæœ¬å·²ç»æ”¯æŒ TSI ç´¢å¼•ç»“æ„ã€‚ InfluxDB çš„å­˜å‚¨ç³»ç»Ÿ InfluxDB çš„å­˜å‚¨å±‚æœ‰ä¸‰ä¸ªå­ç³»ç»Ÿï¼š TSMï¼šæ•°</description>
			<content type="html"><![CDATA[<blockquote>
<p>InfluxDB çš„å­˜å‚¨å¼•æ“ç»è¿‡å¤šæ¬¡ä¿®æ”¹ï¼Œæœ¬æ–‡æè¿°çš„ç³»ç»Ÿç»“æ„åŸºäº InfluxDB æˆªæ­¢ 2022-02-24 çš„ <code>adf29dfedfc785620db0e104652544ce9f67cb6e</code> ç‰ˆæœ¬ã€‚å½“å‰ç‰ˆæœ¬å·²ç»æ”¯æŒ TSI ç´¢å¼•ç»“æ„ã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-overview.svg" alt="image.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
  InfluxDB çš„å­˜å‚¨ç³»ç»Ÿ 
</i>
</div>
<p>InfluxDB çš„å­˜å‚¨å±‚æœ‰ä¸‰ä¸ªå­ç³»ç»Ÿï¼š</p>
<ul>
<li>TSMï¼šæ•°æ®ç‚¹çš„å­˜å‚¨ï¼Œå¯ä»¥é«˜æ•ˆåœ°æä¾› SeriesKey åˆ°æ—¶åºæ•°æ®å€¼çš„æ’å…¥å’Œæ£€ç´¢ï¼›</li>
<li>TSIï¼šæ—¶åºæ•°æ®çš„å€’æ’ç´¢å¼•ï¼Œæä¾›æŸ¥è¯¢æŸä¸ª measurement ä¸‹æŸä¸ª tag åŒ…å«ç‰¹å®šå€¼çš„ SeriesID çš„æ¥å£ï¼›
<ul>
<li>TSI æ˜¯ InfluxDB æŸ¥è¯¢å¼•æ“çš„æ ¸å¿ƒï¼Œæ‰€è°“çš„åŸºæ•°è†¨èƒ€å¸¦æ¥çš„é—®é¢˜ä¹Ÿæ˜¯å‡ºç°åœ¨è¿™ä¸€å±‚ã€‚</li>
<li>ä¸ºäº†é™ä½ TSI çš„å†…å­˜å ç”¨ï¼ŒInfluxDB å¼•å…¥äº†ä¸€ä¸ªé¢å¤–çš„ SeriesIDã€‚</li>
</ul>
</li>
<li>Series ç´¢å¼•ï¼šæä¾›æ ¹æ® SeriesID æŸ¥æ‰¾ SeriesKey çš„æ¥å£ç­‰
<ul>
<li><code>SeriesFile.CreateSeriesListIfNotExists</code>ï¼šåˆ›å»º <code>SeriesKey</code>-&gt;<code>SeriesID</code> çš„æ˜ å°„</li>
<li><code>SeriesFile.SeriesKey</code>ï¼šæ ¹æ® SeriesID æŸ¥æ‰¾ SeriesKey</li>
</ul>
</li>
</ul>
<p>åº”è¯¥è¯´ TSI åŠ ä¸Š SeriesIndex æ‰æ˜¯ InfluxDB å®Œæ•´çš„ç´¢å¼•éƒ¨åˆ†ï¼Œä½†æ˜¯è¿™ä¸¤è€…å„è‡ªæ˜¯ä¸€ä¸ªç±» LSMT çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿæœ‰è‡ªå·±çš„ WALã€compaction/recover ç­–ç•¥ç­‰ç­‰ï¼Œå› æ­¤ InfluxDB åšäº†åŒºåˆ†ã€‚</p>
<p>åœ¨ InfluxDB æŸ¥è¯¢æ•°æ®æ—¶ï¼Œé¦–å…ˆæ ¹æ®ç”¨æˆ·çš„æŸ¥è¯¢æ¡ä»¶ä» TSI æŸ¥æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ SeriesIDï¼Œç„¶åä» SeriesIndex æŸ¥è¯¢å¯¹åº”çš„ SeriesKeyï¼Œæœ€åä» TSM æ ¹æ® SeriesKey è¯»å–å¹¶åˆå¹¶æ‰€æœ‰çš„æ•°æ®ç‚¹ã€‚</p>
<blockquote>
<p>å€¼å¾—é¢å¤–è¯´æ˜çš„æ˜¯ï¼ŒInfluxDB é‡‡ç”¨äº† Roaring Bitmap ä½œä¸ºå‹ç¼©çš„ map ç”¨æ¥å­˜å‚¨ SeriesID ç­‰æ•°æ®ï¼›æ­¤å¤–ç”¨ Robin Hood Hash ç”¨ä½œç£ç›˜ä¸Šçš„æŒä¹…åŒ–çš„ hashtable çš„ hash ç®—æ³•ï¼Œè¯»å–æ—¶çš„ locality æ¯”è¾ƒå¥½ã€‚æœ¬æ–‡æ‰€è¿°çš„ ç£ç›˜æ–‡ä»¶ä¸Šçš„ hash index éƒ½æ˜¯é‡‡ç”¨çš„ RHHã€‚</p>
</blockquote>
<h2 id="tsm">TSM</h2>
<p>TSM æ˜¯ InfluxDB å­˜å‚¨æ—¶é—´çº¿æ•°æ®ç‚¹çš„å¼•æ“ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª <code> map&lt;SeriesKey, list&lt;DataPoint&gt;&gt;</code> çš„æ•°æ®åº“ã€‚ä¸ºäº†æé«˜æ—¶é—´ç‚¹çš„å†™å…¥ååï¼ŒTSM é‡‡ç”¨äº†ç±»ä¼¼äº LSMT çš„æ•°æ®ç»“æ„ã€‚</p>
<p>InfluxDB å°†æ¯ä¸ªæ—¶é—´æ®µåˆ’åˆ†ä¸ºä¸€ä¸ª shardï¼Œæ¯ä¸ª shard å¯¹åº”åº•å±‚çš„ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ï¼ŒåŒ…æ‹¬å…¶è‡ªå·±çš„ WAL å’Œ TSM æ–‡ä»¶ã€‚InfluxDB æ–‡æ¡£ä¸­å¾ˆå¤šåœ°æ–¹æŠŠè¿™ä¸ª DB çš„æ¦‚å¿µç§°ä¸º RPï¼ˆRetention Policyï¼‰ï¼Œæœ¬è´¨ä¸Šæ˜¯å› ä¸º RP å†³å®šäº† DB ä¸‹é¢çš„ shard å¦‚ä½•è¿‡æœŸæ¸…ç†ï¼Œä¸€ä¸ª DB åªä¼šæœ‰ä¸€ä¸ª RPï¼Œå› æ­¤ RP å®ä¾‹å°±æ˜¯ DB å®ä¾‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/tsm-overview.svg#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;height=588&amp;id=p6Hzv&amp;originHeight=2175&amp;originWidth=1997&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=&amp;width=540" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSM æ–‡ä»¶æ€»è§ˆ 
</i>
</div>
<h2 id="tsi">TSI</h2>
<p>TSI æä¾›çš„èƒ½åŠ›æ˜¯ tag åˆ° series key çš„ç´¢å¼•ï¼Œå¦‚å¼€å¤´æ‰€è¯´ï¼Œä¸ºäº†é™ä½ TSI çš„å†…å­˜å ç”¨ï¼ŒInfluxDB é¢å¤–å¼•å…¥äº† SeriesID çš„æ¦‚å¿µï¼Œè¿™æ ·ä¸€æ¥å°±å°† TSI åˆ†ä¸º tag-&gt;id å’Œ id-&gt;key ä¸¤éƒ¨åˆ†ï¼Œæœ¬æ–‡åˆ†åˆ«ç§°ä¸º Index å’Œ Seriesã€‚åªæœ‰ä¸¤éƒ¨åˆ†åŠ èµ·æ¥æ‰æ˜¯å®Œæ•´çš„ InfluxDB çš„æ—¶åºç´¢å¼•ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-overview.svg" alt="influxdb-tsi-overview"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSI ç´¢å¼•å­˜å‚¨å…¨æ™¯ 
</i>
</div>
<h3 id="index-éƒ¨åˆ†">Index éƒ¨åˆ†</h3>
<p>TSI ä¸»è¦ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªæŒä¹…åŒ–çš„ <code>map&lt;TagName, map&lt;TagValue, list&lt;SeriesID&gt;&gt;&gt;</code> æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äºä¸€ä¸ª LSMT çš„ KV ç³»ç»Ÿã€‚</p>
<p>TSI æä¾›çš„æ¥å£ä¸»è¦æ˜¯ï¼š</p>
<ul>
<li><code>Index.TagValueSeriesIDIterator</code>ï¼šæ ¹æ® measurementã€tag keyã€tag value æ‰¾åˆ°éœ€è¦è¯»å–çš„ SeriesID</li>
<li><code>Index.CreateSeriesIfNotExists</code>ï¼šæ ¹æ®è¾“å…¥çš„ measurementã€key å’Œ tag value åˆ›å»ºä¸€ä¸ªæ–°çš„</li>
</ul>
<p>å’Œå…¶ä»–çš„ LSMT ä¸€æ ·ï¼ŒTSI ä¹Ÿæœ‰ä¸€ä¸ª WALã€Memtableã€SSTã€‚</p>
<ul>
<li>WALï¼š<code>LogFile</code> çš„ç£ç›˜éƒ¨åˆ†ï¼ˆ.tsl æ–‡ä»¶ï¼‰</li>
<li>MemTableï¼š<code>LogFile</code>çš„å†…å­˜éƒ¨åˆ†</li>
<li>SSTï¼š<code>IndexFile</code></li>
</ul>
<p>TSI æœ¬èº«ä¹Ÿæ˜¯ Shard ç»´åº¦çš„ï¼Œè¿™æ ·å½“æ—§çš„ shard è¿‡æœŸä¹‹åé‡Œé¢çš„ ç´¢å¼•ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ã€‚</p>
<h4 id="tsl-æ–‡ä»¶çš„æ ¼å¼">TSL æ–‡ä»¶çš„æ ¼å¼</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsl-layout.svg" alt="image.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSL æ–‡ä»¶çš„å¸ƒå±€ 
</i>
</div>
<p>TSL æ–‡ä»¶æ˜¯  LogFile çš„ç£ç›˜è¡¨ç¤ºï¼Œç”±ä¸€ç³»åˆ—çš„ LogEntry ç»„æˆã€‚å½“æ–°çš„ SeriesKey å†™å…¥çš„æ—¶å€™ï¼Œä¼šåœ¨è¿™ä¸ª TSL æ–‡ä»¶çš„æœ«å°¾ append ä¸€ä¸ª log entryã€‚æ¯ä¸ª log entry åŒ…æ‹¬ï¼š</p>
<ul>
<li>flagï¼šä»£è¡¨è¿™ä¸ª entry æ‰€æ‰§è¡Œçš„æ“ä½œï¼Œå¯ä»¥æ˜¯æ–°å¢/åˆ é™¤ seriesã€åˆ é™¤ measurementã€åˆ é™¤ tag keyã€åˆ é™¤ tag value ä¹‹ä¸€</li>
<li>series idï¼šseries key çš„ ID</li>
<li>nameï¼šseries key çš„ name</li>
<li>keyï¼šseries key çš„ tag key</li>
<li>valueï¼šseries key çš„ tag value</li>
<li>checksumï¼šæ ¡éªŒå’Œ</li>
<li>sizeï¼šå¤§å°</li>
</ul>
<p>å½“ InfluxDB å®ä¾‹é‡å¯çš„æ—¶å€™ï¼Œä¼šé€šè¿‡é‡æ”¾è¿™ä¸ª TSL æ–‡ä»¶è·å¾—ä¸€ä»½æœ€æ–°çš„ series key æ•°æ®ã€‚</p>
<h4 id="tsi-æ–‡ä»¶çš„æ ¼å¼">TSI æ–‡ä»¶çš„æ ¼å¼</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-layout.svg" alt="influxdb-tsi-layout"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 TSI æ–‡ä»¶å¸ƒå±€ 
</i>
</div>
<p>TSI æ–‡ä»¶åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯æ–‡ä»¶å°¾éƒ¨çš„ tailerã€measurement block å’Œ tag block ç»„æˆã€‚</p>
<ul>
<li>é€šè¿‡è¯»å– trailer çš„æ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° measurement å¯¹åº” çš„ measurement block çš„ offset</li>
<li>é€šè¿‡ measurement block ä¸­çš„ tag offset å¯ä»¥æ‰¾åˆ° tag å¯¹åº”çš„ tag block ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œmeasurement block è¿˜è®°å½•äº† measurement  çš„ cardinality ã€SeriesID Setï¼ˆbitmapï¼‰ç­‰ä¿¡æ¯ã€‚</li>
<li>tag block æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒä¹…åŒ–çš„ hashmap</li>
</ul>
<h5 id="indexfiletailer">IndexFileTailer</h5>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-index-trailer.svg" alt="influxdb-tsi-index-trailer.svg"></p>
<h5 id="measurementblocks">MeasurementBlocks</h5>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-measurement-block.svg" alt="influxdb-tsi-measurement-block.svg"></p>
<p>MeasurementBlocks æœ‰ä¸€ç³»åˆ—çš„ MeasurementBlockã€ä¸€ä¸ª HashIndex å’Œä¸€ä¸ª MeasurementBlockTrailer ç»„æˆï¼š</p>
<ul>
<li>MeasurementBlock ä¿å­˜çš„æ˜¯ measurement çš„æ•°æ®</li>
<li>HashIndex ä¿å­˜çš„æ˜¯æ¯ä¸€ä¸ª MeasurementBlock åœ¨æ–‡ä»¶çš„åç§»é‡</li>
<li>MeasurementBlockTrailer è®°å½•äº†åœ¨ MeasurementBlock æ•°æ®åŒºçš„èµ·å§‹ offset å’Œ sizeã€HashIndex çš„èµ·å§‹ offset å’Œ size ä»¥åŠ sketchã€tsketch çš„èµ·å§‹ offset å’Œ size ä¿¡æ¯ã€‚</li>
</ul>
<h5 id="tagblocks">TagBlocks</h5>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-tag-block.svg" alt="influxdb-tsi-tag-block"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
Tag block å­˜å‚¨æ ¼å¼
</i>
</div>
<p>TagBlocks ä¿å­˜çš„æ˜¯æŸä¸ª tag key ä¸‹é¢çš„æ‰€æœ‰ tag value ä»¥åŠè¿™ä¸ª tag value å¯¹åº”çš„ series id åˆ—è¡¨ã€‚TagBlock é€šè¿‡ä¸€ä¸ªå¤šçº§çš„ map å»ç»´æŠ¤äº†è¿™æ ·çš„åŒé‡æ˜ å°„å…³ç³»ã€‚</p>
<ul>
<li>é¦–å…ˆåœ¨ TagBlockTrailer è¿™ä¸ªå°¾éƒ¨çš„æ•°æ®ç»“æ„ç»´æŠ¤äº† tag value sectionã€tag key sectionã€tag key array map çš„åœ°å€ï¼›</li>
<li>é€šè¿‡ trailer çš„ hash index offset å¯ä»¥æ‰¾åˆ° tag key block çš„ hash index ï¼ˆä¸‹å›¾ä¸­çš„ 1ï¼‰ï¼›</li>
<li>éå† hash index å¯ä»¥æ‰¾åˆ°æ‰€éœ€è¦æŸä¸ª tag key çš„ tag key block entry ï¼ˆä¸‹å›¾ä¸­çš„ 2ï¼‰ï¼›</li>
<li>é€šè¿‡ tag key block entry çš„ tag hash index offset å¯ä»¥æ‰¾åˆ° è¿™ä¸ª key å¯¹åº”çš„ tag value çš„ hash index éƒ¨åˆ†çš„åœ°å€ ï¼ˆä¸‹å›¾ä¸­çš„ 3ï¼‰ï¼›</li>
<li>éå†è¿™ä¸ª tag value block çš„ tag value hash index å¯ä»¥æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ tag value entry çš„åœ°å€ï¼Œä»è€Œè¯»å–åˆ°è¿™ä¸ª tag value çš„æ•°æ®ï¼ŒåŒ…æ‹¬ series id ç­‰ï¼ˆä¸‹å›¾ä¸­çš„ 4ï¼‰ã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-tsi-search.svg" alt="influxdb-tsi-tag-lookup.png"></p>
<h4 id="æ ¹æ®-tag-key-å’Œ-tag-value-æŸ¥æ‰¾">æ ¹æ® Tag key å’Œ Tag value æŸ¥æ‰¾</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-latex" data-lang="latex"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">Index.TagValueSeriesIDIterator 						@tsdb/index/tsi1/index.go:999
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="k">\-</span>-- Partition.TagValueSeriesIDIterator 	@tsdb/index/tsi1/index.go:1010
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">    <span class="k">\-</span>-- IndexFile.TagValueSeriesIDSet 		@tsdb/index/tsi1/partition.go:805
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">        <span class="k">\-</span>-- TagBlock.DecodeTagValueElem	@tsdb/index/tsi1/index<span class="nb">_</span>file.go:335
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl">              <span class="nb">^</span>~ è¿™é‡Œçš„ tagblocks åœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šä»ç£ç›˜ä¸Šçš„ IndexFile è¯»å–åˆ°IndexFile.tblks ä¸­æ¥ï¼Œ
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl">                  è€Œ IndexFile ä¹‹å¤–çš„å˜æ›´ä¿ç•™åœ¨ LogFile çš„å†…å­˜ç´¢å¼•ä¸­
</span></span></code></pre></div><h4 id="index-compaction">Index Compaction</h4>
<p>TSI ç´¢å¼•çš„ compaction æœ‰ä¸¤ç±»ï¼š</p>
<ul>
<li>LogFile -&gt; IndexFile: <code>LogFile.Compact</code>ï¼Œå³ level 0 åˆ° level 1 çš„ compactionï¼ŒæŠŠ TSL æ–‡ä»¶å‹ç¼©æˆ TSI æ–‡ä»¶</li>
<li>IndexFile leveled compaction: <code>IndexFiles.Compact</code>ï¼Œå³ level n åˆ° level n+1 çš„ compaction</li>
</ul>
<h3 id="series-ç´¢å¼•">Series ç´¢å¼•</h3>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-index-overview.svg" alt="influxdb-series-index-overview.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Series ç´¢å¼•å…¨æ™¯å›¾ 
</i>
</div>
<p>Series ç´¢å¼•ä¸»è¦è´Ÿè´£ SeriesKey åˆ° SeriesID å’Œ SeriesID åˆ° SeriesOffset çš„æ˜ å°„ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæŒä¹…åŒ–çš„ <code>map&lt;SeriesID, SeriesKey&gt;</code>ã€‚Series ç´¢å¼•ä¹Ÿæ˜¯ database ç»´åº¦çš„ã€‚Series ç´¢å¼•åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>&ldquo;WAL&rdquo;ï¼šSeriesSegment</li>
<li>&ldquo;MemTable&rdquo;ï¼šSeriesIndex çš„å†…å­˜éƒ¨åˆ†</li>
<li>&ldquo;SST&rdquo;ï¼šSeriesIndex æŒä¹…åŒ–åˆ°ç£ç›˜çš„éƒ¨åˆ†ï¼ˆåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šé€šè¿‡ mmap è½½å…¥ï¼‰</li>
</ul>
<p>ç†è§£ Series ç´¢å¼•çš„æ ¸å¿ƒåœ¨äºç†è§£ SeriesIndex å’Œ SeriesSegment çš„äº¤äº’ã€‚</p>
<p>SeriesIndex ç›¸å½“äºæ˜¯ Memtableï¼ŒSeriesSegment ç›¸å½“äºæ˜¯ WALã€‚SeriesSegment é‡Œé¢ä¿å­˜çš„éƒ½æ˜¯å…·ä½“é’ˆå¯¹ series çš„æ“ä½œï¼ˆoperationï¼‰ï¼Œåªè¦åœ¨ recover çš„æ—¶å€™æŠŠ SeriesSegment é‡Œé¢çš„æ•°æ®é‡æ”¾ä¸€éå°±å¯ä»¥äº†ï¼ˆè§<code>SeriesIndex.Recover</code>ï¼‰ã€‚<strong>ä¸ºäº†å‡å° SeriesIndex çš„å†…å­˜å ç”¨ï¼ŒInfluxDB åšäº† KV åˆ†ç¦»</strong>ï¼ŒçœŸå®çš„ valueï¼ˆå³Series Keyï¼‰ éƒ½æ˜¯ä¿å­˜åœ¨ â€œWALâ€ï¼ˆSeriesSegmentï¼‰ ä¸­çš„ï¼Œâ€œmemtableâ€ï¼ˆå³ SeriesIndexï¼‰ ä¸­çš„ value åªæ˜¯æŒ‡å‘  SeriesSegment å½“ä¸­ä¸€ä¸ªåœ°å€çš„ offsetã€‚</p>
<p>å’Œå…¶ä»– LSMT ç±»ä¼¼ï¼ŒSeriesIndex ä¹Ÿéœ€è¦åš compactï¼Œcompact çš„é€»è¾‘å°±æ˜¯ éå† SeriesPartition ä¸‹é¢çš„æ‰€æœ‰çš„ segment é‡Œé¢çš„æ‰€æœ‰ entryï¼ŒæŠŠå­˜æ´»çš„ series å†™åˆ° series index æ–‡ä»¶ä¸­ã€‚å…·ä½“çš„ compact é€»è¾‘æ˜¯åœ¨<code>SeriesPartitionCompactor.compactIndexTo</code>ä¸­ï¼Œä¸ºäº†å®ç° series çš„åˆ é™¤ï¼Œä¹Ÿåœ¨ compact çš„æ—¶å€™åˆ¤æ–­æ˜¯ series æ˜¯å¦å·²ç»è¢«æ ‡è®°ä¸º deletedã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆéœ€è¦ SeriesIDï¼Ÿå¦‚æœç›´æ¥åœ¨å†…å­˜é‡Œé¢ç»´æŠ¤ SeriesKey åˆ° Series çš„æ˜ å°„ï¼Œåˆ™å†…å­˜é‡Œé¢ä¼šå¤šå¾ˆå¤šçš„ tag key å’Œ tag value æ‹¼æ¥è€Œæˆçš„æ•°æ®ï¼Œè€Œä¸”è¿™ä¸ªæ•°æ®ä¼šæœ‰å¤§é‡çš„å†—ä½™ã€‚SeriesID ç›¸å½“äºåˆå¹¶äº†è¿™éƒ¨åˆ†å†—ä½™çš„æ•°æ®ã€‚</p>
</blockquote>
<h4 id="seriesindex">SeriesIndex</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-index-file-layout.svg" alt="influxdb-series-index-file-layout.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
SeriesIndex çš„æ•°æ®ç»„æˆ
</i>
</div>
<p>SeriesIndex åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸Šçš„ï¼š<code>SeriesIndex.keyIDMap</code>/<code>SeriesIndex.idOffsetMap</code>/<code>SeriesIndex.tombstones</code>ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ä¿å­˜åœ¨ç£ç›˜ä¸Šçš„ï¼š<code>SeriesIndex.keyIDData</code> /<code>SeriesIndex.idOffsetData</code>ã€‚</p>
<p>SeriesIndex ç£ç›˜æ–‡ä»¶é‡Œé¢çš„ series æ•°æ®å¯ä»¥ç†è§£ä¸ºåŸºçº¿æ•°æ®ã€‚åœ¨å¯åŠ¨çš„æ—¶å€™ï¼ŒInfluxDB ä¼šæŠŠç£ç›˜ä¸Šé¢çš„ Series Index æ–‡ä»¶é‡Œé¢çš„å†…å®¹åŠ åœ¨åˆ° <code>SeriesIndex.keyIdData</code>å’Œ <code>SeriesIndex.idOffsetData</code>ä¸­ï¼ˆé€šè¿‡ mmap çš„æ–¹å¼ï¼‰ï¼Œè¿™å—æ–‡ä»¶é‡Œé¢çš„å†…å®¹å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæŒä¹…åŒ–çš„ HashMapã€‚InfluxDB ä¼šå®šæœŸåœ°æŠŠ å†…å­˜çš„æ•°æ®ï¼ˆ<code>SeriesIndex.keyIDMap</code>å’Œ <code>SeriesIndex.idOffsetMap</code>ç­‰ï¼‰å’Œç£ç›˜çš„åŸºçº¿æ•°æ®åˆå¹¶å½¢æˆä¸€ä¸ªæ–°çš„åŸºçº¿æ•°æ®ã€‚</p>
<h4 id="seriessegment">SeriesSegment</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-segment-file-layout.svg" alt="influxdb-series-segment-file-layout.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 SeriesSegment çš„äºŒè¿›åˆ¶æ ¼å¼ 
</i>
</div>
<p>SeriesSegment å°±æ˜¯ä¸€ç»„ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œç”±ä¸€ä¸ª header å’Œæ¤…å­åˆ—çš„ SeriesEntry ç»„æˆï¼Œæ¯ä¸ª Entry å¯èƒ½æ˜¯ä¸€ä¸ª insert entryï¼ˆä»£è¡¨ SeriesKey çš„æ’å…¥ï¼‰æˆ–è€… tombstone entry ï¼ˆä»£è¡¨ series key çš„åˆ é™¤ï¼‰ã€‚åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šé€šè¿‡ mmap çš„æ–¹å¼æŠŠ segments åŠ è½½è¿›æ¥ï¼Œæ¯æ¬¡åˆ›å»ºæ–°çš„ Series Key çš„æ—¶å€™ä¹Ÿä¼šå‘è¿™ä¸ª mmap çš„æ–‡ä»¶çš„æœ«å°¾å» append ä¸€ä¸ªæ–°çš„ series entryã€‚</p>
<p>å¦‚ä¸Šä»‹ç»ï¼ŒSeriesIndex å†…éƒ¨ç»´æŠ¤çš„å¹¶ä¸æ˜¯ SeriesID åˆ° SeriesKey çš„æ˜ å°„ï¼ŒçœŸæ­£çš„ SeriesKey æ˜¯ä¿å­˜åœ¨ WAL å³ SeriesSegment ä¸Šé¢çš„ï¼Œå› æ­¤ SeriesIndex é¢å¤–å¼•å…¥äº†ä¸€ä¸ª offset å»è¡¨æ˜ SeriesKey åœ¨ SeriesSegment ä¸Šçš„ åœ°å€ã€‚</p>
<h4 id="seriesoffset">SeriesOffset</h4>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/influxdb-series-offset.svg" alt="influxdb-series-offset.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 SeriesOffset æ ¼å¼
</i>
</div>
<p>SeriesOffset æŒ‡å‘çš„æ˜¯ä¸€ä¸ª series entry åœ¨ series segments ä¸­çš„åœ°å€ï¼Œæ˜¯ä¸€ä¸ª 64 ä½å€¼ï¼Œç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œé«˜ 32 ä½ï¼ˆå®é™…ä¸Šåªä¼šæœ‰ 16 ä½ä½¿ç”¨ï¼Œè¶³å¤Ÿå¯»å€ 2^16 ä¸ª segment)æ˜¯ segment id ï¼Œä½ 32 ä½æ˜¯ series entry åœ¨æ­¤ id çš„ series segment ä¸­çš„åç§»é‡ã€‚å› æ­¤é€šè¿‡ SeriesOffset å¯ä»¥å”¯ä¸€åœ°æ‰¾åˆ° segment ä»¥åŠå…¶ä¸­ entry çš„ä½ç½®ã€‚</p>
<blockquote>
<p>Series Offset çš„æ‹¼æ¥å’Œæ‹†åˆ†è§<code>JoinSeriesOffset</code>å’Œ <code>SplitSeriesOffset</code>ä¸¤ä¸ªå‡½æ•°</p>
</blockquote>
<h4 id="æŸ¥æ‰¾è·¯å¾„">æŸ¥æ‰¾è·¯å¾„</h4>
<ul>
<li>æ ¹æ® SeriesKey æŸ¥æ‰¾ SeriesIDï¼šé¦–å…ˆåœ¨å†…å­˜çš„<code>SeriesIndex.keyIDMap</code>æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™<strong>éå†</strong> SeriesSegment ä¸‹é¢çš„æ‰€æœ‰ SeriesEntryï¼Œæ‰¾åˆ° Key åŒ¹é…çš„ ID è¿”å›</li>
<li>æ ¹æ® SeriesID æŸ¥æ‰¾ SeriesKeyï¼š<code>SeriesPartition.SeriesKey</code>ã€‚é¦–å…ˆæ ¹æ® series id æ‰¾åˆ° series offsetï¼Œç„¶åæ ¹æ® series offset æ‰¾åˆ° series keyã€‚
<ul>
<li>æ ¹æ® id æ‰¾åˆ° offset é¦–å…ˆä¹Ÿæ˜¯ä» å†…å­˜çš„ <code>SeriesIndex.idOffsetMap</code>è¯»å–ï¼Œå¦‚æœæ²¡æœ‰å°±å» SeriesIndex çš„ç£ç›˜éƒ¨åˆ†è¯»å–ï¼ˆéå† <code>SeriesIndex.idOffsetData</code>æŸ¥æ‰¾ï¼‰</li>
<li>æ ¹æ® offset æ‰¾åˆ° keyï¼šæŠŠ offset åˆ†å‰²ä¸º SegmentID å’Œ pos ä¸¤éƒ¨åˆ†ï¼Œä» Segment ID å¯ä»¥æ‰¾åˆ° ç£ç›˜ä¸Šçš„ SeriesSegment æ–‡ä»¶ï¼Œæ¥ç€è¿™ä¸ª SeriesSegment çš„ pos ä½ç½®çš„æ•°æ®ï¼ˆUvarint+stringï¼‰å°±æ˜¯å¯¹åº”çš„ series keyã€‚</li>
</ul>
</li>
</ul>
<h3 id="high-cardinality-é—®é¢˜æ˜¯å¦‚ä½•å‡ºç°çš„">High Cardinality é—®é¢˜æ˜¯å¦‚ä½•å‡ºç°çš„</h3>
<p>InfluxDB æœ€ä¸ºäººè¯Ÿç—…çš„é—®é¢˜å°±æ˜¯æ‰€è°“çš„ high cardinality é—®é¢˜ï¼Œå³å½“ InfluxDB å®ä¾‹å†™å…¥å¤§é‡çš„ä¸åŒ tag value çš„æ—¶å€™ï¼Œæ—¶é—´çº¿æ•°é‡ä¼šå¤§å¹…è†¨èƒ€ã€‚</p>
<p>è€ƒè™‘æŸä¸ª measurement æœ‰ä¸‰ä¸ª tag: HostName, AZ, Regionï¼Œåˆ†åˆ«ä»£è¡¨ä¸€ä¸ªæœåŠ¡å™¨çš„æœºå™¨åã€å¯ç”¨åŒºå’Œ regionã€‚å…¶ä¸­ HostName å¯èƒ½å‡ºç° 100 ä¸ªå€¼ï¼ŒAZ å¯èƒ½ å‡ºç° 20 ä¸ªå€¼ï¼ŒRegion å¯èƒ½å‡ºç° 10 ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ª measurement å¯èƒ½å‡ºç°çš„æ€»æ—¶é—´çº¿æ•°é‡ï¼ˆå³æ‰€è°“çš„ cardinalityï¼‰ä¸º $100 \times 20 \times 10=20000$ï¼Œå³æ‰€æœ‰ tag å€¼ç©ºé—´å¤§å°çš„ç¬›å¡å°”ç§¯ã€‚</p>
<p>å½“æ—¶åºæ•°æ®çš„ cardinality å¢é•¿çš„æ—¶å€™ï¼ŒInfluxDB å†…éƒ¨çš„å€’æ’ç´¢å¼•ä¼šå¤§å¹…è†¨èƒ€ã€‚InfluxDB å†å²ä¸Šä¸ºäº†è§£å†³å€’æ’ç´¢å¼•è†¨èƒ€çš„é—®é¢˜é‡‡å–äº†å¤šç§ç­–ç•¥ï¼Œæ¯”å¦‚é€šè¿‡ SeriesID é™ä½å€’æ’ç´¢å¼•çš„å¤§å°ï¼Œå°†<a href="https://github.com/influxdata/influxdb/issues/7151">çº¯å†…å­˜å­˜å‚¨çš„å€’æ’ç´¢å¼•ä¼˜åŒ–ä¸ºå†…å­˜+ç£ç›˜çš„ç´¢å¼•</a>ï¼ˆå³æœ¬æ–‡çš„ TSI å¼•æ“ï¼‰ç­‰ç­‰ã€‚ä½†æ˜¯è¿™äº›æ‰‹æ®µéƒ½æ˜¯å»¶ç¼“å€’æ’å‡ºç°æ€§èƒ½ç“¶é¢ˆçš„æ—¶é—´ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒSeries Index éƒ¨åˆ†ï¼ˆå³ SeriesID åˆ° SeriesKey çš„æ­£æ’ç´¢å¼•ï¼‰åœ¨å¤§é‡æ—¶é—´çº¿çš„æƒ…å†µä¸‹ä¹Ÿä¼šå‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚æ¯”å¦‚ Series ç´¢å¼•åœ¨åš compaction çš„æ—¶å€™ï¼ˆ<code>SeriesPartitionCompactor.Compact</code>ï¼‰ä¸€æ–¹é¢ä¼šéå† SeriesSegment æ–‡ä»¶ä¸­çš„æ‰€æœ‰ entry å» apply åˆ°å†…å­˜çš„ hashmapï¼Œå†æŠŠå†…å­˜ä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜ä¸Šçš„ SeriesIndex æ–‡ä»¶ä¸­ã€‚å‡è®¾ Series æ•°é‡å¾ˆå¤§ï¼Œé‚£ä¹ˆè¿™ä¸ª compact è¿‡ç¨‹å¾ˆæœ‰å¯èƒ½å‡ºç° OOMã€‚</p>
<p>ç›®å‰å¯ä»¥æƒ³åˆ°çš„ä¸€ä¸ªç®€å•çš„ç¼“è§£åŠæ³•æ˜¯ç°åœ¨ RP ç»´åº¦çš„ Series ç´¢å¼•å˜æˆ RP ä¸‹é¢çš„ Shard ç»´åº¦çš„ï¼Œå½“ Shard è¿‡æœŸä¹‹åä¼šè‡ªåŠ¨æŠŠç›¸åº”çš„ Series ç´¢å¼•è¿‡æœŸã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>Apache Parquet æ ¼å¼ç®€ä»‹</title>
			<link>https://huanglei.rocks/posts/parquet/</link>
			<pubDate>Sat, 05 Mar 2022 15:44:33 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/parquet/</guid>
			<description>ç®€ä»‹ Parquet æ˜¯ä¸€ç§é¢å‘åˆ—çš„æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œåœ¨ Hadoop ç”Ÿæ€ä¸­ä½¿ç”¨å¹¿æ³›ã€‚Parquet æ–‡ä»¶æ˜¯ä¸å¯å˜çš„ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ï¼Œåªèƒ½é€šè¿‡ rewrite çš„æ–¹å¼å®ç°ã€‚ æ•°æ® layout ä¸€ä¸ª Parquet æ–‡ä»¶çš„æ•°</description>
			<content type="html"><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>Parquet æ˜¯ä¸€ç§é¢å‘åˆ—çš„æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œåœ¨ Hadoop ç”Ÿæ€ä¸­ä½¿ç”¨å¹¿æ³›ã€‚Parquet æ–‡ä»¶æ˜¯ä¸å¯å˜çš„ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ï¼Œåªèƒ½é€šè¿‡ rewrite çš„æ–¹å¼å®ç°ã€‚</p>
<h2 id="æ•°æ®-layout">æ•°æ® layout</h2>
<p>ä¸€ä¸ª Parquet æ–‡ä»¶çš„æ•°æ®å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®˜ç½‘ä¸Šçš„è¿™ä¸ªå›¾å¹¶æ²¡æœ‰åŒ…å« index pagesã€‚</p>
<p><img src="https://raw.githubusercontent.com/apache/parquet-format/master/doc/images/FileLayout.gif#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=gFbsV&amp;originHeight=478&amp;originWidth=601&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 å®˜æ–¹çš„æ ¼å¼å›¾  
</i>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-original.svg" alt="parquet-original.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 åŸå§‹è¡Œæ ¼å¼çš„æ•°æ®  
</i>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-travel.svg" alt="parquet-travel.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Parquet æ•°æ®çš„éå†é¡ºåº 
</i>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-layout.svg" alt="parquet-layout.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 ä½¿ç”¨ Parquet è½¬æ¢ä¹‹åçš„æ ¼å¼ 
</i>
</div>
<p>åœ¨ Parquet ä¸­ï¼Œæ•°æ®æ¯éš”è‹¥å¹²è¡Œè¢«åˆ†ä½œä¸€ä¸ª row groupï¼›åœ¨åŒä¸€ä¸ª row group ä¸­ï¼Œä¸åŒ row çš„ç›¸åŒåˆ—è¢«è¿ç»­å­˜å‚¨åœ¨ä¸€èµ·ã€‚è¿ç»­çš„åˆ—å†é—´éš”è‹¥å¹²è¡Œä¼šè¢«åˆ†å‰²ä¸ºä¸€ä¸ªé¡µï¼ˆpageï¼‰ã€‚</p>
<h2 id="å…ƒæ•°æ®">å…ƒæ•°æ®</h2>
<p><img src="https://cdn.jsdelivr.net/gh/apache/parquet-format/doc/images/FileLayout.gif" alt="image.png"></p>
<p>ä»å¦‚ä¸Šçš„ Parquet æ ¼å¼å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸€ä¸ª Parquet æ–‡ä»¶æ˜¯åŒ…å«äº†ä¸€äº›å…ƒæ•°æ®çš„ï¼Œæ¯”å¦‚ footerã€page header ç­‰ç­‰ï¼Œè¿™äº›å…ƒæ•°æ®å¯ä»¥åœ¨è¯»å– parquet æ–‡ä»¶çš„æ—¶å€™æä¾›ç›¸å…³ä¿¡æ¯æ¥åŠ é€Ÿéå†ã€‚</p>
<h3 id="footer">Footer</h3>
<p>Footer æ˜¯æ•´ä¸ª Parquet æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œä» footer å¯ä»¥å¾—åˆ°æ–‡ä»¶çš„ç‰ˆæœ¬ã€æ•°æ® schemaã€row group çš„å…ƒæ•°æ®ã€row group ä¸­çš„æ¯ä¸€åˆ—çš„å…ƒæ•°æ®ç­‰ç­‰ã€‚</p>
<p>Footer ä½äº Parquet çš„æœ«å°¾ï¼Œå› æ­¤å¯ä»¥ä»æ–‡ä»¶ç»“å°¾ seek åˆ°å€’æ•°ç¬¬ 8 åˆ°å€’æ•°ç¬¬ 4 å­—èŠ‚ï¼Œä½œä¸º footer çš„é•¿åº¦ï¼Œä»è€Œå¾—åˆ° footer åŒºçš„èµ·å§‹ offsetã€‚</p>
<p>Footer åŒºæ•°æ®éµå¾ªç‰¹å®šçš„ç¼–ç æ ¼å¼ï¼ˆThriftCompactProtocolï¼‰ï¼Œå› æ­¤å¯ä»¥æ–¹ä¾¿åœ°ååºåˆ—åŒ–ã€‚</p>
<p>Footer åŒºè¿˜åŒ…å«äº† row group å’Œ row group ä¸­çš„åˆ—çš„ä¿¡æ¯ã€‚</p>
<h3 id="åˆ—çš„å…ƒæ•°æ®">åˆ—çš„å…ƒæ•°æ®</h3>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/20220305160426.png" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
  åˆ—çš„å…ƒæ•°æ®ä½ç½®  
</i>
</div>
<p>åœ¨ footer ä¸­ï¼Œæ¯ä¸€åˆ—çš„ä¿¡æ¯ä¹Ÿè¢«è®°å½•ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>åˆ—çš„ç±»å‹ã€ç¼–ç ï¼›</li>
<li>åˆ—å€¼çš„æ•°é‡ï¼›</li>
<li>ç¬¬ä¸€ä¸ªæ•°æ®é¡µçš„ offsetï¼›</li>
<li>ç¬¬ä¸€ä¸ªç´¢å¼•é¡µçš„ offsetï¼›</li>
<li>å‹æµ‹/è§£å‹ç¼©çš„å¤§å°ï¼›</li>
<li>ä»¥åŠä¸€äº›é¢å¤–çš„é”®å€¼å¯¹ã€‚</li>
</ul>
<p>æ ¹æ® footer ä¸­çš„è¿™äº›åˆ—çš„ä¿¡æ¯å°±å¯ä»¥å¿«é€Ÿæ‰¾åˆ° Parquet æ–‡ä»¶ä¸­çš„æ•°æ®åœ°å€å’Œç´¢å¼•åœ°å€ã€ä»¥åŠå¦‚ä½•è§£æè¿™äº›æ•°æ®ã€‚</p>
<h3 id="æ–‡ä»¶å†…ç´¢åˆ—">æ–‡ä»¶å†…ç´¢åˆ—</h3>
<p><a href="https://issues.apache.org/jira/browse/PARQUET-1201">Parquet 2.5 ç‰ˆæœ¬</a>æ”¯æŒäº†åˆ—å€¼ç´¢å¼•åŠŸèƒ½ï¼Œå…·ä½“çš„åŠŸèƒ½ä»‹ç»å¯ä»¥å‚è€ƒ <a href="https://github.com/apache/parquet-format/blob/master/PageIndex.md">ColumnIndex Layout to Support Page Skipping</a>.</p>
<p>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œç»Ÿè®¡æ•°æ®ï¼ˆminã€maxï¼‰åªåœ¨ column çš„ metadata å’Œ page header å½“ä¸­ï¼Œå½“è¯»å– page çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® page header ä¸­çš„ç»Ÿè®¡æ•°æ®å†³å®šæ˜¯å¦éœ€è¦è·³è¿‡è¿™ä¸€é¡µï¼Œä½†è¿™æ ·è¿˜æ˜¯éœ€è¦éå†æ–‡ä»¶ä¸­çš„æ¯ä¸€é¡µã€‚</p>
<p>ç›®æ ‡ï¼šé€šè¿‡ minmax å¯ä»¥ç›´æ¥å®šä½åˆ° page çš„æ–¹å¼æé«˜èŒƒå›´æŸ¥è¯¢å’Œç‚¹æŸ¥çš„ IO æ•ˆç‡ã€‚å…·ä½“æ¥è¯´é’ˆå¯¹ row group æ’åºåˆ—çš„å•è¡ŒæŸ¥è¯¢ï¼Œæ¯ä¸€åˆ—åªéœ€è¦è¯»å–ä¸€é¡µæ•°æ®ã€‚æ’åºåˆ—çš„èŒƒå›´æŸ¥è¯¢åªè¯»å–èŒƒå›´æ‰€æ¶‰åŠçš„æ•°æ®é¡µï¼›å¦‚æœå…¶ä»–çš„æŸ¥è¯¢å…·æœ‰é«˜é€‰æ‹©æ€§ï¼Œå³ä½¿æŸ¥è¯¢æ¡ä»¶ä¸æ˜¯æ’åºåˆ—ï¼Œä¹Ÿè¦èƒ½å¤ŸæŒ‰éœ€è¯»å–æ•°æ®é¡µã€‚</p>
<p>ä¸ºäº†å®ç°è¿™æ ·çš„ç›®æ ‡ï¼ŒParquet åœ¨ row group çš„å…ƒæ•°æ®ä¸Šå¢åŠ äº†å¦‚ä¸‹ä¸¤ä¸ªé’ˆå¯¹åˆ—çš„æ•°æ®ç»“æ„ï¼ˆå³åœ¨ä¸€ä¸ª row group ä¸­çš„æ¯ä¸€ä¸ªåˆ—éƒ½æœ‰ä¸‹é¢çš„ä¸¤ä¸ªç´¢å¼•æ¥æè¿°å®ƒä»¬ï¼‰ï¼š</p>
<ul>
<li>ColumnIndexï¼šé’ˆå¯¹ scan predicateï¼Œæ”¯æŒé€šè¿‡åˆ—å€¼æ‰¾åˆ°åˆ—çš„æ•°æ®æ‰€åœ¨çš„é¡µï¼›</li>
<li>OffsetIndexï¼šé€šè¿‡ ColumnIndex æ‰¾åˆ° match çš„ row ä¹‹åï¼ŒOffsetIndex æ”¯æŒæŒ‰ row index å»è·å–ç›¸åº”çš„å€¼ã€‚ä¸€ä¸ª row group çš„æ‰€æœ‰ column çš„ OffsetIndex éƒ½æ˜¯å­˜å‚¨åœ¨ä¸€èµ·çš„ã€‚</li>
</ul>
<p>ç´¢å¼•çš„åœ°å€åœ¨ footer åŒºä¹‹å‰çš„åœ°æ–¹ï¼Œfooter é‡Œé¢æœ‰ä¸€ä¸ªå­—æ®µæŒ‡æ˜äº†å…¶ offsetã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/parquet-file-format.svg" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Index page çš„ä½ç½® 
</i>
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="sd">/// Description for ColumnIndex.
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="sd">/// Each &lt;array-field&gt;[i] refers to the page at OffsetIndex.page_locations[i]
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="sd"></span><span class="cp">#[derive(Clone, Debug, Eq, Hash, Ord, PartialEq, PartialOrd)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ColumnIndex</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">  </span><span class="sd">/// A list of Boolean values to determine the validity of the corresponding
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// min and max values. If true, a page contains only null values, and writers
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// have to set the corresponding entries in min_values and max_values to
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// byte[0], so that all lists have the same length. If false, the
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// corresponding entries in min_values and max_values must be valid.
</span></span></span><span class="line hl"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">null_pages</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">  </span><span class="sd">/// Two lists containing lower and upper bounds for the values of each page.
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// These may be the actual minimum and maximum values found on a page, but
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// can also be (more compact) values that do not exist on a page. For
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// example, instead of storing &#34;&#34;Blart Versenwald III&#34;, a writer may set
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// min_values[i]=&#34;B&#34;, max_values[i]=&#34;C&#34;. Such more compact values must still
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// be valid values within the column&#39;s logical type. Readers must make sure
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// that list entries are populated before using them by inspecting null_pages.
</span></span></span><span class="line hl"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">min_values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line hl"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">max_values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="w">  </span><span class="sd">/// Stores whether both min_values and max_values are orderd and if so, in
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// which direction. This allows readers to perform binary searches in both
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// lists. Readers cannot assume that max_values[i] &lt;= min_values[i+1], even
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// if the lists are ordered.
</span></span></span><span class="line hl"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">boundary_order</span>: <span class="nc">BoundaryOrder</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-25">25</a></span><span class="cl"><span class="w">  </span><span class="sd">/// A list containing the number of null values for each page *
</span></span></span><span class="line hl"><span class="ln" id="code-sec-26"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-26">26</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">null_counts</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-27">27</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-28">28</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-29">29</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-30">30</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Clone, Debug, Eq, Hash, Ord, PartialEq, PartialOrd)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-31">31</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">OffsetIndex</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-32">32</a></span><span class="cl"><span class="w">  </span><span class="sd">/// PageLocations, ordered by increasing PageLocation.offset. It is required
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-33">33</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="sd">/// that page_locations[i].first_row_index &lt; page_locations[i+1].first_row_index.
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-34">34</a></span><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">page_locations</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PageLocation</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-35">35</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="parquet-çš„ä¼˜åŠ¿">Parquet çš„ä¼˜åŠ¿</h2>
<ul>
<li>æŒ‰éœ€è¯»å–åˆ—çš„å€¼ï¼Œæ¯”å¦‚åœ¨ OLAP åœºæ™¯ä¸‹ï¼Œå¤§å®½è¡¨å¾€å¾€æœ€ç»ˆåªæœ‰å°‘é‡çš„åˆ—ä¼šè¢«è¯»å–åˆ°ï¼›</li>
<li>è‡ªæè¿°ï¼Œè‡ªå¸¦ schemaï¼Œæ”¯æŒæ•°æ®ç»“æ„åµŒå¥—ï¼›</li>
<li>ç”±äºåˆ—ä¿å­˜åœ¨ä¸€èµ·ï¼Œå› æ­¤å¯ä»¥æé«˜å‹ç¼©å’Œç¼–ç çš„æ•ˆç‡ï¼ˆæ¯”å¦‚ RLEã€å­—å…¸å‹ã€Bit Packing ç­‰ç­‰ï¼‰;</li>
<li>æ–‡ä»¶è‡ªå¸¦ç´¢å¼•ï¼Œæ”¯æŒå¿«é€Ÿæ£€ç´¢ data pageã€‚</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Apache BookKeeper ç¬”è®°</title>
			<link>https://huanglei.rocks/posts/bookkeeper-note/</link>
			<pubDate>Thu, 24 Feb 2022 01:18:35 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/bookkeeper-note/</guid>
			<description>BookKeeper çš„ä½¿ç”¨åœºæ™¯ WALï¼šæ¯”å¦‚ HDFS Namenode çš„ EditLogï¼ˆè¦æ±‚é«˜å¯é ï¼‰ åˆ†å¸ƒå¼å­˜å‚¨ï¼šæ¯”å¦‚ Pulsar çš„æ¶ˆæ¯å­˜å‚¨ã€DistributedLog ç­‰ æ ¸å¿ƒç†å¿µ é€šè¿‡æ¡å¸¦åŒ–å†™ï¼ˆ</description>
			<content type="html"><![CDATA[<h1 id="bookkeeper-çš„ä½¿ç”¨åœºæ™¯">BookKeeper çš„ä½¿ç”¨åœºæ™¯</h1>
<ul>
<li>WALï¼šæ¯”å¦‚ HDFS Namenode çš„ EditLogï¼ˆè¦æ±‚é«˜å¯é ï¼‰</li>
<li>åˆ†å¸ƒå¼å­˜å‚¨ï¼šæ¯”å¦‚ Pulsar çš„æ¶ˆæ¯å­˜å‚¨ã€DistributedLog ç­‰</li>
</ul>
<h1 id="æ ¸å¿ƒç†å¿µ">æ ¸å¿ƒç†å¿µ</h1>
<ul>
<li>é€šè¿‡æ¡å¸¦åŒ–å†™ï¼ˆData Stripingï¼‰å®ç°æ•°æ®çš„å¤šå‰¯æœ¬ï¼Œæ‰€æœ‰å­˜å‚¨èŠ‚ç‚¹è§’è‰²å¯¹ç­‰ï¼›</li>
<li>é€šè¿‡å…¶ä»–çš„å­˜å‚¨ç»„ä»¶ï¼ˆZooKeeperï¼‰å®ç°å…ƒæ•°æ®é«˜å¯é ï¼Œæ•…éšœæ¢å¤ï¼ˆrecoverï¼‰æµç¨‹å¼ºä¾èµ– ZK çš„å…ƒæ•°æ®ï¼›
<ul>
<li>ä¹Ÿå¯ä»¥é€‰ç”¨å…¶ä»–çš„å­˜å‚¨æœåŠ¡ï¼Œè¦æ±‚ 1. CP ç³»ç»Ÿï¼›2. æä¾› CAS åŸè¯­</li>
</ul>
</li>
<li>åŸºäº RocksDB æä¾› <code>(ledger, sequence) -&gt; (file, physicalOffset)</code>  çš„ç´¢å¼•ï¼ˆ<code>SingleDirectoryDbLedgerStorage#ledgerIndex</code>ï¼‰ï¼›</li>
<li>åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª writer å’Œå¤šä¸ª readerï¼Œé€šè¿‡ fencing æœºåˆ¶é¿å…å‡ºç°å¤š writerï¼Œé¿å… sequence ä¹±åºï¼›</li>
<li>è¯»å†™åˆ†ç¦»ï¼Œå†·çƒ­åˆ†ç¦»ï¼ˆtailing read/catch-up readï¼‰æé«˜ååï¼›</li>
</ul>
<h1 id="bookkeeper-çš„æœ¯è¯­">BookKeeper çš„æœ¯è¯­</h1>
<ul>
<li>ledgerï¼šä¸€å†™å¤šè¯»çš„ append-only æ–‡ä»¶ï¼Œledger çš„æœ€å°æ•°æ®å•å…ƒæ˜¯ fragmentï¼›</li>
<li>bookieï¼šå­˜å‚¨ ledger çš„èŠ‚ç‚¹ï¼›</li>
<li>ledger has many recordsï¼Œ calledï¼šentryï¼Œæ¯ä¸ªentryéƒ½æœ‰ä¸€ä¸ª sequence numberï¼Œå¯ä»¥æ ¹æ® ledger + seq æ¥è¯»å–ä¸€éƒ¨åˆ† entryã€‚</li>
<li>quorumï¼šå‡ ä¸ª bookie ç»„æˆä¸€ä¸ª quorumï¼Œé€šè¿‡å¤åˆ¶æé«˜å¯ç”¨æ€§ã€‚</li>
<li>data stripingï¼šæ•°æ®å—äº¤ç»‡å†™å…¥åˆ°å„ä¸ªè®¾å¤‡ï¼Œæé«˜å†™å…¥çš„æ€§èƒ½ã€‚ç±»ä¼¼ RAID1 çš„æœºåˆ¶ã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/bookkeeper-quorum-writes.svg" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 BookKeeper çš„ quorum write æœºåˆ¶ 
</i>
</div>
<p>Striping å¾ˆå®¹æ˜“å°±ä¼šå¯¼è‡´è¯»å–è€…æ‰€çœ‹åˆ°çš„ log ä¸ä¸€è‡´ï¼Œå› æ­¤ BK å¼•å…¥äº† ZK å»ä¿å­˜å…ƒæ•°æ®ï¼Œå¹¶ä¸”é€šè¿‡ triming æœºåˆ¶ï¼ˆBK ç§°ä¸º reader-initiated ledger recoveryï¼‰æ¥ç¡®ä¿æœ«å°¾æœªå®Œæ•´å†™å®Œæ•´ä¸ª quorum çš„æ•°æ®èƒ½å¤Ÿè¢«å®‰å…¨åˆ é™¤å¹¶ä¸”å¯¹ reader ä¸å¯è§ã€‚</p>
<h1 id="å®ç°ç»†èŠ‚">å®ç°ç»†èŠ‚</h1>
<h2 id="bookie-çš„ç»“æ„">Bookie çš„ç»“æ„</h2>
<p>Bookie æ˜¯å­˜å‚¨èŠ‚ç‚¹ï¼Œå…·ä½“åŒ…å«ä¸¤ä¸ªæ¨¡å—ï¼š</p>
<ul>
<li>journalï¼šWALï¼ŒåŒæ­¥å†™ï¼Œè´Ÿè´£ä¿å­˜ writer çš„å†™å…¥æ“ä½œï¼›</li>
<li>ledgerï¼šåŒ…å«å†…å­˜çš„çŠ¶æ€ï¼ˆmemtableï¼‰ã€ledger çš„ç´¢å¼•ç­‰ï¼Œå¼‚æ­¥å†™ã€‚</li>
</ul>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/20220224231150.png" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 BookKeeper çš„è¯»å†™è·¯å¾„ 
</i>
</div>
<p>ç†æƒ³çŠ¶å†µä¸‹ï¼Œjournal å’Œ ledger åº”è¯¥ä½äºä¸åŒçš„ç£ç›˜ä¸Šï¼Œå‡å°‘ä»–ä»¬åŒæ—¶ä¸å¯ç”¨çš„æ¦‚ç‡ã€‚</p>
<h2 id="bookkeeper-æä¾›çš„-api">BookKeeper æä¾›çš„ API</h2>
<ul>
<li>åˆ›å»º ledger</li>
<li>å‘ ledger æ–°å¢ entry</li>
<li>æ‰“å¼€ä¸€ä¸ª ledger</li>
<li>ä»ledger è¯»å– entry</li>
<li>å…³é—­ ledger é¿å…åç»­æ•°æ®å†™å…¥</li>
<li>åˆ é™¤ä¸€ä¸ªledger</li>
</ul>
<h2 id="ledger-æ“ä½œ">Ledger æ“ä½œ</h2>
<h3 id="ledger-åˆ›å»º">Ledger åˆ›å»º</h3>
<p>ä¸€ä¸ª ledger éœ€è¦ç”±ä¸€ä¸ª ensemble æ¥è´Ÿè´£ï¼Œå› æ­¤åˆ›å»º ledger çš„æ—¶å€™å¿…é¡»æŒ‡å®š ledger çš„ quorum å’Œ ensembleã€‚å…·å¤‡ f+1 ä¸ªèŠ‚ç‚¹çš„ quorum å¯ä»¥å®¹å¿ f ä¸ªèŠ‚ç‚¹å®•æœºã€‚</p>
<ul>
<li>quorumï¼šå†™å…¥èŠ‚ç‚¹é›†åˆã€‚æ›´å¤§çš„quorum æä¾›æ›´å¼ºçš„å¯ç”¨æ€§ã€‚</li>
<li>ensembleï¼šstriping æ‰€éœ€è¦çš„èŠ‚ç‚¹æ€»æ•°ã€‚æ›´å¤§çš„ ensemble æä¾›æ›´å¤§çš„ååã€‚</li>
</ul>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/paper-creating-using-ledger.png?versionId=CAEQIBiBgMDlsZax.RciIGJmZGJjYjRjODNiZjQ4ZDE4OWZkMjVlZWRhNmEzMGJh" alt="paper-creating-using-ledger.png"></p>
<ul>
<li>quorum æ˜¯ä»¥ round-robin çš„å½¢å¼åˆ†æ•£åœ¨æ•´ä¸ª ensemble ä¸­ã€‚</li>
<li>quorum å’Œ ensemble è¿™äº›å…ƒæ•°æ®ä¿å­˜åœ¨ zookeeper ä¸­ã€‚</li>
</ul>
<blockquote>
<p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå½“bkå®¢æˆ·ç«¯å°è¯•è¯»å– entry çš„æ—¶å€™ï¼Œéœ€è¦ç¡®å®šä»å“ªäº›bookieç»„æˆçš„quorum è¯»å–ï¼Œé‚£è¿™ä¸ªquorumæ˜¯æ€ä¹ˆç¡®å®šçš„ï¼Ÿ</p>
</blockquote>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/paper-to-read-a-given-entry-e.png?versionId=CAEQIBiBgICTgJmx.RciIGNmMjU4OWFmYTE0YjQ4NzFiNjY0MTM4NzRjZjNjZTJi" alt="image.png"></p>
<h3 id="ledger-å…³é—­">Ledger å…³é—­</h3>
<p>Ledger å…³é—­æ˜¯ä¸€ä¸ªåŸå­çš„æ“ä½œï¼Œä¼šåœ¨ ZK ä¸­è®°å½• ledger æœ€åä¸€ä¸ª entry çš„ seqã€‚è¿™é‡ŒZK æä¾›çš„ä¸€è‡´æ€§åè®®éå¸¸é‡è¦ï¼Œå¦åˆ™ Bookkeper çš„å®¢æˆ·ç«¯å¯èƒ½ä¼šè§‚å¯Ÿåˆ° ledger çš„ ä¸ä¸€è‡´ã€‚
<img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/1635067390415-cdc4ede3-9bd7-4bd3-82e7-f3c3091be3d1.png" alt="paper-closing-a-ledger">
å½“ BK çš„å®¢æˆ·ç«¯æ²¡æœ‰ close ä¸€ä¸ªledger å°± crash æ€ä¹ˆåŠï¼Ÿå› æ­¤éœ€è¦ä¸€ä¸ªé¢å¤–çš„æœºåˆ¶æ¥ä¿è¯æ‰€æœ‰ open çš„ledger éƒ½èƒ½å¤Ÿæœ€ç»ˆè¢« closeã€‚</p>
<h3 id="ledger-çš„æ¢å¤">Ledger çš„æ¢å¤</h3>
<p>Ledger çš„å†™å…¥è€…å¯èƒ½åœ¨æ²¡å…³é—­ ledger çš„æ—¶å€™å°± crash äº†ï¼Œè¿™ç§æƒ…å†µä¸‹ entry çš„å…ƒæ•°æ®å°šæœªæ›´æ–°åˆ° zkä¸­ï¼Œ ledger çš„è¯»å–è€…æ— æ³•å®‰å…¨åœ°ç¡®è®¤ ledgerä¸­çš„æœ€åçš„ entry æ˜¯ä»€ä¹ˆï¼Œå› æ­¤ ledger éœ€è¦ æ¢å¤æ“ä½œï¼ˆrecoveryï¼‰ã€‚</p>
<p>å½“ reader æ‰“å¼€ä¸€ä¸ª ledger è¯»å–çš„æ—¶å€™ï¼Œä» ZK ä¸­è·å–å…ƒæ•°æ®ï¼ŒåŒæ—¶å¦‚æœå‘ç°è¿™ä¸ª ledger å°šæœªè¢« closeï¼Œå°±è§¦å‘ä¸€ä¸ª recovery æµç¨‹ã€‚</p>
<p>Recoveryï¼šç¡®å®šæŒ‰æ‰€è¦æ±‚çš„ quorum å†™å…¥æˆåŠŸçš„æœ€åä¸€ä¸ª entryï¼Œå†™å…¥åˆ° ZK ä¸­ã€‚</p>
<blockquote>
<p>å¦‚ä½•ç¡®è®¤æœ€åä¸€ä¸ª entryï¼Ÿå¯ä»¥ç®€å•åœ°ä» ledger ä¸€æ¬¡è¯»å–æ‰€æœ‰çš„entryï¼Œé‡æ–°å†™å…¥ä¸€éã€‚
ä¸ºäº†åŠ é€Ÿï¼Œreader å‘ ensemble ä¸­æ‰€æœ‰çš„ bookie è¯¢é—® æ­¤ledger å†™å…¥çš„æœ€æ–°çš„ entry çš„LACå­—æ®µï¼ˆLast Add Confirmedï¼‰ã€‚ç„¶åæ¢å¤æµç¨‹å°±å¯ä»¥ä»æœ€é«˜çš„ LAC ä½ç½®å¼€å§‹ï¼Œè€Œæ— éœ€è¯»å–æ•´ä¸ª ledgerã€‚</p>
</blockquote>
<h3 id="lac">LAC</h3>
<p>LACï¼šLast add confirmedï¼Œè·å–ä¸€ä¸ª quorum ä¸­æœ€åä¸€ä¸ªè¢«ç¡®è®¤å†™å…¥çš„ entry çš„ id
å¯¹äº å•ä¸ª bookie è€Œè¨€ï¼Œæ‰€è°“çš„LACå°±æ˜¯å½“å‰ ledger æœ€åä¸€ä¸ªå†™å…¥çš„ entry çš„ entry idã€‚è€Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œè·å–quorum çš„LACå°±æ˜¯è·å–æ•´ä¸ª quorum ä¸­æœ€å¤§çš„LACã€‚</p>
<p><strong>è¿™é‡Œæ¯”è¾ƒå®¹æ˜“æ··æ·†ï¼šLAC åº”è¯¥æ˜¯ç»´æŠ¤åœ¨ writer æœ¬åœ°çš„ï¼Œåªæ˜¯æ¯æ¬¡å†™å…¥åˆ° bookie çš„æ—¶å€™æŠŠå®ƒæ”¾åœ¨ entry çš„æŸä¸ªå­—æ®µä¸­ã€‚Quorum ä¸­æ‰€æœ‰ bookie çš„æœ€åä¸€ä¸ª entry çš„ LAC æœ€å¤§å€¼ï¼Œæ‰€åæ˜ çš„ä¸€å®šæ˜¯è¿™ä¸ª writer çš„ LAC çš„æœ€å¤§å€¼ï¼Œè¿™æ ·ä¸€æ¥ LAC çš„ä½œç”¨å°±å¥½ç†è§£äº†ï¼Œç›¸å½“äºæ˜¯æŠŠ writer çš„å†™å…¥ç¡®è®¤æ°´ä½çŠ¶æ€éšç€ entry å†™å…¥åˆ°äº†æ¯ä¸€ä¸ª bookieä¸­ã€‚</strong></p>
<blockquote>
<p><strong>è¿™å—çš„ä»‹ç»å¯ä»¥çœ‹ <strong><a href="https://bookkeeper.apache.org/distributedlog/docs/latest/user_guide/design/main.html"><strong>DistributedLog</strong></a></strong>ã€‚</strong></p>
</blockquote>
<h1 id="fencing">Fencing</h1>
<p>LAC åªèƒ½ä¿è¯ reader ä¹‹é—´è¯»å–çš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯ä¸èƒ½é¿å…å‡ºç°å¤šä¸ª writerã€‚</p>
<p>bookie æ£€æµ‹åˆ°æŸä¸ª ledger å‡ºäº recovery æµç¨‹ä¸­æ—¶ï¼Œæ‹’ç»æ‰æ‰€æœ‰è¿™ä¸ªledger å†™å…¥çš„è¯·æ±‚ã€‚</p>
<h3 id="ä»ä¸€ä¸ª-open-çŠ¶æ€çš„-ledger-è¯»å–æ•°æ®">ä»ä¸€ä¸ª open çŠ¶æ€çš„ ledger è¯»å–æ•°æ®</h3>
<p>å‰è¿°éƒ½æ˜¯åŸºäº reader åªèƒ½è¯»å– closed çš„ ledger çš„å‰æã€‚ä½†æ˜¯ readerå®Œå…¨æœ‰å¯èƒ½éœ€è¦è¯»å– open çš„ledgerï¼ˆåºŸè¯ã€‚ã€‚ã€‚ï¼‰ï¼Œå› æ­¤ BK æä¾›äº†ç»•è¿‡äº† recovery æµç¨‹çš„è¯»å–APIã€‚åœ¨è¿™ä¸ªAPI ä¸­ï¼Œä¸ºäº†é˜²æ­¢ reader è¯»å–åˆ° transient entryï¼ˆåªåœ¨ quorum ä¸­å¤åˆ¶äº†ä¸€éƒ¨åˆ†ï¼Œå…³é—­ ledger åå¯èƒ½ä¼šè¢« trim æ‰çš„ entryï¼‰ï¼Œreaderä¼šå‘bookie æŸ¥è¯¢ ledger çš„ LACï¼Œè¯»å– LAC ä»¥å‰çš„ entry æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºä»–ä»¬éƒ½å·²ç»è¢«å®Œæ•´åœ°å¤åˆ¶äº†ã€‚</p>
<p>Ledger deviceï¼šç¬¬ä¸€ç‰ˆä¸åŒçš„ ledger æœ‰ä¸åŒçš„æ–‡ä»¶ï¼Œåæ¥æ”¹ä¸ºä¸€ä¸ªï¼ˆç±»ä¼¼RocketMQçš„CommitLogï¼‰ï¼Œæˆä¸ºentry logã€‚åŸå› æ˜¯å¤šä¸ªæ–‡ä»¶çš„éšæœºå†™å…¥å¸¦æ¥çš„ç£ç›˜å¯»é“ã€Page cache çš„ç«äº‰å¤§å¤§é™ä½äº†å†™å…¥ååã€‚ä¸åŒ ledger çš„ entry éƒ½å­˜å‚¨åœ¨ä¸€ä¸ª entry log ä¸­ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/bookkeeper-journal-to-ledger-index.svg" alt="bookkeeper-journal-to-ledger-index.svg"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Journal to Ledger Log 
</i>
</div>
<p>å¯¹äºæ¯ä¸ªledgerï¼Œbookie åœ¨ ledger device ä¸Šè¿˜ç»´æŠ¤äº†ä¸€ä¸ªç´¢å¼•ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªç´¢å¼• æ˜ å°„ åˆ°å†…å­˜ï¼Œé™ä½ç´¢å¼•æ„å»ºå¯¼è‡´çš„ IO å¼€é”€ã€‚</p>
<p>Ledger çš„è®¾è®¡ä¸»è¦é’ˆå¯¹å†™ä¸ºä¸»çš„æµé‡ã€‚è¯»çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœå‘½ä¸­äº†å†…å­˜ä¸­çš„ledger indexï¼Œé‚£ä¹ˆåªéœ€è¦ä¸€æ¬¡ç£ç›˜ IOï¼Œå¦åˆ™éœ€è¦å…ˆä» Ledger indexæ–‡ä»¶æ‰¾åˆ° entry æ‰€åœ¨ entry log ä¸­çš„ä½ç½®ï¼Œç„¶åå†å» entry log ä¸­è¯»å–entryå†…å®¹ã€‚</p>
<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2>
<h3 id="entry-çš„å†™å…¥">Entry çš„å†™å…¥</h3>
<p><img src="https://huanglei-rocks-blog.oss-cn-shanghai.aliyuncs.com/blog/entry-write-diagram.png" alt="entry-write-diagram.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Entry å†™å…¥çš„æµç¨‹ 
</i>
</div>
<h3 id="entry-çš„è¯»å–">Entry çš„è¯»å–</h3>
<p>è¿˜æ˜¯æ ¹æ® write set æ‰¾åˆ°è´Ÿè´£ entry çš„ bookie åˆ—è¡¨ï¼Œç„¶åå‘è¿™äº› bookie å‘é€è¯»å–è¯·æ±‚ã€‚</p>
<p>Entry è¯»å–çš„æ—¶å€™å¯èƒ½å­˜åœ¨ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼šè¯»å–çš„ entry èŒƒå›´ä¸€jnkmlxcéƒ¨åˆ†è½åœ¨ä¸€ä¸ª ensembleï¼Œä¸€éƒ¨åˆ†è½åœ¨å¦ä¸€ä¸ª ensembleï¼Œæ¯”å¦‚ä¸‹é¢å›¾ä¸­çš„æƒ…å†µã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/bookkeeper-read-ensemble-change.svg" alt="bookkeeper-read-ensemble-change"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 å°è¯•è¯»å–æ•£è½åœ¨ä¸åŒ ensemble çš„ entry 
</i>
</div>
<p>ä¸ºäº†å¤„ç†è¯»å–æ•£è½åœ¨ä¸åŒ ensemble çš„ entry çš„æƒ…å†µï¼ŒBookKeeper æ¯æ¬¡è¯»å– entry å‰éƒ½ä¼šåˆ¤æ–­æ‰€è¯»å–çš„ entry id æ˜¯å¦å‡ºç° ensemble changeã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/Bookkeeper.drawio.svg?" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Entry è¯»å–çš„ä¸»æµç¨‹ä»£ç  
</i>
</div>
<p>ä¸ºäº†é¿å…éƒ¨åˆ†æ…¢èŠ‚ç‚¹å¯¼è‡´å»¶è¿Ÿå‡é«˜ï¼Œæå‡è¯»å–çš„æ€§èƒ½ï¼ŒBookKeeper å®¢æˆ·ç«¯è¿˜é‡‡ç”¨äº† speculative readï¼ˆæ¨æµ‹è¯»å–ï¼‰çš„æ–¹å¼ï¼Œå¦‚æœå½“å‰è¯»å–çš„ bookie æ²¡æœ‰åœ¨ç‰¹å®šæ—¶é—´å†…è¿”å›æ•°æ®ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šç«‹åˆ»å°è¯•å‘å¦ä¸€ä¸ª bookie å‘é€è¯»å–è¯·æ±‚ï¼Œå¹¶åŒæ—¶ç­‰å¾…ä¸¤ä¸ª bookie çš„å“åº”ã€‚å…·ä½“å¯è§ <a href="https://bookkeeper.apache.org/docs/4.5.0/api/javadoc/org/apache/bookkeeper/client/DefaultSpeculativeRequestExecutionPolicy.html">DefaultSpeculativeRequestExecutionPolicy</a>.</p>
]]></content>
		</item>
		
		<item>
			<title>LSM Tree ç¬”è®°</title>
			<link>https://huanglei.rocks/posts/note-on-lsmt/</link>
			<pubDate>Thu, 10 Feb 2022 22:34:39 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/note-on-lsmt/</guid>
			<description>å†™å…¥ï¼ˆWrite pathï¼‰ å…ˆä»ç£ç›˜ï¼ˆHDDï¼‰å†™å…¥çš„ç‰¹æ€§å¼•å…¥ append-only çš„ WALã€‚ å¯¹äº KV ç»“æ„ï¼Œå¦‚æœå†™å…¥æ˜¯ append onlyçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆå¹¶ï¼Œä¸ç„¶è¯»å–æ€§èƒ½å¤ªå·®ã€‚</description>
			<content type="html"><![CDATA[<h2 id="å†™å…¥write-path">å†™å…¥ï¼ˆWrite pathï¼‰</h2>
<ul>
<li>
<p>å…ˆä»ç£ç›˜ï¼ˆHDDï¼‰å†™å…¥çš„ç‰¹æ€§å¼•å…¥ append-only çš„ WALã€‚</p>
</li>
<li>
<p>å¯¹äº KV ç»“æ„ï¼Œå¦‚æœå†™å…¥æ˜¯ append onlyçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆå¹¶ï¼Œä¸ç„¶è¯»å–æ€§èƒ½å¤ªå·®ã€‚</p>
</li>
<li>
<p>å•æ–‡ä»¶åˆå¹¶æ€§èƒ½å·®ï¼Œå› æ­¤éœ€è¦æŒ‰é˜ˆå€¼åˆ‡åˆ†ä¸ºå¤šä¸ªå°æ–‡ä»¶ï¼Œé€šè¿‡å½’å¹¶æ’åºçš„æ€è·¯ä¼˜åŒ–åˆå¹¶çš„æ•ˆç‡ã€‚</p>
</li>
<li>
<p>å¤šè·¯å½’å¹¶è¦æ±‚æ¯ä¸ªæ–‡ä»¶æœ‰åºï¼Œä¸ºäº†ä¿è¯æ¯ä¸ªæ–‡ä»¶æœ‰åºï¼Œå°±éœ€è¦ï¼Œæ•°æ®å†™å…¥çš„æ—¶å€™ï¼Œä¸ç›´æ¥æŠŠ operation ç›´æ¥å†™å…¥åˆ°ç£ç›˜ï¼Œè€Œæ˜¯å…ˆåœ¨å†…å­˜ç¼“å­˜ä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸”åœ¨å†…å­˜æ’å¥½åºï¼Œç„¶åå†ä¸€æ¬¡æŠŠæ•´ä¸ªæ–‡ä»¶ flush åˆ°ç£ç›˜ã€‚</p>
<ul>
<li>å†…å­˜æœ‰åºçš„æ•°æ®ç»“æ„ï¼šè·³è¡¨ã€çº¢é»‘æ ‘ã€B+ æ ‘</li>
<li>buffer åœ¨å†…å­˜çš„æ•°æ®ä¸¢äº†æ€ä¹ˆåŠï¼Ÿå…ˆå†™ redo log</li>
</ul>
</li>
</ul>
<h2 id="æœ‰åºæ•°æ®ç»“æ„">æœ‰åºæ•°æ®ç»“æ„</h2>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/V8oKiYS5z/1639280343.png" alt=""></p>
<blockquote>
<p><a href="https://github.com/facebook/rocksdb/wiki/MemTable">RocksDB çš„æ•°æ®ç»“æ„æ¯”è¾ƒ</a>ï¼šé€‰æ‹©è·³è¡¨çš„åŸå› æ˜¯è·³è¡¨æ”¯æŒå¹¶å‘æ’å…¥ã€‚</p>
</blockquote>
<p>LSMT çš„æ•°æ®åˆ†ç±»</p>
<ul>
<li>å†…å­˜æ•°æ®ï¼šMemTable</li>
<li>ç£ç›˜æ•°æ®ï¼šSSTableï¼ˆSorted Sequence Tableï¼‰</li>
<li>æ—¥å¿—ï¼šredo log</li>
</ul>
<h2 id="å†…å­˜æ•°æ®ç»„ç»‡">å†…å­˜æ•°æ®ç»„ç»‡</h2>
<p>å†…å­˜çš„æ•°æ®éœ€è¦ä¿è¯æœ‰åºï¼ŒåŒæ—¶æ”¯æŒé«˜æ€§èƒ½çš„æ’å…¥å’ŒæŸ¥æ‰¾ã€‚</p>
<ul>
<li>ARTï¼šè‡ªé€‚åº”åŸºæ ‘ï¼ˆæ¯”å¦‚ Bitcask é‡‡ç”¨ï¼‰ï¼›</li>
<li>SkipListï¼šLevelDBã€RocksDB ç­‰ã€‚</li>
</ul>
<h2 id="sstable-æ–‡ä»¶æ ¼å¼">SSTable æ–‡ä»¶æ ¼å¼</h2>
<p>æŒ‰ Block è¿›è¡Œå­˜å‚¨ï¼Œå¯ä»¥å‚è€ƒ LevelDB å’Œ RocksDB çš„ SST æ–‡ä»¶çš„æ ¼å¼ã€‚</p>
<h2 id="åˆå¹¶ç­–ç•¥">åˆå¹¶ç­–ç•¥</h2>
<ul>
<li>
<p>åˆ†çº§åˆå¹¶ï¼ˆLeveling Merge Policyï¼‰</p>
<ul>
<li>æ¯ä¸€çº§éƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ–‡ä»¶</li>
</ul>
</li>
<li>
<p>åˆ†å±‚åˆå¹¶ (Tiering Merge Policy)</p>
<ul>
<li>æ¯ä¸€çº§æœ‰å¤šä¸ªå°æ–‡ä»¶ï¼Œæ¯ä¸ªå°æ–‡ä»¶ä¸­çš„ key ä¸é‡å ï¼ˆLevelDB å’Œ RocksDBé‡‡ç”¨ï¼Œå°½ç®¡ä»–ä»¬ç§°è‡ªå·±ä¸º leveling mergeï¼‰</li>
</ul>
</li>
<li>
<p>åˆå¹¶æ—¶é—´ï¼šå®šæ—¶åˆå¹¶ã€è¾¾åˆ°é˜ˆå€¼åˆå¹¶ã€‚</p>
</li>
</ul>
<h2 id="è¯»å–read-path">è¯»å–ï¼ˆRead pathï¼‰</h2>
<p>æ ¸å¿ƒåŸåˆ™ï¼šå…ˆçƒ­åå†·è¯»å–æœ€æ–°çš„æ•°æ®ï¼Œä¸€æ—¦è¯»å–åˆ°å°±åœæ­¢ã€‚</p>
<ul>
<li>ä¼˜å…ˆè¯»å– MemTableï¼Œç„¶åè¯»å– SSTable</li>
</ul>
<h3 id="è¯»å–çš„ä¼˜åŒ–">è¯»å–çš„ä¼˜åŒ–</h3>
<ul>
<li>é€šè¿‡ BloomFilter ä¼˜åŒ–ä¸å­˜åœ¨çš„æ•°æ®çš„åˆ¤æ–­</li>
<li>SSTable åˆ†åŒº</li>
<li>å‹ç¼©</li>
</ul>
<h2 id="lsmt-çš„é—®é¢˜">LSMT çš„é—®é¢˜</h2>
<h3 id="è¯»æ”¾å¤§">è¯»æ”¾å¤§</h3>
<p>ä¸€æ¬¡ key çš„è¯»å–éœ€è¦ç”±æ–°åˆ°æ—§ä¾æ¬¡è¯»å–ï¼Œæ¶‰åŠåˆ°ä¸æ­¢ä¸€æ¬¡IOï¼Œåœ¨èŒƒå›´æŸ¥è¯¢çš„æ—¶å€™å°¤å…¶æ˜æ˜¾ã€‚</p>
<h3 id="å†™æ”¾å¤§">å†™æ”¾å¤§</h3>
<p>åå°åˆå¹¶ï¼ˆcompactionï¼‰å¯¼è‡´ä¸€ä¸ªæ–‡ä»¶å¯èƒ½éœ€è¦è¢«å†™å…¥å¤šæ¬¡ã€‚</p>
<h3 id="ç©ºé—´æ”¾å¤§">ç©ºé—´æ”¾å¤§</h3>
<p>Append-only å¯¼è‡´è¿‡æœŸæ•°æ®ä¸€è‡´å­˜åœ¨ï¼Œç›´åˆ°è¢«æ¸…ç†</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
<li>å†™æ”¾å¤§ï¼šå°½ç®¡ LSM Tree é€šè¿‡é¡ºåº IO æä¾›äº†æ›´å¤§çš„å†™å…¥ååï¼Œä½†æ˜¯å†™å…¥æ”¾å¤§çš„é—®é¢˜ä¼šäº‰æŠ¢æ­£å¸¸å†™å…¥çš„ç£ç›˜å¸¦å®½ï¼Œä»è€Œé™ä½æ€§èƒ½å’Œç£ç›˜çš„ä½¿ç”¨å¯¿å‘½ã€‚</li>
<li>åˆå¹¶ï¼šåå°çš„åˆå¹¶æ“ä½œå¯¼è‡´ write stall</li>
<li>æ–°ç¡¬ä»¶ï¼šRemote compactionï¼ŒCompaction offloadingï¼ŒAEP</li>
</ul>
<p>ç´¢å¼•å­˜å‚¨</p>
<ul>
<li>ç´¢å¼•ä¸å­˜å‚¨
<ul>
<li>buntdbï¼šæ¯æ¬¡é‡å¯é‡å»º</li>
</ul>
</li>
<li>ç´¢å¼•å­˜å‚¨
<ul>
<li>åˆ†ç¦»å­˜å‚¨
<ul>
<li>Bitcask</li>
<li>MySQL MyISAM</li>
</ul>
</li>
<li>ä¸€èµ·å­˜å‚¨
<ul>
<li>BoltDB</li>
<li>MySQL Innodb</li>
<li>LevelDB (SStable)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="https://www.youtube.com/watch?v=adamqSuHHck&amp;ab_channel=TalkGo">ç†è®ºç»“åˆå®è·µè¯¦è§£ lsm æ ‘å­˜å‚¨å¼•æ“ï¼ˆbitcaskã€mossã€leveldb ç­‰ï¼‰</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>ä½¿ç”¨ GitHub Issue ä½œä¸º Hugo çš„è¯„è®ºç³»ç»Ÿ</title>
			<link>https://huanglei.rocks/posts/hugo-comment-with-github-issues/</link>
			<pubDate>Thu, 10 Feb 2022 15:07:10 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/hugo-comment-with-github-issues/</guid>
			<description>å®‰è£… Octomments æŒ‰ç…§ Octomments çš„ä»‹ç»ï¼Œå°† Octomments å®‰è£…åˆ°æ‚¨çš„ GitHub è´¦æˆ·ï¼Œç¡®ä¿å®ƒæ‹¥æœ‰è®¿é—®æ‚¨çš„ç›®æ ‡ repo çš„ issue çš„æƒé™ã€‚ é…ç½® GitHub issue åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ é…ç½®é¡¹ï¼š comment.ownerï¼šI</description>
			<content type="html"><![CDATA[<h1 id="å®‰è£…-octomments">å®‰è£… Octomments</h1>
<p>æŒ‰ç…§ <a href="https://ocs.vercel.app/">Octomments</a> çš„ä»‹ç»ï¼Œå°† Octomments å®‰è£…åˆ°æ‚¨çš„ GitHub è´¦æˆ·ï¼Œç¡®ä¿å®ƒæ‹¥æœ‰è®¿é—®æ‚¨çš„ç›®æ ‡ repo çš„ issue çš„æƒé™ã€‚</p>
<h1 id="é…ç½®-github-issue">é…ç½® GitHub issue</h1>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ é…ç½®é¡¹ï¼š</p>
<ul>
<li><code>comment.owner</code>ï¼šIssue repo çš„æ‹¥æœ‰è€…</li>
<li><code>comment.repo</code>ï¼šIssue repo çš„åå­—</li>
</ul>
<h1 id="é…ç½®-comment-ç»„ä»¶">é…ç½® Comment ç»„ä»¶</h1>
<p>åœ¨æ‚¨çš„åšå®¢ç«™ç‚¹æ ¹ç›®å½•ä¸‹çš„<code>layouts/partials/comments.html</code> æ¨¡æ¿ä¸­å¢åŠ ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl">{{ if .Params.issueNumber -}}
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://unpkg.com/octomments/build/ocs-ui.min.css&#34;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;comments&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://unpkg.com/octomments/build/ocs.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl">  <span class="nx">Octomments</span><span class="p">({</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl">    <span class="nx">github</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl">      <span class="nx">owner</span><span class="o">:</span> <span class="s1">&#39;{{ $.Site.Params.comment.owner }}&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl">      <span class="nx">repo</span><span class="o">:</span> <span class="s1">&#39;{{ $.Site.Params.comment.repo }}&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl">    <span class="nx">issueNumber</span><span class="o">:</span> <span class="p">{{</span> <span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">issueNumber</span> <span class="p">}},</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl">    <span class="nx">renderer</span><span class="o">:</span> <span class="p">[</span><span class="nx">OctommentsRenderer</span><span class="p">,</span> <span class="s1">&#39;#comments&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl">  <span class="p">}).</span><span class="nx">init</span><span class="p">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl">{{ end }}
</span></span></code></pre></div><h1 id="é…ç½®éœ€è¦è¯„è®ºçš„æ–‡ç« ">é…ç½®éœ€è¦è¯„è®ºçš„æ–‡ç« </h1>
<p>åœ¨æ–‡ç« çš„ metadata ç« èŠ‚åŠ å…¥åˆ›å»ºçš„ issue çš„ issue numberï¼Œå¦‚æœ¬æ–‡çš„ metadataï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w"></span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ä½¿ç”¨ GitHub Issue ä½œä¸º Hugo çš„è¯„è®ºç³»ç»Ÿ&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w"></span><span class="nt">date</span><span class="p">:</span><span class="w"> </span><span class="ld">2022-02-10T15:07:10</span><span class="m">+08</span><span class="p">:</span><span class="m">00</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="nt">draft</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w"></span><span class="nt">toc</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w"></span><span class="nt">issueNumber</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="nt">images</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w"></span><span class="nt">tags</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">  </span>- <span class="l">Hugo</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w">  </span>- <span class="l">Github</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span></code></pre></div><p>è¿™æ ·æœ¬æ–‡çš„æœ«å°¾å°±ä¼šå‡ºç°ä¸€ä¸ªè¯„è®ºæ å•¦ï¼Œæ‰€æœ‰å¯¹æœ¬æ–‡çš„è¯„è®ºéƒ½ä¼šåŒæ­¥åˆ° GitHub çš„ issue ä¸­ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>ç†è§£ Rust çš„ Pin æœºåˆ¶</title>
			<link>https://huanglei.rocks/posts/rust-pinning/</link>
			<pubDate>Sat, 29 Jan 2022 22:41:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/rust-pinning/</guid>
			<description>Pin ä¹‹æ‰€ä»¥éš¾ä»¥ç†è§£ï¼Œæ˜¯å› ä¸ºå…¶æ˜¯åŒæ—¶æ¶‰åŠåˆ°ç§»åŠ¨è¯­ä¹‰ã€æ‰€æœ‰æƒã€å¼‚æ­¥çš„ä¸€ä¸ªæ¦‚å¿µã€‚å¯ä»¥è¯´ï¼ŒPin æ˜¯ä¸ºäº†è§£å†³è‡ªå¼•ç”¨æ•°æ®ç»“æ„çš„ç§»åŠ¨é—®é¢˜ï¼Œè€Œè¿™ä¸ªé—®é¢˜åœ¨ Rust çš„åŸº</description>
			<content type="html"><![CDATA[<p>Pin ä¹‹æ‰€ä»¥éš¾ä»¥ç†è§£ï¼Œæ˜¯å› ä¸ºå…¶æ˜¯åŒæ—¶æ¶‰åŠåˆ°ç§»åŠ¨è¯­ä¹‰ã€æ‰€æœ‰æƒã€å¼‚æ­¥çš„ä¸€ä¸ªæ¦‚å¿µã€‚å¯ä»¥è¯´ï¼ŒPin æ˜¯ä¸ºäº†è§£å†³è‡ªå¼•ç”¨æ•°æ®ç»“æ„çš„ç§»åŠ¨é—®é¢˜ï¼Œè€Œè¿™ä¸ªé—®é¢˜åœ¨ Rust çš„åŸºäº Future çš„å¼‚æ­¥ç¼–ç¨‹ä¸­è¾ƒä¸ºå¸¸è§ã€‚</p>
<p>é¦–å…ˆåœ¨æ–‡ç« çš„æœ€å¼€å§‹ç”¨å‡ å¥è¯æ€»ç»“ä¸‹è¿™å‡ ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>Pinï¼šæ§åˆ¶æ•°æ®çš„æ‰€æœ‰æƒï¼ˆhow?ï¼‰ï¼Œè®©å…¶æ— æ³•ç§»åŠ¨ï¼Œä»è€Œé¿å… self-referential çš„æ•°æ®ç»“æ„åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­è¢«ç ´åã€‚</li>
<li>Unpinï¼šè¯´æ˜æ•°æ®ä¸å…³å¿ƒè¢«ç§»åŠ¨ï¼Œå³ä½¿å®ƒè¢«ç§»åŠ¨äº†ä¹Ÿä¸ä¼šäº§ç”Ÿæ‚¬æŒ‚æŒ‡é’ˆã€‚å¦‚æœä¸€ä¸ªè¢« pin ä½çš„æ•°æ®çš„ç±»å‹å®ç°äº† unpin traitï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è¿™ä¸ª pin è·å–è¢« pin ä½çš„æ•°æ®çš„ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œä»è€Œç§»åŠ¨è¿™ä¸ªå€¼ï¼ˆhow?ï¼‰ã€‚</li>
<li>!Unpinï¼šä¸€ä¸ª Markerï¼Œå‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªæ•°æ®ç»“æ„ä¸èƒ½è¢«éšæ„ç§»åŠ¨ï¼Œä»è€Œå½“è¿™ä¸ªæ•°æ®ç»“æ„è¢« pin ä½çš„æ—¶å€™ï¼Œæ— æ³•å¾—åˆ°å…¶å¯å˜å¼•ç”¨ã€‚</li>
<li>Pin-Projectionï¼šè¢« pin çš„æ•°æ®ç»“æ„å¯èƒ½å­˜åœ¨éƒ¨åˆ†å­—æ®µæ˜¯éœ€è¦åŒæ—¶è¢« pinã€éƒ¨åˆ†å­—æ®µä¸éœ€è¦è¢« pin çš„ã€‚</li>
<li>ä¸ºä»€ä¹ˆ Rust çš„ Future çš„æ–¹æ³•ç­¾åæ˜¯ <code>Pin&lt;&amp;mut self&gt;</code>? å› ä¸º Rust çš„ Future æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé€šè¿‡çŠ¶æ€æœºå®ç°çš„ generatorï¼Œgenrator æ˜¯ stackless çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Rust åœ¨ runtime å¹¶ä¸ä¼šä¸ºæ¯ä¸ª generator ç»´æŠ¤ä¸Šä¸‹æ–‡çš„çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€éƒ½æ˜¯é€šè¿‡ç¼–è¯‘å™¨çš„é»‘é­”æ³•å˜æˆ future é‡Œé¢çš„æ•°æ®ã€‚è€Œ future æœ‰å¯èƒ½ä¼šè¢«ä¼ é€’ã€ç§»åŠ¨ã€‚Rust æ‰€ç”Ÿæˆçš„ future é‡Œé¢çš„æ•°æ®å­˜åœ¨ self-referential çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨ future è¢«ç§»åŠ¨çš„æ—¶å€™ï¼Œè¿™äº› self-referential çš„æŒ‡é’ˆå°±ä¼šå˜æˆé‡æŒ‡é’ˆï¼Œä»è€Œå¯¼è‡´å¼‚å¸¸ã€‚</li>
</ul>
<h2 id="catch-up-å¦‚ä½•åœ¨-rust-ä¸­ç§»åŠ¨æ•°æ®">Catch up: å¦‚ä½•åœ¨ Rust ä¸­ç§»åŠ¨æ•°æ®</h2>
<ul>
<li>èµ‹å€¼ã€ä¼ å‚ã€è¿”å›ï¼šè¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ã€‚</li>
<li>receiver ä¸º<code>self</code>çš„æ–¹æ³•è°ƒç”¨ï¼šä¸ºä»€ä¹ˆæ•°æ®ç»“æ„ä¸Šæ–¹æ³•è°ƒç”¨ä¹Ÿæœ‰å¯èƒ½éœ€è¦ç§»åŠ¨å‘¢ï¼Ÿä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ <code>Vec#push</code>ï¼Œè°ƒç”¨ä¹‹åå¯èƒ½ä¼šå¯¼è‡´å†…éƒ¨æ•°ç»„æ‰©å®¹ä»è€Œè¢«ç§»åŠ¨åˆ°æ–°çš„å†…å­˜ä½ç½®ã€‚</li>
<li><code>std::mem::replace</code>ï¼šé€šè¿‡ä¸€ä¸ªå¯å˜å¼•ç”¨æ¥ç§»åŠ¨ã€‚</li>
</ul>
<h2 id="self-reference">Self-reference</h2>
<p>æˆ‘ä»¬æ¥æ„å»ºä¸€ä¸ªå­˜åœ¨è‡ªæˆ‘å¼•ç”¨çš„æ•°æ®ç»“æ„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="n">parsed</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Parsed</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Parsed</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7">7</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8">8</a></span><span class="cl"><span class="w">    </span><span class="n">result</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9">9</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ° <code>ParsedContext</code>æ‹¥æœ‰ä¸€ä¸ªå­—ç¬¦æ•°ç»„ <code>buf</code>å’Œ è§£æçš„ç»“æœï¼š<code>Parsed</code>ã€‚è€Œ <code>Parsed</code>å†…éƒ¨åŒ…å«ä¸€ä¸ªå¯¹å­—ç¬¦æ•°ç»„ <code>buf</code>çš„å¼•ç”¨ï¼ˆå…ˆä¸è€ƒè™‘è¿™æ ·çš„æ•°æ®ç»“æ„æ˜¯å¦å¿…è¦åˆç†ï¼‰ã€‚</p>
<div style="width:100%;display:flex; justify-content: center; align-items: center;">
<div style="width: 70%;">
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/rust-self-referential-data.svg" alt="image.png"></p>
</div>
</div>    
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
<p>æ•°æ®å¼•ç”¨ç»“æ„</p>
</i>
</div>
<p>è¿™æ ·çš„ <code>ParserContext</code>æ˜¾ç„¶æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ã€‚å‡è®¾ç”±äºå„ç§åŸå› ï¼Œ<code>ParserContext</code>çš„å†…å­˜è¢«ç§»åŠ¨äº†ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆæ‚¬å‚å¼•ç”¨ï¼Œå¯ä»¥çœ‹ä¸‹å›¾ï¼š</p>
<div style="width:100%;display:flex; justify-content: center; align-items: center;">
<div style="width: 70%;">
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/rust-move-a-self-referential.svg" alt="image.png"></p>
</div>
</div>    
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
<p>ç§»åŠ¨åçš„æ•°æ®ç»“æ„</p>
</i>
</div>
<p>åœ¨ ParserContext è¢«ç§»åŠ¨ä¹‹åï¼Œ<code>ParserContext#buf</code>è¢«ç§»åŠ¨äº† <code>0xDCBA</code>ï¼Œä½†æ˜¯ <code>ParserContext#parsed#buf</code>å¼•ç”¨æŒ‡å‘çš„è¿˜æ˜¯ <code>0xABCD</code>è¿™ä¸ªæ— æ•ˆçš„åœ°å€ã€‚</p>
<p>æˆ‘ä»¬æŠŠè¿™ç§å­—æ®µä¸­å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è‡ªèº«æˆ–è€…è‡ªèº«ä¸€éƒ¨åˆ†çš„æ•°æ®ç»“æ„ç§°ä½œè‡ªå¼•ç”¨ï¼ˆself-referentialï¼‰æ•°æ®ç»“æ„ã€‚è‡ªå¼•ç”¨æ•°æ®ç»“æ„ä¹‹æ‰€ä»¥éœ€è¦å•ç‹¬æåŠï¼Œæ˜¯å› ä¸ºè‡ªå¼•ç”¨æ•°æ®ç»“æ„çš„å€¼ç§»åŠ¨æ“ä½œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚</p>
<p>Rust å¤„ç†è‡ªå¼•ç”¨æ•°æ®ç»“æ„çš„æ–¹æ³•ï¼Œæ˜¯å¼•å…¥ <code>Pin</code>è¯­ä¹‰æ¥é˜²æ­¢å…¶è¢«éšæ„ç§»åŠ¨ã€‚</p>
<h2 id="how-pin-works">How Pin works</h2>
<p>å½“ä½ æŠŠä¸€ä¸ªå€¼æ”¾è¿› Pin ä¸­ï¼Œä½ å°±æ— æ³•å†è·å–è¿™ä¸ªå€¼çš„å¯å˜å¼•ç”¨ã€‚è¿™æ ·å°±æ— æ³•é€šè¿‡èµ‹å€¼ã€ä¼ å‚ã€è¿”å›ã€æ–¹æ³•è°ƒç”¨ã€<code>std::mem::replace</code> è¿™äº›æ–¹æ³•æ¥ç§»åŠ¨å€¼äº†ã€‚å½“ç„¶ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå½“ä½ æ˜ç¡®åœ°çŸ¥é“è¢« Pin åŒ…è£¹çš„å€¼ä¸ä¼šå†è¢«ç§»åŠ¨ï¼Œé‚£å¯ä»¥é€šè¿‡ unsafe çš„æ–¹æ³•æ¥è·å–å®ƒçš„å¯å˜å¼•ç”¨ã€‚</p>
<h2 id="how-async-code-compiles">How async code compiles</h2>
<p>ä¸¾ä¸ªä¾‹å­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">AsyncRead</span><span class="o">+</span><span class="n">AsyncWrite</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">	</span><span class="n">tokio</span>::<span class="n">io</span>::<span class="n">read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="o">..</span><span class="p">]).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w"></span><span class="c1">// ä¸Šé¢çš„ä»£ç ä¼šè¢«ç¼–è¯‘å™¨ç”Ÿæˆä¸‹é¢çš„æ ·å­ 
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">AsyncRead</span><span class="o">+</span><span class="n">AsyncWrite</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">FooFuture</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">	</span><span class="c1">//...
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="c1">// å½“ foo è¿”å›çš„ future ç¬¬ä¸€æ¬¡è¢« poll çš„æ—¶å€™,ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ ReadFuture è®¾ç½®åˆ° FooFuture çš„
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="c1">// readFuture å­—æ®µä¸­
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">ReadFuture</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">	</span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="n">s</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">AsyncRead</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="c1">// foo å‡½æ•°è¿”å›çš„ futureï¼Œæ˜¯ä¸€ä¸ªå­˜åœ¨ self-reference çš„ç»“æ„â€”â€” bufçš„æ‰€æœ‰æƒåœ¨ FooFutureï¼Œ
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="c1">// FooFuture åŒ…å«ä¸€ä¸ª readFutureï¼ŒreadFuture åŒ…å«ä¸€ä¸ª buf çš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">FooFuture</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="p">[</span><span class="kt">u8</span>: <span class="mi">1024</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl"><span class="w">	</span><span class="n">readFuture</span>: <span class="nc">ReadFuture</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆ foo è¿”å›çš„ future æ˜¯ä¸€ä¸ª self-reference çš„ç»“æ„ã€‚
ç”±äº Rust çš„ future æ˜¯é€šè¿‡ä¸æ–­åœ°è¢« poll ä»è€Œé©±åŠ¨çŠ¶æ€æœºçš„çŠ¶æ€æµè½¬çš„ï¼Œfoo å‡½æ•°è¿”å›çš„è¿™ä¸ª self-referential future å¦‚æœä¼šè¢«ç§»åŠ¨ï¼ˆæ¯”å¦‚åœ¨èµ‹å€¼ã€ä¼ å‚ã€æ•°ç»„æ‰©ç¼©å®¹ç­‰æƒ…å†µä¸‹ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ª self-referential çš„æ•°æ®ç»“æ„å°±ä¼šè¢«ç ´åï¼Œä»è€Œå¯¼è‡´å¼‚å¸¸ã€‚</p>
<p>Rust çš„ future çš„ç‰¹æ€§ï¼š</p>
<ul>
<li>Future åˆšåˆšåˆ›å»ºå‡ºæ¥çš„æ—¶å€™ï¼Œç§»åŠ¨å®ƒæ˜¯å®‰å…¨çš„ï¼šå› ä¸ºæ²¡æœ‰è¢« poll è¿‡ï¼Œself-referential çš„ç»“æ„è¿˜æ²¡æœ‰å½¢æˆï¼›</li>
<li>Future ç¬¬ä¸€æ¬¡è¢« poll ä¹‹åï¼Œç§»åŠ¨è¿™ä¸ª future å°±ä¸å†æ˜¯æ˜¯å®‰å…¨çš„ï¼šå› ä¸ºè·¨è¶Šä¸åŒçš„ yield point ä¹‹é—´ï¼Œä¸€å®šä¼šå¯¼è‡´ç”ŸæˆåµŒå¥—çš„ self-refenrential futureã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ Future çš„ç­¾å:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œpoll æ–¹æ³•çš„ self çš„ç±»å‹æ˜¯ï¼š<code>Pin&lt;&amp;mut Self&gt;</code>ï¼Œè¿™å°±æ„å‘³ç€ï¼Œè°ƒç”¨ä¸€æ¬¡ poll ä¹‹åï¼Œself çš„æ‰€æœ‰æƒå°± somehow è¢«è¿™ä¸ª <code>Pin</code>è·å–äº†ï¼ŒæŒæœ‰ future å¯¹è±¡çš„ä»£ç æ— æ³•å†é€šè¿‡ä»»ä½•åŠæ³•è·å–åˆ° future çš„æ‰€æœ‰æƒï¼Œä¹Ÿå°±æ— æ³•ç§»åŠ¨è¿™ä¸ª futureã€‚</p>
<p>è¿™é‡Œä¹Ÿæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ä¸‹ï¼ŒæŒæœ‰è¿™ä¸ª future çš„å¯¹è±¡å¦‚ä½•å» poll ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">f</span>: <span class="nc">FooFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="n">f</span><span class="p">.</span><span class="n">poll</span><span class="p">();</span><span class="w"> </span><span class="c1">// x: è¿™é‡Œä¸èƒ½ç›´æ¥è°ƒç”¨,å› ä¸ºè¿™é‡Œçš„ f çš„ç±»å‹æ˜¯ FooFutureï¼Œä¹Ÿå°±æ˜¯ Self
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w"> </span><span class="c1">// p çš„ç±»å‹æ˜¯ï¼šPin&lt;&amp;mut FooFuture&gt; 
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="c1"></span><span class="n">p</span><span class="p">.</span><span class="n">poll</span><span class="p">();</span><span class="w"> </span><span class="c1">// è¿™æ‰æ˜¯ç¬¦åˆpoll æ–¹æ³•ç­¾åçš„
</span></span></span></code></pre></div><p>é‚£ä¹ˆï¼Œå‡è®¾æˆ‘ä»¬é€šè¿‡ä¸€äº› workaround å»æ‹¿åˆ° pin é‡Œé¢çš„å€¼å‘¢ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">f</span>: <span class="nc">FooFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="n">p</span><span class="p">.</span><span class="n">poll</span><span class="p">();</span><span class="w"> </span><span class="c1">// p é‡Œé¢çš„ future å·²ç»è¢« poll è¿‡äº†,æŒ‰é“ç†è¿™ä¸ªæ—¶å€™ future ä¸èƒ½å†è¢«ç§»åŠ¨
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="w"></span><span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">());</span><span class="c1">// è§†è¯•å›¾é€šè¿‡ mem::replace ç§»åŠ¨ p  é‡Œé¢çš„future
</span></span></span></code></pre></div><p>å…¶å®è¿™ä¸ªæ—¶å€™çš„ mem::replace ä¼šæŠ¥é”™çš„:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">Deref</span><span class="o">&lt;</span><span class="n">Target</span>: <span class="nb">Unpin</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="c1">//             ^~~~~ Deref çš„ç›®æ ‡ç±»å‹å¿…é¡»æ˜¯ Unpin   
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°, Pin æ‰€å®ç°çš„ Deref trait æ˜¯æœ‰ç±»å‹é™åˆ¶çš„ï¼šå®ƒè¦æ±‚ pin é‡Œé¢çš„æŒ‡é’ˆçš„ç›®æ ‡ç±»å‹å¿…é¡»å®ç° Unpin Trait. å¦‚æœæŒ‡é’ˆçš„ç›®æ ‡ç±»å‹å­˜åœ¨ self-referential çš„æƒ…å†µï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸èƒ½è¢« deref çš„ï¼Œä¹Ÿå°±æ— æ³•ä» Pin ä¸­å–å‡ºåŸå§‹çš„å€¼ä»è€Œä»»æ„ç§»åŠ¨ã€‚</p>
<blockquote>
<p>Rustâ€™s solution to this problem rests on the insight that futures are always safe to move when they are first created, and only become unsafe to move when they are polled. A future that has just been created by calling an asynchronous function simply holds a resumption point and the argument values. These are only in scope for the asynchronous functionâ€™s body, which has not yet begun execution. Only polling a future can borrow its contents.</p>
</blockquote>
<p><code>Pin&lt;&amp;mut Self&gt;</code> å°±æ˜¯ä¸ºäº†ç¡®ä¿ Future å¯¹è±¡è‡ªå·±ä¸ä¼šè¢«ç§»åŠ¨ã€‚</p>
<p><code>Unpin</code>ï¼šä»£è¡¨å¯¹è±¡ä¸å­˜åœ¨ self-reference ç­‰æƒ…å†µï¼Œå¯ä»¥è¢«éšæ„ç§»åŠ¨ã€‚å¤§éƒ¨åˆ† Rust æ ‡å‡†åº“é‡Œé¢çš„æ•°æ®ç»“æ„éƒ½æ˜¯ Unpin çš„ã€‚
<code>!Unpin</code>ï¼šä½œä¸ºä¸€ä¸ª marker,å‘Šè¯‰ rust ç¼–è¯‘å™¨è¿™ä¸ªæ•°æ®ç»“æ„æ˜¯æ— æ³•è¢«éšæ„ç§»åŠ¨çš„,ä¸€æ—¦è¿™ä¸ªæ•°æ®ç»“æ„è¿›å…¥åˆ° Pin ä¸­ï¼Œå°±ä¸èƒ½ä» Pin ä¸­é‡æ–°è·å–æ•°æ®çš„æ‰€æœ‰æƒã€‚</p>
<h1 id="ä¸€ä¸ª-self-referential-çš„ä¾‹å­">ä¸€ä¸ª self-referential çš„ä¾‹å­</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="c1">// buf ä¸èƒ½ç§»åŠ¨
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">buf</span>: <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">    </span><span class="c1">// parsed è¿™ä¸ªå­—æ®µå¯ä»¥éšæ„ç§»åŠ¨
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">parsed</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Parsed</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    </span><span class="n">result</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_parse</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="w">        </span><span class="c1">// do_parse åªä¿®æ”¹ parsedï¼Œè€Œ parsed çš„ç§»åŠ¨
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-25">25</a></span><span class="cl"><span class="w">        </span><span class="n">this</span><span class="p">.</span><span class="n">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-26">26</a></span><span class="cl"><span class="w">            </span><span class="n">buf</span>: <span class="nc">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-27">27</a></span><span class="cl"><span class="w">            </span><span class="n">result</span>: <span class="nb">String</span>::<span class="n">from_utf8_lossy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()]).</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-28">28</a></span><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-29">29</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-30">30</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-31">31</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-32">32</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-33">33</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-34">34</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;h&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-35">35</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;e&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-36"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-36">36</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-37"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-37">37</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-38"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-38">38</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;o&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-39"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-39">39</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-40"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-40">40</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-41"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-41">41</a></span><span class="cl"><span class="w">        </span><span class="n">buf</span>: <span class="nc">pin</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-42"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-42">42</a></span><span class="cl"><span class="w">        </span><span class="n">parsed</span>: <span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-43"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-43">43</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-44"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-44">44</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-45"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-45">45</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pinned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-46"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-46">46</a></span><span class="cl"><span class="w">    </span><span class="n">pinned</span><span class="p">.</span><span class="n">do_parse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-47"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-47">47</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-48"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-48">48</a></span><span class="cl"><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-49"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-49">49</a></span><span class="cl"><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-50"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-50">50</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Not expect to reach here.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-51"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-51">51</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-52"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-52">52</a></span><span class="cl"><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-53"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-53">53</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Parse success&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-54"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-54">54</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-55"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-55">55</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-56"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-56">56</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-57"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-57">57</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¦‚æœç”¨ pin_project æ¥æ”¹å†™</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w"></span><span class="cp">#[pin_project::pin_project]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="c1">// buf ä¸èƒ½ç§»åŠ¨ï¼Œå› æ­¤ä½¿ç”¨ pin æ¥æ ‡è¯†
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="cp">#[pin]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="c1">// parsed è¿™ä¸ªå­—æ®µå¯ä»¥éšæ„ç§»åŠ¨
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">parsed</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Parsed</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="w"></span><span class="cp">#[pin_project::pin_project]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="cp">#[pin]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="n">result</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_parse</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">project</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">parsed</span><span class="p">,</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">Parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-25">25</a></span><span class="cl"><span class="w">            </span><span class="n">buf</span>: <span class="nc">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-26">26</a></span><span class="cl"><span class="w">            </span><span class="n">result</span>: <span class="nb">String</span>::<span class="n">from_utf8_lossy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">this</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()]).</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-27">27</a></span><span class="cl"><span class="w">        </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-28">28</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-29">29</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-30">30</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-31">31</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-32">32</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-33">33</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;h&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-34">34</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;e&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-35">35</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-36"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-36">36</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;l&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-37"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-37">37</a></span><span class="cl"><span class="w">    </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="sc">b&#39;o&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-38"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-38">38</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-39"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-39">39</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-40"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-40">40</a></span><span class="cl"><span class="w">        </span><span class="n">buf</span>: <span class="nc">vec</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-41"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-41">41</a></span><span class="cl"><span class="w">        </span><span class="n">parsed</span>: <span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-42"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-42">42</a></span><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-43"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-43">43</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-44"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-44">44</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pinned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-45"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-45">45</a></span><span class="cl"><span class="w">    </span><span class="n">pinned</span><span class="p">.</span><span class="n">do_parse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-46"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-46">46</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-47"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-47">47</a></span><span class="cl"><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">parsed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-48"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-48">48</a></span><span class="cl"><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-49"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-49">49</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Not expect to reach here.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-50"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-50">50</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-51"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-51">51</a></span><span class="cl"><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-52"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-52">52</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Parse success&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-53"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-53">53</a></span><span class="cl"><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-54"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-54">54</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-55"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-55">55</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-56"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-56">56</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>Rust å¯¹è±¡å®‰å…¨è¯¦è§£</title>
			<link>https://huanglei.rocks/posts/object-safety/</link>
			<pubDate>Thu, 09 Dec 2021 21:57:33 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/object-safety/</guid>
			<description>Rust çš„ RFC ä¸Šåªç»™å‡ºäº† object-safety çš„å®šä¹‰ï¼Œä½†æ˜¯æ²¡æœ‰è§£é‡Šä¸ºä½•åœ¨æ»¡è¶³è¿™äº›æ¡ä»¶çš„æ—¶å€™ trait æ˜¯ object safe çš„ï¼Œä»¥åŠä¸ºå•¥éœ€è¦ object safetyï¼Œè¿™åè€Œæ˜¯åˆå­¦è€…æœ€ä¸ºå›°æƒ‘çš„ç‚¹ã€‚ ä¸ºä»€ä¹ˆéœ€è¦</description>
			<content type="html"><![CDATA[<p>Rust çš„ <a href="https://rust-lang.github.io/rfcs/0255-object-safety.html">RFC</a> ä¸Šåªç»™å‡ºäº† object-safety çš„å®šä¹‰ï¼Œä½†æ˜¯æ²¡æœ‰è§£é‡Šä¸ºä½•åœ¨æ»¡è¶³è¿™äº›æ¡ä»¶çš„æ—¶å€™ trait æ˜¯ object safe çš„ï¼Œä»¥åŠä¸ºå•¥éœ€è¦ object safetyï¼Œè¿™åè€Œæ˜¯åˆå­¦è€…æœ€ä¸ºå›°æƒ‘çš„ç‚¹ã€‚</p>
<h1 id="ä¸ºä»€ä¹ˆéœ€è¦-object-safety">ä¸ºä»€ä¹ˆéœ€è¦ object safetyï¼Ÿ</h1>
<p>Rust é€šè¿‡ trait object æä¾›äº†ç±»å‹æ“¦é™¤ã€åŠ¨æ€åˆ†æ´¾çš„èƒ½åŠ›ï¼Œä½†æ˜¯è¿™ä¸ªèƒ½åŠ›æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸æ˜¯æ‰€æœ‰çš„ trait éƒ½èƒ½è‡ªåŠ¨ç”Ÿæˆå®ç°ã€‚
<strong>Trait object æœ¬è´¨ä¸Šæ˜¯å¯¹æŸä¸ª trait çš„è‡ªåŠ¨é»˜è®¤å®ç°ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ•°æ®åŒºå’Œä¸€ä¸ªæ–¹æ³•è¡¨ã€‚<u>Object-safety å°±æ˜¯ä¸ºäº†ä¿è¯ Rust ç¼–è¯‘å™¨èƒ½å¤Ÿä¸ºæŸä¸ª trait ç”Ÿæˆåˆæ³•è‡ªåŠ¨å®ç°ã€‚</u></strong></p>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/QAgzwRCoT/1644416416.png" alt="trait-object.png"></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 Trait object çš„å†…å­˜å¸ƒå±€ 
</i>
</div>
<blockquote>
<p><a href="https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/">Where Self Meets Sized: Revisiting Object Safety</a></p>
</blockquote>
<p>é¦–å…ˆæ˜¯å…³äº trait çš„ object safetyï¼Œä¸€ä¸ª trait æ˜¯å¯¹è±¡å®‰å…¨çš„ï¼Œå½“ä¸”ä»…å½“å®ƒ<strong>æ»¡è¶³ä»¥ä¸‹<u>æ‰€æœ‰</u>æ¡ä»¶</strong>ï¼š</p>
<ul>
<li>trait çš„ç±»å‹ä¸èƒ½é™å®šä¸º <code>Self: Sized</code><sup>1ï¸âƒ£</sup>ï¼›</li>
<li>trait ä¸­æ‰€å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ object-safe çš„<sup>2ï¸âƒ£</sup>ï¼›</li>
</ul>
<p>æ¥ä¸‹æ¥æ˜¯å…³äºæ–¹æ³•çš„ object safetyï¼šä¸€ä¸ªæ–¹æ³•æ˜¯å¯¹è±¡å®‰å…¨çš„ï¼Œå½“ä¸”ä»…å½“è¿™ä¸ªæ–¹æ³•<strong>æ»¡è¶³ä¸‹é¢<u>ä»»æ„ä¸€ä¸ª</u>ç‰¹æ€§</strong>ï¼š</p>
<ul>
<li>æ–¹æ³• receiver çš„ç±»å‹é™å®šæ˜¯ <code>Self: Sized</code><sup>3ï¸âƒ£ </sup>ï¼›æˆ–è€…</li>
<li>æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼š
<ul>
<li>æ–¹æ³•ä¸èƒ½æœ‰æ³›å‹å‚æ•°<sup>4ï¸âƒ£</sup>ï¼›ä¸”</li>
<li>receiver ç±»å‹å¿…é¡»æ˜¯ Self æˆ–è€…å¯ä»¥è§£å¼•ç”¨ä¸º Self çš„å¼•ç”¨ç±»å‹<sup>5ï¸âƒ£ </sup>ã€‚ç›®å‰åªåŒ…æ‹¬<code>self</code>/ <code>&amp;self</code> / <code>&amp;mut self</code>/ <code>self: Box&lt;Self&gt;</code>ã€‚ä»¥åå¯èƒ½ä¹Ÿä¼šæ‰©å±•åˆ° <code>Rc&lt;Self&gt;</code>ç­‰ç­‰ã€‚</li>
<li><code>Self</code>ç±»å‹åªèƒ½ç”¨ä½œ receiver <sup>6ï¸âƒ£ </sup></li>
</ul>
</li>
</ul>
<p>1ï¸âƒ£   ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚ä¸‹çš„ trait æ˜¯ä¸èƒ½ç”¨ä½œ trait object çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Test</span>: <span class="nb">Sized</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">	</span><span class="k">fn</span> <span class="nf">some_method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ä¸ºä»€ä¹ˆtrait çš„æ–¹æ³•çš„ receiver ä¸èƒ½é™å®šä¸º <code>Self: Sized</code>ï¼Ÿå› ä¸º trait object æœ¬èº«æ˜¯åŠ¨æ€åˆ†æ´¾çš„ï¼Œç¼–è¯‘æœŸæ— æ³•ç¡®å®š trait object çš„å¤§å°ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™ trait object çš„æ–¹æ³•åˆè¦æ±‚ Self å¤§å°å¯ç¡®å®šï¼Œé‚£å°±äº’ç›¸çŸ›ç›¾äº†ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtrait object è‡ªèº«çš„å¤§å°æ˜¯å¯ç¡®å®šçš„ï¼Œå› ä¸ºå…¶åªåŒ…æ‹¬æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå’ŒæŒ‡å‘ vtable çš„æŒ‡é’ˆè€Œå·²ã€‚</p>
<p>2ï¸âƒ£   è¦æ±‚ trait æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯å¯¹è±¡å®‰å…¨çš„ä¹Ÿæ˜¯ä¸ºäº†ç¡®ä¿åŠ¨æ€åˆ†æ´¾çš„æ—¶å€™èƒ½å¤Ÿæ­£ç¡®ä» vtable ä¸­æ‰¾åˆ°æ–¹æ³•è¿›è¡Œè°ƒç”¨ã€‚</p>
<p>3ï¸âƒ£   ç”±äº trait object è‡ªèº«æ˜¯ Unsizedï¼Œå¦‚æœæ–¹æ³•é™å®šäº†<code>Self: Sized</code>ï¼Œé‚£ä¹ˆä¸€å®šæ— æ³•é€šè¿‡ trait object å»è°ƒç”¨ã€‚ä¹Ÿå°±ä¸ä¼šå¯¼è‡´åŠ¨æ€åˆ†æ´¾çš„ object safety é—®é¢˜ï¼Œå› æ­¤ä¸€ä¸ªé™å®šäº† <code>Self: Sized</code>çš„ trait æ–¹æ³•ä¹Ÿè¢«è®¤ä¸ºæ˜¯ object-safe çš„ã€‚</p>
<blockquote>
<ul>
<li><a href="https://stackoverflow.com/questions/42620022/why-does-a-generic-method-inside-a-trait-require-trait-object-to-be-sized">Why does a generic method inside a trait require trait object to be sized? - Stack Overflow</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/22031">A method marked where Self: Sized on a trait should not be considered during object safety checks #22031</a></li>
</ul>
</blockquote>
<p>4ï¸âƒ£   å¦‚æœæ–¹æ³•ä¸é™å®š <code>Self: Sized</code> ï¼Œå°±æ„å‘³ç€é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•é¦–å…ˆä¸èƒ½æœ‰æ³›å‹å‚æ•°ã€‚å¦‚æœæœ‰æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆ vtable ä¸­çš„æ–¹æ³•åˆ—è¡¨å¤§å°æ˜¯éš¾ä»¥ç¡®å®šçš„ã€‚å½“ç„¶å¦‚æœéè¦åšï¼Œåœ¨ç¼–è¯‘æœŸï¼Œrust ç¼–è¯‘å™¨å¯ä»¥æ‹¿åˆ° trait çš„æ‰€æœ‰å…·ä½“å®ç°ï¼Œç„¶åä¸ºæ¯ä¸€ä¸ªå…·ä½“å®ç°åœ¨ vtable ç”Ÿæˆä¸€ä¸ªç‰¹åŒ–çš„æ–¹æ³•é¡¹ã€‚ä½†æ˜¯é¦–å…ˆè¿™ä¼šå¤§å¤§é™ä½ç¼–è¯‘é€Ÿåº¦ï¼Œå…¶æ¬¡ä¹Ÿä¼šå¼•å…¥æå¤§çš„å¤æ‚æ€§ã€‚å› æ­¤ Rust çš„ trait object ç›´æ¥ç¦æ­¢äº†è¿™ç§ä½¿ç”¨åœºæ™¯ã€‚</p>
<blockquote>
<p><a href="https://stackoverflow.com/questions/67767207/why-are-trait-methods-with-generic-type-parameters-object-unsafe">Why are trait methods with generic type parameters object-unsafe?</a></p>
</blockquote>
<p>5ï¸âƒ£   å¦‚æœæ–¹æ³•æ²¡æœ‰ receiverï¼Œé‚£ä¹ˆä½¿ç”¨ trait object æ¯«æ— æ„ä¹‰ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ ¹æœ¬ä¸éœ€è¦ trait object é‡Œé¢çš„ data æŒ‡é’ˆã€‚</p>
<p>6ï¸âƒ£   å‡è®¾ trait å®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ªæ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">trait</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w">	</span><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>é‚£ä¹ˆè¿™ä¸ª trait çš„ duplicate æ–¹æ³•è¦æ±‚è¿”å›çš„ç±»å‹å’Œæ–¹æ³• receiver çš„ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœ Trait æ˜¯é™æ€åˆ†æ´¾ï¼Œé‚£ä¹ˆåœ¨ç¼–è¯‘å™¨å°±å¯ä»¥ç¡®å®šæ‰€æœ‰å¯èƒ½çš„æ–¹æ³•ç­¾åã€‚æ¯”å¦‚ç»“æ„ä½“ Aã€B å®ç°äº† Test traitï¼Œé‚£ä¹ˆ duplicate æ–¹æ³•æ‰€æœ‰å¯èƒ½çš„ç­¾åæ˜¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">A</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">A</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">B</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>è€Œåœ¨åŠ¨æ€åˆ†æ´¾ä¸‹ï¼Œä»ä¸€ä¸ª trait object å‘èµ·æ–¹æ³•çš„è°ƒç”¨ï¼Œä¹Ÿå°±æ— æ³•åœ¨ç¼–è¯‘æœŸçº¦æŸä¸åŒä½ç½®çš„ Self ç±»å‹éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå®Œå…¨æœ‰å¯èƒ½å‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">A</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>æ˜¾ç„¶è¿™ä¸æ˜¯å¯¹ <code>Test</code> è¿™ä¸ª trait çš„ä¸€ä¸ªåˆæ³•å®ç°ã€‚</p>
<ul>
<li><a href="https://rust-lang.github.io/rfcs/0255-object-safety.html">https://rust-lang.github.io/rfcs/0255-object-safety.html</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Paxos Made Simple ç¬”è®° (WIP)</title>
			<link>https://huanglei.rocks/posts/notes-on-paxos-made-simple/</link>
			<pubDate>Mon, 14 Jun 2021 11:24:18 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/notes-on-paxos-made-simple/</guid>
			<description>å…³äº P2c P2c æ˜¯ P2b çš„å……åˆ†ä¸å¿…è¦æ¡ä»¶ï¼Œwhyï¼Ÿ P2b: If a proposal with value v is chosen, then every higher-numbered proposal issued by any proposer has value v. P2c: For any v and n, if a proposal with value v and number n is issued, then there is a set S consisting of a majority of acceptors such that</description>
			<content type="html"><![CDATA[<h1 id="å…³äº-p2c">å…³äº P2c</h1>
<p>P2c æ˜¯ P2b çš„å……åˆ†ä¸å¿…è¦æ¡ä»¶ï¼Œwhyï¼Ÿ</p>
<blockquote>
<ul>
<li>P2b: If a proposal with value v is chosen, then every higher-numbered proposal issued by any proposer has value <code>v</code>.</li>
<li>P2c: For any <code>v</code> and <code>n</code>, if a proposal with value <code>v</code> and number <code>n</code> is issued, then there is a set S consisting of a majority of acceptors such that either
<ul>
<li>(a) no acceptor in S has accepted any proposal numbered less than <code>n</code>, or</li>
<li>(b) <code>v</code> is the value of the highest-numbered proposal among all proposals numbered less than <code>n</code> accepted by the acceptors in S.</li>
</ul>
</li>
</ul>
</blockquote>
<p>å·²çŸ¥ proposal:<code>(m,v)</code>è¢«é€‰ä¸­ï¼Œè¦æ»¡è¶³ä»»æ„ proposer æå‡ºåºå· n ï¼ˆn &gt; mï¼‰çš„ proposal çš„å€¼éƒ½æ˜¯ <code>v</code>ï¼Œé‚£ä¹ˆåªè¦æ»¡è¶³æ¡ä»¶ï¼š<u> $ \forall i\in [m,\ n-1]$ ï¼Œæœ‰ proposal <code>i</code> çš„å€¼æ˜¯ <code>v</code> 1</u>ï¼Œé‚£ä¹ˆæ ¹æ®æ•°å­¦å½’çº³æ³•ï¼Œproposal <code>n</code>çš„å€¼ä¹Ÿå¿…ç„¶æ˜¯ <code>v</code>ã€‚</p>
<p>1: æ˜¯é™„åŠ å‡è®¾ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¿™ä¸ªé™„åŠ å‡è®¾å»çº¦æŸ proposer çš„è¡Œä¸ºï¼Œä»è€Œä½¿å¾— P2b èƒ½å¤Ÿè¢«æ»¡è¶³ã€‚ä¸‹é¢å°±éœ€è¦è§£é‡Šè¿™ä¸ªé™„åŠ å‡è®¾å¯¹ proposer çš„è¡Œä¸ºåšå‡ºäº†ä»€ä¹ˆæ ·çš„çº¦æŸã€‚</p>
<p>ç”±äº <code>(m,v)</code>å·²ç»è¢«é€‰ä¸­äº†ï¼Œé‚£å°±æ„å‘³ç€å­˜åœ¨ä¸€ä¸ª acceptor çš„é›†åˆ C æ»¡è¶³ä»»æ„ C ä¸­çš„ acceptor éƒ½ accept äº†<code>(m,v)</code>ï¼Œå†åŠ ä¸Šæˆ‘ä»¬éœ€è¦è®©é™„åŠ å‡è®¾ï¼ˆæ»¡è¶³ $i\in [m,\ n-1]$ ï¼Œæœ‰ proposal <code>i</code> çš„å€¼æ˜¯ <code>v</code>ï¼‰æˆç«‹ï¼Œ
è¿™å°±æ„å‘³ç€æ‰€è°“çš„ C-condition 2 ï¼Œå¯¹äº accept äº† <code>(m,v)</code> çš„ acceptor é›†åˆ Cï¼Œæ»¡è¶³ï¼š</p>
<ul>
<li>(1)  C ä¸­çš„æ‰€æœ‰ acceptor éƒ½ accept äº† $[m,\ n-1]$ ä¸­çš„ä¸€ä¸ª proposalï¼ˆå› ä¸ºè‡³å°‘æœ‰<code>m</code>å·²ç»è¢« C ä¸­çš„æ‰€æœ‰ acceptor ç»™ accept äº†ï¼‰</li>
<li>(2) $[m,\ n-1]$ ä¸­æ‰€æœ‰çš„è¢«ä»»æ„ acceptor æ‰€ accept çš„ proposal çš„å€¼éƒ½æ˜¯ <code>v</code>ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œçº¦æŸçš„å¯¹è±¡ä» proposer å˜æˆäº† acceptorï¼Œå®é™…ä¸Š narrow down äº†ï¼Œå› ä¸ºæ˜¯éæ‹œå åº­é—®é¢˜ï¼Œæ‰€æœ‰è¢« acceptor æ‰€ accept çš„å€¼éƒ½éœ€è¦ proposer æå‡ºï¼‰ã€‚</li>
</ul>
<p>é‚£ä¹ˆåªè¦ proposer æ»¡è¶³ P2cï¼Œå°±èƒ½æ»¡è¶³æ‰€è°“çš„ C-conditionï¼Œä»è€Œå®ç° P2c -&gt; C-condidtion -&gt; é™„åŠ å‡è®¾ 1-&gt; P2b çš„è¯æ˜è·¯å¾„ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆ P2c å¯ä»¥ä¿è¯ C-condiditionï¼Ÿ
P2c çº¦æŸäº† proposer æ¯æ¬¡ææ¡ˆä¹‹å‰å…ˆè¦çŸ¥é“ majority çš„æƒ…å†µï¼Œç”±äº<code>(m,v)</code>å·²ç» chosenï¼Œå› æ­¤ç¬¦åˆ P2c çš„ proposer åœ¨æå‡º m+1 çš„æ—¶å€™ï¼Œææ¡ˆçš„å€¼å¿…ç„¶æ˜¯ mï¼ˆhighest accepted proposalï¼‰çš„å€¼ vï¼Œm+2ã€m+3 ç›´åˆ° n-1 éƒ½æ˜¯è¿™æ ·ï¼Œä»è€Œå¯ä»¥ä¿è¯ C-condition çš„ (2)ï¼Œ</p>
</blockquote>
<p>å› æ­¤ P2b åˆ° P2c å®é™…ä¸Šæ˜¯è®©çº¦æŸé€æ­¥å¯å®ç°åŒ–çš„ narrow downï¼Œå› ä¸ºè®© proposer å»æ„ŸçŸ¥ acceptor çš„çŠ¶æ€æ˜¯æ›´å®¹æ˜“å®ç°çš„ã€‚</p>
<blockquote>
<p>Learning about proposals already accepted is easy enough; predicting future acceptances is hard. Instead of trying to predict the future, the proposer controls it by extracting a promise that there wonâ€™t be any such acceptances.</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>ç°ä»£ Java æ‰è™«æŒ‡å—</title>
			<link>https://huanglei.rocks/posts/java-debug-manual/</link>
			<pubDate>Fri, 12 Feb 2021 22:01:27 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/java-debug-manual/</guid>
			<description>gnu.hl@antgroup.com 2020-12-01 æœ¬æ–‡æ˜¯ä½œè€… 2021 å¹´åœ¨èš‚èšå†…éƒ¨åˆ†äº«æ—¶çš„ slides ç»è¿‡è„±æ•ä¹‹åçš„ç‰ˆæœ¬ã€‚ å½“æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…³æ³¨ä»€ä¹ˆï¼Ÿ æ¨ªå‘æ¥çœ‹: context/critical path/caller/callee (tracing) statistics/metrics (profiling) çºµå‘æ¥çœ‹: application runtime kernel Arthas Arthas æ˜¯åŸºäº</description>
			<content type="html"><![CDATA[<p><img src="https://gw.alipayobjects.com/zos/antfincdn/Se%26jyp0zs1/fe9fd884-3cb2-4cf7-b060-cd8d704cb03e.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=HK8X9&amp;originHeight=1634&amp;originWidth=2419&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
 <a href="mailto:gnu.hl@antgroup.com">gnu.hl@antgroup.com</a>  
</i>
</div>
<div style="text-align: center; margin-bottom: 1em; margin-top: -0.5em; opacity: .5;">
<i>
<p><strong>2020-12-01</strong></p>
</i>
</div>
<hr>
<blockquote>
<p>æœ¬æ–‡æ˜¯ä½œè€… 2021 å¹´åœ¨èš‚èšå†…éƒ¨åˆ†äº«æ—¶çš„ slides ç»è¿‡è„±æ•ä¹‹åçš„ç‰ˆæœ¬ã€‚</p>
</blockquote>
<h2 id="å½“æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æ—¶å€™æˆ‘ä»¬å…³æ³¨ä»€ä¹ˆ">å½“æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…³æ³¨ä»€ä¹ˆï¼Ÿ</h2>
<p>æ¨ªå‘æ¥çœ‹:</p>
<ul>
<li>context/critical path/caller/callee (tracing)</li>
<li>statistics/metrics (profiling)</li>
</ul>
<p>çºµå‘æ¥çœ‹:</p>
<ul>
<li>application</li>
<li>runtime</li>
<li>kernel</li>
</ul>
<hr>
<h2 id="arthas">Arthas</h2>
<blockquote>
<p>Arthas æ˜¯åŸºäºå­—èŠ‚ç å¢å¼ºçš„è°ƒè¯•å·¥å…·.</p>
</blockquote>
<p>åŠŸèƒ½:</p>
<ul>
<li>è§‚å¯Ÿæ–¹æ³•çš„å…¥å‚/è¿”å›å€¼/å¼‚å¸¸ç­‰æ•°æ®</li>
<li>è§‚å¯Ÿå†…å­˜å¯¹è±¡çš„å€¼</li>
<li>è·Ÿè¸ªæ–¹æ³•çš„è€—æ—¶å’Œè°ƒç”¨æ ˆ</li>
<li>æŸ¥çœ‹ç±»åŠ è½½æ¥æº/çƒ­æ›´æ–°ç±»å®šä¹‰</li>
</ul>
<h3 id="å®‰è£…">å®‰è£…</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">curl -L http://start.alibaba-inc.com/install.sh <span class="p">|</span> sh
</span></span></code></pre></div><hr>
<h3 id="arthas-ä½¿ç”¨æ–¹æ³•">Arthas ä½¿ç”¨æ–¹æ³•</h3>
<ul>
<li>è§‚å¯Ÿæ–¹æ³•å…¥å‚ã€è¿”å›å€¼ã€å¼‚å¸¸</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp}&#34; [condition] [-f] [-b] [-xN]
</code></pre><ul>
<li>æ‹¦æˆªæŒ‡å®šçº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp}&#34; \
  &#34;@java.lang.Thread@currentThread().getName()==&#39;&lt;thread_name&gt;&#39;&#34; [-f] [-b] [-xN]
</code></pre><ul>
<li>åœ¨è§‚å¯Ÿå…¥å‚åŒæ—¶æ‰“å°æ–¹æ³•æ ˆ</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp, \
@java.lang.Thread@currentThread().getStackTrace()}&#34; [condition] [-f] [-b] [-xN]
</code></pre><hr>
<h3 id="arthas-ä½¿ç”¨æ–¹æ³•cont">Arthas ä½¿ç”¨æ–¹æ³•(cont.)</h3>
<ul>
<li>è€—æ—¶è¾ƒé•¿çš„æ–¹æ³•</li>
</ul>
<pre tabindex="0"><code>watch &lt;class_fqcn&gt; &lt;method_name&gt; &#34;{params,returnObj,throwExp, @java.lang.Thread@currentThread().getStackTrace()}&#34; \
&#39;#cost&gt;100 [&amp;&amp; other_cond]&#39; [-f] [-b] [-xN]
</code></pre><ul>
<li>classloading é—®é¢˜</li>
</ul>
<pre tabindex="0"><code>sc -d &#39;&lt;class_name&gt;&#39;
</code></pre><ul>
<li>æ„é€ å¯¹è±¡</li>
</ul>
<pre tabindex="0"><code>watch com.alipay.antq.broker.processor.SendMessageProcessor sendMessage \
&#34;{new java.lang.String(params[1].body)}&#34; -x2 -n10
</code></pre><hr>
<h3 id="arthas-ä½¿ç”¨æ–¹æ³•cont-1">Arthas ä½¿ç”¨æ–¹æ³•(cont.)</h3>
<ul>
<li>Projection &amp; filtering</li>
</ul>
<pre tabindex="0"><code>watch com.alipay.antqnamesrv.core.service.broker.BrokerFileService getBrokerFiles \
    &#34;{returnObj[&#39;FILE_CLUSTER&#39;][&#39;antq-eu95-3.gz00b.stable.alipay.net&#39;]\
    .topicQueues.values().{ #this.{? #this.queueId==32 } }.{? #this.size()!=0 }}&#34; -x3
</code></pre><ul>
<li>è§‚å¯Ÿæ–¹æ³•æ‰§è¡Œè·¯å¾„</li>
</ul>
<pre tabindex="0"><code>trace [--skipJDKMethod true|false] &lt;class_fqcn&gt; &lt;method_name&gt;
</code></pre><blockquote>
<p>N/A</p>
</blockquote>
<hr>
<h3 id="arthas-ä½¿ç”¨æ–¹æ³•cont-2">Arthas ä½¿ç”¨æ–¹æ³•(cont.)</h3>
<ul>
<li>åˆ¶ä½œç«ç„°å›¾</li>
</ul>
<pre tabindex="0"><code># list all events
profiler list
# profile object allocation
profiler start --event alloc -d 10
# profile lock acquire
profiler start --event lock -d 10
</code></pre><ul>
<li>çƒ­æ›´æ–°ä»£ç </li>
</ul>
<pre tabindex="0"><code>mc/redefine
</code></pre><p>N/A</p>
<hr>
<h3 id="arthas-çš„ç¼ºé™·">Arthas çš„ç¼ºé™·</h3>
<ul>
<li>å¯åŠ¨æœŸè§‚æµ‹ -&gt; <code>jdb</code> / <a href="https://github.com/btraceio/btrace">btrace</a></li>
<li>æµ‹é‡å¼•å…¥ overhead</li>
<li>æ³¨æ„å†…å­˜é—®é¢˜</li>
</ul>
<hr>
<h2 id="eclipse-mat--zprofiler">Eclipse MAT / zprofiler</h2>
<ul>
<li><a href="https://lark-assets-prod-aliyun.oss-accelerate.aliyuncs.com/lark/0/2020/png/122844/1595069971931-7bb33b65-cb9e-41a0-b1b4-8547b2c1708b.png?OSSAccessKeyId=LTAI4GGhPJmQ4HWCmhDAn4F5&amp;Expires=1607186074&amp;Signature=LF4bn%2FxILpoIgYCGtFBWyEjDIXE%3D&amp;response-content-disposition=inline">OQL</a>
<code>select * from io.netty.channel.AbstractChannelhandlerContext$11</code></li>
</ul>
<h3 id="native-memory-issues">Native memory issues</h3>
<p>RSS = xmx + Â MaxDirectMemory + N * xss [ + gc + code cache + metaspace ]</p>
<ul>
<li>case1) DirectByteBuffer æœªé‡Šæ”¾-&gt;é€šè¿‡è§‚å¯Ÿå †å†…çš„DirectMemory</li>
<li>case2) <code>[G]ZIPInput[/Output]Stream</code>/<code>De[/In]flater</code> <a href="https://www.evanjones.ca/java-native-leak-bug.html">native memory leak</a></li>
<li>case3) Netty&lt;= 4.0.24 <a href="https://github.com/netty/netty/pull/3844">epoll native memory leak</a></li>
<li>case4) <a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8164293">JDK-8164293:HotSpot leaking memory</a> (fixed <a href="/8u152">@8u152) </a> )</li>
</ul>
<hr>
<h2 id="sa-jdi--clhsdb">sa-jdi / clhsdb</h2>
<blockquote>
<p>Off-process vs. in-process instrumentation</p>
</blockquote>
<ul>
<li>sa: serviceability agent</li>
<li>clhsdb: command-line hotspot debugger</li>
<li>sa-jdi æä¾›äº†è·å– JVM å†…éƒ¨æ•°æ®ç»“æ„çš„ç¼–ç¨‹æ¥å£</li>
<li>sa-jdi ä¸ä»…å¯ä»¥ attach æ´»ç€çš„è¿›ç¨‹, ä¹Ÿå¯ä»¥åˆ†æ coredump</li>
<li><code>jstack</code>/<code>jstat</code>ç­‰å·¥å…·å‡æä¾›äº†åŸºäº attach api(tools.jar) å’Œ sa-jdi(sa-jdi.jar)çš„å®ç°</li>
<li><a href="https://www.iteye.com/blog/rednaxelafx-1847971">å€ŸHSDBæ¥æ¢ç´¢HotSpot VMçš„è¿è¡Œæ—¶æ•°æ®</a></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">ls <span class="nv">$JAVA_HOME</span>/lib
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">java -cp <span class="nv">$JAVA_HOME</span>/lib/sa-jdi.jar sun.jvm.hotspot.CLHSDB
</span></span></code></pre></div><hr>
<h2 id="sa-jdi--clhsdbcont">sa-jdi / clhsdb(cont.)</h2>
<h5 id="ä½¿ç”¨-sa-jdi-åˆ†æåå°„ç”Ÿæˆçš„ç±»">ä½¿ç”¨ sa-jdi åˆ†æåå°„ç”Ÿæˆçš„ç±»</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="kn">import</span> <span class="nn">sun.jvm.hotspot.oops.InstanceKlass</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="kn">import</span> <span class="nn">sun.jvm.hotspot.tools.jcore.ClassFilter</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodAccessorFilter</span> <span class="kd">implements</span> <span class="n">ClassFilter</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">canInclude</span><span class="o">(</span><span class="n">InstanceKlass</span> <span class="n">instanceKlass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7">7</a></span><span class="cl">        <span class="k">return</span> <span class="n">instanceKlass</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">asString</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;sun/reflect/Generated&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8">8</a></span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9">9</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">java -classpath <span class="s2">&#34;.:</span><span class="nv">$JAVA_HOME</span><span class="s2">/lib/sa-jdi.jar&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="se"></span>-Dsun.jvm.hotspot.tools.jcore.filter<span class="o">=</span>MethodAccessorFilter sun.jvm.hotspot.tools.jcore.ClassDump &lt;pid&gt;
</span></span></code></pre></div><blockquote>
<p>SA-JDI is deprecated since Java9 &ndash; <a href="https://bugs.openjdk.java.net/browse/JDK-8158050">JDK-8158050</a></p>
</blockquote>
<hr>
<h2 id="jfr">JFR</h2>
<ul>
<li>åŸŸå†…è¦æ±‚ JVM ç‰ˆæœ¬ <code>^ajdk-8_5_10_fp2-b9</code></li>
<li><code>-XX:+EnableJFR -XX:+FlightRecorder -XX:FlightRecorderOptions=&lt;opt&gt;=&lt;val&gt; -XX:StartFlightRecording=&lt;opt&gt;=&lt;val&gt;</code></li>
<li>å¯åˆ†æçš„äº‹ä»¶ç±»å‹:
<ul>
<li>Lock contention</li>
<li>Memory allocation</li>
<li>IO performance (Network/File)</li>
<li>Code execution performance</li>
<li>Garbage Collector</li>
<li>JIT performance</li>
</ul>
</li>
</ul>
<hr>
<h2 id="jfr-cont">JFR (cont.)</h2>
<p>ä½¿ç”¨æ­¥éª¤</p>
<ul>
<li>å¯åŠ¨è¿›ç¨‹æ—¶å¢åŠ å¼€å¯ JFR çš„å‚æ•°</li>
<li>å¼€å§‹ JFR è®°å½• <code>jcmd &lt;pid&gt; JFR.start settings=profile name=&lt;record_name&gt;</code></li>
<li>dumpJFR è®°å½• <code>jcmd &lt;pid&gt; JFR.dump filename=jfr.output name=&lt;record_name&gt;</code></li>
<li>ä½¿ç”¨ <a href="https://www.oracle.com/java/technologies/jdk-mission-control.html">JDK Mission Control</a> åˆ†æ JFR dump</li>
</ul>
<hr>
<h2 id="jfr-cont-1">JFR (cont.)</h2>
<p>å‚è€ƒèµ„æ–™</p>
<ul>
<li><a href="http://hirt.se/blog/">Continuous Production Profiling and Diagnostics</a></li>
<li><a href="https://www.javacodegeeks.com/2015/03/oracle-java-mission-control-the-ultimate-guide.html">Oracle Java Mission Control: The Ultimate Guide</a></li>
</ul>
<hr>
<h2 id="interesting-cases">Interesting Cases</h2>
<ul>
<li>N/A</li>
<li>N/A</li>
<li>N/A</li>
</ul>
<hr>
<h2 id="one-more-thing">One more thing</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Tool</th>
</tr>
</thead>
<tbody>
<tr>
<td>Application on runtime(Java/Node/Ruby/PHP)</td>
<td>Runtime debugger,eBPF</td>
</tr>
<tr>
<td>Application (native code)</td>
<td>System debugger,eBPF</td>
</tr>
<tr>
<td>System libraries: /lib/*</td>
<td>ltrace(1),eBPF</td>
</tr>
<tr>
<td>System call interface</td>
<td>strace(1), perf(1),eBPF</td>
</tr>
<tr>
<td>Network Traffic</td>
<td>tcpdump(8),eBPF</td>
</tr>
<tr>
<td>Kernel: Scheduler, file systems, TCP, IP, etc</td>
<td>ftrace(1), perf(1),eBPF</td>
</tr>
<tr>
<td>Hardware: CPU internals, devicec</td>
<td>perf, sar, eBPF</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="perf">Perf</h2>
<ul>
<li>Why is the kernel on-CPU so much? What code-paths?</li>
<li>Which code-paths are causing CPU level 2 cache misses?</li>
<li>Are the CPUs stalled on memory I/O?</li>
<li>Which code-paths are allocating memory, and how much?</li>
<li>What is triggering TCP retransmits?</li>
<li>Is a certain kernel function being called, and how often?</li>
<li>What reasons are threads leaving the CPU?</li>
</ul>
<p>&ndash; Brendan Greg</p>
<hr>
<h2 id="perf-cont">Perf (cont.)</h2>
<p><code>perf_event</code>:</p>
<ul>
<li>Software events</li>
<li>Hardware events</li>
<li>Kernel static tracepoint events</li>
<li>USDT</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/122844/1606655883925-873a4d92-9d1b-4d7d-8e24-31cd567ebd1f.png?x-oss-process=image%2Fresize%2Cw_1412#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=oFLoJ&amp;originHeight=988&amp;originWidth=1412&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<p><code>sudo perf list</code> to list all available events.</p>
<hr>
<pre tabindex="0"><code># sudo perf record -e block:block_rq_issue -e block:block_rq_complete -a sleep 10
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.428 MB perf.data (~18687 samples) ]
# sudo perf script
        run 30339 [000] 2083345.722767: block:block_rq_complete: 202,1 W () 12984648 + 8 [0]
        run 30339 [000] 2083345.722857: block:block_rq_complete: 202,1 W () 12986336 + 8 [0]
        run 30339 [000] 2083345.723180: block:block_rq_complete: 202,1 W () 12986528 + 8 [0]
    swapper     0 [000] 2083345.723489: block:block_rq_complete: 202,1 W () 12986496 + 8 [0]
    swapper     0 [000] 2083346.745840: block:block_rq_complete: 202,1 WS () 1052984 + 144 [0]
  supervise 30342 [000] 2083346.746571: block:block_rq_complete: 202,1 WS () 1053128 + 8 [0]
  supervise 30342 [000] 2083346.746663: block:block_rq_complete: 202,1 W () 12986608 + 8 [0]
        run 30342 [000] 2083346.747003: block:block_rq_complete: 202,1 W () 12986832 + 8 [0]

                                                                            
              /---------------------------------------- #1  supervise: on-CPU cmd                                                             
             /       /--------------------------------- #2  30342: on-CPU cmd tid                                                       
            /       /     /---------------------------- #3  [000]: CPU running cmd                                                 
           /       /     /          /------------------ #4  2083346.746571: reltime                                        
          /       /     /          /                /-- #5  block:block_rq_complete: tracepoint  
         /       /     /          /                /                  /------------- #6  202,1 : storage major,minor number, ref lsblk
        /       /     /          /                /                  /    /--------- #7  IO type: W-Write,R-Read,A-ReadAheader,O-Sync,WS-Sync Write   
       /       /     /          /                /                  /    /  /------- #8  (): Block command details
      /       /     /          /                /                  /    /  /     /-- #9  12986336: storage device offset
     /       /     /          /                /                  /    /  /     /     /---- #10 +8: size of IO (in sectors)
    /       /     /          /                /                  /    /  /     /     /  /-- #11 [0]: if errors happened
supervise 30342 [000] 2083346.746571: block:block_rq_complete: 202,1 WS () 1053128 + 8 [0]
# how can I get this format?  cat /sys/kernel/debug/tracing/events/{event_cat}/{event_name}/format

perf script | awk &#39;{ gsub(/:/, &#34;&#34;) } $5 ~ /issue/ { ts[$6, $10] = $4 }
    $5 ~ /complete/ { if (l = ts[$6, $9]) { printf &#34;%.f %.f\n&#34;, $4 * 1000000,
    ($4 - l) * 1000000; ts[$6, $10] = 0 } }&#39;
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">sudo yum install -y kernel-devels
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">sudo yum install -y kernel-headers
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">sudo mount -t debugfs debugfs /sys/kernel/debug
</span></span></code></pre></div><hr>
<h2 id="using-perf-trace-java-io-issues">Using perf trace Java IO issues</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl">sudo perf record -e block:block_rq_issue  -a -g  -p &lt;pid&gt; sleep <span class="m">10</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">sudo perf report -G <span class="c1"># No java stack info ?</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">sudo yum install -y gcc-c++ cmake
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl">git clone https://github.com/jvm-profiling-tools/perf-map-agent
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="nb">cd</span> perf-map-agent <span class="o">&amp;&amp;</span> cmake . <span class="o">&amp;&amp;</span> make -j8
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7">7</a></span><span class="cl">./bin/create-java-perf-map.sh &lt;pid&gt;
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8">8</a></span><span class="cl"><span class="nb">cd</span> -
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9">9</a></span><span class="cl">perf report -G <span class="c1"># gotcha!</span>
</span></span></code></pre></div><hr>
<h2 id="flame-graph">Flame Graph</h2>
<pre tabindex="0"><code>git clone https://github.com/brendangregg/FlameGraph
sudo perf script | \
    &lt;path-to&gt;/stackcollapse-perf.pl | \
    &lt;path-to&gt;/flamegraph.pl &gt; perf-kernel.svg
</code></pre><h2 id="reference">Reference</h2>
<ul>
<li><a href="http://www.brendangregg.com/perf.html#OneLiners">perf one-liners</a></li>
<li><a href="http://www.brendangregg.com/blog/2015-02-26/linux-perf-off-cpu-flame-graph.html">Off-CPU Analysis</a></li>
</ul>
<hr>
<h2 id="å†…å­˜å¢é•¿çš„å¦å¤–ä¸€ç§æ€è·¯">å†…å­˜å¢é•¿çš„å¦å¤–ä¸€ç§æ€è·¯</h2>
<ul>
<li>é€šè¿‡<code>LD_PRELOAD</code>æ›¿æ¢åˆ†é…å™¨ä¸º jemalloc</li>
<li>å¼€å¯ jemalloc çš„æ³„æ¼åˆ†æ</li>
<li>å¯åŠ¨è¿›ç¨‹, æ‰¾åˆ°æ³„æ¼çš„ native æ ˆ</li>
<li>ç”¨ <code>perf record -e &lt;tp&gt; -ag</code> æŠ“å–åˆ†é…çš„äº‹ä»¶</li>
<li><code>create-java-perf-map.sh</code> ç”Ÿæˆç¬¦å·è¡¨</li>
<li><code>perf report/script</code> æŸ¥çœ‹è®¿é—®çº¿ç¨‹</li>
</ul>
<hr>
<h2 id="ebpfxdp">eBPF/XDP</h2>
<blockquote>
<p>eBPF does to Linux what JavaScript does to HTML. &ndash; Brendan Gregg</p>
</blockquote>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/px8%24TS%2457N/5324708e-a7f5-44d7-963b-a569fd0b6d08.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=RJ0w2&amp;originHeight=818&amp;originWidth=1132&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="ebpf-probes">eBPF probes</h2>
<ul>
<li>Probes (Dynamic, Using <code>trap</code>)
<ul>
<li><a href="https://www.kernel.org/doc/Documentation/kprobes.txt">k{,ret}probes</a></li>
<li><a href="https://lwn.net/Articles/499190/">u{,ret}probes</a></li>
</ul>
</li>
<li>Tracepoints (Static, predefined)
<ul>
<li><a href="https://static.lwn.net/kerneldoc/trace/tracepoints.html">Kernel tracepoints</a>
<ul>
<li><code>cat /sys/kernel/debug/tracing/available_events</code></li>
</ul>
</li>
<li><a href="https://lwn.net/Articles/753601/">USDT</a>
<ul>
<li><code>readelf -n X.so | grep -A4 NT_STAPSDT</code></li>
<li><code>tplist.py -p &lt;running_process&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="ebpf-vs-perf">eBPF vs. Perf</h2>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/d9OtRCINlq/4f7646df-bab8-4fe7-8bd8-5e7ba7005996.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=swEsD&amp;originHeight=964&amp;originWidth=1424&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="ebpf-hello-world">eBPF Hello world</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl"><span class="kn">from</span> <span class="nn">bcc</span> <span class="kn">import</span> <span class="n">BPF</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl"><span class="n">prog</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl"><span class="s2">int hello(void *ctx) {
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl"><span class="s2">    bpf_trace_printk(&#34;Hello world</span><span class="se">\\</span><span class="s2">n&#34;);
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="s2">    return 0;
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl"><span class="c1">#print(b.get_syscall_fnname(&#34;clone&#34;)) # platform-dependent syscall kprobe name</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl"><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&#34;__x64_sys_clone&#34;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="c1">#        ^~~~~~ this is a kprobe </span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="n">b</span><span class="o">.</span><span class="n">trace_print</span><span class="p">()</span>
</span></span></code></pre></div><hr>
<h2 id="bcc-bpf-compiler-collection">BCC (BPF Compiler Collection)</h2>
<blockquote>
<p>&mdash;eBPF made simple</p>
</blockquote>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/ZknkdEV%24hu/68c407a8-8ce3-4fba-a037-f96f09e1fd27.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=oh5dT&amp;originHeight=649&amp;originWidth=872&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="use-bcc-to-explore-jvm-usdt">Use BCC to explore JVM USDT</h2>
<pre tabindex="0"><code>readelf -n $JAVA_HOME/jre/lib/amd64/server/libjvm.so | grep -A4 NT_STAPSDT
sudo &lt;path-to&gt;/trace.py -p &lt;java_pid&gt; &#39;u::thread__sleep__begin&#39;
</code></pre><hr>
<h2 id="bpftrace"><code>bpftrace</code></h2>
<blockquote>
<p>one-liner eBPF tools</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="c1"># list tracepoints</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">bpftrace -l <span class="s1">&#39;tracepoint:syscalls:sys_enter_*&#39;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl"><span class="c1"># trace file open</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">bpftrace -e <span class="s1">&#39;tracepoint:syscalls:sys_enter_openat { printf(&#34;%s %s\n&#34;, comm, str(args-&gt;filename)); }&#39;</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="c1"># bio size dist</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl">bpftrace -e <span class="s1">&#39;tracepoint:block:block_rq_issue { @ = hist(args-&gt;bytes); }&#39;</span>
</span></span></code></pre></div><p><a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#bpftrace-reference-guide">bpftrace Reference Guide</a></p>
<hr>
<h2 id="using-ebpf-to-debug-hotspot-jvmhttpsgithubcomadoptopenjdkopenjdk-buildissues1173"><a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">Using eBPF to debug Hotspot JVM</a></h2>
<ul>
<li>Compile OpenJDK with tracepoints enabled</li>
<li>Use BCC trace tools to trace JVM methods</li>
<li>More Info ref - <a href="https://web.archive.org/web/20161006014657/http://blogs.microsoft.co.il/sasha/2016/03/31/probing-the-jvm-with-bpfbcc/">Probing the JVM with BPF/BCC</a>/[Enable USDT probes for eBPF tracing on Linux #1173</li>
</ul>
<p>](<a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">https://github.com/AdoptOpenJDK/openjdk-build/issues/1173</a>)</p>
<h2 id="ebpf-caveats-and-limitations">eBPF caveats and limitations</h2>
<ul>
<li>Kernel requirement: <code>^4.4</code></li>
<li>Byte code instruction size &lt; 4096</li>
<li>No control loop</li>
</ul>
<hr>
<h2 id="ebpf--xdpexpress-data-path">eBPF &amp; XDP(eXpress Data Path)</h2>
<p>Two ways toward kernel bypass</p>
<ul>
<li>kernel in userspace
<ul>
<li><a href="https://www.dpdk.org/">DPDK</a></li>
<li><a href="https://github.com/luigirizzo/netmap">Netmap</a></li>
</ul>
</li>
<li>user code in kernel
<ul>
<li>XDP</li>
</ul>
</li>
</ul>
<p>XDP Operating modes</p>
<ul>
<li>Native mode
<ul>
<li>Play with DMA buffer</li>
<li>NO SKB ALLOCATON</li>
<li>Least overhead</li>
<li>Need driver modification</li>
</ul>
</li>
<li>SKB mode
<ul>
<li>From <code>netif_receive_skb()</code></li>
<li>After SKB and DMA allocation</li>
<li>More instructions</li>
<li>Driver-Indepent</li>
</ul>
</li>
</ul>
<hr>
<h2 id="xdpcont">XDP(cont.)</h2>
<ul>
<li>Flannel: L2(IP Overlay)</li>
<li>Calico: L3(BGP)</li>
<li>Cilium: L3/4/7 (eBPF/XDP)
<ul>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/bringing-ebpf-and-cilium-to-google-kubernetes-engine">GKE2 data plane</a></li>
</ul>
</li>
</ul>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/SaD3%26t15mG/ab6b1bf1-eacf-49d5-9193-e1adf70c19a7.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=iqOuc&amp;originHeight=1694&amp;originWidth=3248&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<p>Â  Â  Â Container Network
Â  Â </p>
<hr>
<h2 id="cilium-ebpf--xdp-based-cni-plugin">Cilium: eBPF &amp; XDP based CNI plugin</h2>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/iSIr4xVnkO/73cddcf9-6e5b-4a3f-8fa9-3d8e65b8f056.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=abFHP&amp;originHeight=912&amp;originWidth=1600&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
<li>å‹‡äºå°è¯•æ–° kernel/runtime å’Œå®ƒä»¬çš„æ–° feature .</li>
<li>å·¥å…·å¯ä»¥å¿«é€ŸéªŒè¯æ€è·¯, è¿‡åº¦ä¾èµ–å·¥å…·å¯èƒ½å¯¼è‡´ä¸€å¶éšœç›®ä¸è§æ³°å±±, <strong>æ ¸å¿ƒè¿˜æ˜¯å»ºç«‹å¯¹ç³»ç»Ÿçš„ç†è§£</strong>.</li>
</ul>
<p><img src="https://gw.alipayobjects.com/zos/antfincdn/zHvsBUAZw3/f52a93d6-2263-4a2d-bd63-059266789f24.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=ZEv9O&amp;originHeight=310&amp;originWidth=325&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""><img src="https://gw.alipayobjects.com/zos/antfincdn/HFPHA448hX/85db3710-1a5e-426e-96db-91c514a19cfc.png#crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;id=UjanH&amp;originHeight=324&amp;originWidth=300&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<hr>
<h2 id="reference-1">Reference</h2>
<ul>
<li>
<ol>
<li><a href="https://web.archive.org/web/20161006014657/http://blogs.microsoft.co.il/sasha/2016/03/31/probing-the-jvm-with-bpfbcc/">Probing the JVM with BPF/BCC</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://www.evanjones.ca/java-native-leak-bug.html">Debugging Java Native Memory Leaks</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/srecon18americas_slides_goldshtein.pdf">Goldshtein - Profiling JVM Applications in Production</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="https://lwn.net/Articles/708087/">Debating the value of XDP</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="https://yuque.antfin.com/docs/share/ed2a2941-b51a-497f-b9a1-f393002d0473?#MevjG">OSDI 2020 Summary</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="https://www.usenix.org/conference/osdi20/presentation/brunella">hXDP: Efficient Software Packet Processing on FPGA NICs</a></li>
</ol>
</li>
<li>
<ol start="7">
<li><a href="http://vger.kernel.org/lpc_net2018_talks/presentation-lpc2018-xdp-future.pdf">XDP - challenges and future work</a></li>
</ol>
</li>
<li>
<ol start="8">
<li><a href="https://www.linuxplumbersconf.org/event/2/contributions/71/attachments/17/9/presentation-lpc2018-xdp-tutorial.pdf">A practical introduction to XDP</a></li>
</ol>
</li>
<li>
<ol start="9">
<li><a href="https://docs.cilium.io/en/v1.9/bpf/">BPF and XDP Reference Guide â€” Cilium 1.9.0 documentation</a></li>
</ol>
</li>
<li>
<ol start="10">
<li><a href="https://www.evanjones.ca/java-native-leak-bug.html">native memory leak</a></li>
</ol>
</li>
<li>
<ol start="11">
<li><a href="https://github.com/netty/netty/pull/3844">epoll native memory leak</a></li>
</ol>
</li>
<li>
<ol start="12">
<li><a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8164293">JDK-8164293:HotSpot leaking memory</a></li>
</ol>
</li>
<li>
<ol start="13">
<li><a href="https://www.iteye.com/blog/rednaxelafx-1847971">å€ŸHSDBæ¥æ¢ç´¢HotSpot VMçš„è¿è¡Œæ—¶æ•°æ®</a></li>
</ol>
</li>
<li>
<ol start="14">
<li><a href="https://bugs.openjdk.java.net/browse/JDK-8158050">JDK-8158050</a></li>
</ol>
</li>
<li>
<ol start="15">
<li><a href="https://yuque.antfin-inc.com/aone355606/gfqllg/xgllfm">JVMå›¢é˜Ÿ-JFRä½¿ç”¨å¸®åŠ©</a></li>
</ol>
</li>
<li>
<ol start="16">
<li><a href="https://yuque.antfin.com/office/lark/0/2020/pdf/122844/1606645147060-bef1c539-8c2a-4b7e-af40-4a8a5b8cc316.pdf?from=https%3A%2F%2Fyuque.antfin.com%2Fgnu.hl%2Fgnu%2Fxpdq41">JDK Mission Control Tutorial</a></li>
</ol>
</li>
<li>
<ol start="17">
<li><a href="http://hirt.se/blog/">Continuous Production Profiling and Diagnostics</a></li>
</ol>
</li>
<li>
<ol start="18">
<li><a href="https://www.javacodegeeks.com/2015/03/oracle-java-mission-control-the-ultimate-guide.html">Oracle Java Mission Control: The Ultimate Guide</a></li>
</ol>
</li>
<li>
<ol start="19">
<li><a href="http://www.brendangregg.com/perf.html#OneLiners">perf one-liners</a></li>
</ol>
</li>
<li>
<ol start="20">
<li><a href="http://www.brendangregg.com/blog/2015-02-26/linux-perf-off-cpu-flame-graph.html">Off-CPU Analysis</a></li>
</ol>
</li>
<li>
<ol start="21">
<li><a href="http://www.brendangregg.com/perf.html#JIT_Symbols">Bredan Gregg&rsquo;s perf examples</a></li>
</ol>
</li>
<li>
<ol start="22">
<li><a href="https://www.kernel.org/doc/Documentation/kprobes.txt">k{,ret}probes</a></li>
</ol>
</li>
<li>
<ol start="23">
<li><a href="https://lwn.net/Articles/499190/">u{,ret}probes</a></li>
</ol>
</li>
<li>
<ol start="24">
<li><a href="https://static.lwn.net/kerneldoc/trace/tracepoints.html">Kernel tracepoints</a></li>
</ol>
</li>
<li>
<ol start="25">
<li><a href="https://lwn.net/Articles/753601/">USDT</a></li>
</ol>
</li>
<li>
<ol start="26">
<li><a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#bpftrace-reference-guide">bpftrace Reference Guide</a></li>
</ol>
</li>
<li>
<ol start="27">
<li><a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">Use eBPF to debug Hotspot JVM</a></li>
</ol>
</li>
<li>
<ol start="28">
<li><a href="https://github.com/AdoptOpenJDK/openjdk-build/issues/1173">Enable USDT probes for eBPF tracing on Linux #1173</a></li>
</ol>
</li>
<li>
<ol start="29">
<li><a href="https://web.archive.org/web/20161006014657/http://blogs.microsoft.co.il/sasha/2016/03/31/probing-the-jvm-with-bpfbcc/">Probing the JVM with BPF/BCC</a></li>
</ol>
</li>
<li>
<ol start="30">
<li><a href="https://www.evanjones.ca/java-native-leak-bug.html">Debugging Java Native Memory Leaks</a></li>
</ol>
</li>
<li>
<ol start="31">
<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/srecon18americas_slides_goldshtein.pdf">Goldshtein - Profiling JVM Applications in Production</a></li>
</ol>
</li>
<li>
<ol start="32">
<li><a href="https://lwn.net/Articles/708087/">Debating the value of XDP</a></li>
</ol>
</li>
<li>
<ol start="33">
<li><a href="https://yuque.antfin.com/docs/share/ed2a2941-b51a-497f-b9a1-f393002d0473?#MevjG">OSDI 2020 Summary</a></li>
</ol>
</li>
<li>
<ol start="34">
<li><a href="https://www.usenix.org/conference/osdi20/presentation/brunella">hXDP: Efficient Software Packet Processing on FPGA NICs</a></li>
</ol>
</li>
<li>
<ol start="35">
<li><a href="http://vger.kernel.org/lpc_net2018_talks/presentation-lpc2018-xdp-future.pdf">XDP - challenges and future work</a></li>
</ol>
</li>
<li>
<ol start="36">
<li><a href="https://www.linuxplumbersconf.org/event/2/contributions/71/attachments/17/9/presentation-lpc2018-xdp-tutorial.pdf">A practical introduction to XDP</a></li>
</ol>
</li>
<li>
<ol start="37">
<li><a href="https://docs.cilium.io/en/v1.9/bpf/">BPF and XDP Reference Guide â€” Cilium 1.9.0 documentation</a></li>
</ol>
</li>
</ul>
<hr>
<h1 id="tribute-to">Tribute To</h1>
<ul>
<li><a href="http://brendangregg.com/">Brendan Gregg</a></li>
<li><a href="https://github.com/goldshtn">Sasha Goldshtein</a></li>
<li><a href="https://jvns.ca/">Julia Evans</a></li>
<li><a href="https://www.iteye.com/blog/user/rednaxelafx">Rednaxelafx</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Add MathJax and Graphviz support for HUGO</title>
			<link>https://huanglei.rocks/posts/add-math-and-dot-for-hugo/</link>
			<pubDate>Sun, 12 Apr 2020 14:22:22 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/add-math-and-dot-for-hugo/</guid>
			<description>Get into your theme folder
Find some directory named layouts/posts/single.html
Inside the {{ define main }} block, paste following snippets
1{{ if .Params.viz }} 2 &amp;lt;script type=&amp;#34;text/javascript&amp;#34; src=&amp;#34;https://cdn.bootcss.com/viz.js/1.8.2/viz.js&amp;#34;&amp;gt; &amp;lt;/script&amp;gt; 3 &amp;lt;script type=&amp;#34;text/javascript&amp;#34;&amp;gt; 4 (function(){ 5 var vizPrefix = &amp;#34;language-viz-&amp;#34;; 6 Array.prototype.forEach.call(document.querySelectorAll(&amp;#34;[class^=&amp;#34; + vizPrefix + &amp;#34;]&amp;#34;), function(x){ 7 var engine; 8 x.getAttribute(&amp;#34;class&amp;#34;).split(&amp;#34; &amp;#34;).forEach(function(cls){ 9 if (cls.startsWith(vizPrefix)) { 10 engine = cls.substr(vizPrefix.length); 11 } 12 }); 13 var image = new DOMParser().</description>
			<content type="html"><![CDATA[<ol>
<li>
<p>Get into your theme folder</p>
</li>
<li>
<p>Find some directory named <code>layouts/posts/single.html</code></p>
</li>
<li>
<p>Inside the <code>{{ define main }}</code> block, paste following snippets</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="p">{{</span> <span class="k">if</span> <span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">viz</span> <span class="p">}}</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://cdn.bootcss.com/viz.js/1.8.2/viz.js&#34;</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl">  <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl">    <span class="kd">var</span> <span class="nx">vizPrefix</span> <span class="o">=</span> <span class="s2">&#34;language-viz-&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl">    <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">&#34;[class^=&#34;</span> <span class="o">+</span> <span class="nx">vizPrefix</span> <span class="o">+</span> <span class="s2">&#34;]&#34;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl">      <span class="kd">var</span> <span class="nx">engine</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&#34;class&#34;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cls</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">cls</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">vizPrefix</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl">          <span class="nx">engine</span> <span class="o">=</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">vizPrefix</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl">      <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMParser</span><span class="p">().</span><span class="nx">parseFromString</span><span class="p">(</span><span class="nx">Viz</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">innerText</span><span class="p">,</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span><span class="s2">&#34;svg&#34;</span><span class="p">,</span> <span class="nx">engine</span><span class="o">:</span><span class="nx">engine</span><span class="p">}),</span> <span class="s2">&#34;image/svg+xml&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl">      <span class="nx">x</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&#34;white&#34;</span>
</span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl">  <span class="p">})();</span>
</span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl">  <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl"><span class="p">{{</span> <span class="nx">end</span> <span class="p">}}</span>
</span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl"><span class="p">{{</span> <span class="k">if</span>  <span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">math</span>   <span class="p">}}</span>
</span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">MathJax</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-25"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-25">25</a></span><span class="cl">      <span class="nx">tex2jax</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-26"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-26">26</a></span><span class="cl">        <span class="nx">inlineMath</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;\\(&#39;</span><span class="p">,</span><span class="s1">&#39;\\)&#39;</span><span class="p">]],</span>
</span></span><span class="line"><span class="ln" id="code-sec-27"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-27">27</a></span><span class="cl">        <span class="nx">displayMath</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;$$&#39;</span><span class="p">,</span><span class="s1">&#39;$$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;\[&#39;</span><span class="p">,</span><span class="s1">&#39;\]&#39;</span><span class="p">]],</span>
</span></span><span class="line"><span class="ln" id="code-sec-28"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-28">28</a></span><span class="cl">        <span class="nx">processEscapes</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-29"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-29">29</a></span><span class="cl">        <span class="nx">processEnvironments</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="code-sec-30"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-30">30</a></span><span class="cl">        <span class="nx">skipTags</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;noscript&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="ln" id="code-sec-31"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-31">31</a></span><span class="cl">        <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span> <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span> <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&#34;AMS&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="ln" id="code-sec-32"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-32">32</a></span><span class="cl">          <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;AMSmath.js&#34;</span><span class="p">,</span> <span class="s2">&#34;AMSsymbols.js&#34;</span><span class="p">,</span> <span class="s2">&#34;color.js&#34;</span><span class="p">]</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-33"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-33">33</a></span><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="ln" id="code-sec-34"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-34">34</a></span><span class="cl">      <span class="nx">AuthorInit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-35"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-35">35</a></span><span class="cl">        <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Register</span><span class="p">.</span><span class="nx">StartupHook</span><span class="p">(</span><span class="s2">&#34;Begin&#34;</span><span class="p">,</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-36"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-36">36</a></span><span class="cl">          <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Queue</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-37"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-37">37</a></span><span class="cl">            <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">getAllJax</span><span class="p">(),</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-38"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-38">38</a></span><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">all</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-39"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-39">39</a></span><span class="cl">              <span class="nx">all</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">SourceElement</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s1">&#39; has-jax&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-40"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-40">40</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-41"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-41">41</a></span><span class="cl">          <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-42"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-42">42</a></span><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-43"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-43">43</a></span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-44"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-44">44</a></span><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="ln" id="code-sec-45"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-45">45</a></span><span class="cl">  <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-46"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-46">46</a></span><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span>  <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span>
</span></span><span class="line"><span class="ln" id="code-sec-47"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-47">47</a></span><span class="cl">    <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://cdn.bootcss.com/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-48"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-48">48</a></span><span class="cl">  <span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="ln" id="code-sec-49"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-49">49</a></span><span class="cl"><span class="p">{{</span> <span class="nx">end</span> <span class="p">}}</span>
</span></span></code></pre></div><ol start="4">
<li>Create some posts and add following config inside front-matter</li>
</ol>
<pre tabindex="0"><code>viz: true
math: true
</code></pre><p>And try some graphviz and mathjax stuff!</p>
<p><img src="/images/mathjax-dot-demo.png" alt="mathjax-dot-demo"></p>
<blockquote>
<p>You may check the demo <a href="/posts/math-and-dot-demo">here</a></p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>Graphviz and mathjax demo</title>
			<link>https://huanglei.rocks/posts/math-and-dot-demo/</link>
			<pubDate>Sat, 11 Apr 2020 23:26:41 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/math-and-dot-demo/</guid>
			<description>digraph g{ rankdir=LR; node [shape=record,width=01,height=.1]; a[label=&amp;#34;&amp;lt;1&amp;gt;Hash Table|&amp;lt;2&amp;gt;Node|&amp;lt;3&amp;gt;Node|...|&amp;lt;4&amp;gt;TreeNode&amp;#34;]; { // graph[rankdir=LR] node1[label=&amp;#34;{&amp;lt;1&amp;gt;A1|&amp;lt;2&amp;gt;A2|...|An}&amp;#34;] node2[label=&amp;#34;{&amp;lt;1&amp;gt;B1|&amp;lt;2&amp;gt;B2|...|Bn}&amp;#34;] // node3[label=&amp;#34;{&amp;lt;1&amp;gt;C1|&amp;lt;2&amp;gt;C2}&amp;#34;] subgraph cluster_treenode{ penwidth=0; node[shape=circle]; root[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2]; n1[label=&amp;#34;&amp;#34;, style=filled,fillcolor=red,width=.2] n2[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] n3[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] n4[label=&amp;#34;&amp;#34;, style=filled,fillcolor=red,width=.2] n5[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] n6[label=&amp;#34;&amp;#34;, style=filled,fillcolor=black,width=.2] root-&amp;gt;n1; n1-&amp;gt;n2; n1-&amp;gt;n3; root-&amp;gt;n4; n4-&amp;gt;n5; n4-&amp;gt;n6; } } a:2:e-&amp;gt;node1:1 [style=dashed]; a:3:e-&amp;gt;node2:1; a:4:e-&amp;gt;root; // node3:d-&amp;gt;node3:sa2; } $$f(a) = \frac{1}{2\pi i} \oint\frac{f(z)}{z-a}dz$$</description>
			<content type="html"><![CDATA[<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph g{
    rankdir=LR;
    node [shape=record,width=01,height=.1];
	a[label=&#34;&lt;1&gt;Hash Table|&lt;2&gt;Node|&lt;3&gt;Node|...|&lt;4&gt;TreeNode&#34;];
    {
        // graph[rankdir=LR]    
        node1[label=&#34;{&lt;1&gt;A1|&lt;2&gt;A2|...|An}&#34;]
        node2[label=&#34;{&lt;1&gt;B1|&lt;2&gt;B2|...|Bn}&#34;]
        // node3[label=&#34;{&lt;1&gt;C1|&lt;2&gt;C2}&#34;]
        subgraph cluster_treenode{
            penwidth=0;
            node[shape=circle];
            root[label=&#34;&#34;, style=filled,fillcolor=black,width=.2];
            n1[label=&#34;&#34;, style=filled,fillcolor=red,width=.2]
            n2[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            n3[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            n4[label=&#34;&#34;, style=filled,fillcolor=red,width=.2]
            n5[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            n6[label=&#34;&#34;, style=filled,fillcolor=black,width=.2]
            root-&gt;n1;
            n1-&gt;n2;
            n1-&gt;n3;
            root-&gt;n4;
            n4-&gt;n5;
            n4-&gt;n6;
        }
    }
    
    a:2:e-&gt;node1:1 [style=dashed];
    a:3:e-&gt;node2:1;    
    a:4:e-&gt;root;    

    // node3:d-&gt;node3:sa2;
}
</code></pre><p>$$f(a) = \frac{1}{2\pi i} \oint\frac{f(z)}{z-a}dz$$</p>
]]></content>
		</item>
		
		<item>
			<title>ä¸ºä»€ä¹ˆæˆ‘çš„ Netty åº”ç”¨æ²¡æœ‰å“åº”ï¼Ÿ</title>
			<link>https://huanglei.rocks/posts/why-netty-not-responding/</link>
			<pubDate>Tue, 19 Mar 2019 22:41:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/why-netty-not-responding/</guid>
			<description>æœ€ç»ˆé—®é¢˜çš„æ ¹æœ¬åŸå› è¿˜æ˜¯æ²¡æœ‰æ·±å…¥ç†è§£ Netty çš„çº¿ç¨‹æ¨¡å‹ã€‚ æƒ³æ³•å°±æ˜¯ç­‰æœåŠ¡å™¨ç«¯å¯åŠ¨ï¼Œ bindæˆåŠŸåå†å¯åŠ¨clientã€‚è¦æƒ³ç›‘å¬serverç«¯bindæˆåŠŸ</description>
			<content type="html"><![CDATA[<blockquote>
<p>æœ€ç»ˆé—®é¢˜çš„æ ¹æœ¬åŸå› è¿˜æ˜¯æ²¡æœ‰æ·±å…¥ç†è§£ Netty çš„çº¿ç¨‹æ¨¡å‹ã€‚</p>
</blockquote>
<p>æƒ³æ³•å°±æ˜¯ç­‰æœåŠ¡å™¨ç«¯å¯åŠ¨ï¼Œ bindæˆåŠŸåå†å¯åŠ¨clientã€‚è¦æƒ³ç›‘å¬serverç«¯bindæˆåŠŸçš„çŠ¶æ€å˜åŒ–ï¼Œå½“ç„¶ç¬¬ä¸€ååº”å°±æ˜¯åœ¨<code>server.bind().sync()</code>è¿”å›çš„<code>ChannelFuture</code>ä¸­æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ŒbindæˆåŠŸä¹‹ååœ¨è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­å¯åŠ¨clientå°±è¡Œäº†ã€‚é‚£ä¹ˆ APPå…¥å£ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runClientAndServer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">run</span><span class="o">().</span><span class="na">addListener</span><span class="o">((</span><span class="n">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">             <span class="n">client</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>                        <span class="c1">//this doesn&#39;t work!
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="c1">//            new Thread(()-&gt;client.run()).start();   //this works!
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="c1"></span>        <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æœåŠ¡ç«¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl">   <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl">       <span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl">       <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl">               <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl">               <span class="c1">//é…ç½®channel...
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl"><span class="c1"></span>               <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl">                   <span class="nd">@Override</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl">                   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl">                       <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl">                       <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">workerGroup</span><span class="o">,</span> <span class="k">new</span> <span class="n">EchoServerHandler</span><span class="o">());</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl">                   <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl">               <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl">       <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span><span class="c1">//ç­‰å¾…bindæˆåŠŸï¼Œè¿”å›
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl"><span class="c1"></span>   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="o">|</span> <span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl">       <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl">       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å®¢æˆ·ç«¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl">        <span class="n">Bootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl">        <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl">                <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl">                <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl">                    <span class="nd">@Override</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl">                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl">                        <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl">                        <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">channelHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl">                <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl">        <span class="c1">// Start the client.
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-14">14</a></span><span class="cl"><span class="c1"></span>        <span class="n">ChannelFuture</span> <span class="n">f</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-15"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-15">15</a></span><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-16"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-16">16</a></span><span class="cl">            <span class="n">f</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-17"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-17">17</a></span><span class="cl">            <span class="n">channelHandler</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-18"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-18">18</a></span><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-19"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-19">19</a></span><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-20"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-20">20</a></span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-21"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-21">21</a></span><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-22"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-22">22</a></span><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span> <span class="c1">//ç­‰å¾…å®¢æˆ·ç«¯channelå…³é—­
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-23">23</a></span><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-24"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-24">24</a></span><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-25"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-25">25</a></span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-26"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-26">26</a></span><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-27"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-27">27</a></span><span class="cl">        <span class="c1">// Shut down the event loop to terminate all threads.
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-28">28</a></span><span class="cl"><span class="c1"></span>        <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-29"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-29">29</a></span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-30"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-30">30</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>çœ‹ä¸Šå»å¥½åƒæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä¸€åˆ‡éƒ½å¾ˆé¡ºç†æˆç« ã€‚ä½†æ˜¯ç‚¹å‡»è¿è¡Œï¼Œserverç«¯å°±æ˜¯æ”¶ä¸åˆ°clientå‘é€çš„æ•°æ®ã€‚</p>
<h2 id="debugæ€è·¯">debugæ€è·¯</h2>
<p>é¦–å…ˆå°±æ˜¯è¦ç¡®å®šTCPå±‚é¢çš„è¡Œä¸ºï¼Œå³å®¢æˆ·ç«¯åˆ°åº•æœ‰æ²¡æœ‰å‘é€TCPæŠ¥æ–‡ï¼ŒæœåŠ¡å™¨ç«¯æœ‰æ²¡æœ‰æ¥æ”¶åˆ°ã€‚ä½¿ç”¨Wiresharkè¿›è¡ŒæŠ“åŒ…ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/netty-wireshark1.png" alt="Wireshark"></p>
<p>å¯ä»¥æ˜æ˜¾åœ°çœ‹åˆ°ï¼Œclientèƒ½å¤ŸæˆåŠŸåœ°æŠŠæ•°æ®é€šè¿‡TCPäº¤ä»˜ç»™serverï¼Œserverå›å¤çš„<code>ACK</code>æŠ¥æ–‡æ®µä»£è¡¨ç€æ•°æ®å·²ç»åˆ°è¾¾serverç«¯TCP/IPåè®®æ ˆã€‚é‚£ä¹ˆå¯ä»¥è‚¯å®šçš„æ˜¯serverç«¯æ²¡æœ‰èƒ½å¤Ÿå¤„ç†è¿™ä¸ªæŠ¥æ–‡ã€‚ ç»™<code>DefaultChannelPipeline.fireChannelRead()</code>æ–¹æ³•æ‰“ä¸Šæ–­ç‚¹ï¼Œå‘ç°æ²¡æœ‰è¿›å…¥ã€‚å…¶å®åˆ°è¿™åŸºæœ¬å¯ä»¥åˆ¤æ–­æ˜¯serverç«¯è´Ÿè´£ChannelPipelineçš„çº¿ç¨‹å‡ºäº†é—®é¢˜ã€‚ ä¸ŠVisualVMã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/RayneHwang/img-repo/netty-visual-vm.png" alt="VisualVM"></p>
<p>ä¸€çœ¼å°±çœ‹åˆ°æœåŠ¡å™¨çš„NioEventloopGroupå¤„äºwaitingçŠ¶æ€ã€‚ ThreadDumpä¸€ä¸‹ï¼š</p>
<pre tabindex="0"><code>&#34;nioEventLoopGroup-2-1&#34; #16 prio=10 os_prio=0 tid=0x00007f7350b7b000 nid=0x1533 in Object.wait() [0x00007f73022b6000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        - waiting on &lt;0x000000076d6c9d80&gt; (a io.netty.channel.AbstractChannel$CloseFuture)
        at java.lang.Object.wait(Object.java:502)
        at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:236)
        - locked &lt;0x000000076d6c9d80&gt; (a io.netty.channel.AbstractChannel$CloseFuture)
        at io.netty.channel.DefaultChannelPromise.await(DefaultChannelPromise.java:129)
        ...
        at pku.netlab.client.EchoClient.run(EchoClient.java:86)
        at pku.netlab.App.lambda$runClientAndServer$0(App.java:31)
        at pku.netlab.App$$Lambda$1/1521389237.operationComplete(Unknown Source)
        at....
   Locked ownable synchronizers:
        - None
</code></pre><p>å¾ˆæ˜æ˜¾äº†ï¼Œserverç«¯è´Ÿè´£IOçš„çº¿ç¨‹ï¼Œé˜»å¡åœ¨äº†<code>client.run()</code>æ–¹æ³•çš„<code>closeFuture</code>ä¸Šï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ æ ¹æœ¬åŸå› åœ¨äºç¨‹åºå…¥å£è¿è¡Œserverå’Œclientçš„è¿™æ®µä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runClientAndServer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="na">run</span><span class="o">().</span><span class="na">addListener</span><span class="o">((</span><span class="n">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">         <span class="n">client</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>       
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><code>client.run()</code>ä¼šé˜»å¡ç­‰å¾…ç›´åˆ°clientçš„channelå…³é—­ï¼ˆcloseFutureçš„å­˜åœ¨ï¼‰ï¼Œè€Œ<code>server.run()</code>è¿”å›çš„ChannelFutureçš„èƒŒåçš„çº¿ç¨‹æ­£æ˜¯serverçš„IOçº¿ç¨‹ï¼Œä½†æ˜¯æˆ‘ä»¬å´ååä½œæ­»åœ¨è¿™ä¸ªçº¿ç¨‹æ·»åŠ äº†ä¸€ä¸ªé˜»å¡çš„å›è°ƒå‡½æ•°ï¼Œç›´æ¥å¯¼è‡´serverçš„æ‰€æœ‰IOäº‹ä»¶éƒ½å¾—ä¸åˆ°å¤„ç†ã€‚</p>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<p>åœ¨serverçš„å›è°ƒä¸­æ–°å¼€çº¿ç¨‹å¯åŠ¨å®¢æˆ·ç«¯å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runClientAndServer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="na">run</span><span class="o">().</span><span class="na">addListener</span><span class="o">((</span><span class="n">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">         <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;</span><span class="n">client</span><span class="o">.</span><span class="na">run</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
<li>æ°¸è¿œä¸è¦é˜»å¡Nettyåº”ç”¨çš„IOçº¿ç¨‹ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨å¤±å»å“åº”</li>
<li><code>Channel.closeFuture().sync()</code>ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹é˜»å¡åœ¨ç­‰å¾…channelå…³é—­çš„åœ°æ–¹</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>åŒæ­¥/å¼‚æ­¥å’Œé˜»å¡/éé˜»å¡</title>
			<link>https://huanglei.rocks/posts/synchronicity-and-blocking/</link>
			<pubDate>Tue, 19 Mar 2019 22:41:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/synchronicity-and-blocking/</guid>
			<description>åŒæ­¥/å¼‚æ­¥ä»¥åŠé˜»å¡/éé˜»å¡è¿™å‡ ä¸ªæ¦‚å¿µç½‘ç»œä¸Šçš„è§£é‡Šå¾ˆå¤šï¼Œä¸å°‘è§£é‡Šè¯•å›¾é€šè¿‡ä¸¾æ‹¿å¿«é€’/å»ä¹¦åº—ä¹°ä¹¦ç­‰ä¾‹å­æ¥è§£é‡Šè¿™äº›æ¦‚å¿µã€‚ä¹ä¸€çœ‹éå¸¸é€šä¿—æ˜“æ‡‚ï¼Œä½†æ˜¯ä»»ä½•</description>
			<content type="html"><![CDATA[<p>åŒæ­¥/å¼‚æ­¥ä»¥åŠé˜»å¡/éé˜»å¡è¿™å‡ ä¸ªæ¦‚å¿µç½‘ç»œä¸Šçš„è§£é‡Šå¾ˆå¤šï¼Œä¸å°‘è§£é‡Šè¯•å›¾é€šè¿‡ä¸¾æ‹¿å¿«é€’/å»ä¹¦åº—ä¹°ä¹¦ç­‰ä¾‹å­æ¥è§£é‡Šè¿™äº›æ¦‚å¿µã€‚ä¹ä¸€çœ‹éå¸¸é€šä¿—æ˜“æ‡‚ï¼Œä½†æ˜¯ä»»ä½•ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒçš„ä¿¡æ¯é‡æ˜¯ä¸€å®šçš„ï¼Œå¦‚æœä¸¾ä¾‹å­èƒ½å¤Ÿè®©äººæ›´åŠ å®¹æ˜“æ˜ç™½ï¼Œé‚£ä¹ˆä¸€å®šæŸå¤±äº†ç›¸å½“ç¨‹åº¦çš„ä¿¡æ¯é‡ã€‚</p>
<blockquote>
<p>â€œè–›å®šè°”çš„çŒ«â€å¯ä»¥å¸®åŠ©äººä»¬æ›´å¥½åœ°ç†è§£ä¸ç¡®å®šæ€§åŸç†ï¼Œä½†æ˜¯ä¸ç¡®å®šæ€§åŸç†è¿œä¸åªæ˜¯ä¸€ä¸ªæ€æƒ³å®éªŒçš„å†…æ¶µã€‚</p>
</blockquote>
<h2 id="æ¨¡å‹">æ¨¡å‹</h2>
<p>æ‰€æœ‰çš„ IO éƒ½å¯ä»¥æŠ½è±¡æˆè¯·æ±‚æ–¹ï¼ˆclientï¼‰å’Œèµ„æºæä¾›æ–¹ï¼ˆserverï¼‰ä¸¤æ–¹çš„äº¤äº’ã€‚ä»clientæ¥çœ‹:</p>
<ul>
<li>å¦‚æœè¯·æ±‚å‘èµ·ä¹‹åï¼Œclientæ€»æ˜¯ç­‰åˆ°æ”¶åˆ°å“åº”å†ç»§ç»­æ‰§è¡Œæ¥ä¸‹æ¥çš„ä»»åŠ¡ï¼Œåˆ™ç§°ä¸ºé˜»å¡(blocking)</li>
<li>å¦‚æœclientå‘å‡ºè¯·æ±‚ä¹‹åï¼Œä¸ç­‰åˆ°å“åº”å°±ç›´æ¥ç»§ç»­å…¶ä»–ä»»åŠ¡ï¼Œåˆ™æˆä¸ºéé˜»å¡(non-blocking)</li>
<li>å¦‚æœclientéœ€è¦è‡ªå·±å»ä»serverå¤„ä»¥æŸç§æ–¹å¼ä¸»åŠ¨è·å–ç»“æœï¼Œåˆ™ç§°ä¸ºåŒæ­¥(synchronous)</li>
<li>å¦‚æœclientå‘èµ·è¯·æ±‚æ—¶æŒ‡å®šäº†æŸç§é€šçŸ¥æœºåˆ¶ï¼Œserverå›å¤å“åº”æ—¶ç›´æ¥å°†ç»“æœé€šè¿‡è¿™ä¸ªé€šçŸ¥æœºåˆ¶é€šçŸ¥clientå¤„ç†ï¼Œåˆ™ç§°ä¸ºå¼‚æ­¥(asynchronous)</li>
</ul>
<blockquote>
<p>é˜»å¡å’Œéé˜»å¡å…³å¿ƒçš„æ˜¯è¯·æ±‚å‘èµ·è€…åœ¨å‘èµ·è¯·æ±‚åçš„è¡Œä¸ºï¼Œè€ŒåŒæ­¥å¼‚æ­¥å…³å¿ƒçš„æ˜¯å¯¹å“åº”çš„æ§åˆ¶æƒå’Œä¸»åŠ¨æƒã€‚å¼‚æ­¥ç›¸æ¯”åŒæ­¥æ–¹å¼è€Œè¨€æ˜¯å¯¹æ§åˆ¶æƒçš„åè½¬ï¼Œè¯·æ±‚æ–¹è¢«åŠ¨åœ°è·å–ç»“æœã€‚</p>
</blockquote>
<p>å°†åŒæ­¥/å¼‚æ­¥å’Œé˜»å¡/éé˜»å¡ä¸¤ä¸¤ç»„åˆå¯ä»¥å¾—åˆ°å››ç§IOæ¨¡å‹:</p>
<ul>
<li>åŒæ­¥é˜»å¡: æœ€ç»å…¸çš„ç¼–ç¨‹æ¨¡å‹</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="n">response</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="mi">8080</span><span class="p">))</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>ä¸Šé¢çš„ä»£ç ä¸€æ—¦è¿æ¥åˆ°serveråï¼Œpythonè§£é‡Šå™¨ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æ¥æ”¶åˆ°ç»“æœï¼Œç„¶åå†æŠŠç»“æœæ‰“å°å‡ºæ¥ã€‚è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ç³»ç»Ÿä¼šåœ¨é˜»å¡çš„åœ°æ–¹è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç­‰åˆ°æ•°æ®å°±ç»ªå†…æ ¸å°†å”¤é†’pythonçº¿ç¨‹ï¼Œç”±pythonå°†kernel bufferå½“ä¸­çš„æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„bufferã€‚åœ¨äº’è”ç½‘çš„æ—©æœŸï¼ŒCGIï¼ˆCommon Gateway Interfaceï¼‰å¾€å¾€å°±æ˜¯é‡‡ç”¨è¿™ç§IOæ¨¡å‹ï¼Œå½“ç„¶ç¨‹åºå‘˜ä¸ä¼šè ¢åˆ°è®©è¯·æ±‚æŒ‰å…ˆæ¥ååˆ°çš„é¡ºåºæ’é˜Ÿä¸€ä¸ªä¸€ä¸ªå¤„ç†ï¼Œè€Œæ˜¯é€šè¿‡å¤šè¿›ç¨‹çš„æ–¹å¼è§£å†³IOé˜»å¡çš„é—®é¢˜ã€‚ä½†æ˜¯è¿›ç¨‹åˆ‡æ¢ä¼šå¯¼è‡´CPUçš„ç¼“å­˜ä»¥åŠé¡µè¡¨çš„TLB(Translation Lookaside Table)å¤±æ•ˆï¼Œå¯¼è‡´ä¸€æ®µæ—¶é—´å†…çš„è®¿å­˜éå¸¸ä½æ•ˆï¼Œå› æ­¤å¼€é”€å¾ˆå¤§ã€‚é€æ­¥åœ°å¤šçº¿ç¨‹ä»£æ›¿äº†å¤šè¿›ç¨‹ç§°ä¸ºåŒæ­¥ç¼–ç¨‹ã€‚åˆ›å»º/åˆ‡æ¢çº¿ç¨‹çš„ä»£ä»·è™½ç„¶æ¯”è¿›ç¨‹å°ä½†æ˜¯ä¸€æ—¦å¹¶å‘é‡ä¸Šå‡ä»ç„¶æ˜¯å¾ˆå¤§çš„å¼€é”€ï¼Œå› æ­¤å‡ºç°äº†çº¿ç¨‹æ± ï¼Œé€šè¿‡ç¼“å­˜å·²ç»ä½¿ç”¨è¿‡çš„çº¿ç¨‹æ¥é™ä½åˆ›å»ºçº¿ç¨‹çš„å¼€é”€ã€‚</p>
<ul>
<li>åŒæ­¥éé˜»å¡ Client å‘èµ·è¯·æ±‚åç«‹åˆ»è¿”å›ï¼Œå¹¶ä¸”è·å–åˆ°ä¸€ä¸ªå…³äºå·²ç»å‘å‡ºçš„è¿™ä¸ªè¯·æ±‚çš„å¥æŸ„(æ–‡ä»¶æè¿°ç¬¦ç­‰æŠ½è±¡å½¢å¼)ï¼Œç„¶åç»§ç»­å¤„ç†å…¶ä»–äº‹åŠ¡ï¼Œå¹¶ä¸”é€šè¿‡æŸ¥è¯¢è¿™ä¸ªå¥æŸ„çš„çŠ¶æ€ï¼ˆ<code>select</code>ï¼‰å†³å®šæ˜¯å¦å¯¹äº‹ä»¶(å¯è¯»/å‡ºé”™)åšå‡ºç›¸åº”å¤„ç†ã€‚å¦‚æœ client å‘ç°å¥æŸ„å¯è¯»äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å†å»è°ƒç”¨<code>read()</code>æ–¹æ³•ä¸€å®šä¸ä¼šé˜»å¡ã€‚åŒæ­¥éé˜»å¡é€šå¸¸åˆç§°ä¸º IO å¤ç”¨(IO Multiplexing)ï¼Œå› ä¸ºåœ¨è¿™ç§æ¨¡å‹ä¸‹ï¼Œclient å¯ä»¥åŒäº‹å¯¹å¤šä¸ª IO è¿›è¡Œç›‘è§†ï¼Œç„¶åæŠŠäº‹ä»¶åˆ†å‘ç»™ç›¸åº”IOçš„å¤„ç†ç¨‹åºã€‚</li>
<li>å¼‚æ­¥é˜»å¡ æ•ˆæœç­‰åŒäºåŒæ­¥é˜»å¡ã€‚ å› ä¸º client éƒ½å·²ç»é˜»å¡äº†ï¼ŒåŒæ­¥æˆ–è€…å¼‚æ­¥çš„ä¿¡å·é€šçŸ¥æœºåˆ¶å¹¶æ²¡æœ‰åŒºåˆ«ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸ä½œè®¨è®ºã€‚</li>
<li>å¼‚æ­¥éé˜»å¡ client å‘èµ·çš„è¯·æ±‚ä¸º server æŒ‡æ˜äº†å›è°ƒæœºåˆ¶(ç³»ç»Ÿçº§çš„signalåˆæˆ–è€…æ˜¯åº”ç”¨ç¨‹åºçº§åˆ«çš„HTTPå›è°ƒURL)ï¼Œç„¶åclientå»ç»§ç»­å¤„ç†å…¶ä»–äº‹åŠ¡ã€‚ç­‰å¾…serveræœ‰æ¶ˆæ¯è¿”å›æ—¶ï¼Œserverå®Œæˆæ¶ˆæ¯çš„æ‰“åŒ…ï¼Œå¯¹é½ç­‰æ“ä½œï¼Œé€šè¿‡clientæŒ‡æ˜çš„é€šçŸ¥æœºåˆ¶é€šçŸ¥clientã€‚Windowsæä¾›çš„ç³»ç»Ÿçº§å¼‚æ­¥IOæ˜¯IOCPï¼Œè€ŒLinuxæä¾›çš„æ¥å£ä¸ºAIO(éå¸¸éš¾ç”¨)ã€‚</li>
</ul>
<blockquote>
<p>é™¤äº†è¿™å››ç§æ¨¡å‹ï¼ŒLinuxè¿˜å®ç°äº†<a href="http://davmac.org/davpage/linux/async-io.html#sigio">è¾¹ç¼˜è§¦å‘çš„ä¿¡å·é©±åŠ¨å¼çš„IOæ¨¡å‹â€”â€”SIGIO</a>ï¼Œä½†æ˜¯è¿™ç§æ¨¡å‹ä¸èƒ½ç”¨äºæ–‡ä»¶çš„è¯»å†™ã€‚</p>
</blockquote>
<h2 id="ä¸‰å±‚æŠ½è±¡">ä¸‰å±‚æŠ½è±¡</h2>
<p>ä¸ºä»€ä¹ˆä¸Šæ–‡è¦æŠŠIOæ¨¡å‹æŠ½è±¡åœ¨C/Sæ¨¡å‹çš„åŸºç¡€ä¸Šæè¿°?å› ä¸º<strong>åŒæ ·çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä»ä½“ç³»ç»“æ„çš„ä¸åŒå±‚é¢å»çœ‹ï¼Œå®ƒçš„IOæ¨¡å‹ä¸æ€»æ˜¯ä¸€è‡´çš„</strong>ã€‚ å½“ç”¨æˆ·çš„ç¨‹åºå‘èµ·ä¸€ä¸ªIOè¯·æ±‚(æ¯”å¦‚å†™socket)ï¼Œé¦–å…ˆæ˜¯è¯¥è¯­è¨€çš„è¿è¡Œæ—¶ç¯å¢ƒå‘æ“ä½œç³»ç»Ÿå‘èµ·ç³»ç»Ÿè°ƒç”¨(æ¯”å¦‚Linuxä¸‹æ˜¯<code>send</code>)ï¼Œæ“ä½œç³»ç»Ÿå°†éœ€è¦å‘é€çš„ç¼“å†²åŒºå¤åˆ¶åˆ°ç½‘å¡çš„FIFOï¼Œç½‘å¡ä¼šè‡ªè¡Œé€‰æ‹©åˆé€‚çš„æ—¶é—´æŠŠåŒ…å‘é€å‡ºå»ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ï¼Œéœ€è¦ä»”ç»†åˆ†æç”¨æˆ·ä»£ç å’Œè¯­è¨€runtimeï¼Œruntimeå’Œæ“ä½œç³»ç»Ÿï¼ŒCPUå’Œç½‘å¡è¿™ä¸‰å±‚çš„è°ƒç”¨æƒ…å†µã€‚</p>
<h3 id="ç¡¬ä»¶">ç¡¬ä»¶</h3>
<p>é¦–å…ˆçœ‹æœ€åº•å±‚çš„CPUå’Œç½‘å¡ã€‚ æ˜¾ç„¶é™¤äº†é«˜é€Ÿæ€»çº¿ä¸Šçš„ç­‰å¾…ä¹‹å¤–ï¼ŒCPUä¸å­˜åœ¨åŒæ­¥IOçš„æƒ…å†µï¼Œå¤§æ‰¹é‡çš„æ•°æ®å‘é€å’Œæ¥æ”¶æ€»æ˜¯ç”±DMAå¤„ç†ï¼ŒDMAå®Œæˆåé€šè¿‡ç¡¬ä»¶ä¸­æ–­é€šçŸ¥CPUï¼Œè¿™æ˜¯æœ€å…¸å‹çš„å¼‚æ­¥éé˜»å¡çš„æ¨¡å¼ã€‚</p>
<h3 id="osä¸runtime">OSä¸runtime</h3>
<p>å…¶æ¬¡æ˜¯runtimeå’ŒOSçš„äº¤äº’ã€‚å¤§éƒ¨åˆ†å¯¹IOæ€§èƒ½ä¼˜åŒ–çš„åŠªåŠ›éƒ½é›†ä¸­åœ¨è¿™ä¸ªå±‚é¢ã€‚OSæä¾›çš„IOä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨(syscall)å®ç°çš„ï¼Œå‡ ä¹æ‰€æœ‰ç³»ç»Ÿçš„syscallé»˜è®¤éƒ½æ˜¯åŒæ­¥é˜»å¡ï¼Œä½†æ˜¯å¯ä»¥æ‰‹åŠ¨é…ç½®æˆåŒæ­¥éé˜»å¡çš„ã€‚ ç”±äºåŒæ­¥éé˜»å¡éœ€è¦è½®è¯¢å¥æŸ„çš„çŠ¶æ€ï¼Œå› æ­¤è½®è¯¢çš„ç®—æ³•å†³å®šäº†IOä»¥åŠäº‹ä»¶åˆ†å‘çš„æ•ˆç‡ã€‚ Linuxç³»ç»Ÿä¸‹çš„Pollæ¨¡å‹æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œä¸ºäº†æ”¹å–„Pollçš„æ•ˆç‡å‡ºç°äº†Epollï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œç°ä»£æ“ä½œç³»ç»Ÿä¸€èˆ¬è¿˜æ”¯æŒå†…æ ¸çº§åˆ«çš„å¼‚æ­¥IOï¼Œæ¯”å¦‚Linuxä¸‹çš„AIOä»¥åŠWindowsä¸‹çš„IOCPï¼ˆIOå®Œæˆç«¯å£ï¼‰ã€‚ä»¥AIOä¸ºä¾‹ï¼Œéœ€è¦ä¸ºæ¯ä¸€ä¸ªIOåˆ›å»ºå¼‚æ­¥IOæ§åˆ¶å—ï¼ˆaiocbï¼‰ï¼Œaiocbæ˜¯ä¸€ä¸ªç»“æ„ä½“:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="k">struct</span> <span class="n">aiocb</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">         <span class="kt">int</span> <span class="n">aio_fildes</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">         <span class="kt">int</span> <span class="n">aio_lio_opcode</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">         <span class="k">volatile</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aio_buf</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl">         <span class="n">size_t</span> <span class="n">aio_nbytes</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl">         <span class="k">struct</span> <span class="n">sigevent</span> <span class="n">aio_sigevent</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7">7</a></span><span class="cl">         <span class="p">...</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8">8</a></span><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ª<code>aio_buf</code>å­—æ®µç”¨äºå‘å†…æ ¸æŒ‡æ˜ä¸€æ—¦IOå®Œæˆå°±å°†æ•°æ®å¤åˆ¶åˆ°<code>aio_buf</code>è¿™ä¸ªåœ°å€ã€‚ Linux AIOå’ŒEpollç›¸æ¯”ä»ç„¶ä¸å¤Ÿæˆç†Ÿã€‚ é™¤äº†ç³»ç»Ÿå±‚é¢çš„åŠªåŠ›ï¼Œè¿˜æœ‰å„ç§å®ç°äº†AIOçš„åº“ï¼š<a href="https://www.gnu.org/software/libc/manual/html_node/Asynchronous-I_002fO.html">glibc AIO</a>ã€<a href="http://software.schmorp.de/pkg/libeio.html">libeio</a>ï¼Œä½†æ˜¯å’ŒWindowsçš„IOCPç›¸æ¯”ï¼Œå·®è·ä¾ç„¶å¾ˆå¤§ã€‚</p>
<h3 id="è¯­è¨€çš„ç¼–ç¨‹é£æ ¼">è¯­è¨€çš„ç¼–ç¨‹é£æ ¼</h3>
<p>æœ€åçœ‹ç¼–ç¨‹è¯­è¨€æ‰€æä¾›çš„IOæ¨¡å‹ã€‚ é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„å¼‚æ­¥ç¼–ç¨‹èŒƒå¼, å¾€å¾€æŒ‡çš„æ˜¯è¿™ä¸ªå±‚é¢çš„IOæ¨¡å‹, æ¯”å¦‚Node.jsçš„error-first callback:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">    <span class="nx">process</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>åœ¨ç”¨æˆ·çš„functioné‡Œé¢æ‰€å¤„ç†çš„<code>data</code>æ—¢ä¸æ˜¯socketçš„å­—èŠ‚æµï¼Œåˆä¸æ˜¯HTTPæŠ¥æ–‡ï¼Œè€Œæ˜¯è½¬æ¢ä¸ºJSå¯¹è±¡çš„HTTPæŠ¥æ–‡ä½“ã€‚ è¿™æ˜¯å› ä¸ºNode.jsçš„runtimeä¸ºæˆ‘ä»¬åšå¥½äº†dataçš„å¤„ç†å’Œå¯¹é½, æŠŠå¤„ç†å¥½çš„æ•°æ®ä¸¢ç»™ç”¨æˆ·çš„ç¨‹åº, å› æ­¤å¯¹äºç”¨æˆ·è€Œè¨€è¿™æ ·çš„<strong>ç¼–ç¨‹é£æ ¼</strong>æ˜¯å¼‚æ­¥çš„ã€‚ callbackæ˜¯æœ€ç›´è§‚çš„å¼‚æ­¥ç¼–ç¨‹èŒƒå¼ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æœ€å¥½çš„ã€‚ä¸€æ—¦å¤šä¸ªIOè¯·æ±‚å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå°±å®¹æ˜“å‡ºç°ï¼ˆä¹Ÿæ˜¯Node.jsåˆšå‡ºæ¥æ—¶æœ€è®©äººè¯Ÿç—…çš„ä¸€ç‚¹ï¼‰callback hell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;url1&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data1</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl">    <span class="nx">request</span><span class="p">(</span><span class="nx">data1</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data2</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl">        <span class="nx">request</span><span class="p">(</span><span class="nx">data2</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data3</span><span class="p">){</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl">            <span class="nx">process</span><span class="p">(</span><span class="nx">data3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>ç›¸äº’ä¾èµ–çš„IOè¯·æ±‚ä½¿å›è°ƒå‡ºç°åµŒå¥—ï¼Œä¸ä»…ä½¿ä»£ç æ¨ªå‘å¢é•¿ï¼Œè€Œä¸”è®©å¼‚å¸¸é™¤äº†å˜å¾—éå¸¸è‰°éš¾ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavascriptç¤¾åŒºå¼€å‘å‡ºäº†å¾ˆå¤šæ›¿ä»£æ–¹æ¡ˆï¼Œæ¯”å¦‚ES6çš„<code>Promise</code>å’ŒES7çš„<code>async/await</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1"> 1</a></span><span class="cl"><span class="nx">request</span><span class="p">(</span><span class="nx">url1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2"> 2</a></span><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data1</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3"> 3</a></span><span class="cl">        <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data1</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>    
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4"> 4</a></span><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5"> 5</a></span><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data2</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6"> 6</a></span><span class="cl">        <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data2</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>    
</span></span><span class="line"><span class="ln" id="code-sec-7"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-7"> 7</a></span><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-8"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-8"> 8</a></span><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data3</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-9"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-9"> 9</a></span><span class="cl">        <span class="nx">process</span><span class="p">(</span><span class="nx">data3</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-10"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-10">10</a></span><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="ln" id="code-sec-11"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-11">11</a></span><span class="cl">    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-12"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-12">12</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-13"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-13">13</a></span><span class="cl">    <span class="p">})</span>
</span></span></code></pre></div><p><code>Promise</code>å°†å›è°ƒè½¬æ¢æˆäº†é“¾å¼è°ƒç”¨çš„APIï¼Œä½†æ˜¯JSç¤¾åŒºä»ä¸æ»¡æ„ï¼Œå› ä¸ºPromiseæœ€å¤§çš„é—®é¢˜åœ¨äºå®ƒå…·æœ‰ä¼ æŸ“æ€§ï¼Œå¦‚æœå‡½æ•°2ä¾èµ–äºå‡½æ•°1çš„ç»“æœï¼Œè€Œå‡½æ•°1æ˜¯å›è°ƒå¼çš„ï¼Œé‚£ä¹ˆå¿…é¡»å°†å‡½æ•°1è½¬æ¢ä¸ºPromiseçš„æ‰è¡Œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå‡ ä¹æ‰€æœ‰çš„JS Promiseåº“éƒ½è‡ªå¸¦äº†<code>promisify</code>åŠŸèƒ½ã€‚å› æ­¤åˆå¼€å‘å‡ºäº†<code>async/await</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln" id="code-sec-1"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-1">1</a></span><span class="cl"><span class="p">(</span><span class="kr">async</span><span class="p">()=&gt;{</span>
</span></span><span class="line"><span class="ln" id="code-sec-2"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-2">2</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">data1</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">url1</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-3"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-3">3</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">data2</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data1</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-4"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-4">4</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">data3</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">data2</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-5"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-5">5</a></span><span class="cl">    <span class="nx">process</span><span class="p">(</span><span class="nx">data3</span><span class="p">);</span>
</span></span><span class="line"><span class="ln" id="code-sec-6"><a style="outline: none; text-decoration:none; color:inherit" href="#code-sec-6">6</a></span><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>JavaScriptçš„<code>async/await</code>æ˜¯åŸºäº<code>generator</code>çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å»ç ”ç©¶ã€‚ åŒç†ï¼ŒPythonçš„<code>asyncio</code>ä¹Ÿæ˜¯åŸºäºåç¨‹å’Œ<code>generator</code>çš„ã€‚</p>
<h2 id="å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</h2>
<p>Q: Node.jsæ˜¯å¼‚æ­¥IOå—? A: ç³»ç»Ÿçº§åˆ«çš„å¼‚æ­¥æ€§å–å†³äºNode.jsçš„å®ç°ã€‚Node.jsåº•å±‚æ‰€ä¾èµ–çš„<code>libuv</code>(ä»Node.js 0.9.0å¼€å§‹)åœ¨Linuxä¸ŠåŸºäºEpoll,åœ¨Windowsä¸ŠåŸºäº<code>IOCP</code>.Epollå±äºåŒæ­¥éé˜»å¡IO(ç„¶è€Œepollæš´éœ²å‡ºæ¥çš„æ¥å£æ˜¯é˜»å¡çš„, å› ä¸º<code>epoll_wait()</code>æ–¹æ³•ä¼šç­‰å¾…ä¸€ä¸ªäº‹ä»¶çš„å‘ç”Ÿç„¶åå†åˆ†å‘äº‹ä»¶), IOCPå±äºå¼‚æ­¥éé˜»å¡IO. Node.jsçš„<code>libuv</code>å°è£…äº†è¿™äº›åº•å±‚çš„å·®å¼‚æ€§, æä¾›äº†ä¸€ä¸ªé€šç”¨çš„äº‹ä»¶å¾ªç¯ã€‚ Node.jsåœ¨libuvçš„åŸºç¡€ä¸Šæä¾›äº†ä¸€å¥—å¼‚æ­¥çš„ç¼–ç¨‹æ¥å£(æ³¨æ„åŒºåˆ«äºå¼‚æ­¥IO)ã€‚ Q: Linuxå¦‚ä½•å®ç°å†…æ ¸å±‚é¢IO? A: ä½¿ç”¨Linux AIO</p>
<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<ol>
<li><a href="https://chamibuddhika.wordpress.com/2012/08/11/io-demystified/">IO Demystified</a></li>
<li><a href="https://www.zhihu.com/question/19732473">æ€æ ·ç†è§£é˜»å¡éé˜»å¡ä¸åŒæ­¥å¼‚æ­¥çš„åŒºåˆ«ï¼Ÿ</a></li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>Manjaro é…ç½®æŒ‡å—</title>
			<link>https://huanglei.rocks/posts/manjaro-config-manual/</link>
			<pubDate>Tue, 03 Apr 2018 05:58:37 +0800</pubDate>
			
			<guid>https://huanglei.rocks/posts/manjaro-config-manual/</guid>
			<description>Manjaro æ˜¯åŸºäº ArchLinux çš„å‘è¡Œç‰ˆ, æ—¢å…·å¤‡äº†å¼€ç®±å³ç”¨çš„ç”¨æˆ·å‹å¥½æ€§, åˆç»§æ‰¿äº† ArchLinux æ»šåŠ¨æ›´æ–°çš„ç‰¹æ€§å’Œå†…å®¹ä¸°å¯Œçš„ AUR è½¯ä»¶åŒ…, å¹¶ä¸”å†…ç½®äº† MHWD ,æ–¹ä¾¿ç”¨æˆ·ç®¡ç†ç¡¬ä»¶é©±åŠ¨. Manjaro å…·æœ‰G</description>
			<content type="html"><![CDATA[<p>Manjaro æ˜¯åŸºäº ArchLinux çš„å‘è¡Œç‰ˆ, æ—¢å…·å¤‡äº†å¼€ç®±å³ç”¨çš„ç”¨æˆ·å‹å¥½æ€§, åˆç»§æ‰¿äº† ArchLinux æ»šåŠ¨æ›´æ–°çš„ç‰¹æ€§å’Œå†…å®¹ä¸°å¯Œçš„ AUR è½¯ä»¶åŒ…, å¹¶ä¸”å†…ç½®äº† MHWD ,æ–¹ä¾¿ç”¨æˆ·ç®¡ç†ç¡¬ä»¶é©±åŠ¨. Manjaro å…·æœ‰GNOME/i3/xfce/KDEç­‰å¤šç§å›¾å½¢ç•Œé¢å¯ä¾›é€‰æ‹©. ä»¥ä¸‹æ˜¯ Manjaro with KDE çš„åŸºæœ¬é…ç½®é€‰é¡¹.</p>
<h2 id="1-æ›´æ¢ä¸æ›´æ–°æº">1 æ›´æ¢ä¸æ›´æ–°æº</h2>
<pre tabindex="0"><code>#nano /etc/pacman.d/mirrors/China
[China]
Server = http://mirrors.ustc.edu.cn/manjaro/$branch/$repo/$arch

#nano /etc/pacman-mirrors.conf
OnlyCountry=China
pacman-mirrors -g

# /etc/pacman.conf 
[archlinuxcn]
SigLevel = Optional TrustedOnly
Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch

sudo pacman -Syy &amp;&amp; sudo pacman -S archlinuxcn-keyring
</code></pre><h2 id="2-å®‰è£…ä¸­æ–‡è¾“å…¥æ³•">2 å®‰è£…ä¸­æ–‡è¾“å…¥æ³•</h2>
<pre tabindex="0"><code>sudo yaourt -S fcitx-sogoupinyin
sudo yaourt -S fcitx-im # å…¨éƒ¨å®‰è£…
sudo yaourt -S fcitx-configtool # å›¾å½¢åŒ–é…ç½®å·¥å…·
</code></pre><p>åœ¨<code>~/.xprofile</code>æ–‡ä»¶å½“ä¸­è¾“å…¥(å¦‚æœæ²¡æœ‰å°±åˆ›å»º)</p>
<pre tabindex="0"><code>export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=&#34;@im=fcitx&#34;
</code></pre><h2 id="3-å®‰è£…å…¶ä»–å¸¸ç”¨è½¯ä»¶">3 å®‰è£…å…¶ä»–å¸¸ç”¨è½¯ä»¶</h2>
<pre tabindex="0"><code>yaourt -S visual-studio-code
yaourt -S vim git zsh 
</code></pre><h3 id="å½•å±è½¬gif">å½•å±è½¬GIF</h3>
<pre tabindex="0"><code>yaourt -S peek
</code></pre><h3 id="æˆªå›¾">æˆªå›¾</h3>
<pre tabindex="0"><code>yaourt -S xclip deepin-screenshot
</code></pre><p>æ³¨æ„upstreamçš„<code>deepin-screenshot</code>è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿çš„åŠŸèƒ½æœ‰é—®é¢˜, éœ€è¦å°†æ–‡ä»¶<code>/usr/share/deepin-screenshot/src/gtk-clip</code>çš„å†…å®¹ä¿®æ”¹ä¸º</p>
<pre tabindex="0"><code>#!/bin/bash
# REPLACE EXISTING FILE WITH THIS
# /usr/share/deepin-screenshot/src/gtk-clip
# source: http://unix.stackexchange.com/a/266761
command -v xclip &gt;/dev/null 2&gt;&amp;1 || { echo &#34;Need command xclip. Aborting.&#34; &gt;&amp;2; exit 1; }
[[ -f &#34;$1&#34; ]] || { echo &#34;Error: Not a file.&#34; &gt;&amp;2; exit 1; }
TYPE=$(file -b --mime-type &#34;$1&#34;)
xclip -selection clipboard -t &#34;$TYPE&#34; &lt; &#34;$1&#34;
</code></pre><h2 id="4-ä¿®æ”¹splash-screen">4 ä¿®æ”¹Splash Screen</h2>
<p>æ›¿æ¢<code>/usr/share/plasma/look-and-feel/org.kde.&lt;theme&gt;.desktop/contents/components/artwork</code>ä¸‹é¢çš„<code>background.png</code>å³å¯</p>
<h2 id="5-å¼ºåˆ¶libreofficeä½¿ç”¨gtkä¸»é¢˜">5 å¼ºåˆ¶Libreofficeä½¿ç”¨GTKä¸»é¢˜</h2>
<pre tabindex="0"><code>sudo vim /etc/profile.d/libreoffice-still.sh
</code></pre><p>å–æ¶ˆ<code>export SAL_USE_VCLPLUGIN=gtk3</code>è¿™ä¸€è¡Œçš„æ³¨é‡Š <code>System Settings</code> -&gt; <code>Application Style</code> -&gt; <code>Gnome Application Style</code> -&gt; <code>Select GTK3 Style</code>é€‰æ‹©<code>Breath</code> <code>System Settings</code> -&gt; <code>Colors</code> -&gt; Uncheck <code>Apply Colors for Non-Qt Applications</code></p>
]]></content>
		</item>
		
	</channel>
</rss>
