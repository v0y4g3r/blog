<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#282c34">
	<meta name="msapplication-TileColor" content="#282c34">
<meta itemprop="name" content="三个字母引发的惨案">
<meta itemprop="description" content="问题 在 feat: compaction integration - GreptimeTeam/greptimedb #997 中，我们尝试把 table compaction 作为 flush 的后置任务触发，因此需要为 FlushJob增加一个 callback，因为涉及到异步操作，所以这个 callback"><meta itemprop="datePublished" content="2023-02-19T18:28:33+08:00" />
<meta itemprop="dateModified" content="2023-02-19T18:28:33+08:00" />
<meta itemprop="wordCount" content="2358">
<meta itemprop="keywords" content="Rust,Programming," /><meta property="og:title" content="三个字母引发的惨案" />
<meta property="og:description" content="问题 在 feat: compaction integration - GreptimeTeam/greptimedb #997 中，我们尝试把 table compaction 作为 flush 的后置任务触发，因此需要为 FlushJob增加一个 callback，因为涉及到异步操作，所以这个 callback" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huanglei.rocks/posts/send-sync/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-19T18:28:33+08:00" />
<meta property="article:modified_time" content="2023-02-19T18:28:33+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="三个字母引发的惨案"/>
<meta name="twitter:description" content="问题 在 feat: compaction integration - GreptimeTeam/greptimedb #997 中，我们尝试把 table compaction 作为 flush 的后置任务触发，因此需要为 FlushJob增加一个 callback，因为涉及到异步操作，所以这个 callback"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>三个字母引发的惨案</title>
	<link rel="stylesheet" href="https://huanglei.rocks/css/style.min.c20f42539b2857b70526b1a2b5475ea081715ad8b772943c9b6ed223021ea10d.css" integrity="sha256-wg9CU5soV7cFJrGitUdeoIFxWti3cpQ8m27SIwIeoQ0=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://huanglei.rocks">Ratuthomm</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://huanglei.rocks/posts/">Posts</a>
				<a href="https://huanglei.rocks/gallery/">Gallery</a>
				<a href="https://huanglei.rocks/scribbles/">Scribbles</a>
				<a href="https://huanglei.rocks/tags/">Tags</a>
				<a href="https://huanglei.rocks/about-me/">About Me</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://twitter.com/ratuthomm" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.instagram.com/ratuthomm" target="_blank" rel="noopener me" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a><a href="https://github.com/v0y4g3r" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
    <script defer data-domain="huanglei.rocks" src="https://plausible.io/js/plausible.js"></script>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://huanglei.rocks/posts/">Posts</a></li>
			<li><a href="https://huanglei.rocks/gallery/">Gallery</a></li>
			<li><a href="https://huanglei.rocks/scribbles/">Scribbles</a></li>
			<li><a href="https://huanglei.rocks/tags/">Tags</a></li>
			<li><a href="https://huanglei.rocks/about-me/">About Me</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Feb 19, 2023</span></div>
				<h1>三个字母引发的惨案</h1>
			</header>

			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://huanglei.rocks/tags/rust">Rust</a></span><span class="tag"><a href="https://huanglei.rocks/tags/programming">Programming</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2358 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2023-02-19 18:28 &#43;0800</p>
			</footer>
		</br>

			<div class="content">
				<h2 id="问题">问题<a href="#问题" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>在 <a href="https://github.com/GreptimeTeam/greptimedb/pull/997">feat: compaction integration - GreptimeTeam/greptimedb #997</a> 中，我们尝试把 table compaction 作为 flush 的后置任务触发，因此需要为 <code>FlushJob</code>增加一个 callback，因为涉及到异步操作，所以这个 callback 的定义是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">FlushCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">FlushJob</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">LogStore</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5">5</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">on_success</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">FlushCallback</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6">6</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>然后在完成 flush 后调用 callback：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="cp">#[async_trait]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">LogStore</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">FlushJob</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">Context</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">write_manifest_and_apply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_metas</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">on_success</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">            </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可惜编译器无情地给出了 error：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="n">error</span>: <span class="nc">future</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="n">safely</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">58</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="mi">250</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">Context</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="n">__________________________________________________________</span><span class="o">^</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w"></span><span class="mi">251</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="mi">252</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_manifest_and_apply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_metas</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w"></span><span class="mi">253</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="o">..</span><span class="p">.</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="mi">257</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="mi">258</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">_____</span><span class="o">^</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="err">`</span><span class="nb">Send</span><span class="err">`</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">help</span>: <span class="nc">the</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="err">`</span><span class="nb">Sync</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">implemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">futures_util</span>::<span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">)</span><span class="err">`</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w"></span><span class="n">note</span>: <span class="nc">future</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="err">`</span><span class="nb">Send</span><span class="err">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">251</span>:<span class="mi">60</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w"></span><span class="mi">251</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">----</span><span class="w">                              </span><span class="o">^^^^^^</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">later</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">here</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">|</span><span class="w">                                 </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">|</span><span class="w">                                 </span><span class="k">await</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="n">here</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span><span class="err">`</span><span class="w"> </span><span class="n">maybe</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">later</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="n">has</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="o">&amp;</span><span class="n">FlushJob</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="err">`</span><span class="nb">Send</span><span class="err">`</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w"></span><span class="n">help</span>: <span class="nc">consider</span><span class="w"> </span><span class="n">moving</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="kd">let</span><span class="err">`</span><span class="w"> </span><span class="n">binding</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">shorter</span><span class="w"> </span><span class="n">lived</span><span class="w"> </span><span class="n">borrow</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">251</span>:<span class="mi">26</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w"></span><span class="mi">251</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">file_metas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">write_memtables_to_layer</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">    </span><span class="o">|</span><span class="w">                          </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">required</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cast</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">`</span><span class="p">[</span><span class="k">async</span><span class="w"> </span><span class="n">block</span><span class="o">@</span><span class="n">src</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">flush</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">58</span>: <span class="mi">258</span>:<span class="mi">6</span><span class="p">]</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="k">dyn</span><span class="w"> </span><span class="n">futures_util</span>::<span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">result</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Send</span><span class="err">`</span><span class="w">
</span></span></span></code></pre></div><p>大概意思是说，新加入<code>FlushJob</code> 的<code>cb</code>字段不是<code>Sync</code>的，导致<code>FlushJob::run</code>方法所产生的 future 不满足<code>Send</code>约束。</p>
<blockquote>
<p>这一点倒是容易理解，因为我们对 FlushCallback 的定义<code>Pin&lt;Box&lt;dyn Future&lt;Output=xxx&gt; + Send&gt;&gt;</code>并未带上 <code>Sync</code>trait，通常我们也不应该要求一个 future 是<code>Sync</code>的，因为 future 的定义中唯一一个方法的 receiver 是 <code>self: Pin&lt;&amp;mut Self&gt;</code>，不存在对 self 的 shared reference，所以不应该要求 future 满足<code>Sync</code>。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">            </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>因此，除了为 <code>FlushCallback</code>强行加上<code>Sync</code>约束外，我们更应该想一想为什么编译器会要求<code>FlushCallback: Sync</code>。</p>
<h2 id="mre">MRE<a href="#mre" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>为了方便排查问题，我们把不相关的代码逻辑去掉，用一段最简单的代码来复现这个问题。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w"></span><span class="cp">#[async_trait::async_trait]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Job</span>: <span class="nb">Send</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w"></span><span class="k">type</span> <span class="nc">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="n">cb</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Callback</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w"></span><span class="cp">#[async_trait::async_trait]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">do_something</span><span class="p">().</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cb</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">            </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="w"></span><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">job_impl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cb</span>: <span class="nb">None</span> <span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl"><span class="w">    </span><span class="n">job_impl</span><span class="p">.</span><span class="n">run</span><span class="p">().</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在 <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=90f5a253a0a6e5cef0e659e42fa1a193">Rust Playground</a> 中编译运行这段代码可以看到类似的报错。</p>
<p>现在代码里面的魔法只剩下了<code>async_trait</code>这个 proc macro。为了进一步简化代码，我们可以手动把这个宏展开：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">mre</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="n">Checking</span><span class="w"> </span><span class="n">lance</span><span class="o">-</span><span class="n">demo</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">lei</span><span class="o">/</span><span class="n">Workspace</span><span class="o">/</span><span class="n">Rust</span><span class="o">/</span><span class="n">mre</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.23</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">mre</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Job</span>: <span class="nb">Send</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w">        </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; 
</span></span><span class="line"><span class="ln" id="code-sec-11"><a class="lnlinks" href="#code-sec-11">11</a></span><span class="cl">            <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-12"><a class="lnlinks" href="#code-sec-12">12</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-13"><a class="lnlinks" href="#code-sec-13">13</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-14"><a class="lnlinks" href="#code-sec-14">14</a></span><span class="cl"><span class="w">    </span><span class="k">type</span> <span class="nc">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-15"><a class="lnlinks" href="#code-sec-15">15</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-16"><a class="lnlinks" href="#code-sec-16">16</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-17"><a class="lnlinks" href="#code-sec-17">17</a></span><span class="cl"><span class="w">        </span><span class="n">cb</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Callback</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-18"><a class="lnlinks" href="#code-sec-18">18</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-19"><a class="lnlinks" href="#code-sec-19">19</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-20"><a class="lnlinks" href="#code-sec-20">20</a></span><span class="cl"><span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-21"><a class="lnlinks" href="#code-sec-21">21</a></span><span class="cl"><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-22"><a class="lnlinks" href="#code-sec-22">22</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-23"><a class="lnlinks" href="#code-sec-23">23</a></span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln" id="code-sec-24"><a class="lnlinks" href="#code-sec-24">24</a></span><span class="cl"><span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-25"><a class="lnlinks" href="#code-sec-25">25</a></span><span class="cl"><span class="w">        </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-26"><a class="lnlinks" href="#code-sec-26">26</a></span><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">__self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-27"><a class="lnlinks" href="#code-sec-27">27</a></span><span class="cl"><span class="w">            </span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-28"><a class="lnlinks" href="#code-sec-28">28</a></span><span class="cl"><span class="w">                </span><span class="n">JobImpl</span>::<span class="n">do_something</span><span class="p">(</span><span class="n">__self</span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-29"><a class="lnlinks" href="#code-sec-29">29</a></span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__self</span><span class="p">.</span><span class="n">cb</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-30"><a class="lnlinks" href="#code-sec-30">30</a></span><span class="cl"><span class="w">                    </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-31"><a class="lnlinks" href="#code-sec-31">31</a></span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-32"><a class="lnlinks" href="#code-sec-32">32</a></span><span class="cl"><span class="w">                </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-33"><a class="lnlinks" href="#code-sec-33">33</a></span><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-34"><a class="lnlinks" href="#code-sec-34">34</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-35"><a class="lnlinks" href="#code-sec-35">35</a></span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-36"><a class="lnlinks" href="#code-sec-36">36</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到 <code>JobImpl::run</code>方法返回的 future 里面只包含了对 self 的引用 <code>__self</code>。因此 future 不满足<code>Send</code>约束，也就是<code>__self</code>不满足<code>Send</code>约束，而 <code>__self</code>的类型是什么呢？根据<code>JobImpl::run</code>的 receiver 很显然是 <code>&amp;mut self</code>。</p>
<p>Hmmm&hellip; <code>Send</code>/<code>Sync</code>/<code>&amp;mut T</code>/<code>&amp;T</code>似乎让人想起来刚刚开始学 Rust 的时候一些古早记忆，查到这里不妨再复习一下。</p>
<h2 id="一点点小知识">一点点小知识🤏🏻<a href="#一点点小知识" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p><code>Send</code> 和 <code>Sync</code> 都是用于描述 thread-safety 的 marker trait.</p>
<ul>
<li><code>Send</code>指的是某个数据类型可以被安全地转移到另一个线程 (move)</li>
<li><code>Sync</code>指的是某个数据类型可以安全地被多个线程共享不可变引用 (borrow)</li>
</ul>
<blockquote>
<p>“安全地传递”指的是在保证线程安全的情况下转移所有权。那么什么情况下转移所有权是不安全的呢？举个例子，<code>Rc</code>并没有实现 <code>Send</code>，只能用作单线程内部的引用计数。<code>Rc</code> 的内部是用的 <code>Cell</code>实现内部可变性，在 drop 的时候，如果引用计数为 0，则将内部包含的数据析构掉。因为<a href="https://doc.rust-lang.org/src/alloc/rc.rs.html#2633-2635">修改引用计数</a>的行为本身不是原子的，因此 move 到另一个线程之后如果进行 clone，那么可能就会导致并发问题，因此 <code>Rc</code> 不能安全地被转移所有权。</p>
</blockquote>
<ul>
<li>Send 和 Sync 的绑定关系
<ul>
<li><code>&amp;T: Send</code> ⇔ <code>T: Sync</code>：要想一个数据类型的不可变引用是<code>Send</code>的，那么这个数据类型自身必须是<code>Sync</code>的，这样才能保证跨线程的只读访问是安全的；</li>
<li><code>&amp;mut T: Send</code> ⇔ <code>T: Send</code>：要想一个数据类型的可变引用是 <code>Send</code>的，那么这个数据类型自身也必须是<code>Send</code>的，因为跨线程共享可变引用即意味着 move 。</li>
<li>显然，相比要求 <code>T: Sync</code>，<code>T: Send</code>是更加宽松的。</li>
</ul>
</li>
</ul>
<h2 id="去掉一点糖">去掉一点糖<a href="#去掉一点糖" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>我们再来看看 <code>!Send</code>的 future：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1"> 1</a></span><span class="cl"><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2"> 2</a></span><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">__self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3"> 3</a></span><span class="cl"><span class="w">    </span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4"> 4</a></span><span class="cl"><span class="w">        </span><span class="n">JobImpl</span>::<span class="n">do_something</span><span class="p">(</span><span class="n">__self</span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-5"><a class="lnlinks" href="#code-sec-5"> 5</a></span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__self</span><span class="p">.</span><span class="n">cb</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-6"><a class="lnlinks" href="#code-sec-6"> 6</a></span><span class="cl"><span class="w">            </span><span class="n">cb</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-7"><a class="lnlinks" href="#code-sec-7"> 7</a></span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-8"><a class="lnlinks" href="#code-sec-8"> 8</a></span><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-9"><a class="lnlinks" href="#code-sec-9"> 9</a></span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-10"><a class="lnlinks" href="#code-sec-10">10</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>既然 future 捕获的是 <code>JobImpl</code>的可变引用，那么只要 <code>JobImpl</code>是<code>Send</code>的那么 future 就一定是<code>Send</code>才对啊？哪里出了问题呢？我们再来看看 <code>JobImpl::do_something</code>的签名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以看到 <code>do_something</code>的 receiver 是 <code>JobImpl</code>的共享引用，那么<code>__self</code>自然就会被 coerce 成 <code>&amp;JobImpl</code>。根据 <code>Send</code> 和 <code>Sync</code> 的绑定关系，如果 T 的共享引用是 <code>Send</code>，那么 T 自身必须是 <code>Sync</code>，这样就能解释为啥要求 <code>JobImpl: Sync</code>了。</p>
<p>仅仅是因为 coercion 吗？我们可以试试把 <code>JobImpl::do_something</code>改成同步的签名 <code>fn do_something(&amp;self) {}</code>，结果居然是可以编译的。显然问题不仅出在 receiver，也和 async 有关。我们都知道，Rust 的 async 本质上只是一个 generator 的语法糖，对 <code>JobImpl::do_something</code>的调用会被展开成一个实现了 Generator trait 的 struct，这个 struct 捕获了<code>JobImpl</code>的共享引用，而 <code>JobImpl</code>不满足<code>Sync</code>约束，从而 genrator 不满足 <code>Send</code>约束。</p>
<p>因此我们只需要增加三个字母，把 <code>JobImpl::do_something</code>的 receiver 改成可变引用就行啦。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln" id="code-sec-1"><a class="lnlinks" href="#code-sec-1">1</a></span><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">JobImpl</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-2"><a class="lnlinks" href="#code-sec-2">2</a></span><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln" id="code-sec-3"><a class="lnlinks" href="#code-sec-3">3</a></span><span class="cl"><span class="w">    </span><span class="c1">//                         ^~~~ the magic lies here
</span></span></span><span class="line"><span class="ln" id="code-sec-4"><a class="lnlinks" href="#code-sec-4">4</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=0f06bf5a9a02c8bfc93a9781462e3b4e">You can try it here</a></p>
<h2 id="结论">结论<a href="#结论" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>所以这个问题的本质是，在一个要求 T 的可变引用的异步上下文中，调用了一个接收 T 的共享引用的异步方法，从而导致对 T 的要求从 <code>Send</code> 升级成了 <code>Sync</code>。
其实这在做了一个复现的 demo 之后还是很容易发现的（毕竟才二三十行代码），但是在项目的一个几百行的 PR 里面就不太容易发现到底是哪里不 <code>Sync</code>了。Rust 的 async/await 语法糖用起来很方便，但是还是要理解它背后是怎么实现的，不然很容易踩坑里。</p>

			</div>

<div class="related-posts thin">
	<h2>See Also</h2>
	<ul>
	
	<li><a href="/posts/rust-pinning/">理解 Rust 的 Pin 机制</a></li>
	
	<li><a href="/posts/bridging-sync-and-async-rust/">如何在同步的 Rust 方法中调用异步代码？</a></li>
	
	<li><a href="/posts/object-safety/">Rust 对象安全详解</a></li>
	
	<li><a href="/posts/java-debug-manual/">现代 Java 捉虫指南</a></li>
	
	<li><a href="/posts/why-netty-not-responding/">为什么我的 Netty 应用没有响应？</a></li>
	
	</ul>
</div>

		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#问题">问题</a></li>
    <li><a href="#mre">MRE</a></li>
    <li><a href="#一点点小知识">一点点小知识🤏🏻</a></li>
    <li><a href="#去掉一点糖">去掉一点糖</a></li>
    <li><a href="#结论">结论</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="prev-post" href="https://huanglei.rocks/posts/bridging-sync-and-async-rust/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>如何在同步的 Rust 方法中调用异步代码？</span>
			</a>
		</div>
		<div id="comments" class="thin"><script src="https://giscus.app/client.js"
        data-repo="v0y4g3r/blog"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyNTQ5MDMwOTk="
        data-category="Announcements"
        data-category-id="DIC_kwDODzGDO84CBGIK"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>&copy; 2023 <a href="https://huanglei.rocks/about-me/">Lei, HUANG</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a> &#183; <a href="https://huanglei.rocks/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
	</p>
</footer>


	

	


	<script src="https://huanglei.rocks/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js" integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin="anonymous"></script>
	

</body>

</html>
